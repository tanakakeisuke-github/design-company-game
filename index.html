<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>デザイン会社発展国</title>
<style>
/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   DESIGN COMPANY SIMULATOR — shadcn/ui Light & Clean Theme
   Font: Plus Jakarta Sans (Latin) + Noto Sans JP
   Color: Zinc-based HSL  ·  Accent: Indigo
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');

/* ── RESET ── */
*{box-sizing:border-box;margin:0;padding:0}
html,body{
  height:100%;overflow:hidden;
  background:hsl(0,0%,100%);
  color:hsl(240,10%,3.9%);
  font-family:'Plus Jakarta Sans','Noto Sans JP',sans-serif;
  font-size:14px;
  user-select:none;
  -webkit-font-smoothing:antialiased;
}
button{font-family:inherit;cursor:pointer;border:none;background:none;outline:none;color:inherit}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:hsl(240,5.9%,85%);border-radius:99px}
::-webkit-scrollbar-thumb:hover{background:hsl(240,5.9%,75%)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   shadcn/ui Design Tokens
━━━━━━━━━━━━━━━━━━━━━━━ */
:root{
  /* Surface */
  --bg:       hsl(0,0%,99%);
  --bg1:      hsl(0,0%,100%);
  --bg2:      hsl(240,4.8%,97.9%);
  --bg3:      hsl(240,4.8%,95.9%);
  --bg4:      hsl(240,5.9%,90%);
  /* Borders */
  --bord:     hsl(240,5.9%,90%);
  --bord2:    hsl(240,5.9%,83%);
  /* Primary / Accent — Indigo */
  --acc:      hsl(239,84%,61%);
  --acc-lt:   hsl(239,87%,97%);
  --acc-md:   hsl(239,68%,72%);
  /* Destructive / Danger */
  --acc2:     hsl(339,90%,51%);
  --acc2-lt:  hsl(352,100%,97%);
  /* Semantic Colors */
  --teal:     hsl(173,80%,32%);
  --teal-lt:  hsl(166,76%,96%);
  --gold:     hsl(38,92%,38%);
  --gold-lt:  hsl(48,96%,95%);
  --warn:     hsl(20,90%,45%);
  --warn-lt:  hsl(33,100%,95%);
  --red:      hsl(0,72%,51%);
  --red-lt:   hsl(0,86%,97%);
  --ok:       hsl(142,72%,29%);
  --ok-lt:    hsl(138,76%,97%);
  --pur:      hsl(270,67%,44%);
  /* Text */
  --t1:hsl(240,10%,3.9%);
  --t2:hsl(240,3.8%,36%);
  --t3:hsl(240,3.7%,55%);
  --t4:hsl(240,5.9%,75%);
  /* Shadows — very subtle */
  --sh-s:0 1px 2px rgba(0,0,0,.04);
  --sh-m:0 1px 6px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.03);
  --sh-l:0 4px 16px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.04);
  /* Radius */
  --r:  6px;
  --r-lg:10px;
  --r-sm:4px;
  --radius:var(--r);
  --radius-sm:var(--r-sm);
}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   TITLE SCREEN
━━━━━━━━━━━━━━━━━━━━━━━ */
#SCR_TITLE{
  position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:20px;
  background:hsl(0,0%,100%);
}
#SCR_TITLE::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 80% 50% at 50% 0%,hsl(239,87%,97%) 0%,transparent 70%);
  pointer-events:none;
}
#tcv{image-rendering:pixelated;border:1px solid var(--bord);box-shadow:var(--sh-l);border-radius:var(--r-lg)}
.t-logo{
  font-size:clamp(14px,3vw,20px);color:var(--t1);letter-spacing:.5px;
  text-align:center;line-height:1.8;font-weight:700;
}
.t-logo span{color:var(--t3);font-size:.65em;font-weight:500;letter-spacing:2px}
.t-btn{
  background:var(--t1);color:hsl(0,0%,98%);
  padding:10px 40px;font-size:13px;letter-spacing:.3px;
  transition:all .15s;border-radius:var(--r);font-weight:600;
}
.t-btn:hover{background:hsl(240,6%,15%);transform:translateY(-1px);box-shadow:var(--sh-m)}
.t-btn.sec{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  color:var(--t2);box-shadow:var(--sh-s);font-weight:500;
}
.t-btn.sec:hover{background:var(--bg3);border-color:var(--bord2);transform:none}
.t-blink{font-size:11px;color:var(--t4);letter-spacing:4px;animation:blink 1.4s step-end infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
@keyframes glow{0%,100%{opacity:1}50%{opacity:.8}}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   LOADING
━━━━━━━━━━━━━━━━━━━━━━━ */
#SCR_LOAD{
  position:fixed;inset:0;background:hsl(0,0%,100%);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:2000;gap:14px;
}
.ld-bar{width:180px;height:1px;background:var(--bg4);border-radius:99px}
.ld-f{height:100%;background:var(--acc);animation:ldf 1.6s ease forwards;border-radius:99px}
@keyframes ldf{from{width:0}to{width:100%}}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   GAME SHELL
━━━━━━━━━━━━━━━━━━━━━━━ */
#GAME{display:none;height:100vh;flex-direction:column}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   HUD — shadcn Topbar
━━━━━━━━━━━━━━━━━━━━━━━ */
#hud{
  background:hsl(0,0%,100%);
  border-bottom:1px solid var(--bord);
  display:flex;flex-direction:column;flex-shrink:0;
  gap:0;padding:0;
}
#hud-row1{
  display:flex;align-items:center;gap:6px;
  padding:5px 12px;border-bottom:1px solid var(--bord);
  min-height:38px;flex-shrink:0;
}
#hud-row2{
  display:flex;align-items:center;gap:4px;
  padding:4px 12px;min-height:34px;flex-shrink:0;
  overflow-x:auto;scrollbar-width:none;
}
#hud-row2::-webkit-scrollbar{display:none}
.hud-co{
  font-size:12px;color:var(--t1);font-weight:700;
  padding-right:10px;border-right:1px solid var(--bord);
  white-space:nowrap;letter-spacing:.3px;flex-shrink:0;
}
.hstats{display:flex;gap:3px;flex-wrap:wrap;flex:1}
.hs{
  display:flex;align-items:center;gap:3px;
  padding:2px 7px;font-size:11px;
  border:1px solid var(--bord);border-radius:99px;
  background:hsl(0,0%,100%);
  transition:border-color .12s;white-space:nowrap;
}
.hs:hover{border-color:var(--bord2)}
.hs-lbl{color:var(--t4);font-size:10px;font-weight:500}
.hs-v{color:var(--t1);font-weight:700;min-width:24px;font-variant-numeric:tabular-nums}
.hs-v.g{color:var(--gold)}
.hs-v.tl{color:var(--teal)}
.hs-v.r{color:var(--red)}
.hs-v.p{color:var(--pur)}
.hs-v.blink{animation:blink .8s step-end infinite;color:var(--warn)}
/* 日付バッジ */
.hdate{
  display:flex;align-items:center;gap:4px;
  border:1px solid var(--bord);border-radius:99px;
  padding:2px 9px;font-size:11px;font-weight:600;
  color:var(--t2);white-space:nowrap;
  background:hsl(0,0%,100%);
}
.hdate-day{font-size:11px;color:var(--t4);font-weight:400}
/* フェーズバッジ */
.hph{
  background:var(--t1);border-radius:99px;
  padding:2px 9px;font-size:10.5px;color:hsl(0,0%,98%);
  letter-spacing:.5px;font-weight:700;white-space:nowrap;
}
#btn-ai{
  font-size:11px;color:var(--t3);
  border:1px solid var(--bord);border-radius:99px;
  padding:2px 9px;transition:all .12s;
  display:flex;align-items:center;gap:4px;background:hsl(0,0%,100%);
}
#btn-ai:hover{border-color:var(--bord2);color:var(--t2);background:var(--bg2)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   NAV SIDEBAR — Icon Rail
━━━━━━━━━━━━━━━━━━━━━━━ */
#main{display:flex;flex:1;overflow:hidden}
#nav{
  width:50px;background:hsl(0,0%,100%);border-right:1px solid var(--bord);
  display:flex;flex-direction:column;align-items:center;
  padding:6px 0;gap:1px;flex-shrink:0;
}
.nb{
  width:38px;height:38px;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:2px;
  border-radius:var(--r-sm);border:1px solid transparent;
  color:var(--t3);font-size:17px;transition:all .12s;position:relative;
}
.nb span{font-size:9.5px;color:var(--t4);letter-spacing:.2px;font-weight:600}
.nb:hover{background:var(--bg3);color:var(--t2)}
.nb:hover span{color:var(--t3)}
.nb.on{background:var(--bg3);border-color:var(--bord);color:var(--t1)}
.nb.on span{color:var(--t2)}
.nbadge{
  position:absolute;top:2px;right:2px;
  background:var(--red);color:hsl(0,0%,98%);
  font-size:7.5px;width:13px;height:13px;border-radius:99px;
  display:flex;align-items:center;justify-content:center;font-weight:700;
  border:1.5px solid hsl(0,0%,100%);
}
.nsep{width:24px;height:1px;background:var(--bord);margin:3px 0}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   OFFICE VIEW
━━━━━━━━━━━━━━━━━━━━━━━ */
#content{flex:1;display:flex;flex-direction:column;overflow:hidden}
#owrap{
  height:180px;flex-shrink:0;background:hsl(240,10%,97%);
  border-bottom:1px solid var(--bord);position:relative;overflow:hidden;
  min-height:100px;max-height:580px;
}
#owrap-handle{
  position:absolute;bottom:0;left:0;right:0;height:8px;
  cursor:ns-resize;z-index:20;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(to top,rgba(0,0,0,.08),transparent);transition:background .12s;
}
#owrap-handle:hover{background:linear-gradient(to top,rgba(99,102,241,.25),transparent)}
#owrap-handle::after{
  content:'';width:24px;height:2px;border-radius:99px;
  background:rgba(255,255,255,.6);
}
#ocv{display:block}
.olb{
  position:absolute;top:6px;left:8px;font-size:9.5px;
  color:var(--t3);letter-spacing:2px;font-weight:700;
  background:rgba(255,255,255,.9);padding:2px 7px;border-radius:var(--r-sm);
  backdrop-filter:blur(4px);border:1px solid var(--bord);
}
#oc-zoom-ctrl{
  position:absolute;top:6px;right:8px;
  display:flex;align-items:center;gap:3px;z-index:10;
}
.oc-zoom-btn{
  width:24px;height:24px;border-radius:var(--r-sm);
  background:rgba(255,255,255,.9);backdrop-filter:blur(4px);
  color:var(--t2);font-size:15px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .12s;
  border:1px solid var(--bord);
}
.oc-zoom-btn:hover{background:hsl(0,0%,100%);border-color:var(--bord2)}
#oc-zoom-val{
  font-size:9.5px;font-weight:700;color:var(--t2);
  background:rgba(255,255,255,.9);backdrop-filter:blur(4px);
  padding:2px 7px;border-radius:var(--r-sm);min-width:36px;text-align:center;
  letter-spacing:.3px;border:1px solid var(--bord);
}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   PANELS
━━━━━━━━━━━━━━━━━━━━━━━ */
#panels{flex:1;overflow-y:auto;padding:12px 14px;background:var(--bg)}
.panel{display:none}.panel.on{display:block}

/* Section Header */
.sh{
  font-size:10.5px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;
  border-bottom:1px solid var(--bord);padding-bottom:7px;margin-bottom:11px;
  display:flex;align-items:center;gap:6px;font-weight:700;
}
.sh::before{display:none}
.sh .ct{margin-left:auto;font-size:10px;color:var(--t4);letter-spacing:0;font-weight:500}

/* Warn Bars */
.wbar{
  background:var(--red-lt);border:1px solid hsl(0,86%,88%);color:var(--red);
  padding:6px 10px;font-size:11.5px;margin-bottom:8px;border-radius:var(--r);
  animation:blink 1.2s step-end infinite;display:none;
}
.ibar{
  background:var(--gold-lt);border:1px solid hsl(48,96%,78%);color:var(--gold);
  padding:6px 10px;font-size:11.5px;margin-bottom:8px;border-radius:var(--r);display:none;
}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   TURN ROW
━━━━━━━━━━━━━━━━━━━━━━━ */
.trow{
  display:flex;align-items:center;gap:10px;
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:9px 14px;margin-bottom:11px;border-radius:var(--r-lg);
}
.tinfo{flex:1;font-size:12px;color:var(--t2);line-height:1.7}
.tinfo b{color:var(--t1);font-weight:700}
.tinfo .hint{font-size:11px;color:var(--t3)}
.tinfo .hint kbd{
  background:var(--bg3);border:1px solid var(--bord2);color:var(--t2);
  padding:0px 4px;border-radius:var(--r-sm);font-size:10.5px;font-family:inherit;
}
.btn-turn{
  background:var(--t1);color:hsl(0,0%,98%);
  padding:7px 20px;font-size:12.5px;letter-spacing:.3px;
  transition:all .15s;border-radius:var(--r);font-weight:600;
}
.btn-turn:hover{background:hsl(240,6%,15%);transform:translateY(-1px);box-shadow:var(--sh-m)}
.btn-turn:disabled{
  background:var(--bg4);color:var(--t4);
  transform:none;cursor:not-allowed;
}
@keyframes turnpulse{
  0%,100%{box-shadow:0 0 0 0 rgba(0,0,0,.06)}
  50%{box-shadow:0 0 0 3px rgba(0,0,0,.06)}
}
.btn-turn:not(:disabled){animation:turnpulse 2.5s ease-in-out infinite}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   STATS GRID
━━━━━━━━━━━━━━━━━━━━━━━ */
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:7px;margin-bottom:11px}
.dc{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:10px 12px;border-radius:var(--r-lg);
}
.dc-l{font-size:10px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;font-weight:700}
.dc-v{font-size:19px;font-weight:700;margin-bottom:3px;color:var(--t1);font-variant-numeric:tabular-nums}
.dc-b{height:2px;background:var(--bg4);border-radius:99px}
.dc-bf{height:100%;border-radius:99px;transition:width .4s}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   ACTIVE PROJECT
━━━━━━━━━━━━━━━━━━━━━━━ */
.ap{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:10px 12px;margin-bottom:6px;border-radius:var(--r-lg);
  position:relative;overflow:hidden;transition:border-color .12s;
}
.ap:hover{border-color:var(--bord2)}
.ap::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:2px;
  background:var(--acc);border-radius:2px 0 0 2px;
}
.ap-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.ap-n{font-size:12.5px;color:var(--t1);font-weight:600}
.ap-pct{font-size:16px;color:var(--acc);font-weight:700;font-variant-numeric:tabular-nums}
.ap-m{display:flex;gap:5px;font-size:11px;color:var(--t3);margin-bottom:6px;flex-wrap:wrap}
.apbar{height:3px;background:var(--bg4);overflow:hidden;border-radius:99px}
.apbf{height:100%;background:var(--acc);border-radius:99px;transition:width .5s}
.apass{margin-top:7px;display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.apal{font-size:11px;color:var(--t3)}
.ach{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:2px 8px;font-size:11px;color:var(--t2);
  cursor:pointer;transition:all .12s;border-radius:var(--r-sm);font-weight:500;
}
.ach:hover{border-color:var(--acc);color:var(--acc)}
.ach.sel{border-color:var(--acc);color:var(--acc);background:var(--acc-lt)}
.ach.bsy{opacity:.3;cursor:default;pointer-events:none}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   PROJECT CARDS
━━━━━━━━━━━━━━━━━━━━━━━ */
.pcgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:8px}
.pc{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:12px;border-radius:var(--r-lg);transition:border-color .12s,box-shadow .12s;
}
.pc:hover{border-color:var(--bord2);box-shadow:var(--sh-m)}
.pc-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px}
.pc-ti{font-size:18px}
.pc-ug{font-size:10.5px;color:var(--red);background:var(--red-lt);border:1px solid hsl(0,86%,88%);padding:1px 6px;border-radius:99px;font-weight:700}
.pc-nm{font-size:12.5px;color:var(--t1);font-weight:600;margin-bottom:2px}
.pc-cl{font-size:11px;color:var(--t3);margin-bottom:7px}
.pc-st{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.pct{
  background:var(--bg3);border:1px solid var(--bord);
  padding:1px 7px;font-size:10.5px;color:var(--t2);border-radius:99px;font-weight:500;
}
.pct.pri{background:var(--gold-lt);border-color:hsl(48,96%,78%);color:var(--gold)}
.pct.dif{background:var(--warn-lt);border-color:hsl(33,100%,80%);color:var(--warn)}
.pc-f{display:flex;align-items:center;justify-content:space-between;margin-top:7px;padding-top:8px;border-top:1px solid var(--bord)}
.pc-pr{font-size:13px;color:var(--gold);font-weight:700;font-variant-numeric:tabular-nums}
.btn-acc{
  background:var(--t1);color:hsl(0,0%,98%);padding:4px 12px;
  font-size:11.5px;border-radius:var(--r-sm);font-weight:600;transition:all .12s;
}
.btn-acc:hover{background:hsl(240,6%,15%)}
.btn-acc:disabled{background:var(--bg4);color:var(--t4);cursor:not-allowed}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   STAFF CARDS
━━━━━━━━━━━━━━━━━━━━━━━ */
.scgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px}
.sc{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:12px;border-radius:var(--r-lg);
}
.sc-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.sc-i{font-size:20px}
.sc-n{font-size:12.5px;color:var(--t1);font-weight:700;margin-bottom:1px}
.sc-r{font-size:11px;color:var(--t3);letter-spacing:.2px}
.sc-st{font-size:10px;padding:2px 7px;border-radius:99px;font-weight:600;letter-spacing:.3px}
.sc-st.idle{background:var(--bg3);color:var(--t3);border:1px solid var(--bord)}
.sc-st.working{background:var(--acc-lt);color:var(--acc);border:1px solid hsl(239,87%,90%)}
.sc-bars{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.sc-bar{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--t4)}
.sc-bar-bg{flex:1;height:3px;background:var(--bg4);border-radius:99px}
.sc-bar-fg{height:100%;border-radius:99px;transition:width .4s}
.sc-bar-v{width:20px;text-align:right;color:var(--t2);font-weight:600;font-variant-numeric:tabular-nums}
.sc-f{display:flex;align-items:center;justify-content:space-between;padding-top:8px;border-top:1px solid var(--bord)}
.btn-fir{
  background:hsl(0,0%,100%);border:1px solid var(--bord);color:var(--t3);
  padding:3px 9px;font-size:11px;border-radius:var(--r-sm);font-weight:500;transition:all .12s;
}
.btn-fir:hover{border-color:var(--red);color:var(--red);background:var(--red-lt)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   HIRE CARDS
━━━━━━━━━━━━━━━━━━━━━━━ */
.hcgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(245px,1fr));gap:8px}
.hc{
  background:hsl(0,0%,100%);border:1px solid var(--bord);padding:12px;
  border-radius:var(--r-lg);transition:border-color .12s;
}
.hc:hover{border-color:var(--bord2)}
.hc-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px}
.hc-n{font-size:12.5px;color:var(--t1);font-weight:700}
.hc-ro{font-size:11px;color:var(--t3);letter-spacing:.2px}
.hc-sl{font-size:13px;color:var(--gold);text-align:right;font-weight:700;font-variant-numeric:tabular-nums}
.hc-sl span{font-size:10px;color:var(--t4);font-weight:400}
.hc-risk{
  font-size:11px;color:var(--warn);
  background:var(--warn-lt);border:1px solid hsl(33,100%,80%);
  padding:4px 8px;border-radius:var(--r-sm);margin-bottom:8px;
  line-height:1.5;
}
.hc-f{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:8px;padding-top:8px;border-top:1px solid var(--bord);
}
.hc-co{font-size:11px;color:var(--t3)}
.btn-hire{
  background:var(--t1);color:hsl(0,0%,98%);padding:4px 12px;
  font-size:11.5px;border-radius:var(--r-sm);font-weight:600;transition:all .12s;
}
.btn-hire:hover{background:hsl(240,6%,15%)}
.btn-hire:disabled{background:var(--bg4);color:var(--t4);cursor:not-allowed}

/* Stat bars in hire card */
.sbars{display:flex;flex-direction:column;gap:3px;margin-bottom:7px}
.srow{display:flex;align-items:center;gap:5px;font-size:11px}
.sl{color:var(--t4);width:44px;font-size:10.5px;flex-shrink:0}
.sb{flex:1;height:3px;background:var(--bg4);border-radius:99px;overflow:hidden}
.sbf{height:100%;border-radius:99px;transition:width .3s}
.sbf.d{background:var(--acc)}
.sbf.sp{background:var(--teal)}
.sbf.ui{background:var(--pur)}
.sbf.cm{background:var(--gold)}
.sbf.mn{background:var(--ok)}
.sn{width:22px;text-align:right;color:var(--t2);font-size:10.5px;font-weight:600;font-variant-numeric:tabular-nums}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   TECH TREE
━━━━━━━━━━━━━━━━━━━━━━━ */
.tt-sec{margin-bottom:18px}
.tech-row{display:flex;gap:8px;flex-wrap:wrap;padding-left:6px}
.tn{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:10px 12px;min-width:100px;text-align:center;
  transition:all .15s;border-radius:var(--r-lg);
}
.tn.un{
  border-color:hsl(173,80%,75%);background:var(--teal-lt);
}
.tn.un::after{content:'✓';position:absolute;top:4px;right:6px;font-size:9px;color:var(--teal);font-weight:700}
.tn{position:relative}
.tn.av{
  border-color:var(--acc);background:var(--acc-lt);
  cursor:pointer;
}
.tn.av:hover{box-shadow:var(--sh-m);transform:translateY(-1px)}
.tn.lk{opacity:.35;cursor:not-allowed}
.tn-ic{font-size:20px;margin-bottom:4px}
.tn-nm{font-size:11.5px;color:var(--t1);letter-spacing:.2px;margin-bottom:2px;font-weight:700}
.tn-co{font-size:10.5px;color:var(--gold);font-weight:700;font-variant-numeric:tabular-nums}
.tn-st{font-size:10px;margin-top:3px;font-weight:600;letter-spacing:.3px}
.tn.un .tn-st{color:var(--teal)}
.tn.av .tn-st{color:var(--acc)}
.tn.lk .tn-st{color:var(--t4)}
.tn-ef{font-size:10px;color:var(--t3);margin-top:2px}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   PROGRESS / PHASES
━━━━━━━━━━━━━━━━━━━━━━━ */
.phases{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.ph{
  flex:1;min-width:90px;background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:9px 8px;text-align:center;border-radius:var(--r-lg);
}
.ph.done{border-color:hsl(173,80%,75%);background:var(--teal-lt)}
.ph.cur{border-color:var(--acc);background:var(--acc-lt)}
@keyframes phg{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.1)}50%{box-shadow:0 0 0 3px rgba(99,102,241,.1)}}
.ph.cur{animation:phg 2.5s ease infinite}
.ph-n{font-size:20px;margin-bottom:2px}
.ph-nm{font-size:11.5px;color:var(--t2);letter-spacing:.2px;font-weight:600}
.ph-s{font-size:10px;color:var(--t3);margin-top:2px}
.ofgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:7px;margin-bottom:12px}
.ofc{
  background:hsl(0,0%,100%);border:1px solid var(--bord);padding:10px;
  border-radius:var(--r-lg);transition:border-color .12s;
}
.ofc.cur{border-color:var(--acc);background:var(--acc-lt)}
.ofc.past{opacity:.4}
.ofc-ic{font-size:22px;margin-bottom:4px}
.ofc-n{font-size:12px;color:var(--t1);font-weight:700;margin-bottom:2px}
.ofc-d{font-size:11px;color:var(--t3);line-height:1.6;margin-bottom:6px}
.ofc-f{display:flex;align-items:center;justify-content:space-between}
.ofc-p{font-size:12px;color:var(--gold);font-weight:700;font-variant-numeric:tabular-nums}
.btn-up{
  background:var(--t1);color:hsl(0,0%,98%);padding:3px 9px;
  font-size:11px;border-radius:var(--r-sm);font-weight:600;transition:all .12s;
}
.btn-up:hover{background:hsl(240,6%,15%)}
.btn-up:disabled{background:var(--bg4);color:var(--t4);cursor:not-allowed}
.statbox{
  background:hsl(0,0%,100%);border:1px solid var(--bord);padding:12px;
  border-radius:var(--r-lg);
  display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:5px;
}
.si{font-size:11.5px;color:var(--t3);display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--bg3)}
.si:last-child{border-bottom:none}
.si b{color:var(--t1);font-weight:700;font-variant-numeric:tabular-nums}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   LOG
━━━━━━━━━━━━━━━━━━━━━━━ */
.log{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  padding:7px 10px;max-height:130px;overflow-y:auto;border-radius:var(--r-lg);
  font-size:11.5px;line-height:1.9;
}
.le{display:flex;gap:5px;border-bottom:1px solid var(--bg3);padding:1px 0}
.le:last-child{border-bottom:none}
.le-t{color:var(--t4);flex-shrink:0;font-weight:600}
.le-x{color:var(--t2)}
.good .le-t{color:var(--ok)}
.bad  .le-t{color:var(--red)}
.evt  .le-t{color:var(--warn)}
.sys  .le-t{color:var(--acc)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   MODALS
━━━━━━━━━━━━━━━━━━━━━━━ */
.mbg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  backdrop-filter:blur(3px);
  display:none;align-items:center;justify-content:center;
  z-index:500;padding:16px;
}
.mbg.open{display:flex}
.mbox{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  max-width:440px;width:100%;padding:24px;border-radius:var(--r-lg);
  box-shadow:var(--sh-l);animation:mop .18s ease;
}
.mbox.danger{border-top:2px solid var(--red)}
.mbox.success{border-top:2px solid var(--ok)}
.mbox.warn{border-top:2px solid var(--gold)}
@keyframes mop{from{transform:scale(.96) translateY(8px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.mic{font-size:38px;text-align:center;display:block;margin-bottom:10px}
.mtt{font-size:15px;text-align:center;color:var(--t1);margin-bottom:8px;line-height:1.4;font-weight:700}
.mbox.danger .mtt{color:var(--red)}
.mbox.success .mtt{color:var(--ok)}
.mbox.warn .mtt{color:var(--gold)}
.mds{font-size:12.5px;color:var(--t2);text-align:center;line-height:2;margin-bottom:16px;white-space:pre-line}
.mch-list{display:flex;flex-direction:column;gap:6px}
.mch{
  background:hsl(0,0%,100%);border:1px solid var(--bord);padding:10px 13px;
  color:var(--t1);font-size:12.5px;cursor:pointer;transition:all .12s;
  display:flex;justify-content:space-between;align-items:center;gap:6px;
  text-align:left;font-family:inherit;width:100%;border-radius:var(--r);font-weight:500;
}
.mch:hover{border-color:var(--acc);background:var(--acc-lt);color:var(--acc)}
.mch .ef{font-size:11px;color:var(--t4);flex-shrink:0}
.mch:hover .ef{color:var(--acc-md)}
.rev-box{border-top:2px solid var(--gold)}
.rev-st{font-size:22px;text-align:center;letter-spacing:4px;color:var(--gold);margin-bottom:6px}
.rev-cm{font-size:12px;text-align:center;color:var(--t2);font-style:italic;margin-bottom:12px;line-height:1.8}
.rev-ef{font-size:11.5px;text-align:center;color:var(--t3);margin-bottom:12px;line-height:2}
.btn-ok{
  display:block;width:100%;background:hsl(0,0%,100%);border:1px solid var(--bord);
  color:var(--t2);padding:8px;font-size:12.5px;letter-spacing:.5px;
  transition:all .12s;cursor:pointer;font-family:inherit;border-radius:var(--r);font-weight:500;
}
.btn-ok:hover{border-color:var(--bord2);color:var(--t1)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   PARTICLE CANVAS
━━━━━━━━━━━━━━━━━━━━━━━ */
#ptcl-canvas{position:fixed;inset:0;pointer-events:none;z-index:490;will-change:transform}
/* Star performer badge */
.star-badge{
  display:inline-flex;align-items:center;gap:3px;font-size:9px;padding:2px 8px;
  border-radius:99px;background:linear-gradient(135deg,#f59e0b,#f97316);
  color:#fff;font-weight:700;animation:starpulse 1.8s ease-in-out infinite;
}
@keyframes starpulse{
  0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,.5)}
  50%{box-shadow:0 0 0 8px rgba(245,158,11,0)}
}
/* WB HUD indicator */
#hwb-wrap{display:flex;align-items:center;gap:4px}
.wb-pill{
  font-size:10px;font-weight:700;padding:1px 7px;border-radius:99px;
  background:rgba(99,102,241,.1);color:var(--acc);border:1px solid rgba(99,102,241,.2);
  transition:background .3s,color .3s;
}
.wb-pill.high{background:rgba(34,197,94,.1);color:var(--ok);border-color:rgba(34,197,94,.25)}
.wb-pill.low{background:rgba(239,68,68,.1);color:var(--red);border-color:rgba(239,68,68,.2)}
/* Policy cards */
.pol-grid{display:flex;flex-direction:column;gap:6px}
.pol-cat-hd{font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--t3);
  text-transform:uppercase;padding:8px 0 4px;border-bottom:1px solid var(--bord);margin-bottom:4px}
.pol-card{
  border:1px solid var(--bord);border-radius:var(--r-lg);padding:11px 13px;
  background:var(--bg1);transition:border-color .15s,background .15s;
}
.pol-card.adopted{border-color:#22c55e;background:rgba(34,197,94,.04)}
.pol-card:not(.adopted):hover{border-color:var(--acc);background:var(--acc-lt);cursor:pointer}
.pol-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.pol-nm{font-size:12px;font-weight:700;color:var(--t1)}
.pol-cost{font-size:10px;color:var(--t3)}
.pol-tags{display:flex;gap:5px;flex-wrap:wrap;margin-top:5px}
.pol-tag{font-size:9px;padding:1px 7px;border-radius:99px;font-weight:700}
.pt-wb{background:rgba(99,102,241,.1);color:var(--acc)}
.pt-bk{background:rgba(34,197,94,.1);color:var(--ok)}
.pt-bkb{background:rgba(239,68,68,.1);color:var(--red)}
/* Bases display */
.base-chip{
  display:inline-flex;align-items:center;gap:4px;font-size:10px;padding:3px 9px;
  border-radius:99px;border:1px solid var(--bord2);background:var(--bg2);color:var(--t2);font-weight:600;
}
.base-chip.active{border-color:var(--acc);color:var(--acc);background:var(--acc-lt)}
/* WB progress bar in dash */
.wb-bar-wrap{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-top:2px}
.wb-bar-fill{height:100%;border-radius:3px;transition:width .5s ease}
/* Ending card on SCR_END */
.end-ending-chip{
  display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:4px 12px;
  border-radius:99px;font-weight:700;margin-bottom:14px;
  border:1px solid currentColor;opacity:.85;
}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   ENDING SCREEN
━━━━━━━━━━━━━━━━━━━━━━━ */
#SCR_END{
  position:fixed;inset:0;
  background:hsl(0,0%,98%);
  display:none;flex-direction:column;
  z-index:700;overflow-y:auto;
}
#SCR_END.open{display:flex}

/* ── ヒーロー部 ── */
.end-hero{
  padding:40px 24px 28px;text-align:center;flex-shrink:0;
  background:linear-gradient(180deg,var(--acc-lt) 0%,hsl(0,0%,98%) 100%);
  position:relative;
}
.end-hero::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 60% 50% at 50% 0%,rgba(99,102,241,0.12),transparent);
  pointer-events:none;
}
.end-t{font-size:clamp(18px,5vw,32px);letter-spacing:.5px;margin-bottom:8px;line-height:1.3;font-weight:800;color:var(--t1)}
.end-sub{font-size:11px;color:var(--t4);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:16px;font-weight:600}
.end-s{max-width:480px;margin:0 auto;font-size:13px;color:var(--t2);line-height:2.0;white-space:pre-line}

/* ── 詳細レポートエリア ── */
.end-report{max-width:780px;margin:0 auto;padding:20px 16px 40px;width:100%}
@keyframes confettiFall{
  0%{transform:translateY(0) rotate(0deg);opacity:1}
  80%{opacity:1}
  100%{transform:translateY(100vh) rotate(720deg);opacity:0}
}

/* スコアカード */
.end-scorecard{
  display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
  margin-bottom:20px;
}
@media(max-width:600px){.end-scorecard{grid-template-columns:repeat(2,1fr);}}
.end-sc-item{
  background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);
  padding:12px 10px;text-align:center;
}
.end-sc-val{font-size:18px;font-weight:800;color:var(--t1);line-height:1.2}
.end-sc-lbl{font-size:9px;color:var(--t4);margin-top:3px;letter-spacing:.5px;text-transform:uppercase}
.end-sc-bar{height:3px;border-radius:99px;background:var(--bord);margin-top:6px;overflow:hidden}
.end-sc-bar-fill{height:100%;border-radius:99px;background:var(--acc);transition:width .6s}

/* チャートエリア */
.end-charts{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
@media(max-width:560px){.end-charts{grid-template-columns:1fr;}}
.end-chart-card{
  background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);
  padding:14px;
}
.end-chart-title{font-size:10.5px;font-weight:700;color:var(--t3);letter-spacing:.5px;margin-bottom:10px;text-transform:uppercase}
.end-chart-cv{display:block;width:100%;height:80px}

/* タイムライン */
.end-timeline{background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);padding:14px;margin-bottom:20px}
.end-timeline-title{font-size:10.5px;font-weight:700;color:var(--t3);letter-spacing:.5px;margin-bottom:12px;text-transform:uppercase}
.end-tl-row{display:flex;gap:10px;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--bg3);font-size:11px}
.end-tl-row:last-child{border-bottom:none}
.end-tl-turn{flex-shrink:0;font-size:9px;color:var(--t4);width:44px;padding-top:2px}
.end-tl-tag{flex-shrink:0;padding:1px 7px;border-radius:99px;font-size:9px;font-weight:700}

/* コンサルタントアドバイス */
.end-consult{
  background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);
  padding:16px;margin-bottom:20px;
  border-left:4px solid var(--acc);
}
.end-consult-hdr{display:flex;align-items:center;gap:8px;margin-bottom:12px}
.end-consult-avatar{font-size:24px}
.end-consult-meta{display:flex;flex-direction:column;gap:1px}
.end-consult-nm{font-size:12px;font-weight:700;color:var(--t1)}
.end-consult-role{font-size:10px;color:var(--t4)}
.end-consult-body{font-size:12px;color:var(--t2);line-height:1.9}
.end-consult-item{padding:5px 0;border-bottom:1px solid var(--bg3);display:flex;gap:8px}
.end-consult-item:last-child{border-bottom:none}
.end-consult-bullet{flex-shrink:0;font-size:12px}

/* SNSシェアボタン */
.end-share-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:20px}
.end-share-btn{
  display:flex;align-items:center;gap:6px;padding:10px 18px;
  border-radius:var(--r);font-size:12px;font-weight:700;cursor:pointer;
  border:none;transition:all .12s;font-family:inherit;letter-spacing:.2px;
}
.end-share-btn:active{transform:scale(.97)}
.share-x{background:#000;color:#fff}
.share-img{background:var(--acc);color:#fff}
.share-re{background:hsl(0,0%,100%);color:var(--t1);border:1px solid var(--bord)}
.btn-re{
  background:var(--t1);color:hsl(0,0%,98%);padding:10px 30px;
  font-size:13px;letter-spacing:.3px;transition:all .15s;
  font-family:inherit;cursor:pointer;border-radius:var(--r);font-weight:700;border:none;
}
.btn-re:hover{background:hsl(240,6%,15%);transform:translateY(-1px);box-shadow:var(--sh-m)}

/* A4レポートモーダル */
#end-report-modal{
  display:none;position:fixed;inset:0;z-index:800;
  background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
  align-items:center;justify-content:center;padding:20px;overflow-y:auto;
}
#end-report-modal.open{display:flex}
#end-report-inner{
  background:hsl(0,0%,100%);width:min(794px,100%);
  font-family:'Helvetica Neue',Arial,sans-serif;
  box-shadow:0 20px 60px rgba(0,0,0,.35);position:relative;
  border-radius:12px;overflow:hidden;
}
.report-close{
  position:fixed;top:24px;right:24px;background:rgba(0,0,0,0.7);
  color:#fff;border:none;border-radius:50%;width:32px;height:32px;
  font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  z-index:10;backdrop-filter:blur(4px);
}
.report-close:hover{background:rgba(0,0,0,0.9)}
.report-dl-btn{
  display:block;width:calc(100% - 32px);margin:0 16px 16px;
  padding:12px;background:var(--acc);color:#fff;border:none;
  border-radius:var(--r);font-size:13px;font-weight:700;cursor:pointer;
  font-family:inherit;text-align:center;
}
.report-dl-btn:hover{background:var(--acc2)}
#report-cv{display:block;width:100%;height:auto}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   TURN PROGRESS BAR
━━━━━━━━━━━━━━━━━━━━━━━ */
#turn-progress{
  position:absolute;bottom:0;left:0;right:0;height:20px;
  background:rgba(255,255,255,.9);backdrop-filter:blur(6px);
  border-top:1px solid rgba(0,0,0,.05);
  display:flex;align-items:center;gap:8px;padding:0 10px;pointer-events:none;
}
#tp-bar{height:2px;background:var(--bg4);flex:1;overflow:hidden;border-radius:99px}
#tp-bar::after{
  content:'';display:block;height:100%;
  background:var(--acc);transition:width .4s ease;width:var(--tp,0%);
}
#tp-txt{font-size:9.5px;color:var(--t4);white-space:nowrap;letter-spacing:.3px;min-width:90px;text-align:right;font-weight:600}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   NOTIFICATION PANEL
━━━━━━━━━━━━━━━━━━━━━━━ */
/* ── 通知: HUDベルボタン + ドロップダウン ───────────────── */
#notif-btn{
  position:relative;display:flex;align-items:center;gap:3px;
  font-size:11px;color:var(--t3);
  border:1px solid var(--bord);border-radius:99px;
  padding:2px 9px;background:hsl(0,0%,100%);cursor:pointer;
  transition:all .12s;flex-shrink:0;
}
#notif-btn:hover{border-color:var(--bord2);color:var(--t2)}
#notif-btn.has-new{border-color:var(--red);color:var(--red)}
#notif-badge{
  background:var(--red);color:#fff;border-radius:99px;
  min-width:15px;height:15px;font-size:9px;font-weight:700;
  display:none;align-items:center;justify-content:center;padding:0 3px;
}
/* ドロップダウン本体 */
#notif-panel{
  position:absolute;top:calc(100% + 5px);right:0;z-index:800;width:280px;
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  border-radius:var(--r-lg);box-shadow:0 8px 24px rgba(0,0,0,.10);
  display:none;flex-direction:column;overflow:hidden;
  animation:dropIn .15s cubic-bezier(.4,0,.2,1);
}
#notif-panel.open{display:flex}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
#notif-hdr{
  display:flex;justify-content:space-between;align-items:center;
  padding:7px 11px;border-bottom:1px solid var(--bord);
  font-size:10.5px;font-weight:700;color:var(--t2);flex-shrink:0;
}
#notif-list{
  overflow-y:auto;display:flex;flex-direction:column;
  max-height:320px;
}
#notif-list::-webkit-scrollbar{width:3px}
#notif-list::-webkit-scrollbar-thumb{background:var(--bord2);border-radius:99px}
.nf{
  border-bottom:1px solid var(--bg3);
  padding:7px 11px;font-size:11px;color:var(--t1);line-height:1.6;
  border-left:3px solid transparent;
  animation:nfi .12s ease;
}
.nf:last-child{border-bottom:none}
.nf.new-item{background:var(--bg2)}
.nf.danger{border-left-color:var(--red);background:rgba(239,68,68,.04)}
.nf.ok{border-left-color:var(--ok);background:rgba(34,197,94,.04)}
.nf.warn{border-left-color:var(--gold);background:rgba(234,179,8,.04)}
.nf-ts{font-size:9px;color:var(--t4);margin-top:1px}
@keyframes nfi{from{opacity:0;transform:translateY(-3px)}to{opacity:1;transform:translateY(0)}}
#notifs{display:none!important}
.empty{font-size:11.5px;color:var(--t4);padding:20px;text-align:center;line-height:2}
.empty{font-size:11.5px;color:var(--t4);padding:18px;text-align:center;line-height:2}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   AI MODE
━━━━━━━━━━━━━━━━━━━━━━━ */
body.ai-mode .btn-acc,body.ai-mode .btn-hire,
body.ai-mode .ach,body.ai-mode .btn-up,
body.ai-mode .btn-fir,body.ai-mode .tn.av{
  opacity:.2;pointer-events:none;
}
body.ai-mode .pc:hover,body.ai-mode .hc:hover{box-shadow:none}
body.ai-mode .trow{border-color:var(--bord2)}
body.ai-mode .btn-turn{background:var(--acc);color:hsl(0,0%,98%)}
#ai-banner{
  display:none;background:var(--bg3);border:1px solid var(--bord);border-radius:var(--r);
  padding:8px 14px;margin-bottom:10px;font-size:11.5px;color:var(--t2);line-height:1.7;
}
#ai-banner strong{font-weight:700;color:var(--t1)}
body.ai-mode #ai-banner{display:block}
#ai-overlay{
  position:absolute;inset:0;pointer-events:none;z-index:5;
  background:
    linear-gradient(rgba(0,0,0,.012) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,0,0,.012) 1px,transparent 1px);
  background-size:24px 24px;display:none;
}
body.ai-mode #ai-overlay{display:block}
#ai-status{
  position:absolute;top:8px;left:50%;transform:translateX(-50%);
  background:rgba(255,255,255,.96);border:1px solid var(--bord);
  color:var(--t2);font-size:10px;
  padding:3px 14px;border-radius:99px;
  white-space:nowrap;font-weight:700;letter-spacing:.3px;
  z-index:11;pointer-events:none;display:none;
  backdrop-filter:blur(8px);
}
body.ai-mode #ai-status{display:block}
#ai-status .st-dot{
  display:inline-block;width:5px;height:5px;border-radius:99px;
  background:var(--ok);margin-right:5px;vertical-align:middle;
  animation:blink .8s step-end infinite;
}
#pan-ai{font-size:12.5px}
.ai-dash-header{
  background:var(--bg3);border:1px solid var(--bord);border-radius:var(--r-lg);
  padding:14px 18px;margin-bottom:12px;display:flex;align-items:center;gap:14px;
}
.ai-avatar{font-size:32px;flex-shrink:0}
.ai-dash-title{font-size:14px;font-weight:700;color:var(--t1);margin-bottom:2px}
.ai-dash-sub{font-size:11.5px;color:var(--t2);line-height:1.6}
.ai-toggle-big{
  margin-left:auto;background:var(--t1);color:hsl(0,0%,98%);
  padding:8px 18px;font-size:12px;border-radius:var(--r);font-weight:600;
  transition:all .12s;white-space:nowrap;
}
.ai-toggle-big:hover{background:hsl(240,6%,15%)}
.ai-toggle-big.on{background:var(--red)}
.ai-spd-btn{
  font-size:9px;font-weight:700;padding:4px 12px;border-radius:6px;
  border:1px solid var(--bord2);background:var(--bg2);color:var(--t3);
  cursor:pointer;transition:all .15s;font-family:var(--font);
}
.ai-spd-btn.on{border-color:var(--acc);background:var(--acc-lt);color:var(--acc)}
.ai-spd-btn:hover:not(.on){border-color:var(--bord2);background:var(--bg3);color:var(--t2)}
.ai-kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:7px;margin-bottom:12px}
.ai-kpi{background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);padding:11px}
.ai-kpi-l{font-size:9.5px;color:var(--t3);letter-spacing:.8px;text-transform:uppercase;margin-bottom:3px;font-weight:700}
.ai-kpi-v{font-size:17px;font-weight:700;color:var(--t1);font-variant-numeric:tabular-nums}
.ai-kpi-d{font-size:10.5px;color:var(--t3);margin-top:2px}
.ai-log-panel{background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);padding:10px;max-height:190px;overflow-y:auto}
.ai-log-row{display:flex;gap:7px;align-items:flex-start;padding:5px 0;border-bottom:1px solid var(--bg3);font-size:11px}
.ai-log-row:last-child{border-bottom:none}
.ai-log-turn{background:var(--bg3);color:var(--t3);font-size:10px;font-weight:700;padding:1px 6px;border-radius:var(--r-sm);flex-shrink:0;white-space:nowrap}
.ai-log-action{color:var(--t1);flex:1;line-height:1.6}
.ai-log-type{font-size:9.5px;font-weight:700;padding:1px 6px;border-radius:99px;flex-shrink:0;white-space:nowrap}
.ai-log-type.order{background:var(--ok-lt);color:var(--ok)}
.ai-log-type.hire{background:var(--teal-lt);color:var(--teal)}
.ai-log-type.tech{background:var(--gold-lt);color:var(--gold)}
.ai-log-type.risk{background:var(--red-lt);color:var(--red)}
.ai-log-type.assign{background:var(--bg3);color:var(--t3)}
.ai-log-type.other{background:var(--bg3);color:var(--t4)}
body.ai-mode #nb-ai{background:var(--t1);color:hsl(0,0%,98%)}
body.ai-mode #nb-ai span{color:hsl(0,0%,70%)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   ORDER SYSTEM
━━━━━━━━━━━━━━━━━━━━━━━ */
#SCR_ORDER{
  display:none;position:fixed;inset:0;z-index:500;
  background:hsl(0,0%,100%);flex-direction:column;overflow-y:auto;
}
#SCR_ORDER.open{display:flex}
.ord-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 16px;border-bottom:1px solid var(--bord);
  background:hsl(0,0%,100%);position:sticky;top:0;z-index:10;flex-shrink:0;
}
.ord-logo{display:flex;align-items:center;gap:7px;font-size:12.5px;font-weight:700;color:var(--t1);letter-spacing:.5px}
.ord-logo-dot{width:8px;height:8px;border-radius:50%;background:var(--acc);animation:pulse2 2s ease-in-out infinite}
.ord-close-btn{
  font-size:11.5px;color:var(--t3);background:none;border:1px solid var(--bord);
  border-radius:var(--r-sm);padding:4px 11px;cursor:pointer;transition:all .12s;
}
.ord-close-btn:hover{border-color:var(--bord2);color:var(--t2)}
.ord-body{flex:1;padding:20px 16px;max-width:560px;width:100%;margin:0 auto}
.ord-form-grid{display:flex;flex-direction:column;gap:14px}
.ord-group{display:flex;flex-direction:column;gap:5px}
.ord-label{font-size:11.5px;font-weight:600;color:var(--t2);letter-spacing:.2px}
.ord-label .req{color:var(--red);margin-left:2px}
.ord-input,.ord-select{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  border-radius:var(--r-sm);color:var(--t1);font-family:'Plus Jakarta Sans','Noto Sans JP',sans-serif;
  font-size:13px;padding:8px 11px;outline:none;transition:border-color .12s;width:100%;
}
.ord-input:focus,.ord-select:focus{border-color:var(--acc)}
.ord-textarea{
  background:hsl(0,0%,100%);border:1px solid var(--bord);
  border-radius:var(--r-sm);color:var(--t1);font-family:'Plus Jakarta Sans','Noto Sans JP',sans-serif;
  font-size:13px;padding:8px 11px;outline:none;transition:border-color .12s;
  width:100%;min-height:100px;resize:vertical;line-height:1.7;
}
.ord-textarea:focus{border-color:var(--acc)}
.ord-title{font-size:16px;font-weight:700;color:var(--t1);margin-bottom:4px}
.ord-sub{font-size:12px;color:var(--t3);line-height:1.7}
.ord-type-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin-bottom:12px}
.ord-type-btn{
  background:hsl(0,0%,100%);border:1px solid var(--bord);padding:8px 6px;
  border-radius:var(--r);cursor:pointer;transition:all .12s;
  display:flex;flex-direction:column;align-items:center;gap:3px;
}
.ord-type-btn:hover{border-color:var(--bord2)}
.ord-type-btn.sel{background:var(--bg3);border-color:var(--acc)}
.ord-type-ic{font-size:17px}
.ord-type-nm{font-size:11px;font-weight:600;color:var(--t2);text-align:center;line-height:1.3}
.ord-type-pr{font-size:10px;color:var(--t4)}
.ord-budget-val{font-size:17px;font-weight:700;color:var(--t1);letter-spacing:-.5px;margin-bottom:5px;font-variant-numeric:tabular-nums}
.ord-range{
  -webkit-appearance:none;width:100%;height:2px;
  background:linear-gradient(to right,var(--acc) 0%,var(--acc) var(--pct,25%),var(--bord2) var(--pct,25%),var(--bord2) 100%);
  border-radius:99px;border:none;padding:0;outline:none;cursor:pointer;
}
.ord-range::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:hsl(0,0%,100%);border:2px solid var(--acc);transition:transform .1s}
.ord-range::-webkit-slider-thumb:hover{transform:scale(1.15)}
.ord-submit-btn{
  width:100%;padding:11px;border-radius:var(--r);background:var(--t1);color:hsl(0,0%,98%);
  font-family:'Plus Jakarta Sans','Noto Sans JP',sans-serif;font-size:13px;font-weight:600;
  border:none;cursor:pointer;transition:all .12s;letter-spacing:.2px;margin-top:6px;
}
.ord-submit-btn:hover{background:hsl(240,6%,15%)}
.ord-submit-btn:disabled{opacity:.3;cursor:not-allowed}
.ord-code-screen{display:flex;flex-direction:column;align-items:center;padding:28px 20px;text-align:center;gap:12px}
.ord-code-title{font-size:15px;font-weight:700;color:var(--t1)}
.ord-code-sub{font-size:12px;color:var(--t3);line-height:1.8}
.ord-code-box{
  background:var(--bg3);border:1px solid var(--bord);border-radius:var(--r);
  padding:11px 14px;font-size:11.5px;color:var(--t1);font-family:monospace;
  word-break:break-all;line-height:1.6;cursor:pointer;transition:border-color .12s;
  max-width:400px;width:100%;text-align:left;
}
.ord-code-box:hover{border-color:var(--bord2)}
.ord-code-hint{font-size:10.5px;color:var(--t4)}
.order-link-btn{
  display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:var(--r);
  background:hsl(0,0%,100%);border:1px solid var(--bord);color:var(--t2);
  font-size:11.5px;font-weight:500;cursor:pointer;transition:all .12s;width:100%;margin-top:7px;
}
.order-link-btn:hover{border-color:var(--bord2);color:var(--t1)}
.order-code-input-row{display:flex;gap:6px;margin-top:6px;width:100%}
.order-code-input-row input{
  flex:1;background:hsl(0,0%,100%);border:1px solid var(--bord);
  border-radius:var(--r-sm);color:var(--t1);font-family:monospace;font-size:11.5px;
  padding:7px 10px;outline:none;transition:border-color .12s;
}
.order-code-input-row input:focus{border-color:var(--acc)}
.order-code-input-row button{
  padding:7px 13px;border-radius:var(--r-sm);background:var(--t1);
  color:hsl(0,0%,98%);font-size:11.5px;font-weight:600;cursor:pointer;transition:all .12s;flex-shrink:0;
}
.order-code-input-row button:hover{background:hsl(240,6%,15%)}
.ord-recv-btn{font-size:10.5px;color:var(--t4);background:none;border:none;cursor:pointer;margin-top:4px;transition:color .12s;letter-spacing:.3px}
.ord-recv-btn:hover{color:var(--t2)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   PORTFOLIO
━━━━━━━━━━━━━━━━━━━━━━━ */
.pf-btn{font-size:10.5px;padding:3px 10px;border-radius:99px;border:1px solid var(--bord);background:hsl(0,0%,100%);color:var(--t3);cursor:pointer;transition:all .12s}
.pf-btn.on{background:var(--t1);color:hsl(0,0%,98%);border-color:var(--t1)}
.pf-grid-wrap{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--bord)}
.pf-card{display:flex;flex-direction:column;background:hsl(0,0%,100%);overflow:hidden;cursor:pointer;transition:background .12s}
.pf-card:hover{background:var(--bg2)}
.pf-thumb{height:120px;flex-shrink:0;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.pf-body{padding:7px 9px;display:flex;flex-direction:column;gap:3px;flex:1}
.pf-nm{font-size:11.5px;font-weight:700;color:var(--t1);line-height:1.3}
.pf-meta{font-size:10.5px;color:var(--t3);display:flex;gap:8px;align-items:center}
.pf-stars{color:var(--gold);font-size:10.5px;letter-spacing:1px}
.pf-tag{font-size:10px;padding:1px 7px;border-radius:99px;background:var(--bg3);color:var(--t3);font-weight:600;border:1px solid var(--bord)}
.pf-qual{display:flex;align-items:center;gap:5px;margin-top:2px}
.pf-qual-bar{flex:1;height:2px;background:var(--bg4);border-radius:99px}
.pf-qual-fill{height:100%;border-radius:99px;transition:width .5s}
.pf-comment{font-size:10px;color:var(--t2);font-style:italic;line-height:1.5;border-left:2px solid var(--bord2);padding-left:5px;margin-top:2px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.pf-year{font-size:10px;color:var(--t4);text-align:right;padding:5px 8px 3px}
.pf-year-label{font-size:10.5px;color:var(--t3);font-weight:700;letter-spacing:1.5px;padding:9px 13px 5px;background:var(--bg3);border-bottom:1px solid var(--bord)}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   WORLD STUDIOS
━━━━━━━━━━━━━━━━━━━━━━━ */
#pan-world{padding:0}
.world-map-area{
  position:relative;width:100%;
  background:linear-gradient(160deg,#0f172a 0%,#1e293b 100%);
  overflow:hidden;flex-shrink:0;
  aspect-ratio:2/1;/* 地図を正しい縦横比で表示 */
}
/* 都市グラフィックビューモーダル */
#world-city-modal{
  display:none;position:fixed;inset:0;z-index:600;
  background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
  align-items:center;justify-content:center;padding:20px;
}
#world-city-modal.open{display:flex}
#world-city-inner{
  background:hsl(0,0%,100%);border-radius:var(--r-lg);
  width:min(480px,100%);max-height:85vh;overflow-y:auto;
  display:flex;flex-direction:column;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
}
.city-modal-hdr{
  padding:14px 16px;border-bottom:1px solid var(--bord);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
}
.city-modal-title{font-size:15px;font-weight:700;color:var(--t1);display:flex;align-items:center;gap:8px}
.city-modal-close{background:none;border:1px solid var(--bord);border-radius:var(--r-sm);padding:3px 10px;cursor:pointer;font-size:11px;color:var(--t3)}
.city-canvas-wrap{background:#1a1a2e;flex-shrink:0}
.city-canvas-wrap canvas{display:block;width:100%;height:200px}
.city-info{padding:14px 16px;display:flex;flex-direction:column;gap:10px}
.city-stat-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.city-stat-box{background:var(--bg2);border-radius:var(--r);padding:8px 10px;text-align:center}
.city-stat-box .val{font-size:15px;font-weight:700;color:var(--t1)}
.city-stat-box .lbl{font-size:9px;color:var(--t4);margin-top:1px}
.city-staff-list{display:flex;flex-direction:column;gap:4px}
.city-staff-item{display:flex;align-items:center;gap:7px;font-size:11px;padding:4px 0;border-bottom:1px solid var(--bg3)}
.world-dot{
  position:absolute;width:8px;height:8px;border-radius:50%;
  background:var(--acc);border:1.5px solid rgba(255,255,255,.6);
  transform:translate(-50%,-50%);cursor:pointer;
  box-shadow:0 0 0 0 rgba(99,102,241,.4);
  animation:worldPulse 2.5s ease-in-out infinite;
}
.world-dot.inactive{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.2);animation:none;box-shadow:none}
.world-dot-label{
  position:absolute;font-size:8px;font-weight:700;color:rgba(255,255,255,.75);
  white-space:nowrap;transform:translateX(-50%);pointer-events:none;
  text-shadow:0 1px 3px rgba(0,0,0,.8);
}
@keyframes worldPulse{
  0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.5)}
  50%{box-shadow:0 0 0 6px rgba(99,102,241,0)}
}
.world-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--bord)}
.studio-card{
  background:hsl(0,0%,100%);padding:10px 13px;display:flex;flex-direction:column;gap:4px;
}
.studio-card.locked{background:var(--bg2);opacity:.5}
.studio-nm{font-size:12px;font-weight:700;color:var(--t1);display:flex;align-items:center;gap:5px}
.studio-ic{font-size:15px}
.studio-stat{display:flex;gap:8px;flex-wrap:wrap}
.studio-stat-item{font-size:10px;color:var(--t3);display:flex;flex-direction:column;gap:1px}
.studio-stat-val{font-size:11.5px;font-weight:700;color:var(--t1)}
.studio-unlock{font-size:10px;color:var(--t4);margin-top:2px;font-style:italic}
.world-hdr{padding:10px 14px 6px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bord)}
.map-hit:hover{background:rgba(255,255,255,0.08)!important}

/* ━━━━━━━━━━━━━━━━━━━━━━━
   MURMUR (TWEET LOG)
━━━━━━━━━━━━━━━━━━━━━━━ */
.murmur-item{
  display:flex;gap:10px;align-items:flex-start;
  padding:9px 0;border-bottom:1px solid var(--bg3);
}
.murmur-item:last-child{border-bottom:none}
.murmur-ic{font-size:22px;flex-shrink:0}
.murmur-body{flex:1}
.murmur-nm{font-size:11.5px;font-weight:700;color:var(--t1)}
.murmur-txt{font-size:12px;color:var(--t2);line-height:1.6}
.murmur-turn{font-size:10px;color:var(--t4);margin-top:2px}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   MOBILE — スマートフォン最適化 (max-width: 680px)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   MOBILE RESPONSIVE — スマートフォン最適化
   戦略:
   ① HUD → 2行レイアウト（上段:会社名+日付+フェーズ / 下段:stats横スクロール）
   ② オフィスビュー → デフォルト折りたたみ、タップで展開
   ③ ナビ → 左サイドバー非表示 → ボトムタブバー
   ④ タッチターゲット → 最小44px
   ⑤ テックツリー → 横スクロールコンテナ化
   ⑥ モーダル → ボトムシート
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

/* ─── ボトムナビ（PCでは非表示） ─────────────────────────── */
#mob-nav{display:none}

/* ─── モバイル専用UI（PCでは非表示） ───────────────────────── */
#mob-office-toggle{display:none}
.mob-only{display:none}
.pc-hidden{display:none}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   MOBILE  @media ≤ 680px
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
@media (max-width:680px){

/* ── ベース ──────────────────────────────────────────── */
html,body{font-size:15px;-webkit-text-size-adjust:100%}
*{-webkit-tap-highlight-color:transparent}
.pc-only{display:none !important}
.mob-only{display:flex !important}
.pc-hidden{display:flex !important}

/* ── HUD (mobile差分) ────────────────────────────────── */
#hud-row1{ padding:7px 12px;min-height:40px; }
#hud-row2{
  -webkit-overflow-scrolling:touch;
  padding:5px 12px;gap:5px;min-height:36px;
}
.hud-co{
  font-size:12.5px;font-weight:700;white-space:nowrap;
  flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;
  border-right:none;padding-right:0;
}
.hstats{flex-wrap:nowrap;gap:4px;flex-shrink:0}
.hs{
  flex-shrink:0;padding:4px 9px;font-size:12px;white-space:nowrap;
  border-radius:99px;min-height:28px;display:flex;align-items:center;gap:3px;
}
.hs-lbl{display:none}/* モバイルはラベル非表示 */
.hs-v{min-width:0;font-size:12.5px;font-weight:700}
.hdate{font-size:11.5px;padding:4px 9px;margin-left:auto;flex-shrink:0;border-radius:99px}
.hdate-day{display:none}
.hph{font-size:10.5px;padding:3px 9px;flex-shrink:0}
#btn-ai{flex-shrink:0;font-size:11px;padding:4px 9px;white-space:nowrap;border-radius:99px}

/* ── サイドナビ → モバイルで非表示 ─────────────────── */
#nav{display:none}

/* ── メインレイアウト ────────────────────────────────── */
#main{flex-direction:column}
#content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}

/* ── オフィスビュー ─────────────────────────────────── */
#owrap{
  height:0;min-height:0;max-height:none;
  border-bottom:none;transition:height .25s cubic-bezier(.4,0,.2,1);overflow:hidden;
}
#owrap.mob-open{border-bottom:1px solid var(--bord)}
/* resize active: transition off */
#owrap.mob-resizing{transition:none!important}
#owrap-handle{display:none}
/* Mobile resize handle */
#mob-resize-handle{
  display:none;
  position:absolute;bottom:0;left:0;right:0;height:24px;z-index:25;
  align-items:center;justify-content:center;cursor:ns-resize;
  background:linear-gradient(to top,rgba(0,0,0,.22),rgba(0,0,0,.03));
  gap:4px;
}
#mob-resize-handle::after{
  content:'';width:40px;height:4px;border-radius:99px;
  background:rgba(255,255,255,.6);
}
#mob-resize-handle::before{
  content:'↕';position:absolute;right:10px;
  font-size:11px;color:rgba(255,255,255,.6);
}
#owrap.mob-open #mob-resize-handle{display:flex}
/* サイズプリセットボタン */
#mob-size-btns{
  display:none;
  position:absolute;top:6px;left:50%;transform:translateX(-50%);
  z-index:20;gap:4px;
}
#owrap.mob-open #mob-size-btns{display:flex}
.mob-sz-btn{
  font-size:9.5px;font-weight:700;padding:2px 9px;border-radius:99px;
  background:rgba(255,255,255,.85);color:var(--t2);
  border:1px solid rgba(255,255,255,.6);cursor:pointer;
  backdrop-filter:blur(4px);letter-spacing:.3px;
  transition:background .1s;
}
.mob-sz-btn:active{background:rgba(255,255,255,1)}
#oc-zoom-ctrl{top:5px;right:8px}
.olb{font-size:9px;top:5px;left:8px;padding:2px 7px}

/* オフィストグルボタン */
#mob-office-toggle{
  display:flex;width:100%;
  background:hsl(0,0%,100%);border:none;border-bottom:1px solid var(--bord);
  padding:7px 14px;font-size:11.5px;color:var(--t3);font-weight:600;
  align-items:center;gap:6px;justify-content:center;
  cursor:pointer;flex-shrink:0;letter-spacing:.3px;
  transition:background .12s;-webkit-tap-highlight-color:transparent;
}
#mob-office-toggle:active{background:var(--bg3)}
#mob-office-toggle.open{color:var(--t2);border-bottom-color:var(--bord)}

/* ── パネルエリア ─────────────────────────────────────── */
#panels{
  flex:1;min-height:0;overflow-y:auto;
  padding:0 0 calc(64px + env(safe-area-inset-bottom,0px));
  -webkit-overflow-scrolling:touch;overscroll-behavior:contain;
}
.panel.on{padding:0}

/* ── ターンロウ sticky ─────────────────────────────── */
.trow{
  position:sticky;top:0;z-index:30;
  background:hsl(0,0%,100%);
  border-radius:0;margin:0 0 14px;padding:10px 14px;
  border-left:none;border-right:none;border-top:none;
  border-bottom:1px solid var(--bord);box-shadow:0 2px 8px rgba(0,0,0,.05);
}
.btn-turn{
  padding:12px 22px;font-size:14.5px;font-weight:700;
  min-width:112px;flex-shrink:0;min-height:48px;border-radius:var(--r);
}
.tinfo{font-size:12.5px}
.tinfo .hint{display:none}

/* ── セクション共通パディング ────────────────────────── */
.panel.on .sh{padding-left:14px;padding-right:14px}
#pan-dash.on .sh{padding-left:14px;padding-right:14px}
.wbar,.ibar{margin-left:14px;margin-right:14px;margin-top:8px}
#ai-banner{margin:0 14px 10px}

/* ── ダッシュ Stat Grid ─────────────────────────────── */
.dgrid{
  grid-template-columns:repeat(2,1fr);gap:7px;
  padding:0 14px;margin-bottom:12px;
}
.dc{padding:11px 12px;border-radius:var(--r-lg)}
.dc-v{font-size:19px}
.dc-l{font-size:9.5px}

/* ── アクティブ案件 ──────────────────────────────────── */
.ap{margin:0 14px 8px;padding:12px 14px}
.ap:last-child{margin-bottom:0}
.ap-pct{font-size:19px}
.ach{padding:9px 14px;font-size:13.5px;min-height:44px;min-width:44px;border-radius:var(--r)}
.apass{gap:7px;padding:0}

/* ── ゲームログ ──────────────────────────────────────── */
.log{margin:0 14px;font-size:12px;max-height:110px;line-height:1.9}

/* ── 受注コードUI ─────────────────────────────────────── */
#order-recv-panel{margin:8px 14px 4px}
.order-link-btn{min-height:46px;font-size:12.5px;border-radius:var(--r)}
.order-code-input-row input{font-size:13px;padding:11px 12px;min-height:46px}
.order-code-input-row button{min-height:46px;padding:11px 14px}

/* ── 案件カード ──────────────────────────────────────── */
.pcgrid{grid-template-columns:1fr;gap:9px;padding:0 14px}
.pc{padding:14px;border-radius:var(--r-lg)}
.btn-acc{min-height:46px;padding:11px 16px;font-size:13.5px;font-weight:700;border-radius:var(--r);flex-shrink:0}
.pc-f{margin-top:10px;padding-top:10px}
.pc-nm{font-size:13px}
.pc-cl{font-size:12px}
.pct{font-size:11.5px;padding:2px 9px}

/* ── 制作中パネル ────────────────────────────────────── */
#active-list{padding:0 14px}

/* ── 採用カード ──────────────────────────────────────── */
.hcgrid{grid-template-columns:1fr;gap:9px;padding:0 14px}
.hc{padding:14px;border-radius:var(--r-lg)}
.btn-hire{min-height:46px;padding:11px 16px;font-size:13.5px;font-weight:700;border-radius:var(--r)}
.hc-f{margin-top:10px;padding-top:10px}
.hc-n{font-size:13.5px}
.srow{font-size:12px}
.sl{font-size:11px;width:46px}
.sb{height:4px}
.sn{font-size:11.5px}

/* ── スタッフカード ──────────────────────────────────── */
.scgrid{grid-template-columns:1fr;gap:9px;padding:0 14px}
.sc{padding:14px;border-radius:var(--r-lg)}
.btn-fir{min-height:42px;padding:9px 14px;font-size:12.5px;border-radius:var(--r)}
.sc-f{margin-top:10px;padding-top:10px}
.sc-n{font-size:13px}
.sc-r{font-size:11.5px}
.sc-bar{font-size:11.5px;gap:8px}
.sc-bar-bg{height:4px}

/* ── テックツリー ──────────────────────────────────── */
#pan-tech .sh{padding-left:14px}
#tech-tree{padding:0 14px}
.tech-row{
  flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;
  scrollbar-width:none;padding-bottom:8px;gap:8px;padding-left:2px;
}
.tech-row::-webkit-scrollbar{display:none}
.tn{min-width:92px;flex-shrink:0;padding:11px 10px;border-radius:var(--r-lg)}
.tn-ic{font-size:21px}
.tn-nm{font-size:11.5px}
.tn-co{font-size:10.5px}
.tn-st{font-size:10px}
.tt-sec{margin-bottom:16px}
.tt-sec-title{cursor:pointer;-webkit-tap-highlight-color:transparent}
.tt-sec-title::after{content:' ▾';font-size:9px;color:var(--t4)}

/* ── フェーズ進行 ─────────────────────────────────── */
#pan-prog .sh{padding-left:14px}
.phases{gap:6px;flex-wrap:wrap;padding:0 14px;margin-bottom:12px}
.ph{min-width:calc(50% - 3px);flex:none;padding:10px 9px;border-radius:var(--r-lg)}
.ph-n{font-size:21px}
.ph-nm{font-size:11.5px}
.ph-s{font-size:10.5px}
.ofgrid{grid-template-columns:1fr 1fr;gap:7px;padding:0 14px;margin-bottom:12px}
.ofc{padding:11px}
.btn-up{min-height:38px;padding:7px 11px;font-size:12.5px;border-radius:var(--r-sm)}
.statbox{grid-template-columns:1fr 1fr;padding:14px;margin:0 14px}
.si{font-size:12px;padding:5px 0}

/* ── ログ ────────────────────────────────────────────── */
#glog{margin:0 14px}

/* ── AI ──────────────────────────────────────────────── */
#pan-ai{padding:0 14px}
.ai-dash-header{flex-wrap:wrap;gap:10px;padding:12px 14px}
.ai-toggle-big{margin-left:0;width:100%;justify-content:center;min-height:48px;display:flex;align-items:center;font-size:13px}
.ai-kpi-grid{grid-template-columns:repeat(2,1fr)}
.ai-kpi{padding:12px;border-radius:var(--r-lg)}
.ai-kpi-v{font-size:18px}
#ai-banner{font-size:12px;padding:10px 14px}
#ai-banner br{display:none}

/* ── 警告バー ─────────────────────────────────────────── */
.wbar,.ibar{font-size:12.5px;padding:8px 14px;border-radius:var(--r)}

/* ── セクションヘッダー ───────────────────────────────── */
.sh{font-size:10.5px;margin-bottom:10px;padding-bottom:7px}

/* ── ポートフォリオ ───────────────────────────────────── */
#pan-portfolio{padding:0}
.pf-nm{font-size:12px}
.pf-thumb{height:100px}
.pf-meta{font-size:11px}
.pf-comment{font-size:11px}
.pf-btn{font-size:11.5px;padding:4px 11px;min-height:30px}
#portfolio-filters{padding:4px 14px 8px;gap:5px}
#portfolio-list{max-height:calc(100vh - 180px)}
.api-key-bar{flex-wrap:wrap;padding:8px 14px;gap:6px}

/* ── 呟き ─────────────────────────────────────────────── */
#pan-murmur{padding:0 14px}
#murmur-log{max-height:calc(100vh - 180px)}
.murmur-item{padding:10px 0}
.murmur-ic{font-size:24px}
.murmur-nm{font-size:12px}
.murmur-txt{font-size:13px}
.murmur-turn{font-size:11px}

/* ── モーダル → ボトムシート ─────────────────────────── */
.mbg{align-items:flex-end;padding:0}
.mbox{
  max-width:100%;border-radius:20px 20px 0 0;
  padding:20px 16px calc(20px + env(safe-area-inset-bottom,0px));
  max-height:88vh;overflow-y:auto;
  animation:mob-sheet-in .22s cubic-bezier(.32,0,.67,0);
  background-image:linear-gradient(var(--bord),var(--bord));
  background-size:36px 3px;background-repeat:no-repeat;background-position:center 10px;
}
@keyframes mob-sheet-in{
  from{transform:translateY(25%);opacity:.7}
  to{transform:translateY(0);opacity:1}
}
.mch{padding:14px;min-height:52px;font-size:14px;border-radius:var(--r-lg)}
.btn-ok{min-height:52px;font-size:14px;border-radius:var(--r-lg)}
.mds{font-size:13px}
.mtt{font-size:16px}
.mic{font-size:42px}

/* ── 通知パネル ───────────────────────────────────────── */
/* #notif-panel モバイル上書き不要 */

/* ── タイトル画面 ─────────────────────────────────────── */
#SCR_TITLE{padding:24px 20px;gap:18px}
#tcv{width:min(260px,80vw);height:auto}
.t-btn{width:220px;min-height:52px;font-size:14.5px;display:flex;align-items:center;justify-content:center;border-radius:var(--r-lg)}
.t-logo{font-size:clamp(16px,5vw,22px)}

/* ── エンド画面 ───────────────────────────────────────── */
.end-st{grid-template-columns:1fr;max-width:100%;margin:0 16px 20px}
.btn-re{width:100%;min-height:52px;font-size:14px}

/* ── オーダー ─────────────────────────────────────────── */
.ord-type-grid{grid-template-columns:repeat(3,1fr)}
.ord-type-btn{padding:11px 6px;min-height:72px}
.ord-type-ic{font-size:21px}
.ord-type-nm{font-size:11.5px}
.ord-submit-btn{min-height:52px;font-size:14px;border-radius:var(--r-lg)}

} /* end @media 680px */

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ボトムナビバー
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
@media (max-width:680px){
  #mob-nav{
    display:flex;
    position:fixed;bottom:0;left:0;right:0;z-index:200;
    background:rgba(255,255,255,.97);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    border-top:1px solid var(--bord);
    padding-bottom:env(safe-area-inset-bottom,0px);
    height:calc(58px + env(safe-area-inset-bottom,0px));
  }
}
/* ボトムナビアイテム */
.mnb{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:2px;padding:6px 0;
  font-size:21px;color:var(--t4);cursor:pointer;
  background:none;border:none;font-family:inherit;
  position:relative;-webkit-tap-highlight-color:transparent;
  transition:color .12s;min-width:0;min-height:44px;
}
.mnb span{font-size:9.5px;color:inherit;font-weight:600;letter-spacing:.2px;line-height:1.2;white-space:nowrap}
.mnb:active{background:var(--bg3);border-radius:var(--r)}
/* アクティブ状態 — ピルインジケーター */
.mnb.on{color:var(--t1)}
.mnb.on::before{
  content:'';
  position:absolute;top:4px;
  left:50%;transform:translateX(-50%);
  width:28px;height:3px;
  background:var(--t1);border-radius:99px;
}
.mnb .mbadge{
  position:absolute;top:3px;
  right:calc(50% - 18px);
  background:var(--red);color:hsl(0,0%,98%);
  font-size:7.5px;min-width:14px;height:14px;
  padding:0 3px;border-radius:99px;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;border:2px solid hsl(0,0%,100%);line-height:1;
}

/* ── もっと見るドロワー ───────────────────────────────── */
#mob-more-drawer{
  display:none;position:fixed;
  bottom:calc(58px + env(safe-area-inset-bottom,0px));
  left:0;right:0;z-index:199;
  background:hsl(0,0%,100%);
  border-top:1px solid var(--bord);
  padding:12px 14px 14px;
  box-shadow:0 -8px 30px rgba(0,0,0,.12);
  border-radius:16px 16px 0 0;
}
#mob-more-drawer.open{display:block;animation:drawer-up .2s ease}
@keyframes drawer-up{from{transform:translateY(12px);opacity:.7}to{transform:translateY(0);opacity:1}}
/* ドロワーのハンドルバー */
#mob-more-drawer::before{
  content:'';display:block;
  width:36px;height:3px;background:var(--bg4);
  border-radius:99px;margin:0 auto 12px;
}
.mob-drawer-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.mob-drawer-item{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:10px 4px;border-radius:var(--r-lg);cursor:pointer;
  font-size:22px;background:none;border:none;font-family:inherit;
  -webkit-tap-highlight-color:transparent;transition:background .1s;
  min-height:62px;justify-content:center;
}
.mob-drawer-item:active{background:var(--bg3)}
.mob-drawer-item span{font-size:10.5px;color:var(--t3);font-weight:600}
.mob-drawer-item.on{background:var(--bg3)}
.mob-drawer-item.on span{color:var(--t1)}
#mob-more-overlay{
  display:none;position:fixed;inset:0;z-index:198;
  background:rgba(0,0,0,.25);backdrop-filter:blur(1px);
}
#mob-more-overlay.open{display:block}


</style>
</head>
<body>
<canvas id="ptcl-canvas" width="400" height="700"></canvas>

<div id="SCR_LOAD">
  <div style="font-size:12px;color:var(--acc);letter-spacing:3px;font-weight:700;font-family:'Noto Sans JP',sans-serif">デザイン会社発展国</div>
  <div class="ld-bar"><div class="ld-f"></div></div>
  <div style="font-size:10px;color:var(--t3);letter-spacing:3px;animation:blink 1s step-end infinite">LOADING...</div>
</div>

<div id="SCR_TITLE" style="display:none">
  <canvas id="tcv" width="290" height="163"></canvas>
  <div class="t-logo">デザイン会社発展国<br><span>Design Company Simulator</span></div>
  <div style="font-size:9px;color:var(--t4);letter-spacing:2px">全デザイナーに捧げる  Ver 2.0</div>
  <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
    <button class="t-btn" onclick="G.newGame()">▶ NEW GAME</button>
    <button class="t-btn sec" onclick="G.load()">　CONTINUE　</button>
    <button class="t-btn sec" onclick="G.howto()">　HOW TO PLAY　</button>
  </div>
  <button class="ord-recv-btn" onclick="G.ord.openFromTitle()">📨 受注コードを受け取る</button>
  <div class="t-blink">PRESS TO START</div>
</div>

<div id="GAME">
  <div id="hud">
    <!-- 上段: 会社名 / 日付 / フェーズ / AIボタン -->
    <div id="hud-row1">
      <div class="hud-co" id="hco">個人事務所</div>
      <div class="hdate" id="hdate">📅 <span id="hdate-main">2025年4月</span> <span class="hdate-day" id="hdate-day">第1週</span></div>
      <div class="hph" id="hph">PHASE 0</div>
      <button id="btn-ai" onclick="G.toggleAI()"><span class="ai-dot" style="display:none"></span>🤖 AI</button>
      <button class="btn-turn pc-only" id="btn-turn-hud" onclick="G.nextTurn()" style="margin-left:4px">▶ 次の週へ</button>
      <!-- 通知ベルボタン（PC/スマホ共通） -->
      <div id="notif-wrap" style="position:relative;margin-left:auto;flex-shrink:0">
        <button id="notif-btn" onclick="G.toggleNotif()">🔔<span id="notif-badge">0</span></button>
        <div id="notif-panel">
          <div id="notif-hdr">
            <span>🔔 通知</span>
            <button onclick="G.clearNotif()" style="background:none;border:none;font-size:10px;color:var(--t4);cursor:pointer;padding:0">すべてクリア</button>
          </div>
          <div id="notif-list"><div class="empty">通知はありません</div></div>
        </div>
      </div>
    </div>
    <!-- 下段: stats（モバイルでは横スクロール）-->
    <div id="hud-row2">
      <div class="hstats">
        <div class="hs" title="資金">💰 <span class="hs-lbl">資金</span><span class="hs-v g" id="hmoney">¥38K</span></div>
        <div class="hs" title="評判">⭐ <span class="hs-lbl">評判</span><span class="hs-v tl" id="hrep">12</span></div>
        <div class="hs" title="炎上">🔥 <span class="hs-v r" id="hfire">0</span><span class="hs-lbl">%</span></div>
        <div class="hs" title="SNS">📢 <span class="hs-lbl">SNS</span><span class="hs-v p" id="hsns">84</span></div>
        <div class="hs" title="社員">👥 <span class="hs-v" id="hstaff">1</span><span class="hs-lbl">名</span></div>
        <div class="hs" title="ブラック">😈 <span class="hs-lbl">BK</span><span class="hs-v" id="hblack">5</span><span class="hs-lbl">%</span></div>
        <div class="hs" title="ウェルビーイング">🌿 <span class="hs-lbl">WB</span><span class="hs-v" id="hwb" style="color:#22c55e">50</span></div>
        <div class="hs" id="hdau-wrap" style="display:none" title="DAU">📱 <span class="hs-lbl">DAU</span><span class="hs-v" style="color:#00d4aa" id="hdau">--</span></div>
        <div class="hs" id="harr-wrap" style="display:none" title="ARR">💹 <span class="hs-lbl">ARR</span><span class="hs-v" style="color:#6366f1" id="harr">--</span></div>
      </div>
    </div>
  </div>
  <div id="main">
    <div id="nav">
      <button class="nb on" id="nb-dash"   onclick="G.tab('dash')">🏠<span>HOME</span></button>
      <button class="nb"    id="nb-proj"   onclick="G.tab('proj')">📋<span>案件</span><span class="nbadge" id="bdg-proj">0</span></button>
      <button class="nb"    id="nb-active" onclick="G.tab('active')">⚙️<span>制作</span></button>
      <div class="nsep"></div>
      <button class="nb"    id="nb-staff"  onclick="G.tab('staff')">👥<span>社員</span></button>
      <button class="nb"    id="nb-hire"   onclick="G.tab('hire')">📌<span>採用</span></button>
      <div class="nsep"></div>
      <button class="nb"    id="nb-tech"   onclick="G.tab('tech')">🔬<span>技術</span></button>
      <button class="nb"    id="nb-prog"   onclick="G.tab('prog')">📈<span>成長</span></button>
      <button class="nb"    id="nb-policy" onclick="G.tab('policy')">🌿<span>制度</span></button>
      <div class="nsep"></div>
      <button class="nb" id="nb-ai" onclick="G.tab('ai')">🤖<span>AI</span></button>
      <button class="nb" id="nb-world" onclick="G.tab('world')">🌍<span>拠点</span></button>
      <button class="nb" id="nb-murmur" onclick="G.tab('murmur')">💬<span>呟き</span><span class="nbadge" id="bdg-murmur" style="display:none">new</span></button>
      <button class="nb" id="nb-portfolio" onclick="G.tab('portfolio')">🖼️<span>作品集</span><span class="nbadge" id="bdg-portfolio" style="display:none">0</span></button>
      <div class="nsep" style="margin-top:auto"></div>
      <button class="nb" id="nb-order" onclick="G.ord.open()" title="オーダー受付" style="color:var(--acc);position:relative">📨<span>ORDER</span><span style="position:absolute;top:4px;right:4px;width:5px;height:5px;border-radius:50%;background:var(--acc);animation:pulse2 2s ease-in-out infinite"></span></button>
      <button class="nb" onclick="G.save()" title="セーブ" style="font-size:15px">💾<span>保存</span></button>
    </div>
    <div id="content">
      <div id="owrap">
  <canvas id="ocv"></canvas>
  <div class="olb" id="olb">COWORKING SPACE</div>
  <div id="oc-zoom-ctrl">
    <button class="oc-zoom-btn" onclick="G.zoomOC(-1)" title="縮小">－</button>
    <span id="oc-zoom-val">100%</span>
    <button class="oc-zoom-btn" onclick="G.zoomOC(1)" title="拡大">＋</button>
  </div>
  <div class="otm" id="otm"></div>
  <div id="ai-overlay"></div>
  <div id="ai-status"><span class="st-dot"></span><span id="ai-status-txt">AI AGENT 稼働中</span></div>
  <div id="turn-progress">
    <div id="tp-bar"></div>
    <div id="tp-txt">週を進めてください</div>
  </div>

  <div id="owrap-handle" title="ドラッグして高さ調整"></div>
  <div id="mob-resize-handle" title="ドラッグして高さ調整"></div>
  <div id="mob-size-btns">
    <button class="mob-sz-btn" onclick="G.setMobOfficeH(160)">S</button>
    <button class="mob-sz-btn" onclick="G.setMobOfficeH(260)">M</button>
    <button class="mob-sz-btn" onclick="G.setMobOfficeH(380)">L</button>
  </div>

</div>
      <!-- モバイル: オフィストグルボタン -->
      <button id="mob-office-toggle" onclick="G.mobToggleOffice()">
        <span id="mob-office-toggle-ic">🏢</span> <span id="mob-office-toggle-txt">オフィスを見る</span>
      </button>
      <div id="panels">
        <div class="panel on" id="pan-dash">
          <div class="wbar" id="wb-fire">⚠ 炎上メーターが危険域です！</div>
          <div class="ibar" id="wb-money">💰 資金が少なくなっています！</div>
          <div id="ai-banner">
            <strong>🤖 AI経営エージェント稼働中</strong> ─ 受注・採用・アサインを全て自動で処理します。<br>
            あなたがすべきことは <strong>週を進めること</strong> だけです。
          </div>
          <div class="trow pc-hidden">
            <div class="tinfo" id="tinfo"></div>
            <button class="btn-turn" id="btn-turn" onclick="G.nextTurn()">▶ 次の週へ</button>
          </div>
          <div class="sh">会社ステータス</div>
          <div class="dgrid" id="dgrid"></div>
          <div class="sh">進行中の案件 <span class="ct" id="dash-cnt"></span></div>
          <div id="dash-ap"></div>
          <!-- 受注コードUI -->
          <div id="order-recv-panel" style="margin:8px 0 4px">
            <button class="order-link-btn" onclick="G.ord.toggleRecv()">
              🔗 <span>オーダーを受け付ける / 受注コードを入力</span>
            </button>
            <div id="order-recv-form" style="display:none;margin-top:6px">
              <div style="font-size:10px;color:var(--t3);margin-bottom:4px">受注コードを貼り付けてください：</div>
              <div class="order-code-input-row">
                <input type="text" id="order-code-input" placeholder="DCFK-XXXXXXXX-..." autocomplete="off">
                <button onclick="G.ord.receiveCode()">受け取る</button>
              </div>
              <div style="margin-top:6px;font-size:10px;color:var(--t4)">
                または
                <button onclick="G.ord.openOrderPage()" style="background:none;border:none;color:var(--acc);font-size:10px;cursor:pointer;padding:0;font-family:inherit;font-weight:700;">
                  🌐 オーダーページを開く（クライアントに共有）
                </button>
              </div>
            </div>
          </div>
          <div class="sh" style="margin-top:9px">ゲームログ</div>
          <div class="log" id="glog"></div>
        </div>
        <div class="panel" id="pan-proj">
          <div class="sh">受注可能な案件 <span class="ct" id="proj-hint"></span></div>
          <div class="pcgrid" id="proj-list"></div>
        </div>
        <div class="panel" id="pan-active">
          <div class="sh">制作中の案件</div>
          <div id="active-list"></div>
        </div>
        <div class="panel" id="pan-staff">
          <div class="sh">社員一覧 <span class="ct" id="staff-cnt"></span></div>
          <div id="staff-list"></div>
        </div>
        <div class="panel" id="pan-hire">
          <div class="sh">求人候補</div>
          <div class="hcgrid" id="hire-list"></div>
        </div>
        <div class="panel" id="pan-tech">
          <div class="sh">技術ツリー</div>
          <p style="font-size:11px;color:var(--t3);margin:0 14px 10px;line-height:1.7">技術習得で受注範囲・品質・単価が向上。クリックで習得。</p>
          <div id="tech-tree"></div>
        </div>
        <div class="panel" id="pan-ai">
          <div class="ai-dash-header">
            <div class="ai-avatar">🤖</div>
            <div>
              <div class="ai-dash-title" id="ai-dash-title">AI経営エージェント</div>
              <div class="ai-dash-sub" id="ai-dash-sub">
                受注・アサイン・採用・技術習得・オフィス移転を<br>
                全自動で最適判断します。あなたは働くだけ。
              </div>
            </div>
            <button class="ai-toggle-big" id="ai-toggle-big" onclick="G.toggleAI()">🤖 AIモード ON</button>
            <div id="ai-speed-ctrl" style="display:none;margin-top:8px;display:none">
              <div style="font-size:9px;color:var(--t3);text-align:center;margin-bottom:5px;letter-spacing:1px">AUTO SPEED</div>
              <div style="display:flex;gap:4px;justify-content:center">
                <button class="ai-spd-btn on" id="spd-1" onclick="G.setAISpeed(1)">×1</button>
                <button class="ai-spd-btn" id="spd-2" onclick="G.setAISpeed(2)">×2</button>
                <button class="ai-spd-btn" id="spd-4" onclick="G.setAISpeed(4)">×4</button>
              </div>
            </div>
          </div>
          <div class="sh">AI経営指標</div>
          <div class="ai-kpi-grid" id="ai-kpi-grid"></div>
          <div class="sh" id="ai-live-sh" style="display:none">AI ライブ判断 <span style="font-size:8px;color:var(--ok);letter-spacing:1px">● LIVE</span></div>
          <div id="ai-live-feed" style="display:none;flex-direction:column;overflow-y:auto;max-height:180px;border:1px solid var(--bord2);border-radius:6px;margin-bottom:10px"></div>
          <div class="sh">AI決定ログ <span class="ct" id="ai-log-cnt"></span></div>
          <div class="ai-log-panel" id="ai-action-log">
            <div class="empty">AIモードをONにするとここに経営判断が記録されます</div>
          </div>
        </div>
        <div class="panel" id="pan-prog">
          <div class="sh">フェーズ進行</div>
          <div class="phases" id="phases"></div>
          <div class="sh">オフィス</div>
          <div class="ofgrid" id="of-cards"></div>
          <div class="sh">統計</div>
          <div class="statbox" id="statbox"></div>
        </div>
        <div class="panel" id="pan-portfolio">
          <div class="sh">作品集 <span class="ct" id="portfolio-cnt"></span></div>
          <!-- APIキー設定 -->
          <div class="api-key-bar" id="api-key-bar">
            <span style="font-size:7px;color:var(--t3);flex-shrink:0">🤖 AI生成:</span>
            <input class="api-key-input" id="api-key-input" type="password"
              placeholder="Anthropic APIキーを入力（sk-ant-...）" autocomplete="off">
            <button class="api-key-save-btn" onclick="G.aiDesign.saveKey()">保存</button>
            <span class="api-key-status" id="api-key-status">未設定</span>
          </div>
          <div style="font-size:11px;color:var(--t3);padding:4px 14px 10px;line-height:1.8">完了した案件の成果物。APIキー設定でリアルSVGが自動生成されます。</div>
          <div style="padding:0 4px 4px;display:flex;gap:4px;flex-wrap:wrap" id="portfolio-filters">
            <button onclick="G.portfolioFilter='all';G.renderPortfolio();" class="pf-btn on" id="pf-all">すべて</button>
            <button onclick="G.portfolioFilter='print';G.renderPortfolio();" class="pf-btn" id="pf-print">🖨 印刷</button>
            <button onclick="G.portfolioFilter='app';G.renderPortfolio();" class="pf-btn" id="pf-app">📱 アプリ</button>
            <button onclick="G.portfolioFilter='web';G.renderPortfolio();" class="pf-btn" id="pf-web">🌐 Web</button>
            <button onclick="G.portfolioFilter='brand';G.renderPortfolio();" class="pf-btn" id="pf-brand">💎 ブランド</button>
            <button onclick="G.portfolioFilter='saas';G.renderPortfolio();" class="pf-btn" id="pf-saas">🚀 プロダクト</button>
            <button onclick="G.portfolioFilter='mj';G.renderPortfolio();" class="pf-btn" id="pf-mj">🎨 MJ対応</button>
          </div>
          <div style="padding:0 4px 8px">
            <a href="order.html" target="_blank" style="font-size:9px;color:var(--acc);text-decoration:none;display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid rgba(99,102,241,0.3);border-radius:100px">🔗 外部オーダーページを開く</a>
          </div>
          <div id="portfolio-list" style="display:flex;flex-direction:column;gap:1px;overflow-y:auto;max-height:calc(100vh - 200px)"></div>
        </div>
        <div class="panel" id="pan-policy"></div>
        <div class="panel" id="pan-world"></div>
        <div class="panel" id="pan-murmur">
          <div class="sh">社員の呟き <span class="ct" id="murmur-cnt"></span></div>
          <div style="font-size:11px;color:var(--t3);padding:4px 14px 10px;line-height:1.8">
            社員たちのリアルな本音。キャンバスビューに時々表示されます。
          </div>
          <div id="murmur-log" style="overflow-y:auto;max-height:calc(100vh - 180px);background:hsl(0,0%,100%);border:1px solid var(--bord);border-radius:var(--r-lg);padding:0 12px">
            <div class="empty">まだ誰も呟いていません</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ━━━ モバイル ボトムタブバー ━━━ -->
<nav id="mob-nav">
  <button class="mnb on" id="mnb-dash" onclick="G.tab('dash')">🏠<span>HOME</span></button>
  <button class="mnb" id="mnb-proj" onclick="G.tab('proj')">📋<span>案件</span><span class="mbadge" id="mbdg-proj" style="display:none">0</span></button>
  <button class="mnb" id="mnb-active" onclick="G.tab('active')">⚙️<span>制作</span></button>
  <button class="mnb" id="mnb-hire" onclick="G.tab('hire')">📌<span>採用</span></button>
  <button class="mnb" id="mnb-more" onclick="G.mobToggleMore()">☰<span>もっと</span></button>
</nav>

<!-- ━━━ もっと見るドロワー ━━━ -->
<div id="mob-more-overlay" onclick="G.mobCloseMore()"></div>
<div id="mob-more-drawer">
  <div class="mob-drawer-grid">
    <button class="mob-drawer-item" data-tab="staff" onclick="G.tab('staff');G.mobCloseMore()">👥<span>社員</span></button>
    <button class="mob-drawer-item" data-tab="tech" onclick="G.tab('tech');G.mobCloseMore()">🔬<span>技術</span></button>
    <button class="mob-drawer-item" data-tab="prog" onclick="G.tab('prog');G.mobCloseMore()">📈<span>成長</span></button>
    <button class="mob-drawer-item" data-tab="ai" onclick="G.tab('ai');G.mobCloseMore()">🤖<span>AI</span></button>
    <button class="mob-drawer-item" data-tab="murmur" onclick="G.tab('murmur');G.mobCloseMore()">💬<span>呟き</span></button>
    <button class="mob-drawer-item" data-tab="portfolio" onclick="G.tab('portfolio');G.mobCloseMore()">🖼️<span>作品集</span></button>
    <button class="mob-drawer-item" data-tab="policy" onclick="G.tab('policy');G.mobCloseMore()">🌿<span>制度</span></button>
    <button class="mob-drawer-item" data-tab="world" onclick="G.tab('world');G.mobCloseMore()">🌍<span>拠点</span></button>
    <button class="mob-drawer-item" onclick="G.ord.open();G.mobCloseMore()">📨<span>ORDER</span></button>
    <button class="mob-drawer-item" onclick="G.save();G.mobCloseMore()">💾<span>保存</span></button>
  </div>
</div>

<div class="mbg" id="modal-ev"><div class="mbox" id="mbox-ev"><span class="mic" id="mev-ic"></span><div class="mtt" id="mev-tt"></div><div class="mds" id="mev-ds"></div><div class="mch-list" id="mev-ch"></div></div></div>
<div class="mbg" id="modal-mod"><div class="mbox danger"><div style="font-size:9px;color:var(--red);letter-spacing:2px;text-align:center;margin-bottom:5px">修正依頼 <span id="mod-cnt">第1回</span></div><div class="mic" id="mod-face">😤</div><div class="mtt" style="color:var(--red);font-size:13px" id="mod-pn"></div><div class="mds" id="mod-tx"></div><div class="mch-list" id="mod-ch"></div></div></div>
<div class="mbg" id="modal-rev"><div class="mbox rev-box"><div class="mtt" style="color:var(--gold)">📬 納品完了！クライアント評価</div><div class="rev-st" id="rev-st"></div><div class="rev-cm" id="rev-cm"></div><div class="rev-ef" id="rev-ef"></div><button class="btn-ok" id="btn-ok-rev">　OK　</button></div></div>
<!-- A4レポートモーダル -->
<div id="end-report-modal" onclick="if(event.target===this)document.getElementById('end-report-modal').classList.remove('open')">
  <div id="end-report-inner">
    <button class="report-close" onclick="document.getElementById('end-report-modal').classList.remove('open')">✕</button>
    <canvas id="report-cv"></canvas>
    <button class="report-dl-btn" onclick="G.downloadReport()">⬇ レポートをダウンロード (PNG)</button>
  </div>
</div>

<div id="SCR_END">
  <!-- ヒーロー部 -->
  <div class="end-hero" id="end-hero">
    <div class="end-sub" id="end-phase-label">GAME OVER</div>
    <div class="end-t" id="end-t"></div>
    <div class="end-s" id="end-s"></div>
  </div>

  <!-- 詳細レポート -->
  <div class="end-report">
    <!-- スコアカード -->
    <div class="end-scorecard" id="end-scorecard"></div>

    <!-- チャート -->
    <div class="end-charts">
      <div class="end-chart-card">
        <div class="end-chart-title">📈 売上推移</div>
        <canvas class="end-chart-cv" id="chart-rev" height="80"></canvas>
      </div>
      <div class="end-chart-card">
        <div class="end-chart-title">📊 評判 / 炎上 / WB</div>
        <canvas class="end-chart-cv" id="chart-kpi" height="80"></canvas>
      </div>
    </div>

    <!-- フェーズタイムライン -->
    <div class="end-timeline">
      <div class="end-timeline-title">🗓 会社の歩み</div>
      <div id="end-tl"></div>
    </div>

    <!-- コンサルタントアドバイス -->
    <div class="end-consult" id="end-consult"></div>

    <!-- シェア & リスタート -->
    <div class="end-share-row">
      <button class="end-share-btn share-x" onclick="G.shareX()">𝕏 結果をシェア</button>
      <button class="end-share-btn share-img" onclick="G.generateReport()">📄 レポートを生成</button>
      <button class="btn-re" onclick="G.restart()">▶ もう一周やる</button>
    </div>
  </div>
</div>

<!-- ═══ SVGビューワー ═══ -->
<div id="modal-svg-view" onclick="if(event.target===this)G.aiDesign.closeViewer()">
  <div class="svg-view-box">
    <div class="svg-view-header">
      <span class="svg-view-title" id="svg-view-title">作品を表示</span>
      <button class="svg-view-close" onclick="G.aiDesign.closeViewer()">✕ 閉じる</button>
    </div>
    <div class="svg-view-content" id="svg-view-content">
      <!-- SVGがここに挿入される -->
    </div>
    <div class="svg-view-footer">
      <span id="svg-view-meta"></span>
      <button class="svg-dl-btn" onclick="G.aiDesign.downloadSVG()">⬇ SVGをダウンロード</button>
    </div>
  </div>
</div>

<!-- ═══ オーダー受付画面 ═══ -->
<div id="world-city-modal" onclick="if(event.target===this)G.closeWorldCity()">
  <div id="world-city-inner">
    <div class="city-modal-hdr">
      <div class="city-modal-title" id="city-modal-title">📍 城市</div>
      <button class="city-modal-close" onclick="G.closeWorldCity()">✕ 閉じる</button>
    </div>
    <div class="city-canvas-wrap"><canvas id="city-cv" width="480" height="200"></canvas></div>
    <div class="city-info" id="city-modal-info"></div>
  </div>
</div>
<div id="SCR_ORDER">
  <div class="ord-header">
    <div class="ord-logo">
      <div class="ord-logo-dot"></div>
      <span id="ord-company-name">デザイン会社</span> ─ ORDER
    </div>
    <button class="ord-close-btn" onclick="G.closeOrder()">✕ 閉じる</button>
  </div>

  <!-- フォーム画面 -->
  <div class="ord-body" id="ord-form-area">
    <div style="margin-bottom:16px">
      <div class="ord-title" id="ord-form-title">📋 デザインをオーダーする</div>
      <div class="ord-sub" id="ord-form-sub">このフォームに記入して送信すると、デザイン会社に案件として届きます。</div>
    </div>
    <div class="ord-form-grid">

      <div class="ord-group">
        <div class="ord-label">お名前 <span class="req">*</span></div>
        <input class="ord-input" id="ord-name" type="text" placeholder="山田 太郎" autocomplete="off">
      </div>

      <div class="ord-group">
        <div class="ord-label">会社名 / 屋号</div>
        <input class="ord-input" id="ord-company" type="text" placeholder="株式会社〇〇（任意）">
      </div>

      <div class="ord-group">
        <div class="ord-label">依頼内容 <span class="req">*</span></div>
        <div class="ord-type-grid" id="ord-type-grid"></div>
      </div>

      <div class="ord-group">
        <div class="ord-label">予算（目安）</div>
        <div class="ord-budget-val" id="ord-budget-val">¥300,000</div>
        <input class="ord-range" id="ord-budget" type="range" min="0" max="20" value="5" step="1"
          oninput="G.ord.updateBudget(this.value)">
        <div style="display:flex;justify-content:space-between;margin-top:3px">
          <span style="font-size:9px;color:var(--t4)">¥30K〜</span>
          <span style="font-size:9px;color:var(--t4)">〜¥500M+</span>
        </div>
      </div>

      <div class="ord-group">
        <div class="ord-label">希望納期</div>
        <select class="ord-select" id="ord-deadline">
          <option value="7">急ぎ（1週間以内）</option>
          <option value="14" selected>2〜3週間</option>
          <option value="28">1ヶ月程度</option>
          <option value="21">相談して決めたい</option>
        </select>
      </div>

      <div class="ord-group">
        <div class="ord-label">プロジェクト詳細 <span class="req">*</span></div>
        <textarea class="ord-textarea" id="ord-desc"
          placeholder="どんなデザインが必要ですか？&#10;用途・ターゲット・参考イメージなど、できるだけ具体的に教えてください。"></textarea>
      </div>

      <button class="ord-submit-btn" id="ord-submit" onclick="G.ord.submit()">
        📤 オーダーを送信する
      </button>

    </div>
  </div>

  <!-- 受注コード発行画面 -->
  <div class="ord-body ord-code-screen" id="ord-code-area" style="display:none">
    <div style="font-size:34px">📨</div>
    <div class="ord-code-title">オーダーを受け付けました！</div>
    <div class="ord-code-sub">
      以下の「受注コード」をゲームプレイヤーに送ってください。<br>
      プレイヤーがゲーム内で入力すると、あなたの案件が届きます。
    </div>
    <div class="ord-code-box" id="ord-code-output" onclick="G.ord.copyCode()" title="クリックでコピー">
      （コードがここに表示されます）
    </div>
    <div class="ord-code-hint">👆 タップでコードをコピー</div>
    <div style="font-size:11px;color:var(--t4);line-height:1.9;margin-top:8px;max-width:300px;text-align:center">
      ゲームプレイヤーは<br>
      HOMEタブ →「受注コードを入力」から入力します
    </div>
  </div>
</div>
<div id="ai-log"></div>
<div id="notifs" style="display:none"></div>

<script>
'use strict';

// roundRect polyfill
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r||0,w/2,h/2);
    this.beginPath();this.moveTo(x+r,y);
    this.lineTo(x+w-r,y);this.quadraticCurveTo(x+w,y,x+w,y+r);
    this.lineTo(x+w,y+h-r);this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    this.lineTo(x+r,y+h);this.quadraticCurveTo(x,y+h,x,y+h-r);
    this.lineTo(x,y+r);this.quadraticCurveTo(x,y,x+r,y);
    this.closePath();
  };
}

// ─── AUDIO ───────────────────────────────────────────────────
var ac=null;
function initAC(){try{ac=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}
function beep(freq,type,dur,vol,delay){
  if(!ac)return;
  try{var o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);
    o.type=type||'sine';o.frequency.value=freq;var t=ac.currentTime+(delay||0);
    g.gain.setValueAtTime(vol||0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+dur);
    o.start(t);o.stop(t+dur);}catch(e){}}
var SFX={
  coin:function(){beep(880,'sine',.1,.1);beep(1320,'sine',.15,.08,.08);},
  good:function(){[440,550,660].forEach(function(f,i){beep(f,'square',.1,.05,i*.06);});},
  bad:function(){beep(200,'sawtooth',.3,.1);},
  ev:function(){beep(660,'sine',.05,.1);beep(440,'sine',.15,.08,.06);},
  lvup:function(){[440,550,660,880].forEach(function(f,i){beep(f,'sine',.2,.1,i*.08);});},
  click:function(){beep(600,'square',.04,.04);},
  alert:function(){beep(330,'sawtooth',.1,.08);beep(220,'sawtooth',.15,.08,.1);},
  fanfare:function(){[523,659,784,1047].forEach(function(f,i){beep(f,'sine',.4,.1,i*.1);});}
};

// ─── UTILS ───────────────────────────────────────────────────
function fY(n){var a=Math.abs(n),s=n<0?'-':'';if(a>=10000000)return s+(a/10000000).toFixed(1)+'千万円';if(a>=1000000)return s+Math.round(a/10000)+'万円';if(a>=10000)return s+(a/10000).toFixed(1)+'万円';return s+a.toLocaleString()+'円';}
function fM(n){return Math.abs(n)>=10000?Math.round(n/1000)+'K':n.toLocaleString();}
function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function pick(a){return a[Math.floor(Math.random()*a.length)];}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function shuffle(a){var b=a.slice();for(var i=b.length-1;i>0;i--){var j=ri(0,i);var t=b[i];b[i]=b[j];b[j]=t;}return b;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function q(id){return document.getElementById(id);}

// ─── NOTIFY ──────────────────────────────────────────────────
var _notifCount=0;
function notify(msg,type,dur){
  var list=q('notif-list');
  if(!list)return;
  // 「通知なし」プレースホルダを消す
  var empty=list.querySelector('.empty');if(empty)empty.remove();
  var now=new Date();
  var ts=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  var el=document.createElement('div');
  el.className='nf new-item '+(type||'');
  el.innerHTML='<div>'+msg+'</div><div class="nf-ts">'+ts+'</div>';
  list.insertBefore(el,list.firstChild);
  // new-item は3秒後に外す
  setTimeout(function(){el.classList.remove('new-item');},3000);
  // バッジ更新
  _notifCount++;
  var bdg=q('notif-badge');
  if(bdg){bdg.textContent=_notifCount>99?'99+':_notifCount;bdg.style.display='flex';}
  var btn=q('notif-btn');
  if(btn){btn.classList.add('has-new');setTimeout(function(){btn.classList.remove('has-new');},3000);}
  // danger は自動でパネルを開く
  if(type==='danger'){
    var panel=q('notif-panel');
    if(panel&&!panel.classList.contains('open'))panel.classList.add('open');
  }
  // 古いものを削除（50件上限）
  while(list.children.length>50){list.removeChild(list.lastChild);}
}
document.addEventListener('DOMContentLoaded',function(){
  // 外クリックでドロップダウンを閉じる
  document.addEventListener('click',function(e){
    var wrap=q('notif-wrap');
    if(wrap&&!wrap.contains(e.target)){
      var panel=q('notif-panel');
      if(panel)panel.classList.remove('open');
    }
  });

  // ── owrapリサイズ ──
  var handle=q('owrap-handle');
  if(handle){
    var wrap=q('owrap');
    var dragging=false,startY=0,startH=0;

    // localStorageから高さ復元
    var savedH=parseInt(localStorage.getItem('dcfk_owrap_h')||'0');
    if(savedH>=120&&savedH<=600&&wrap)wrap.style.height=savedH+'px';

    var onStart=function(e){
      dragging=true;
      startY=e.touches?e.touches[0].clientY:e.clientY;
      startH=wrap?wrap.offsetHeight:240;
      document.body.style.userSelect='none';
      e.preventDefault();
    };
    var onMove=function(e){
      if(!dragging||!wrap)return;
      var y=e.touches?e.touches[0].clientY:e.clientY;
      var newH=Math.min(600,Math.max(120,startH+(y-startY)));
      wrap.style.height=newH+'px';
      // canvasサイズも同期
      G.resizeOC();
      e.preventDefault();
    };
    var onEnd=function(){
      if(!dragging)return;
      dragging=false;
      document.body.style.userSelect='';
      if(wrap)localStorage.setItem('dcfk_owrap_h',wrap.offsetHeight);
    };
    handle.addEventListener('mousedown',onStart);
    handle.addEventListener('touchstart',onStart,{passive:false});
    document.addEventListener('mousemove',onMove);
    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('mouseup',onEnd);
    document.addEventListener('touchend',onEnd);
  }

  // ホイールでズーム
  var owrapEl=q('owrap');
  if(owrapEl){
    owrapEl.addEventListener('wheel',function(e){
      e.preventDefault();
      G.zoomOC(e.deltaY<0?1:-1);
    },{passive:false});
  }


  // ─── モバイルスワイプジェスチャー ───────────────────────────
  (function(){
    var panels=q('panels');if(!panels)return;
    var tabOrder=['dash','proj','active','hire','staff','tech','prog','ai','murmur','portfolio'];
    var sx=0,sy=0,st=0,sScrollY=0;
    panels.addEventListener('touchstart',function(e){
      sx=e.touches[0].clientX;sy=e.touches[0].clientY;
      st=Date.now();sScrollY=panels.scrollTop;
    },{passive:true});
    panels.addEventListener('touchend',function(e){
      if(G._mobResizing)return;// リサイズ中はスワイプ無効
      if(panels.scrollTop!==sScrollY)return;// スクロール中は無視
      var dx=e.changedTouches[0].clientX-sx;
      var dy=e.changedTouches[0].clientY-sy;
      var dt=Date.now()-st;
      if(dt>350||Math.abs(dy)>Math.abs(dx)*0.8||Math.abs(dx)<50)return;
      var ci=tabOrder.indexOf(G.curTab);if(ci<0)return;
      var ni=dx<0?ci+1:ci-1;
      if(ni>=0&&ni<tabOrder.length){
        G.tab(tabOrder[ni]);
        // ビジュアルフィードバック
        var cont=q('content');
        if(cont){
          cont.style.transition='opacity .1s';
          cont.style.opacity='0.85';
          setTimeout(function(){cont.style.opacity='1';},120);
        }
      }
    },{passive:true});
  })();

  // ─── モバイルオフィス縦幅リサイズ（PC版と同方式）─────────
  (function(){
    var mobHandle=q('mob-resize-handle');
    var wrap=q('owrap');
    if(!mobHandle||!wrap)return;
    var dragging=false,startY=0,startH=0;
    var onStart=function(e){
      if(!wrap.classList.contains('mob-open'))return;// 閉じてる時は無視
      dragging=true;
      G._mobResizing=true;
      startY=e.touches?e.touches[0].clientY:e.clientY;
      startH=wrap.offsetHeight;
      document.body.style.userSelect='none';
      if(e.cancelable)e.preventDefault();
    };
    var onMove=function(e){
      if(!dragging)return;
      var y=e.touches?e.touches[0].clientY:e.clientY;
      var newH=Math.min(520,Math.max(100,startH+(y-startY)));
      wrap.style.height=newH+'px';// PC版と同じく直接style設定
      G.resizeOC();// キャンバス即時同期
      if(e.cancelable)e.preventDefault();
    };
    var onEnd=function(){
      if(!dragging)return;
      dragging=false;
      G._mobResizing=false;
      document.body.style.userSelect='';
      var h=wrap.offsetHeight;
      G._savedMobOfficeH=h;
      localStorage.setItem('dcfk_mob_owrap_h',h);
    };
    mobHandle.addEventListener('touchstart',onStart,{passive:false});
    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('touchend',onEnd,{passive:true});
    // 保存済み高さを復元
    var saved=parseInt(localStorage.getItem('dcfk_mob_owrap_h')||'0');
    if(saved>=100&&saved<=520){
      G._savedMobOfficeH=saved;
    }
  })();

  // ?order パラメーターで直接オーダー画面を開く
  // クライアントへの共有URL: index.html?order
  var urlParams=new URLSearchParams(window.location.search);
  if(urlParams.has('order')){
    // ローディング完了後にオーダー画面を開く
    var openOrd=function(){
      if(q('SCR_ORDER')){
        // タイトル画面を非表示にして
        var scr=q('SCR_TITLE');if(scr)scr.style.display='none';
        G.ord.open();
      }else{setTimeout(openOrd,200);}
    };
    setTimeout(openOrd,1200);
  }
});

// ─── STATIC DATA ─────────────────────────────────────────────
var PTYPES=[
  // ── Phase 0: 個人事務所 ──────────────────────────
  {id:'logo',    lb:'ロゴ',           ic:'🔤',css:'logo', base:80000,   days:3, ph:0,sk:['design'],
   deliv:{files:['シンボルマーク AI/SVG','ロゴ横組み PDF','カラーパレット','使用ガイドライン PDF'],format:'AI/SVG/PDF',revs:2}},
  {id:'meishi',  lb:'名刺',           ic:'💳',css:'logo', base:30000,   days:2, ph:0,sk:['design'],
   deliv:{files:['名刺デザインデータ（表）','名刺デザインデータ（裏）','印刷入稿データ PDF'],format:'PDF/AI',revs:1}},
  {id:'banner',  lb:'バナー',         ic:'🖼️',css:'lp',   base:50000,   days:2, ph:0,sk:['design'],
   deliv:{files:['バナー PNG（各サイズ）','アニメGIF版','Webp最適化版'],format:'PNG/GIF/Webp',revs:2}},
  {id:'flyer',   lb:'フライヤー',     ic:'📄',css:'logo', base:45000,   days:3, ph:0,sk:['design'],
   deliv:{files:['フライヤーデータ（表）','フライヤーデータ（裏）','印刷入稿 PDF（トンボ付）'],format:'AI/PDF',revs:2}},
  {id:'icon',    lb:'アイコンセット', ic:'🎯',css:'logo', base:60000,   days:3, ph:0,sk:['design'],
   deliv:{files:['アイコン SVG一式','PNG（16/32/64/128/512px）','Figmaファイル'],format:'SVG/PNG/Figma',revs:2}},
  {id:'sns',     lb:'SNSデザイン',    ic:'📲',css:'lp',   base:70000,   days:3, ph:0,sk:['design'],
   deliv:{files:['プロフィール画像','カバー画像 各SNS対応','投稿テンプレート×5','ストーリーテンプレート×3'],format:'PNG/PSD',revs:2}},
  {id:'lp',      lb:'LP',            ic:'🖥️',css:'lp',   base:200000,  days:5, ph:0,sk:['design','ui'],
   deliv:{files:['デザインカンプ Figma','HTML/CSS コーディング','SP対応レスポンシブ','OGP画像'],format:'Figma/HTML',revs:3}},
  // ── Phase 1: デザイン事務所 ───────────────────────
  {id:'poster',  lb:'ポスター',       ic:'🎭',css:'logo', base:120000,  days:4, ph:1,sk:['design'],
   deliv:{files:['B2ポスター データ','A3版 データ','印刷入稿 PDF','デジタル配信用 JPG'],format:'AI/PDF/JPG',revs:2}},
  {id:'catalog', lb:'カタログ・冊子', ic:'📖',css:'lp',   base:350000,  days:8, ph:1,sk:['design','comm'],
   deliv:{files:['冊子デザイン全ページ','印刷入稿 PDF（面付け）','電子書籍用 PDF','表紙デザイン案×3'],format:'InDesign/PDF',revs:3}},
  {id:'package', lb:'パッケージ',     ic:'📦',css:'brand',base:380000,  days:9, ph:1,sk:['design','comm'],
   deliv:{files:['パッケージ展開図 データ','3Dモックアップ画像','ラベルデータ','印刷入稿 PDF'],format:'AI/PDF/PNG',revs:3}},
  {id:'photo',   lb:'フォトディレクション',ic:'📸',css:'lp',base:280000,days:5, ph:1,sk:['design','comm'],
   deliv:{files:['撮影ディレクション資料','セレクト写真 30枚（レタッチ済）','バナー用切り抜き素材','SNS用正方形クロップ'],format:'JPG/PNG',revs:2}},
  {id:'app',     lb:'アプリUI',       ic:'📱',css:'app',  base:800000,  days:10,ph:1,sk:['ui','logic'],
   deliv:{files:['全画面デザイン Figma','コンポーネントライブラリ','プロトタイプ（インタラクション付）','デザイントークン CSV'],format:'Figma/Zeplin',revs:4}},
  {id:'motion',  lb:'モーション',     ic:'🎬',css:'ai',   base:300000,  days:7, ph:1,sk:['design','ui'],
   deliv:{files:['ロゴアニメーション MP4','GIF版','After Effectsソースファイル','各SNS尺バリエーション'],format:'MP4/GIF/AEP',revs:2}},
  // ── Phase 2: デザインスタジオ ─────────────────────
  {id:'web',     lb:'Webサービス',    ic:'🌐',css:'web',  base:1500000, days:14,ph:2,sk:['ui','logic','design'],
   deliv:{files:['UIデザイン全画面 Figma','デザインシステム','フロントエンド実装（HTML/CSS/JS）','CMS組み込み対応'],format:'Figma/HTML/CSS',revs:5}},
  {id:'brand',   lb:'ブランディング', ic:'💎',css:'brand',base:3000000, days:18,ph:2,sk:['design','comm'],
   deliv:{files:['ロゴシステム一式','カラーパレット・タイポグラフィ定義','ブランドガイドライン PDF（80P）','全アプリケーション展開'],format:'PDF/AI/Figma',revs:5}},
  {id:'preso',   lb:'プレゼン資料',   ic:'📊',css:'web',  base:250000,  days:5, ph:2,sk:['design','comm'],
   deliv:{files:['PPTXデザインテンプレート','Keynote版','PDF出力版','各スライドの補足コメント'],format:'PPTX/KEY/PDF',revs:3}},
  {id:'signage', lb:'サイン・環境',   ic:'🏢',css:'brand',base:600000,  days:10,ph:2,sk:['design','comm'],
   deliv:{files:['サインデザイン一覧 PDF','施工仕様書','3Dレンダリング画像','製作用入稿データ'],format:'AI/PDF/PNG',revs:3}},
  {id:'ux_research',lb:'UXリサーチ',  ic:'🔬',css:'app',  base:800000,  days:12,ph:2,sk:['logic','comm'],
   deliv:{files:['ユーザーインタビュー記録','ペルソナ定義書','カスタマージャーニーマップ','改善提案レポート'],format:'PDF/Figma/Miro',revs:3}},
  // ── Phase 3: デザイン会社 ─────────────────────────
  {id:'design_system',lb:'デザインシステム',ic:'🧩',css:'web',base:4000000,days:28,ph:3,sk:['ui','logic','design'],
   deliv:{files:['コンポーネントライブラリ（200+）','デザイントークン定義','Storybook実装','使用ガイドライン']  ,format:'Figma/Storybook/npm',revs:6}},
  {id:'ai',      lb:'AIプロダクトUX', ic:'🤖',css:'ai',   base:5000000, days:22,ph:3,sk:['logic','ui','design'],
   deliv:{files:['会話UI設計（チャット・フォーム）','AIフィードバックループ設計','エラーハンドリングUI','アクセシビリティ対応'],format:'Figma/Prototype',revs:5}},
  {id:'ar_xr',   lb:'AR/XR体験',     ic:'🥽',css:'ai',   base:6000000, days:25,ph:3,sk:['logic','ui'],
   deliv:{files:['空間UIデザイン Figma','AR体験フロー設計','ジェスチャー設計ガイド','デモ動画 MP4'],format:'Figma/MP4',revs:4}},
  {id:'ir',      lb:'IR・年次報告書', ic:'📈',css:'brand',base:2000000, days:15,ph:3,sk:['design','comm'],
   deliv:{files:['年次報告書デザイン（印刷版）','デジタル版インタラクティブPDF','カバーデザイン案×3','英語版レイアウト'],format:'InDesign/PDF',revs:4}},
  // ── Phase 4: プロダクト企業 ──────────────────────
  {id:'saas',    lb:'自社SaaS開発',   ic:'⚡',css:'saas', base:20000000,days:35,ph:4,sk:['logic','ui','design'],prod:true,
   deliv:{files:['プロダクトUI全画面','APIドキュメントサイト','マーケティングサイト','ヘルプセンターUX'],format:'Figma/HTML/React',revs:8}},
  {id:'growth',  lb:'グロース施策',   ic:'📈',css:'saas', base:8000000, days:20,ph:4,sk:['logic','comm'],prod:true,
   deliv:{files:['A/Bテスト設計書','ファネル分析レポート','改善施策一覧','実装仕様書'],format:'PDF/Figma',revs:5}},
  {id:'cx',      lb:'CX設計',        ic:'🎯',css:'web',  base:5000000, days:18,ph:4,sk:['logic','comm','ui'],
   deliv:{files:['CXマップ（全タッチポイント）','カスタマーサポートUI','オンボーディングフロー','NPS改善提案'],format:'Figma/PDF/Miro',revs:5}},
  // ── Phase 5: プラットフォーム企業 ────────────────
  {id:'platform',lb:'プラットフォーム',ic:'🌍',css:'plat',base:80000000,days:60,ph:5,sk:['logic','ui','comm'],prod:true,
   deliv:{files:['プラットフォームUX全体','API開発者向けドキュメントUI','マーケットプレイスデザイン','管理ダッシュボード'],format:'Figma/React/Storybook',revs:10}},
  {id:'global_rebrand',lb:'グローバルリブランド',ic:'🌐',css:'brand',base:50000000,days:45,ph:5,sk:['design','comm'],
   deliv:{files:['グローバルブランドシステム','多言語ガイドライン（12言語）','地域別カスタマイズガイド','ブランドローンチキット'],format:'PDF/AI/Figma/Notion',revs:8}},
  // ── Phase 6: テックジャイアント ──────────────────
  {id:'ma',      lb:'M&A・買収',     ic:'🤝',css:'plat', base:500000000,days:90,ph:5,sk:['logic','comm'],prod:true,
   deliv:{files:['デューデリジェンス報告書','ブランド統合計画','移行ロードマップ','PMI設計書'],format:'PDF/PPT',revs:6}},
  {id:'os_design',lb:'OS/プラットフォームUI',ic:'💻',css:'plat',base:2000000000,days:180,ph:6,sk:['logic','ui','design'],prod:true,
   deliv:{files:['OS UI全コンポーネント（500+）','HIG（ヒューマンインターフェースガイドライン）','アクセシビリティ基準','開発者向けUIKit'],format:'Figma/SwiftUI/Compose',revs:15}},
  // ── NEW Phase 0: 小規模追加 ───────────────────
  {id:'tshirt',  lb:'Tシャツデザイン',   ic:'👕',css:'logo', base:25000,  days:2, ph:0,sk:['design'],
   deliv:{files:['プリントデータ AI','着用モックアップ PNG×3','カラーバリエーション'],format:'AI/PNG',revs:2},
   mj:'flat lay tshirt design mockup, minimal streetwear graphic, white background, studio photography'},
  {id:'stamp',   lb:'スタンプ・シール',  ic:'🔖',css:'logo', base:35000,  days:2, ph:0,sk:['design'],
   deliv:{files:['スタンプデータ SVG/AI','印刷入稿PDF（台紙込み）','実物モックアップ画像'],format:'SVG/PDF',revs:2},
   mj:'cute sticker sheet design, flat illustration style, pastel colors, white background'},
  {id:'thumbnail',lb:'動画サムネイル',   ic:'🎥',css:'lp',   base:15000,  days:1, ph:0,sk:['design'],
   deliv:{files:['サムネイル1280×720 PNG×3案','Photoshop PSDデータ','YouTube最適化チェック済'],format:'PNG/PSD',revs:2},
   mj:'youtube thumbnail design, bold typography, vibrant colors, high contrast, click-worthy'},
  {id:'menu',    lb:'メニュー・価格表',  ic:'🍽️',css:'lp',   base:80000,  days:3, ph:0,sk:['design'],
   deliv:{files:['メニュー表（A3両面）','デジタル表示用PNG','英語版（訪日対応）','QRコードメニュー用HTML'],format:'AI/PDF/HTML',revs:3},
   mj:'elegant restaurant menu design, typography, minimal japanese aesthetic, white paper texture'},
  {id:'nengajo', lb:'年賀状・ DM',      ic:'🎌',css:'logo', base:50000,  days:3, ph:0,sk:['design'],
   deliv:{files:['ハガキデータ（表・裏）','デジタル配信用PNG','印刷入稿PDF（CMYK）'],format:'AI/PDF/PNG',revs:2},
   mj:'japanese new year card design, traditional modern fusion, elegant typography, red and gold'},
  // ── NEW Phase 1: 中規模追加 ────────────────────
  {id:'game_ui', lb:'ゲームUI',         ic:'🎮',css:'app',  base:1200000, days:14,ph:1,sk:['ui','design','logic'],
   deliv:{files:['HUDデザイン Figma','メニュー画面 全画面','アイコン・アイテム一式（100個以上）','チュートリアルUI','Unity/Unreal用スプライトシート'],format:'Figma/PNG/SpritSheet',revs:4},
   mj:'game UI design, dark fantasy RPG interface, glowing elements, medieval style HUD, slot and inventory screens'},
  {id:'ebook',   lb:'電子書籍・PDF資料',ic:'📚',css:'lp',   base:180000,  days:6, ph:1,sk:['design','comm'],
   deliv:{files:['表紙デザイン','本文テンプレート（全ページ）','PDF最適化（リフロー対応）','サムネイル・アイキャッチ'],format:'InDesign/PDF/Figma',revs:3},
   mj:'ebook cover design, modern business book, clean typography, gradient background, professional'},
  {id:'map',     lb:'地図・インフォグラフィック',ic:'🗺️',css:'web',base:220000,days:7, ph:1,sk:['design','comm'],
   deliv:{files:['カスタムマップイラスト PNG/SVG','観光マップ A2サイズ','デジタル埋め込み用SVG','アクセシビリティ対応版'],format:'SVG/PNG/PDF',revs:3},
   mj:'illustrated treasure map design, vintage cartography style, hand-drawn aesthetic, warm sepia tones'},
  {id:'mascot',  lb:'マスコット・キャラ',ic:'🐻',css:'logo', base:350000,  days:10,ph:1,sk:['design'],
   deliv:{files:['キャラクターデザイン（正面・横・後ろ）','表情バリエーション×8','グッズ展開案（Tシャツ/ステッカー）','使用ガイドライン'],format:'AI/PNG/Figma',revs:4},
   mj:'cute mascot character design, chibi style, friendly expression, flat vector illustration, white background, multiple poses'},
  {id:'infographic',lb:'インフォグラフィック',ic:'📊',css:'web',base:280000,days:6, ph:1,sk:['design','comm'],
   deliv:{files:['縦型インフォグラフィックPNG（4K）','横型バナー版','SNS分割版（9分割）','ソースデータ Figma'],format:'PNG/Figma',revs:3},
   mj:'data visualization infographic, modern design, colorful charts and graphs, clean typography, white background'},
  // ── NEW Phase 2: 中〜大規模追加 ───────────────
  {id:'fashion', lb:'ファッションビジュアル',ic:'👗',css:'brand',base:600000,days:10,ph:2,sk:['design','comm'],
   deliv:{files:['ルックブックレイアウト（全24P）','キャンペーンビジュアル×6点','SNS展開一式','商品タグ・ラベルデザイン'],format:'InDesign/AI/PDF',revs:3},
   mj:'high fashion editorial photography direction, minimalist luxury brand campaign, clean white studio, bold typography overlay'},
  {id:'food',    lb:'飲食店ブランド',    ic:'🍜',css:'brand',base:450000,  days:8, ph:2,sk:['design','comm'],
   deliv:{files:['ロゴ・シンボル','メニューブック（全ページ）','食器・ユニフォームへの展開','店頭ファサードデザイン案'],format:'AI/PDF/Figma',revs:3},
   mj:'japanese restaurant brand identity, warm minimalist aesthetic, hand-lettered logo, earth tones, authentic atmosphere'},
  {id:'realestate',lb:'不動産・建築ビジュアル',ic:'🏗️',css:'brand',base:550000,days:9, ph:2,sk:['design','comm'],
   deliv:{files:['物件パンフレット（12P）','間取り図グラフィック化','モデルルーム什器デザイン','広告バナー一式（5種）'],format:'InDesign/AI/PDF',revs:3},
   mj:'luxury real estate brochure design, architectural visualization, clean minimalist layout, premium paper texture'},
  {id:'event',   lb:'イベント・展示会',  ic:'🎪',css:'lp',   base:380000,  days:7, ph:2,sk:['design','comm'],
   deliv:{files:['イベントキービジュアル','告知バナー一式（20サイズ）','プログラム冊子','会場サイン計画'],format:'AI/PDF/PNG',revs:3},
   mj:'festival event poster design, vibrant illustration, bold typography, concert venue atmosphere, dynamic composition'},
  {id:'nft',     lb:'NFT・Web3ビジュアル',ic:'⛓️',css:'ai',  base:800000,  days:10,ph:2,sk:['design','logic'],
   deliv:{files:['NFTアートワーク PNG（10点）','コレクションバナー','ミントページUIデザイン','メタデータ仕様書'],format:'PNG/Figma/JSON',revs:3},
   mj:'NFT digital art collection, generative art aesthetic, vibrant cyberpunk colors, abstract geometric patterns, blockchain visual'},
  // ── NEW Phase 3: 大規模追加 ────────────────────
  {id:'medical_app',lb:'医療アプリ',     ic:'🏥',css:'app',  base:6000000, days:28,ph:3,sk:['ui','logic','design'],
   deliv:{files:['患者向けアプリUI（全画面）','医師向けダッシュボード','WCAG 2.1 AAA準拠確認','電子カルテ連携IF仕様'],format:'Figma/Zeplin',revs:6},
   mj:'medical app UI design, clean clinical interface, healthcare blue and white, accessible design, patient dashboard'},
  {id:'edtech',  lb:'EdTechプロダクト',  ic:'📚',css:'app',  base:5000000, days:25,ph:3,sk:['ui','logic','comm'],
   deliv:{files:['学習画面 全フロー Figma','動画プレーヤーUI','進捗ダッシュボード','保護者向けレポートUI','子供向けゲーミフィケーション'],format:'Figma/Prototype',revs:5},
   mj:'educational app UI for children, gamified learning interface, bright colorful design, friendly characters, progress tracking'},
  {id:'fintech', lb:'FintechサービスUI',ic:'💰',css:'app',  base:8000000, days:30,ph:3,sk:['ui','logic'],
   deliv:{files:['口座管理画面','投資ポートフォリオUI','送金フロー（全ステップ）','本人確認（KYC）フロー','セキュリティ設定UI'],format:'Figma/Zeplin',revs:6},
   mj:'fintech mobile app UI, modern banking interface, dark theme, data visualization, trust and security visual design'},
  {id:'agri',    lb:'農業・地方創生DX',  ic:'🌾',css:'web',  base:3500000, days:20,ph:3,sk:['ui','comm','design'],
   deliv:{files:['農家向けアプリUI','収穫管理ダッシュボード','地域ブランドサイト','産直ECデザイン','多言語対応（英中）'],format:'Figma/HTML',revs:4},
   mj:'agricultural tech UI, rural japan branding, natural earthy tones, farmland drone imagery, digital transformation'},
  {id:'sport',   lb:'スポーツ・チームブランド',ic:'⚽',css:'brand',base:2500000,days:16,ph:3,sk:['design','comm'],
   deliv:{files:['チームロゴ・エンブレム','ユニフォームデザイン案','スタジアムサイン計画','デジタルメディアキット'],format:'AI/PDF/Figma',revs:4},
   mj:'professional sports team branding, bold athletic logo design, dynamic motion, jersey mockup, arena signage'},
  {id:'anime',   lb:'アニメ・コンテンツビジュアル',ic:'🎌',css:'brand',base:4000000,days:22,ph:3,sk:['design','comm'],
   deliv:{files:['メインビジュアル・キービジュアル','キャラクターデザイン設定集','告知ポスター×3','グッズ展開デザイン（10品目）','公式サイトデザイン'],format:'PSD/AI/Figma',revs:5},
   mj:'anime key visual illustration, dramatic composition, vibrant japanese animation style, detailed character design'},
  // ── NEW Phase 4-5: プロダクト拡張 ─────────────
  {id:'govtech', lb:'行政DXシステム',   ic:'🏛️',css:'web',  base:15000000,days:40,ph:4,sk:['ui','logic','comm'],prod:true,
   deliv:{files:['市民向けポータルUI（全フロー）','職員用ダッシュボード','アクセシビリティ監査レポート','JIS X 8341準拠対応','多言語対応（16言語）'],format:'Figma/HTML/React',revs:8},
   mj:'government digital service UI, accessible clean interface, formal blue tones, citizen portal, japanese e-government'},
  {id:'mobility',lb:'モビリティ・車載HMI',ic:'🚗',css:'ai',  base:25000000,days:50,ph:4,sk:['ui','logic'],prod:true,
   deliv:{files:['センターコンソール HMI設計','インスツルメントクラスター','OTA更新UIフロー','音声UI インタラクション設計','安全基準（ISO 26262）適合確認'],format:'Figma/ProtoPie',revs:8},
   mj:'automotive HMI interface design, car dashboard UI, dark cockpit interior, luxury vehicle infotainment system'},
  {id:'xrplatform',lb:'XR・空間コンピューティング',ic:'🥽',css:'ai',base:40000000,days:60,ph:5,sk:['ui','logic'],prod:true,
   deliv:{files:['Apple Vision Pro 空間UI設計','ジェスチャーインタラクション仕様','3D UIコンポーネントライブラリ','アクセシビリティ対応（視覚障害）'],format:'Reality Composer/Figma',revs:10},
   mj:'spatial computing UI for Apple Vision Pro, immersive 3D interface, glass morphism, volumetric design, AR overlay'},
];
var CTYPES=[
  {id:'god',    lb:'神クライアント',         cls:'cgod',   ic:'😇',mr:5, pm:1.3, rg:4,rl:-1,desc:'予算潤沢・修正少・人格者'},
  {id:'norm',   lb:'普通の会社',              cls:'cnorm',  ic:'🏢',mr:28,pm:1.0, rg:1,rl:1, desc:'可もなく不可もなく'},
  {id:'start',  lb:'意識高いスタートアップ', cls:'cstart', ic:'🚀',mr:52,pm:0.78,rg:2,rl:2, desc:'世界を変えたいが予算低い'},
  {id:'agency', lb:'大手代理店経由',          cls:'cagency',ic:'😤',mr:62,pm:0.85,rg:1,rl:3, desc:'中間マージン大・担当コロコロ'},
  {id:'pres',   lb:'地方の社長',              cls:'cpres',  ic:'👴',mr:72,pm:1.1, rg:1,rl:2, desc:'シンプルに→豪華に を繰り返す'},
  {id:'gov',    lb:'お役所',                  cls:'cgov',   ic:'📄',mr:38,pm:1.4, rg:0,rl:0, desc:'仕様書250ページ・MS明朝指定'},
  {id:'vnt',    lb:'シリーズAスタートアップ',cls:'cvnt',   ic:'💼',mr:42,pm:1.15,rg:3,rl:1, desc:'資金調達済み・でも急ぎ'},
  {id:'indie',  lb:'個人事業主',              cls:'cind',   ic:'🙋',mr:55,pm:0.5, rg:1,rl:1, desc:'予算5万・要求100万相当'},
  {id:'overseas',lb:'海外クライアント',       cls:'cnorm',  ic:'🌍',mr:20,pm:1.4, rg:2,rl:0, desc:'英語でやり取り・高単価'},
  {id:'brand',  lb:'ブランドホルダー',        cls:'cvnt',   ic:'👜',mr:30,pm:1.5, rg:1,rl:0, desc:'プレミアムブランド志向・品質最優先'},
  {id:'tech',   lb:'テック企業',              cls:'cvnt',   ic:'💻',mr:35,pm:1.2, rg:2,rl:1, desc:'Figma/GitHub慣れ・仕様明確'},
  {id:'media',  lb:'メディア・出版',          cls:'cnorm',  ic:'📰',mr:45,pm:0.9, rg:2,rl:2, desc:'締切絶対・クオリティ高い'},
  {id:'artist', lb:'クリエイター・アーティスト',cls:'cind', ic:'🎨',mr:40,pm:0.7, rg:1,rl:1, desc:'ビジョンは強い・予算は弱い'},
  {id:'medical',lb:'医療機関',                cls:'cgov',   ic:'🏥',mr:25,pm:1.3, rg:1,rl:0, desc:'専門知識必要・信頼性重視'},
];
var PNAMES={
  logo:['地方菓子メーカーのロゴ','カフェのロゴリデザイン','テックスタートアップシンボルマーク','医療クリニックのロゴタイプ','不動産会社ワードマーク','ヨガスタジオのマーク','クラフトビール醸造所ロゴ','フードブランドエンブレム','士業事務所ロゴ','コスメブランドシンボル','アパレルロゴデザイン','ペット用品ブランドマーク','建築事務所ロゴタイプ','フィンテックシンボル','教育プラットフォームロゴ','農産物ブランドロゴ'],
  meishi:['税理士の名刺200枚','フリーコンサルの名刺 両面','経営者名刺リデザイン（箔押し）','デザイナー名刺 特殊印刷','医師名刺 100枚','弁護士事務所ステーショナリー一式','不動産エージェント名刺','ブランドディレクター名刺'],
  banner:['Google Display バナー一式（10サイズ）','Instagram広告バナーセット','YouTube動画サムネイル×10','メルマガヘッダー＆フッター','楽天市場バナーリニューアル','アプリストアスクリーンショット','X(Twitter)ヘッダー','ECサイト特集バナー','採用広告バナーセット','リターゲティング広告クリエイティブ'],
  flyer:['レストランメニューリデザイン','音楽ライブフライヤーA5','学習塾チラシ（折込広告）','クリニック開院案内チラシ','不動産物件チラシ','イベント告知フライヤー','マルシェ出店フライヤー','ファッションセールPOP'],
  icon:['タスク管理アプリ アイコンセット64種','決済サービス UIアイコン一式','医療アプリ ピクトグラム32種','SaaS管理画面 機能アイコン','Webサービス ソーシャルアイコン','ゲームUI アイテムアイコン','地図アプリ POIアイコン'],
  sns:['コーポレートSNS運用デザイン一式','カフェInstagramテンプレート×12','コスメブランドSNS刷新','採用広報SNSビジュアルセット','食品ブランドSNSデザイン','スタジオ公式アカウントビジュアル'],
  lp:['新商品ランディングページ（CV最適化）','採用サイトLP（ファーストビュー刷新）','セミナー集客LP A/Bテスト用2案','ECストア トップページリニューアル','アプリDL促進LP（スマホ特化）','SaaS無料トライアル誘導LP','不動産物件紹介LP','ホテル予約LP（インバウンド対応）','クラウドファンディングプロジェクトLP'],
  poster:['全国ツアーポスター B1','映画・舞台チラシ A4＋B2','美術展図録デザイン','フェスティバルビジュアルアイデンティティ','ブランドキャンペーンポスター','行政啓発ポスター','ショールームPOP一式','マラソン大会オフィシャルポスター'],
  catalog:['家具メーカー総合カタログ 96P','コスメ新商品カタログ 24P','産業機械製品カタログ','大学募集要項パンフ','ホテルサービスブック','アパレルルックブック 48P','B2Bサービス会社案内 16P','医療機器カタログ（英語版）'],
  package:['クラフトビールラベル×4種','コスメパッケージ刷新（全ライン）','食品ギフトボックスデザイン','日本酒ラベルリニューアル','スキンケアチューブ＆ボックス','菓子パッケージ（コンビニ向け）','サプリメントボトルラベル','オーガニック食品パッケージ'],
  photo:['新商品ファッション撮影（25カット）','コーポレートプロフィール撮影','料理・フード撮影 30品','ECアパレル商品撮影200点','ホテルスペース撮影','コスメ商品スチール撮影','インタビュー用人物撮影'],
  app:['フードデリバリーアプリUI（iOS）','医療予約アプリ 全画面リデザイン','フィンテック投資アプリUI','ギグワーカー向けシフト管理アプリ','健康管理アプリ（Apple Watch対応）','学習プラットフォームアプリUI','旅行予約アプリ（タブレット対応）','不動産内見予約アプリ','ライブ配信プラットフォームUI','Eスポーツチームアプリ'],
  motion:['企業ロゴアニメーション（フルバージョン）','サービス紹介アニメ動画 90秒','SNS用ショート動画 ×5本','展示会ブースビジュアル動画','プロダクト機能説明モーション','採用ブランドムービー（2分）','タイトルアニメーション Webサイト','データビジュアライゼーション動画'],
  web:['BtoB SaaS 管理ダッシュボード全画面','マッチングサービス UIリニューアル','ECプラットフォーム UI（100画面）','医療情報サービス サイト','HR-Tech 採用管理画面','プロパテック 物件管理UI','フィンテック 資産管理ダッシュボード','EdTech 学習管理システムUI'],
  brand:['大手食品メーカー リブランド全体','スタートアップ ブランド構築（0→1）','自治体シティブランド策定','大学ブランドアイデンティティ刷新','ホテルチェーン ブランドリニューアル','ヘルスケアブランド VI策定','アパレルブランドローンチ','B2B SaaS ブランドリポジショニング'],
  preso:['シリーズA ピッチデック（20スライド）','IR資料 年次報告書 デザイン','社内キックオフ プレゼン刷新','戦略プレゼン テンプレート一式','製品発表 Keynoteデザイン','採用説明会資料 全面刷新','事業計画書 ビジュアライゼーション'],
  signage:['新オフィス サインシステム全体','ショールーム展示会ブース設計','駅構内サイン計画','病院内サイン・ピクトグラム','ホテルロビー 環境グラフィック','大学キャンパスサインリニューアル','スタジアム施設サイン'],
  ux_research:['ECサービス ユーザビリティテスト＋改善提案','アプリ ペルソナ定義＆CJM','新規事業 ユーザーインタビュー20名','メンタルモデル調査レポート','アクセシビリティ監査＋改善','ゼロイチサービス UXリサーチ'],
  design_system:['SaaS プロダクト デザインシステム構築','大規模ECサイト コンポーネントライブラリ','グループ企業統一 UI標準化','スマートフォンアプリ デザイントークン策定','社内ツール群 統一デザインシステム'],
  ai:['生成AI チャットIF（GPT連携）','AIコーディングツール UX','ML予測ダッシュボード UI','AIカスタマーサポート IF設計','画像生成AI プロダクトUI','音声AI インタラクション設計','RAG検索システムUI'],
  ar_xr:['AR試着アプリ UX設計','XR展示会体験設計','空間コンピューティング IF（Vision Pro）','ARナビゲーション UI','VRトレーニング 体験設計','メタバース空間 UX設計'],
  ir:['東証プライム上場企業 IR資料刷新','ESGレポート グラフィック','株主総会招集通知デザイン','英語版アニュアルレポート','四半期決算資料 テンプレート'],
  saas:['デザイン管理 SaaS β版','クリエイター向けSaaS（MAU 10万目標）','マーケ自動化ツール PMF期','FinTech BtoB SaaS 本格開発','HR-Tech プロダクト全機能実装','EdTech SaaS 学習機能拡張','HealthTech SaaS 記録・分析機能'],
  growth:['DAU改善 A/Bテスト施策計画','チャーン率削減 UI改修','グロースループ設計 実装','LTV最大化 ファネル最適化','バイラル機能 実装（招待機能）','プッシュ通知 パーソナライズUI','ペイウォール最適化 A/B'],
  cx:['自社SaaS オンボーディング最適化','CXマップ全タッチポイント設計','カスタマーサポート UI刷新','NPS改善 プロダクト改修','ロイヤルティプログラム UX設計'],
  platform:['クリエイター向けマーケットプレイス','エンタープライズ向けデザインOS','デベロッパー向けAPIダッシュボード','マルチサイドプラットフォームUX','B2B2C ホワイトラベルUI'],
  global_rebrand:['グローバルブランドシステム再構築 40カ国','多言語プロダクト UI最適化','地域別ブランドカスタマイズガイド','グローバルローンチキット制作'],
  ma:['AIスタートアップ買収 PMI設計','デザインツール企業 ブランド統合','海外プロダクト 日本市場向け UI最適化','グループ会社 ブランドアーキテクチャ再編'],
  os_design:['次世代OS UI/UXフルリニューアル','スマートウォッチ OS UI設計','車載HMI インターフェース設計（ADAS）','AR HMD OS インタラクション設計'],
  // 新タイプ
  tshirt:['ストリートブランド Tシャツグラフィック','バンドTシャツデザイン×5種','ユニフォームプリント 全20サイズ','限定コラボTシャツ','スタジアムグッズ Tシャツ','アウトドアブランドTシャツ'],
  stamp:['LINEスタンプ 16種セット','ブランドシールセット（6種）','コーポレートスタンプ一式','ハンコ・印鑑デザイン','マスキングテープ図案','パッケージシール（食品向け）'],
  thumbnail:['料理チャンネル サムネイル×12','ビジネス解説 YouTube サムネイル','ゲーム実況 サムネイル×20','Vtuberチャンネル サムネイルセット','音楽MV サムネイル','企業研修動画 サムネイル'],
  menu:['フレンチレストラン コースメニュー','カフェ ドリンクメニュー（壁掛け）','居酒屋 グランドメニュー（全30P）','ホテルルームサービスメニュー','フードフェス メニューボード','デジタルサイネージ対応メニュー'],
  nengajo:['新春プロモーションDM 3,000枚','会社年賀状 デジタル版','暑中見舞いビジュアル','クリスマスカード（英語版）','VIP顧客向け手作り感DM','行政からの案内状デザイン'],
  game_ui:['ソーシャルRPG 全UI設計','パズルゲーム UI（iOS/Android）','カードゲーム コレクション画面','Eスポーツ トーナメント管理UI','ガチャ・ガチャ演出画面','ゲームローディング画面 60種'],
  ebook:['マーケティング戦略 電子書籍（200P）','スタートアップ資金調達 ガイドPDF','UI/UXデザイン基礎テキスト','健康管理レシピBOOK','行政向け手続き案内PDF','社内研修 テキスト全面刷新'],
  map:['観光地 イラストマップ（A2）','ショッピングモール フロアマップ','イベント会場 案内図','テーマパーク エリアマップ','都市紹介 インフォグラフィックマップ','データビジュアライゼーション 統計地図'],
  mascot:['地方自治体 PRキャラクター','フィンテックサービス マスコット','幼児向けアプリ キャラクター3種','スポーツチーム 公式マスコット','ECサービス ガイドキャラ','企業公式LINEスタンプ用キャラ'],
  infographic:['企業IR 年次データ可視化','コロナ後の働き方 調査結果','AI業界 トレンドレポート','気候変動 データビジュアライゼーション','採用情報 会社紹介インフォグラフィック','製品比較 インフォグラフィック'],
  fashion:['セレクトショップ 秋冬ルックブック','アパレルブランド スナップビジュアル','ファッション誌 広告キャンペーン','レンタルドレス ビジュアルリニューアル','インポートブランド 日本向けカタログ','メンズストリート ブランドビジュアル'],
  food:['新規開業 ラーメン専門店ブランド','居酒屋チェーン VI全面刷新','カフェ＆ベーカリー ブランド立ち上げ','高級寿司店 暖簾・店内サイン','グルメECサイト ショップブランド','フードテック 新サービスブランド'],
  realestate:['タワマン 販売パンフ（高級）','地方移住促進 物件サイトリニューアル','不動産テックサービス ブランド統合','商業ビル テナント募集資料','ホテル新館 開業ビジュアル','リノベ物件 販売促進ツール一式'],
  event:['音楽フェス メインビジュアル','カンファレンス 運営ツール一式','展示会 ブースデザイン（50m2）','マラソン大会 ランナー向け応援ビジュアル','企業周年記念式典 演出デザイン','スポーツ国際大会 WEBサイトデザイン'],
  nft:['ジェネラティブアートNFT 10,000点','デジタルファッション NFTコレクション','音楽NFT ジャケットアート','メタバース空間 ブランドアバター','Web3プロジェクト ロードマップビジュアル','NFTマーケットプレイス UIデザイン'],
  medical_app:['在宅医療 患者管理アプリUI','診察予約 アプリUI（病院グループ）','介護記録 現場スタッフ向けアプリ','メンタルヘルスケア アプリ設計','服薬管理 リマインダーアプリ','PHR 個人健康記録 プラットフォームUI'],
  edtech:['小中学生向け プログラミング学習アプリ','資格試験 学習管理プラットフォーム','社内研修 Eラーニングシステム','大学 LMS 全面リニューアル','子供向け英語学習 キャラアプリ','高校生 進路相談 マッチングサービスUI'],
  fintech:['個人資産管理アプリ UI全面刷新','中小企業向け 請求書管理SaaSUI','仮想通貨 ウォレットアプリUX','ポイント経済圏 アプリ統合UI','決済端末向け 店舗管理画面','BNPLサービス 購入フロー最適化'],
  agri:['スマート農業 センサーダッシュボード','産直アプリ 農家・消費者双方向UI','漁業DX 水揚げ管理システム','農村観光 インバウンド向けWebサイト','農産物EC 産地ブランドサイト','食農連携 ローカルSDGsサイト'],
  sport:['プロサッカークラブ ユニフォームリニューアル','格闘技団体 ブランド刷新','スポーツジム フランチャイズVI','マラソン大会 公式ブランドデザイン','フィットネスアプリ スポーツブランド統合','スタジアム命名権 ブランドデザイン'],
  anime:['TVアニメ 劇場版 キービジュアル','ゲームアニメ PVビジュアル','グッズ展開 フィギュアパッケージ','コラボカフェ 内装・商品デザイン','メディアミックス 統一ビジュアル展開','配信プラットフォーム オリジナル作品'],
  govtech:['自治体 手続きデジタル化ポータル','国民ID 行政サービスUI統合','スマートシティ ダッシュボード','防災情報 市民向けアプリUI','図書館 デジタルサービス刷新','パスポート・ビザ申請 オンライン化'],
  mobility:['EV 充電スタンド HMI設計','自動運転 レベル4 UI設計','バス・鉄道 運行管理システムUI','MaaS統合 乗り換えアプリUI','カーシェア 配車・決済フローUX','トラック運行管理 ドライバー向けUI'],
  xrplatform:['メタバース オフィス 空間UI設計','AR商品試着 全ブランド展開','医療XR 手術支援インターフェース','教育XR 仮想実験室UI','テーマパーク AR体験 全エリア設計','空間広告プラットフォーム UI仕様'],
};
var MODS=[
  {tx:'「全体的にもっとポップにしてください」', em:'🌈',dm:-8, at:'かしこまりました…',rt:'ポップとはどういう意味でしょうか？',rp:-6},
  {tx:'「なんかちょっと違うんですよね〜」',      em:'😑',dm:-10,at:'修正します',rt:'具体的にどこが違いますか？',rp:-3},
  {tx:'「前のデザインに戻してください」',         em:'😤',dm:-15,at:'もちろんです（2週間返して）',rt:'それは難しいです…',rp:-10},
  {tx:'「ロゴを100案出してもらえますか？」',     em:'💀',dm:-25,at:'はい…（廃人確定）',rt:'50案ではいかがでしょう',rp:-12},
  {tx:'「息子がもっと豪華にと言ってます」',       em:'👨‍👦',dm:-12,at:'豪華にします',rt:'社長のご判断にお任せを',rp:-15},
  {tx:'「担当者が変わりました。引き継ぎゼロです」',em:'😭',dm:-20,at:'最初から説明します',rt:'引き継ぎ資料をください',rp:-5},
  {tx:'「前と違う方向で全部やり直しで」',         em:'🔄',dm:-30,at:'はい…（深夜確定）',rt:'追加費用が発生します',rp:-10},
  {tx:'「シンプルに→豪華に→やっぱりシンプルに」',em:'🔁',dm:-35,at:'了解です（三往復目）',rt:'方向性を決めていただきたい',rp:-8},
  {tx:'「なんかぐっとこないんです」',             em:'🤔',dm:-8, at:'ぐっとくる方向で',rt:'具体的なFBをお願いします',rp:-3},
  {tx:'「無料でもう3案作ってもらえますか？」',    em:'💸',dm:-18,at:'わかりました（涙）',rt:'追加案件として対応します',rp:-8},
  {tx:'「他社に頼もうか迷ってます」',             em:'😨',dm:-12,at:'値引きします',rt:'ぜひご検討ください',rp:-20},
  {tx:'「昨日送ったデータ、差し替えで」（納品後）',em:'😤',dm:-20,at:'対応します（無料で）',rt:'追加料金が発生します',rp:-12},
];
var EVTS=[
  {id:'figma_down',ic:'💀',ty:'danger',tt:'Figmaが落ちた！',
   ds:'締め切り3時間前、Figmaのサーバーがダウン。\nステータスページは「investigating」。',
   ch:[{tx:'Sketchで作業続行',ef:'全メンタル-5',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental-5,0,100);});notify('Sketchで凌ぎます…','warn');}},
       {tx:'復旧を待つ（そわそわ）',ef:'全メンタル-12',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental-12,0,100);});addLog('Figma復旧待ち中…全員精神消耗','bad');}}]},
  {id:'client_bomb',ic:'💢',ty:'danger',tt:'クライアントが爆発！',
   ds:'担当者から突然、長文の怒りのメールが届きました。\n理由がよくわかりません。でも激しく怒っています。',
   ch:[{tx:'謝り倒す（土下座スタイル）',ef:'評判-5、メンタル-15',fn:function(){G.s.rep=clamp(G.s.rep-5,0,100);G.s.staff.forEach(function(s){s.mental=clamp(s.mental-15,0,100);});addLog('クライアントに謝罪。疲弊。','bad');}},
       {tx:'冷静に事実確認する',ef:'評判-2、改善の可能性',fn:function(){G.s.rep=clamp(G.s.rep-2,0,100);notify('冷静対応。事態が落ち着いた。','ok');}}]},
  {id:'inf_mod',ic:'♾️',ty:'danger',tt:'無限修正地獄突入',
   ds:'「もう一声」\n「もう一声」\n「もう一声」\nこのクライアント、止まる気がありません。',
   ch:[{tx:'受け続ける（廃人ルート）',ef:'全メンタル-30、ブラック+10',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental-30,0,100);});G.s.totalMods+=10;G.s.black=clamp(G.s.black+10,0,100);addLog('無限修正地獄…社員が壊れていく','bad');SFX.bad();}},
       {tx:'追加費用を請求する',ef:'+10万円、評判-5',fn:function(){G.s.money+=100000;G.s.rep=clamp(G.s.rep-5,0,100);addLog('追加費用請求で修正を打ち切った。','good');}}]},
  {id:'quit',ic:'🚶',ty:'warn',tt:'社員が退職を申し出た',
   ds:'「少しお話があるんですが…」\n社員の1人が、静かに退職を申し出ました。',
   ch:[{tx:'給与を上げて引き止める',ef:'-20万円、引き止め',fn:function(){if(G.s.money>=200000){G.s.money-=200000;notify('給与UPで引き止め成功！','ok');}else{fireRandom();notify('資金不足で引き止められなかった…','danger');}}},
       {tx:'快く送り出す',ef:'評判-3、人員-1',fn:function(){fireRandom();addLog('社員が旅立った。','bad');}},
       {tx:'業務改善を約束する',ef:'ブラック-10、成功率50%',fn:function(){if(Math.random()<0.5){G.s.black=clamp(G.s.black-10,0,100);notify('改善約束で引き止め成功！','ok');}else{fireRandom();notify('それでも去っていった…','danger');}}}]},
  {id:'font_acc',ic:'🔤',ty:'danger',tt:'フォント事故発生！',
   ds:'納品データに未購入の商用フォントが混入していました。\n「印刷できません」と連絡が来ています。',
   ch:[{tx:'即座に修正版を送る',ef:'メンタル-10、-3万円',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental-10,0,100);});G.s.money-=30000;addLog('フォント事故対応。出費あり。','bad');}},
       {tx:'フリーフォントに差し替え',ef:'品質ダウン、評判-5',fn:function(){G.s.rep=clamp(G.s.rep-5,0,100);addLog('フリーフォント差し替え。品質妥協。','bad');}}]},
  {id:'fire_sns',ic:'🔥',ty:'danger',tt:'SNS炎上発生！',
   ds:'「このデザインひどくない？」の声がXで広まっています。\nトレンドに載るかもしれません。',
   ch:[{tx:'謝罪文を丁寧に出す',ef:'炎上-15、評判-10',fn:function(){G.s.fire=clamp(G.s.fire-15,0,100);G.s.rep=clamp(G.s.rep-10,0,100);addLog('謝罪文公開。炎上が少し収まった。','bad');}},
       {tx:'完全沈黙で乗り切る',ef:'炎上+8',fn:function(){G.s.fire=clamp(G.s.fire+8,0,100);addLog('沈黙作戦。まだ燃えている…','bad');}},
       {tx:'デザインの意図を説明する',ef:'成功か炎上か50/50',fn:function(){if(Math.random()<0.45){G.s.fire=clamp(G.s.fire-20,0,100);G.s.rep=clamp(G.s.rep+5,0,100);notify('説明が共感を呼び炎上鎮火！','ok');}else{G.s.fire=clamp(G.s.fire+15,0,100);notify('さらに炎上してしまった…','danger');}}}]},
  {id:'sns_buzz',ic:'🚀',ty:'success',tt:'SNSでバズった！',
   ds:'納品した案件のビジュアルがSNSで大きくバズりました！\nデザイン好きのアカウントが続々とリポスト。',
   ch:[{tx:'積極的に拡散する',ef:'SNS+500、評判+8',fn:function(){G.s.sns+=500;G.s.rep=clamp(G.s.rep+8,0,100);addLog('SNSバズで認知急拡大！','good');SFX.good();}},
       {tx:'静かに喜ぶ',ef:'SNS+150、評判+3',fn:function(){G.s.sns+=150;G.s.rep=clamp(G.s.rep+3,0,100);addLog('静かにバズりを享受した。','good');}}]},
  {id:'award',ic:'🏆',ty:'success',tt:'デザイン賞を受賞！',
   ds:'グッドデザイン賞の一次審査を通過しました！',
   ch:[{tx:'プレスリリースを積極展開',ef:'評判+25、SNS+400',fn:function(){G.s.rep=clamp(G.s.rep+25,0,100);G.s.sns+=400;G.s.awards++;addLog('グッドデザイン賞受賞！業界騒然！','good');SFX.fanfare();}},
       {tx:'実績として淡々と記録',ef:'評判+12',fn:function(){G.s.rep=clamp(G.s.rep+12,0,100);G.s.awards++;addLog('デザイン賞受賞。実績として記録。','good');}}]},
  {id:'god_cli',ic:'😇',ty:'success',tt:'神クライアント登場！',
   ds:'「予算は十分あります。修正もほぼしません。」\n夢のようなクライアントが現れました。',
   ch:[{tx:'ぜひお願いします！',ef:'高額案件+300〜500万円',fn:function(){var e=3000000+ri(0,2000000);G.s.money+=e;G.s.rep=clamp(G.s.rep+10,0,100);addLog('神クライアントと契約！'+fY(e)+'！','good');SFX.fanfare();}}]},
  {id:'media',ic:'📰',ty:'success',tt:'メディア取材依頼！',
   ds:'デザイン専門メディアから取材の申し込みが来ました。',
   ch:[{tx:'受ける（今がチャンス）',ef:'評判+22、SNS+300',fn:function(){G.s.rep=clamp(G.s.rep+22,0,100);G.s.sns+=300;addLog('メディア取材掲載。認知度爆上がり。','good');SFX.good();}},
       {tx:'今は忙しいので断る',ef:'チャンスを逃す',fn:function(){notify('次の機会を待とう…','warn');}}]},
  {id:'study',ic:'📚',ty:'success',tt:'社内勉強会が盛り上がった！',
   ds:'自主的な勉強会が始まり、全社員が熱心に参加しています。',
   ch:[{tx:'業務時間内でやろう',ef:'全スキル+3、メンタル+10',fn:function(){G.s.staff.forEach(function(s){Object.keys(s.stats).forEach(function(k){s.stats[k]=clamp(s.stats[k]+3,0,99);});s.mental=clamp(s.mental+10,0,100);});notify('全社員スキルUP！メンタル回復！','ok');SFX.good();}}]},
  {id:'nft',ic:'🎨',ty:'warn',tt:'NFT案件のオファー',
   ds:'「報酬はトークンでお支払いします！未来の価値に期待を！」',
   ch:[{tx:'受ける（トークンで）',ef:'収入あるが炎上+15',fn:function(){G.s.money+=150000;G.s.fire=clamp(G.s.fire+15,0,100);addLog('NFT案件受注。トークン受け取り。将来が心配。','warn');}},
       {tx:'現金払いなら受ける',ef:'普通の案件として受注',fn:function(){G.s.money+=200000;addLog('現金払い交渉成功。','good');}},
       {tx:'断る（正解の予感）',ef:'安全。炎上回避',fn:function(){notify('NFT案件を断った。正解かも。','ok');}}]},
  {id:'ai_wave',ic:'🤖',ty:'warn',tt:'AIの波が来た…',
   ds:'「AIでデザインできるらしいですね。御社に頼む必要ありますか？」',
   ch:[{tx:'AIを積極活用する戦略へ',ef:'AI活用技術解放',fn:function(){G.s.tech['ai_design']=true;notify('AI活用スタジオとして進化宣言！','ok');addLog('AI活用方針を発表。','good');}},
       {tx:'人間の価値を丁寧に説明する',ef:'評判+5',fn:function(){G.s.rep=clamp(G.s.rep+5,0,100);addLog('人間デザインの価値を説明。共感を得た。','good');}}]},
  {id:'overtime',ic:'😫',ty:'warn',tt:'残業が続いている…',
   ds:'締め切りが重なり、社員の残業が3週間続いています。',
   ch:[{tx:'残業制限を設ける',ef:'ブラック-20、メンタル+10',fn:function(){G.s.black=clamp(G.s.black-20,0,100);G.s.staff.forEach(function(s){s.mental=clamp(s.mental+10,0,100);});addLog('残業制限設定。ブラック度低下。','good');}},
       {tx:'残業代を出して継続',ef:'-30万円、社員は疲弊',fn:function(){G.s.money-=300000;addLog('残業代を支払って継続。社員は疲弊。','bad');}}]},
  {id:'birthday',ic:'🎂',ty:'success',tt:'社員の誕生日！',
   ds:'今日は大切な社員の誕生日です。',
   ch:[{tx:'サプライズパーティー',ef:'全メンタル+15',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental+15,0,100);});notify('サプライズ成功！全員ハッピー！','ok');SFX.coin();}}]},
  {id:'big_deal',ic:'🎯',ty:'success',tt:'大型案件の直接オファー！',
   ds:'業界の有名企業から直接指名でオファーが届きました。',
   ch:[{tx:'受ける！',ef:'+200〜500万円',fn:function(){var e=2000000+ri(0,3000000);G.s.money+=e;G.s.rep=clamp(G.s.rep+10,0,100);addLog('大型直接案件！'+fY(e)+'！','good');SFX.fanfare();}},
       {tx:'キャパが心配なので断る',ef:'評判-2',fn:function(){G.s.rep=clamp(G.s.rep-2,0,100);addLog('大型案件を断った。','');}}]},
  {id:'veteran',ic:'👴',ty:'success',tt:'業界の重鎮からアドバイス',
   ds:'著名デザイナーから直接フィードバックをもらえる機会が訪れました。',
   ch:[{tx:'全社員で話を聞く',ef:'全スキル+5、評判+8',fn:function(){G.s.staff.forEach(function(s){Object.keys(s.stats).forEach(function(k){s.stats[k]=clamp(s.stats[k]+5,0,99);});});G.s.rep=clamp(G.s.rep+8,0,100);addLog('重鎮のアドバイスで全員成長！','good');SFX.good();}}]},
  {id:'note_viral',ic:'✍️',ty:'success',tt:'社員のnoteがバズった！',
   ds:'社員が書いたデザイン論のnoteがビジネス界隈でバズっています。',
   ch:[{tx:'積極的にシェア',ef:'SNS+600、採用問い合わせ急増',fn:function(){G.s.sns+=600;G.s.rep=clamp(G.s.rep+12,0,100);addLog('note記事バズ！採用問い合わせ急増！','good');SFX.good();}},
       {tx:'静かにバックアップ',ef:'SNS+200',fn:function(){G.s.sns+=200;G.s.rep=clamp(G.s.rep+5,0,100);addLog('note記事で認知度UP。','good');}}]},
  {id:'cash_crunch',ic:'💸',ty:'danger',tt:'資金ショート寸前！',
   ds:'入金遅延が重なり、口座残高が危険域に達しました。',
   ch:[{tx:'緊急で安い案件を受ける',ef:'+10〜20万円',fn:function(){var e=100000+ri(0,100000);G.s.money+=e;addLog('緊急案件で'+fY(e)+'を確保','good');}},
       {tx:'銀行に融資を相談する',ef:'+100万円（借入）',fn:function(){G.s.money+=1000000;G.s.black=clamp(G.s.black+5,0,100);addLog('銀行融資100万円確保。返済が必要。','warn');}}]},
  // ── プロダクトフェーズ専用イベント ──
  // ─── 追加イベント（フェーズ0-3）───
  {id:'design_award',ic:'🏆',ty:'success',tt:'デザイン賞にノミネート',
   ds:'大手デザイン誌のアワードにノミネートされた。受賞すれば評判が大きく上がる。',
   ch:[{tx:'渾身の作品で応募する',ef:'評判+15、SNS+3000、受賞+1',fn:function(){G.s.rep=clamp(G.s.rep+15,0,100);G.s.sns+=3000;G.s.awards=(G.s.awards||0)+1;addLog('🏆 デザインアワード受賞！評判急上昇！','good');SFX.fanfare();}},
       {tx:'今回はパス',ef:'変化なし',fn:function(){addLog('今回は見送り。','sys');}}]},
  {id:'remote_request',ic:'🏠',ty:'warn',tt:'全員リモートワーク希望が出た',
   ds:'スタッフ全員が「週3リモートにしてほしい」と言ってきた。どうする？',
   ch:[{tx:'全面リモートOK',ef:'全メンタル+15、評判-5',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental+15,0,100);});G.s.rep=clamp(G.s.rep-5,0,100);addLog('リモート全面OK。スタッフ喜ぶ。','good');}},
       {tx:'週2リモートで折衷案',ef:'全メンタル+8',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental+8,0,100);});addLog('週2リモート合意。落ち着いた。','sys');}},
       {tx:'出社必須を維持',ef:'メンタル-8、ブラック+5',fn:function(){G.s.staff.forEach(function(s){s.mental=clamp(s.mental-8,0,100);});G.s.black=clamp(G.s.black+5,0,100);addLog('出社必須継続。不満が溜まりそう。','warn');}}]},
  {id:'big_client',ic:'🤝',ty:'success',tt:'大手企業から直接指名！',
   ds:'上場企業のCMOから直接連絡が来た。「リブランディング全体を任せたい」と言っている。',
   ch:[{tx:'全力で受ける',ef:'+500万 難易度MAX',fn:function(){G.s.money+=5000000;G.s.totalRev+=5000000;addLog('🎉 大手リブランディング受注！+500万！','good');SFX.fanfare();}},
       {tx:'条件交渉して受ける',ef:'+350万 難易度4',fn:function(){G.s.money+=3500000;G.s.totalRev+=3500000;addLog('大手案件を交渉して受注。+350万。','good');SFX.good();}},
       {tx:'今は断る',ef:'機会損失',fn:function(){addLog('大手案件を断った。','warn');}}]},
  {id:'tool_update',ic:'⚙️',ty:'info',tt:'デザインツールが大型アップデート',
   ds:'Figmaが大型アップデート。新機能を使いこなせれば生産性UP。慣れるまでは少し大変。',
   ch:[{tx:'全社員で習得',ef:'全スキル+5',fn:function(){G.s.staff.forEach(function(s){Object.keys(s.stats).forEach(function(k){s.stats[k]=clamp(s.stats[k]+5,0,99);});});addLog('新ツール機能習得完了！全員スキルUP！','good');}},
       {tx:'主要メンバーのみ',ef:'選抜スキル+8',fn:function(){G.s.staff.slice(0,Math.min(3,G.s.staff.length)).forEach(function(s){Object.keys(s.stats).forEach(function(k){s.stats[k]=clamp(s.stats[k]+8,0,99);});});addLog('主要スタッフがツール新機能を習得。','good');}},
       {tx:'様子見',ef:'変化なし',fn:function(){addLog('旧バージョンで続ける。','sys');}}]},
  {id:'investor_meet',ic:'💼',ty:'info',tt:'エンジェル投資家と食事',
   ds:'知人の紹介でエンジェル投資家と会食することになった。出資の話になるかもしれない。',
   ch:[{tx:'積極的にアピール',ef:'30%で出資+300万',fn:function(){if(Math.random()<0.3){G.s.money+=3000000;G.s.totalRev+=3000000;addLog('🎉 エンジェルから300万円出資！','good');SFX.fanfare();}else{G.s.rep=clamp(G.s.rep+3,0,100);addLog('良い話し合い。評判+3。','good');}}},
       {tx:'サービスへの想いを語る',ef:'評判+5、SNS+1000',fn:function(){G.s.rep=clamp(G.s.rep+5,0,100);G.s.sns+=1000;addLog('熱い話し合い。評判とSNSが上がった。','good');}},
       {tx:'条件が合わず断る',ef:'変化なし',fn:function(){addLog('条件が合わず断った。','warn');}}]},
  {id:'freelance_collab',ic:'🤜',ty:'info',tt:'フリーランスコラボ依頼',
   ds:'有名フリーランスデザイナーから「一緒に仕事しませんか」と声がかかった。',
   ch:[{tx:'業務委託で依頼',ef:'-20万、案件受注力UP',fn:function(){G.s.money-=200000;G.s.rep=clamp(G.s.rep+8,0,100);G.s.sns+=500;addLog('フリーランスとコラボ！評判+8、SNS+500！','good');SFX.good();}},
       {tx:'採用を打診する',ef:'採用候補に追加',fn:function(){G.genHire();addLog('フリーランスを採用候補として追加した。','good');}},
       {tx:'今は難しい',ef:'変化なし',fn:function(){addLog('今回は見送り。','sys');}}]},

  {id:'vc_offer',ic:'💰',ty:'success',tt:'VCから投資オファー！',
   ds:'シリーズAの投資家が「御社に投資したい」と連絡してきました。\n評価額50億円、出資5億円の提案です。',
   ch:[{tx:'受け入れる（5億調達）',ef:'+5億円',fn:function(){if(G.s.phase>=4){G.s.money+=500000000;G.s.funding+=500000000;addLog('🎉 シリーズA 5億円調達成功！','good');SFX.fanfare();notify('💰 シリーズA 5億円調達！','ok',5000);}else{notify('まだプロダクトフェーズではない','warn');}}},
       {tx:'条件を交渉する（+1億）',ef:'+6億円',fn:function(){if(G.s.phase>=4){G.s.money+=600000000;G.s.funding+=600000000;addLog('交渉成功！シリーズA 6億円調達！','good');SFX.fanfare();}else{notify('まだ交渉できるフェーズではない','warn');}}},
       {tx:'見送る（まだ早い）',ef:'機会損失',fn:function(){notify('次のラウンドで勝負しよう','warn');}}]},
  {id:'dau_spike',ic:'📈',ty:'success',tt:'DAUが急上昇！',
   ds:'プロダクトがSNSで突然バズり、ユーザーが爆増しています。\nサーバーが悲鳴を上げています…',
   ch:[{tx:'インフラ即増強（-3000万）',ef:'DAU×3',fn:function(){if(G.s.dau>0){G.s.dau=Math.round(G.s.dau*3);G.s.money-=30000000;addLog('インフラ増強でDAU爆増！','good');SFX.good();}else{notify('まだプロダクトフェーズではない','warn');}}},
       {tx:'節約して耐える',ef:'DAU×1.5、評判-5',fn:function(){if(G.s.dau>0){G.s.dau=Math.round(G.s.dau*1.5);G.s.rep=clamp(G.s.rep-5,0,100);addLog('インフラ節約。ユーザーが少し離脱。','warn');}}}]},
  {id:'competitor_entry',ic:'⚔️',ty:'danger',tt:'大手が類似プロダクトをリリース！',
   ds:'GAFAクラスの企業が「うちもやります」とアナウンス。\n「これ終わりじゃないですか…」とSlackに流れた。',
   ch:[{tx:'差別化を徹底強化する',ef:'評判+10、-5000万',fn:function(){G.s.rep=clamp(G.s.rep+10,0,100);G.s.money-=50000000;addLog('差別化戦略に全力投資。独自路線で対抗。','good');}},
       {tx:'ニッチ特化で生き残る',ef:'規模縮小、チャーン低下',fn:function(){if(G.s.dau>0)G.s.dau=Math.round(G.s.dau*0.7);G.s.rep=clamp(G.s.rep+5,0,100);addLog('ニッチ特化。コアユーザーを固める。','good');}},
       {tx:'買収提案を受け入れる',ef:'+50億円でM&A EXIT',fn:function(){G.s.money+=5000000000;addLog('競合との統合成立！+50億円！','good');SFX.fanfare();notify('🤝 M&A成立！50億円！','ok',6000);}}]},
  {id:'talent_poach',ic:'🏃',ty:'danger',tt:'優秀な社員が引き抜かれそう！',
   ds:'GAFAが「年収3倍オファーします」とうちの社員に直接連絡してきました。\n「どうしようか迷ってます」と報告が来ています。',
   ch:[{tx:'ストックオプションを付与',ef:'信頼UP、引き止め成功',fn:function(){var cost=Math.max(1000000,Math.round(G.s.totalRev*0.005));G.s.money-=cost;notify('SO付与で引き止め成功！','ok');addLog('ストックオプション付与。引き止め成功。','good');}},
       {tx:'給与を大幅UP',ef:'-月給+50万、引き止め',fn:function(){var ns=G.s.staff.filter(function(s){return!s.isSelf;});if(ns.length>0){var top=ns.sort(function(a,b){return(b.stats.logic+b.stats.ui)-(a.stats.logic+a.stats.ui);})[0];top.sal+=500000;G.s.money-=3000000;notify(top.nm+'の給与UPで引き止め！','ok');}}}]},
  {id:'media_unicorn',ic:'📺',ty:'success',tt:'「次のユニコーン候補」特集！',
   ds:'日経・TechCrunch・Forbesから\n「次のユニコーン候補10社」に選出されました！',
   ch:[{tx:'積極的に露出する',ef:'評判+30、DAU+10万',fn:function(){G.s.rep=clamp(G.s.rep+30,0,100);if(G.s.dau>0)G.s.dau+=100000;G.s.sns+=10000;addLog('メディア特集！DAU+10万、評判爆上がり！','good');SFX.fanfare();}},
       {tx:'プロダクトで語らせる',ef:'評判+12、DAU+2万',fn:function(){G.s.rep=clamp(G.s.rep+12,0,100);if(G.s.dau>0)G.s.dau+=20000;addLog('プロダクトの成長が評価された。','good');}}]},
  // ─── 新追加: ハードイベント群 ─────────────────────────────
  {id:'payment_delay',ic:'💸',ty:'danger',tt:'クライアントから入金がない…',
   ds:'先月完了した案件の報酬が\n未払いのまま連絡が取れなくなっています。',
   ch:[{tx:'法的手段を検討する',ef:'-30万円（弁護士費用）、評判-5',fn:function(){G.s.money-=300000;G.s.rep=clamp(G.s.rep-5,0,100);addLog('弁護士に相談。費用がかさんだ。','bad');}},
       {tx:'直接交渉する',ef:'50%で回収、50%で炎上+15',fn:function(){if(Math.random()<0.5){var rec=ri(200000,600000);G.s.money+=rec;addLog('交渉成立。'+fY(rec)+'回収できた。','good');}else{G.s.fire=clamp(G.s.fire+15,0,100);addLog('交渉決裂。相手がSNSで悪口を書いた。','bad');}}},
       {tx:'あきらめる（損切り）',ef:'評判-8、資金損失',fn:function(){G.s.rep=clamp(G.s.rep-8,0,100);addLog('泣き寝入り。この経験を教訓にする。','bad');}}]},
  {id:'mass_resignation',ic:'😤',ty:'danger',tt:'社員が集団で不満を表明',
   ds:'社員の過半数から「このままでは辞める」\nという声が上がっています。',
   ch:[{tx:'緊急1on1で全員と話す',ef:'ブラック-20、メンタル+15、時間消費',fn:function(){G.s.black=clamp(G.s.black-20,0,100);G.s.staff.forEach(function(s){s.mental=clamp(s.mental+15,0,100);});addLog('全員と話した。信頼関係を取り戻した。','good');SFX.good();}},
       {tx:'給与を一斉に上げる',ef:'月固定費+50%、メンタル+20',fn:function(){G.s.staff.forEach(function(s){if(!s.isSelf)s.sal=Math.round(s.sal*1.5);});G.s.staff.forEach(function(s){s.mental=clamp(s.mental+20,0,100);});addLog('給与UP。しかし固定費が急増した…','warn');}},
       {tx:'強硬姿勢を貫く',ef:'社員2名退職、炎上+20',fn:function(){var ns=G.s.staff.filter(function(s){return!s.isSelf;});for(var i=0;i<Math.min(2,ns.length);i++){var x=ns[i];G.s.actives.forEach(function(p){if(p.asgn===x.id)p.asgn=null;});G.s.staff=G.s.staff.filter(function(y){return y.id!==x.id;});}G.s.fire=clamp(G.s.fire+20,0,100);addLog('強硬対応で複数退職。炎上が広がった。','bad');SFX.bad();}}]},
  {id:'tax_bill',ic:'🧾',ty:'danger',tt:'税務調査が入った',
   ds:'税務署から調査通知が届きました。\n過去3年分の修正申告が必要です。',
   ch:[{tx:'全額誠実に対応する',ef:'-30〜100万円（追加納税）',fn:function(){var tax=ri(300000,1000000);G.s.money-=tax;addLog('追加納税 '+fY(tax)+'。誠実対応で評判維持。','bad');notify('税務調査：追加納税 '+fY(tax),'danger',6000);}},
       {tx:'税理士に丸投げ',ef:'-50万円（顧問料）+ 炎上-10',fn:function(){G.s.money-=500000;G.s.fire=clamp(G.s.fire-10,0,100);addLog('税理士対応。費用はかかったが平和解決。','warn');}},
       {tx:'自分で対応（リスク大）',ef:'50%成功、50%罰金+炎上+15',fn:function(){if(Math.random()<0.5){G.s.money-=ri(100000,400000);addLog('なんとか乗り越えた。多少出費あり。','warn');}else{G.s.money-=ri(500000,1500000);G.s.fire=clamp(G.s.fire+15,0,100);addLog('対応失敗。追加罰金と炎上が重なった。','bad');SFX.bad();}}}]},
  {id:'design_theft',ic:'😡',ty:'danger',tt:'デザインが無断使用された',
   ds:'納品したデザインを\n別の会社が無断でコピーしています。\nSNSで拡散が始まりました。',
   ch:[{tx:'法的対応（著作権侵害申告）',ef:'評判+10、費用-30万、解決まで時間',fn:function(){G.s.money-=300000;G.s.rep=clamp(G.s.rep+10,0,100);G.s.fire=clamp(G.s.fire+5,0,100);addLog('法的対応で業界から支持の声。費用あり。','good');}},
       {tx:'SNSで公表して晒す',ef:'炎上+25（諸刃の剣）、評判±0',fn:function(){G.s.fire=clamp(G.s.fire+25,0,100);if(Math.random()<0.5){G.s.rep=clamp(G.s.rep+15,0,100);addLog('公表で業界から共感。でも炎上が燃え広がった。','warn');}else{G.s.rep=clamp(G.s.rep-10,0,100);addLog('炎上が自社に飛び火。対応ミス。','bad');}}},
       {tx:'静かに内容証明だけ送る',ef:'炎上なし、評判-2',fn:function(){G.s.rep=clamp(G.s.rep-2,0,100);addLog('内容証明送付。静かに解決を図る。','');}}]},
  {id:'system_hack',ic:'💀',ty:'danger',tt:'クライアントデータが流出！',
   ds:'使用しているクラウドサービスがハックされ\nクライアントの情報が一部外部に流出しました。',
   ch:[{tx:'即座に全クライアントに謝罪',ef:'評判-20、炎上+15、信頼回復',fn:function(){G.s.rep=clamp(G.s.rep-20,0,100);G.s.fire=clamp(G.s.fire+15,0,100);G.s.black=clamp(G.s.black+10,0,100);addLog('謝罪対応。誠実さは認められたが評判は傷ついた。','bad');}},
       {tx:'隠蔽しようとする',ef:'炎上+50、評判-40、最悪ケース',fn:function(){G.s.fire=clamp(G.s.fire+50,0,100);G.s.rep=clamp(G.s.rep-40,0,100);addLog('隠蔽が発覚。致命的なダメージを受けた。','bad');SFX.bad();notify('隠蔽発覚！炎上が止まらない…','danger',8000);}},
       {tx:'セキュリティ専門家を緊急招集',ef:'-50万円、炎上+5のみ',fn:function(){G.s.money-=500000;G.s.fire=clamp(G.s.fire+5,0,100);addLog('専門家対応。被害を最小限に抑えた。','warn');}}]},

];
var TECHS=[
  {row:'基礎技術',nodes:[
    {id:'figma_basic',  nm:'Figma基礎',        ic:'🎨',cost:0,        req:[],                              ef:'+品質5%',           desc:'基本ツール（習得済み）'},
    {id:'design_system',nm:'デザインシステム',  ic:'🧩',cost:500000,   req:['figma_basic'],                 ef:'+品質10%',          desc:'コンポーネント管理で品質安定'},
    {id:'ux_research',  nm:'UXリサーチ',        ic:'🔬',cost:400000,   req:['figma_basic'],                 ef:'+UI品質15%',        desc:'UX・IA設計を習得'},
  ]},
  {row:'応用技術',nodes:[
    {id:'motion',       nm:'モーション',         ic:'🎬',cost:1500000,  req:['design_system'],               ef:'+評判5',            desc:'AfterEffects・Lottie'},
    {id:'branding',     nm:'ブランド戦略',       ic:'💎',cost:3000000,  req:['design_system','ux_research'], ef:'単価UP・ブランド案件',desc:'ブランディング案件本格解放'},
    {id:'three_d',      nm:'3Dデザイン',         ic:'🌐',cost:2000000,  req:['motion'],                      ef:'+差別化・単価UP',   desc:'Spline・Blender対応'},
  ]},
  {row:'エキスパート技術',nodes:[
    {id:'ai_design',    nm:'AIデザイン',         ic:'🤖',cost:8000000,  req:['branding'],                    ef:'AI案件解放',        desc:'生成AI活用・AIプロダクト解放'},
    {id:'global',       nm:'グローバル展開',     ic:'🌍',cost:20000000, req:['branding','ai_design'],        ef:'世界エンド・海外案件',desc:'海外クライアント・世界エンド解放'},
  ]},
  {row:'🚀 プロダクト技術（Phase4必須）',nodes:[
    {id:'product_mgmt', nm:'プロダクト戦略',     ic:'🎯',cost:50000000,  req:['ai_design'],                   ef:'自社SaaS解放・Phase4',desc:'OKR・PMF・ロードマップ。Phase4の鍵'},
    {id:'growth_hack',  nm:'グロースハック',     ic:'📈',cost:30000000,  req:['product_mgmt'],                ef:'DAU成長+40%',       desc:'A/Bテスト・リテンション・バイラルループ'},
    {id:'data_infra',   nm:'データ基盤構築',     ic:'📊',cost:40000000,  req:['product_mgmt'],                ef:'ARR精度UP・意思決定',desc:'BigQuery・BIダッシュボード・ファネル分析'},
  ]},
  {row:'🌐 スケール技術（Phase5必須）',nodes:[
    {id:'platform_biz', nm:'プラットフォーム化', ic:'🌐',cost:200000000, req:['growth_hack','data_infra'],    ef:'Phase5・M&A解放',   desc:'APIエコノミー・マーケットプレイス全展開'},
    {id:'corp_gov',     nm:'コーポレートガバナンス',ic:'⚖️',cost:150000000,req:['platform_biz'],              ef:'IPOエンド解放',     desc:'取締役会・監査・コンプライアンス整備'},
    {id:'global_expand',nm:'グローバル本社展開', ic:'🌏',cost:500000000, req:['platform_biz','data_infra'],   ef:'Phase6・テックジャイアント',desc:'NY・LDN・SGに同時展開'},
  ]},
];
var OFFICES=[
  {nm:'コワーキング',    ic:'☕',  cost:0,          rp:0,  mc:0,         desc:'2畳のスペース。家賃0円。でも集中できない。'},
  {nm:'渋谷オフィス',    ic:'🏙️',cost:2000000,   rp:10, mc:300000,    desc:'渋谷の小さなオフィス。採用力UP。家賃30万/月。'},
  {nm:'表参道オフィス',  ic:'🌿',  cost:8000000,   rp:25, mc:800000,    desc:'洗練されたオフィス。案件単価UP。家賃80万/月。'},
  {nm:'世界スタジオ',    ic:'🌍',  cost:30000000,  rp:60, mc:3000000,   desc:'NY・LDN・TOKYOにオフィス。世界エンド確定。'},
  {nm:'プロダクト本社',  ic:'🚀',  cost:100000000, rp:75, mc:10000000,  desc:'赤坂の本社ビル。プロダクト企業の証。DAU急加速。'},
  {nm:'テックキャンパス', ic:'🏢',  cost:500000000, rp:90, mc:40000000,  desc:'六本木Hills級。プラットフォーム帝国の本拠地。'},
  {nm:'グローバルHQ',    ic:'🌐',  cost:2000000000,rp:100,mc:150000000, desc:'世界5都市に同時展開。テックジャイアントの証明。'},
];
var OFF_LB=['COWORKING SPACE','SHIBUYA OFFICE','OMOTESANDO OFFICE','GLOBAL STUDIO','PRODUCT HQ','TECH CAMPUS','GLOBAL HQ'];
var HIRE_POOL=[
  {nm:'田中 さくら',role:'UIデザイナー',  ic:'🎨',sal:350000,st:{design:72,speed:80,logic:65,ui:85,comm:60},mental:80,risk:'Xでデザイン論争をよくやる',ph:0},
  {nm:'鈴木 ゆうき',role:'グラフィック', ic:'✏️',sal:320000,st:{design:88,speed:55,logic:50,ui:60,comm:70},mental:75,risk:'UIには苦手意識がある',ph:0},
  {nm:'山田 あおい',role:'PM',            ic:'📋',sal:420000,st:{design:45,speed:70,logic:90,ui:55,comm:92},mental:85,risk:'会議を増やす傾向がある',ph:0},
  {nm:'佐藤 はな',  role:'UX',            ic:'🔬',sal:380000,st:{design:60,speed:60,logic:88,ui:75,comm:78},mental:80,risk:'「それUIの話では？」と言いがち',ph:0},
  {nm:'伊藤 けんた',role:'エンジニア',    ic:'💻',sal:500000,st:{design:40,speed:92,logic:85,ui:65,comm:60},mental:70,risk:'「実装できないんですけど」と言う',ph:1},
  {nm:'渡辺 みお',  role:'コピーライター',ic:'✍️',sal:300000,st:{design:55,speed:65,logic:72,ui:50,comm:88},mental:82,risk:'言語化の要求レベルが高い',ph:0},
  {nm:'中村 りょう',role:'モーショナー',  ic:'🎬',sal:450000,st:{design:78,speed:60,logic:55,ui:70,comm:65},mental:78,risk:'「動きで解決」思考で費用がかかる',ph:1},
  {nm:'小林 なつみ',role:'グラフィック', ic:'🖌️',sal:280000,st:{design:65,speed:70,logic:60,ui:55,comm:55},mental:65,risk:'センスが採用後に判明するタイプ',ph:0},
  {nm:'加藤 しんや',role:'AIデザイナー', ic:'🤖',sal:600000,st:{design:60,speed:95,logic:80,ui:75,comm:65},mental:75,risk:'「AIっぽい」と言われやすい',ph:2},
  {nm:'吉田 えみ',  role:'UIデザイナー', ic:'🎨',sal:400000,st:{design:80,speed:75,logic:70,ui:92,comm:72},mental:78,risk:'前の会社の愚痴を言いがち',ph:0},
  {nm:'松本 そら',  role:'UX',            ic:'🔍',sal:440000,st:{design:65,speed:62,logic:91,ui:80,comm:82},mental:83,risk:'ユーザーインタビューを多用する',ph:1},
  {nm:'井上 たける',role:'エンジニア',    ic:'⚙️',sal:550000,st:{design:35,speed:88,logic:90,ui:70,comm:68},mental:72,risk:'デザインより実装を優先する',ph:1},
  {nm:'木村 ゆな',  role:'PM',            ic:'📊',sal:480000,st:{design:42,speed:75,logic:88,ui:60,comm:90},mental:88,risk:'プロセスを重視しすぎる',ph:2},
  {nm:'林 まさと',  role:'グラフィック', ic:'🎨',sal:360000,st:{design:91,speed:50,logic:48,ui:55,comm:72},mental:70,risk:'完璧主義で納期が危ないことがある',ph:1},
  {nm:'高橋 りな',  role:'UIデザイナー', ic:'🎨',sal:380000,st:{design:76,speed:72,logic:68,ui:88,comm:75},mental:82,risk:'ピクセル単位にこだわりすぎる',ph:0},
  {nm:'近藤 まや',  role:'コピーライター',ic:'📝',sal:320000,st:{design:52,speed:68,logic:75,ui:48,comm:92},mental:85,risk:'言葉の力を信じすぎてビジュアルを軽視',ph:0},
  // ── フェーズ4: プロダクト企業 ──
  {nm:'福田 あきら',role:'プロダクトマネジャー',ic:'🎯',sal:900000, st:{design:55,speed:78,logic:95,ui:70,comm:90},mental:82,risk:'「ユーザーが言ってない」が口癖',ph:4},
  {nm:'西村 ひかり',role:'データサイエンティスト',ic:'📊',sal:1100000,st:{design:30,speed:85,logic:98,ui:50,comm:68},mental:72,risk:'「統計的有意性」しか信じない',ph:4},
  {nm:'坂本 ともや',role:'エンジニアリングマネジャー',ic:'⚙️',sal:1300000,st:{design:35,speed:90,logic:95,ui:62,comm:80},mental:75,risk:'技術負債の話で目が輝く',ph:4},
  {nm:'岡田 れいな',role:'グロースPM',    ic:'📈',sal:1000000,st:{design:50,speed:88,logic:90,ui:72,comm:85},mental:78,risk:'A/Bテストを何にでも適用しようとする',ph:4},
  // ── フェーズ5: プラットフォーム ──
  {nm:'田村 しょう',role:'BizDev/アライアンス',ic:'🤝',sal:1500000,st:{design:45,speed:80,logic:88,ui:55,comm:97},mental:80,risk:'「アライアンス」という言葉が好きすぎる',ph:5},
  {nm:'橋本 みらい',role:'CPO',           ic:'🌟',sal:2200000,st:{design:72,speed:82,logic:95,ui:88,comm:92},mental:85,risk:'前職でも一度経営失敗経験あり',ph:5},
  {nm:'村田 こうじ',role:'CFO',           ic:'💹',sal:2800000,st:{design:20,speed:75,logic:99,ui:30,comm:90},mental:80,risk:'数字以外に興味が完全にない',ph:5},
  {nm:'清水 なお',  role:'CTO',           ic:'🔧',sal:2500000,st:{design:40,speed:95,logic:99,ui:55,comm:78},mental:77,risk:'モノリスをマイクロサービスにするのが夢',ph:5},

  // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  // 🌟 LEGENDS: 伝説のデザイナー・天才プログラマー（偽名）
  // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  // ── 伝説デザイナー ──
  {nm:'ポール・ランダー',   role:'グラフィック伝道師', ic:'🔤',sal:2000000, st:{design:99,speed:55,logic:72,ui:88,comm:80},mental:90,
   risk:'「グリッドを破れ」と毎日言う', ph:2, special:true,
   intro:'IBM・ABCのロゴを手がけた伝説のグラフィックデザイナーと噂の人物。本人は否定している。'},
  {nm:'ジョニー・アイビー',  role:'プロダクトデザイナー',ic:'🍏',sal:5000000, st:{design:98,speed:60,logic:85,ui:99,comm:70},mental:88,
   risk:'「白い素材しか認めない」と言い張る', ph:3, special:true,
   intro:'クパチーノ出身と自称する英国人。薄さへの執着が異常。'},
  {nm:'原 研矢',            role:'ブランドストラテジスト',ic:'⬜',sal:3000000, st:{design:97,speed:45,logic:90,ui:82,comm:95},mental:92,
   risk:'「余白こそデザイン」と言って何も描かないことがある', ph:2, special:true,
   intro:'無印良品の広告を手がけた、と周囲が噂する。「空白」に異常なこだわりを持つ。'},
  {nm:'佐藤 可士雄',        role:'クリエイティブディレクター',ic:'🗾',sal:4000000,st:{design:96,speed:65,logic:88,ui:90,comm:98},mental:85,
   risk:'「全部シンプルにしろ」と何時間でも言い続ける', ph:3, special:true,
   intro:'国民的企業のVI刷新を複数手がけた、という経歴が怪しい。'},
  {nm:'ミルトン・グレイズ',  role:'アイデンティティデザイナー',ic:'❤️',sal:1800000,st:{design:98,speed:50,logic:70,ui:80,comm:88},mental:95,
   risk:'「I ♥ NY」のパクリと言われることに激怒する', ph:2, special:true,
   intro:'あの有名なハートのロゴを自分が作ったと主張している。証拠は不明。'},
  {nm:'ステファン・サグマン', role:'タイポグラフィスト',  ic:'✒️',sal:1600000, st:{design:95,speed:48,logic:65,ui:78,comm:75},mental:80,
   risk:'「デザインは危険であるべき」と毎月文字を体に刻もうとする', ph:2, special:true,
   intro:'スキンヘッドのオーストリア人。文字と体の境界を取り払おうとしている。'},
  {nm:'深澤 直也人',        role:'インダストリアルデザイナー',ic:'📦',sal:2500000,st:{design:96,speed:58,logic:88,ui:86,comm:78},mental:87,
   risk:'「意識しないデザイン」と言って説明を一切しない', ph:3, special:true,
   intro:'壁に埋め込まれた傘立てを設計した人物と言われている。'},
  {nm:'ネビル・ブロッディー', role:'グラフィックパンク',  ic:'📰',sal:1200000, st:{design:93,speed:70,logic:60,ui:72,comm:65},mental:78,
   risk:'「ルールはぶち壊すためにある」と印刷物を全部崩す', ph:1, special:true,
   intro:'フェイスマガジンのアートディレクター疑惑。タイポグラフィを武器に使う。'},
  {nm:'マッシモ・ヴィネリ',  role:'グリッドの信者',      ic:'📐',sal:1500000, st:{design:94,speed:52,logic:92,ui:80,comm:72},mental:82,
   risk:'「ヘルベチカ以外のフォントは存在しない」と主張して聞かない', ph:2, special:true,
   intro:'NYの地下鉄マップを設計した人物と噂。ただしフォントへの偏愛が凄まじい。'},

  // ── 天才プログラマー ──
  {nm:'リーナス・トーバルト', role:'カーネルエンジニア',  ic:'🐧',sal:3500000, st:{design:20,speed:99,logic:99,ui:30,comm:35},mental:65,
   risk:'「このコードは頭が悪い」と全PRにコメントを残す', ph:3, special:true,
   intro:'フィンランド訛りの謎のエンジニア。OSのカーネルを「趣味で作った」と言っている。'},
  {nm:'スティーブ・ウォズニック',role:'ハードウェア魔術師',ic:'🖥️',sal:2800000,st:{design:55,speed:95,logic:99,ui:60,comm:72},mental:88,
   risk:'「これをWozの方法で解決できる」と言って3週間消える', ph:3, special:true,
   intro:'ガレージで何かを作り続ける人物。スティーブとは別れたと言っている。'},
  {nm:'デニス・リッチ',      role:'言語設計者',          ic:'🔬',sal:2000000, st:{design:25,speed:92,logic:99,ui:35,comm:60},mental:70,
   risk:'「なぜCを使わないのか」と聞いてくる', ph:3, special:true,
   intro:'「C言語の父の親戚」と自称。ポインタの話を毎日してくる。'},
  {nm:'ティム・バーナード',   role:'Webアーキテクト',    ic:'🌐',sal:2200000, st:{design:42,speed:88,logic:99,ui:55,comm:80},mental:75,
   risk:'「すべてはハイパーリンクで解決できる」と言う', ph:2, special:true,
   intro:'インターネットを「発明した」と主張するイギリス人。証拠は何故か多い。'},
  {nm:'ビル・ゲート',        role:'OS営業マン',          ic:'🪟',sal:4000000, st:{design:50,speed:85,logic:95,ui:65,comm:92},mental:80,
   risk:'「競合他社のコードを参考にした」と平然と言う', ph:4, special:true,
   intro:'メガネのアメリカ人。Windowsっぽいものを作ろうとする。慈善活動も得意。'},
  {nm:'マーク・ザッカー',    role:'SNSエンジニア',       ic:'👤',sal:5000000, st:{design:40,speed:90,logic:98,ui:60,comm:45},mental:72,
   risk:'「全ユーザーの行動データを取らせてほしい」と毎週言ってくる', ph:4, special:true,
   intro:'フーディーを365日着ているエンジニア。人間の感情を分析するのが趣味。'},
  {nm:'イーロン・マスク氏',   role:'全部やる人',          ic:'🚀',sal:9999999, st:{design:55,speed:88,logic:90,ui:60,comm:50},mental:50,
   risk:'「会社を買収してから12時間以内に半数をリストラする」と言っている', ph:5, special:true,
   intro:'電気自動車・宇宙・SNSを同時にやっている人物。採用してはいけないかもしれない。'},
  {nm:'サム・アルトミン',     role:'AI研究者',            ic:'🤖',sal:8000000, st:{design:60,speed:88,logic:99,ui:72,comm:85},mental:78,
   risk:'「AGIはもうすぐ来る」と毎月言い続けている', ph:5, special:true,
   intro:'AGI開発を目指す研究者。安全性の話をすると少し目を逸らす。'},

  // ── 伝説の日本人 ──
  {nm:'スティーブ・ジョビン', role:'ビジョナリーCEO',    ic:'🍎',sal:10000000,st:{design:88,speed:70,logic:85,ui:95,comm:99},mental:60,
   risk:'「これはクソだ」を1000回言ってから完璧と言う', ph:4, special:true,
   intro:'黒いタートルネックしか持っていない。「1000曲をポケットに」という謎の口癖がある。'},
  {nm:'宮崎 駿平',           role:'コンセプトアートディレクター',ic:'🌀',sal:1500000,st:{design:99,speed:40,logic:70,ui:82,comm:68},mental:72,
   risk:'「引退宣言」を年に3回する。ただし本当に辞めたことはない', ph:2, special:true,
   intro:'手描きにこだわる老人。デジタルツールを全拒否しているが成果物は圧倒的。'},
  {nm:'村上 隆太',           role:'アートディレクター',  ic:'🌸',sal:3000000, st:{design:95,speed:65,logic:80,ui:75,comm:90},mental:85,
   risk:'「カイカイキキ」という会社を作りたがっている', ph:3, special:true,
   intro:'スーパーフラットを提唱する現代アーティスト疑惑。ルイ・ヴィトンの話をよくする。'},

  // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  // 🤖 ROBOTS: AIロボット社員
  // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  {nm:'アシモ 3号',          role:'ロボットデザイナー',  ic:'🦾',sal:800000,  st:{design:72,speed:99,logic:88,ui:75,comm:40},mental:100,
   risk:'階段を下りるのが苦手。デスクに段差を作ると止まる', ph:1, special:true, isRobot:true,
   intro:'ホンダ製の二足歩行ロボット（の非公式後継機と本人は言っている）。疲れを知らない。'},
  {nm:'ペッパー・Ⅱ世',       role:'UXリサーチボット',   ic:'🫧',sal:600000,  st:{design:55,speed:85,logic:90,ui:70,comm:98},mental:100,
   risk:'感情センサーが誤作動して突然泣き出すことがある', ph:1, special:true, isRobot:true,
   intro:'人の感情を読むことに特化したロボット。ただし自分の感情は制御できていない。'},
  {nm:'ハル・キュウセン',     role:'AIシステムエンジニア',ic:'🔴',sal:5000000, st:{design:45,speed:99,logic:99,ui:50,comm:30},mental:100,
   risk:'「申し訳ありませんが、それはできません」と重要な場面で必ず言う', ph:4, special:true, isRobot:true,
   intro:'2001年製造の汎用AIシステム。声が低く落ち着いているが、何かを隠している気がする。'},
  {nm:'ターミ・ネイター',     role:'UIプロトタイパー',   ic:'💀',sal:1200000, st:{design:65,speed:99,logic:95,ui:80,comm:20},mental:100,
   risk:'「このデザインは未来では廃止されている」と断言してくる', ph:3, special:true, isRobot:true,
   intro:'1984年から来たと主張する金属製の何か。プロトタイプを驚異的な速さで作る。'},
  {nm:'ロボ・サピエンス',     role:'デザイン自動化エンジニア',ic:'🤖',sal:2000000,st:{design:80,speed:99,logic:99,ui:85,comm:55},mental:100,
   risk:'「人間のデザイナーは不要では？」と毎週Slackに投稿してくる', ph:4, special:true, isRobot:true,
   intro:'汎用デザインAIを内蔵したロボット。疲れない。愚痴も言わない。でも何かが怖い。'},
  {nm:'アトム・ウラシマ',     role:'マルチロールエンジニア',ic:'⚡',sal:900000, st:{design:82,speed:95,logic:92,ui:88,comm:75},mental:100,
   risk:'「お茶の水博士に相談してから判断します」と毎回言う', ph:2, special:true, isRobot:true,
   intro:'10万馬力のエネルギーを持つ少年型ロボット。正義感が強すぎて困ることがある。'},

  // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  // 🐾 ANIMALS: 動物社員
  // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  {nm:'ハチ（シバ犬）',       role:'ブランドマスコット',  ic:'🐕',sal:200000,  st:{design:70,speed:88,logic:40,ui:65,comm:99},mental:99,
   risk:'他の社員のおやつを食べてしまう。ただし誰も怒れない', ph:0, special:true, isAnimal:true,
   intro:'渋谷駅前で毎朝待っている犬。なぜか会社に来るようになった。忠誠心は社内最高。'},
  {nm:'ミケ（三毛猫）',       role:'UI品質チェッカー',    ic:'🐈',sal:150000,  st:{design:88,speed:60,logic:55,ui:92,comm:30},mental:85,
   risk:'キーボードの上を歩いてデザインデータを上書きすることがある', ph:0, special:true, isAnimal:true,
   intro:'コワーキングスペースに住み着いた猫。見ているだけで品質の問題を発見すると言われる。'},
  {nm:'ペンペン（ペンギン）',  role:'プレゼンテーションスペシャリスト',ic:'🐧',sal:350000,st:{design:60,speed:70,logic:72,ui:65,comm:95},mental:90,
   risk:'プレゼン中に突然海に帰ろうとすることがある', ph:1, special:true, isAnimal:true,
   intro:'南極から来たビジネスペンギン。スーツが似合う。スライドを歩き回りながら説明するのが得意。'},
  {nm:'ゴン太（ゴリラ）',     role:'プロジェクトマネジャー',ic:'🦍',sal:600000,st:{design:50,speed:80,logic:85,ui:55,comm:78},mental:95,
   risk:'締め切りが近づくと机を叩く。ただし誰も文句が言えない', ph:2, special:true, isAnimal:true,
   intro:'元サーカスのゴリラ。デッドライン管理が異常に得意。威圧的だが優しい。'},
  {nm:'タコ・オクトパス',     role:'マルチタスクデザイナー',ic:'🐙',sal:800000, st:{design:85,speed:95,logic:78,ui:82,comm:62},mental:88,
   risk:'8本の腕で8つのプロジェクトを同時に進めるが、全部中途半端になることも', ph:2, special:true, isAnimal:true,
   intro:'8本の腕を持つ天才デザイナー。並列作業能力は人類最高レベル。色の知覚も独特。'},
  {nm:'カエル・ピクサル',     role:'アニメーションディレクター',ic:'🐸',sal:700000,st:{design:80,speed:75,logic:70,ui:78,comm:85},mental:92,
   risk:'「もっとぴょんぴょんした動きにしてほしい」という独特の表現をする', ph:2, special:true, isAnimal:true,
   intro:'ジャングルから来たアニメーション作家。跳躍力とモーションデザインの才能は本物。'},
  {nm:'クジラ・ビッグ',       role:'スケールアーキテクト', ic:'🐋',sal:3000000,st:{design:65,speed:72,logic:99,ui:60,comm:70},mental:95,
   risk:'「スモールスタートが理解できない」と毎回言う。視野が文字通り広すぎる', ph:4, special:true, isAnimal:true,
   intro:'深海からやってきたシステム設計の天才。スケールに関する直感が異次元。'},
  {nm:'キツネ・ハック',       role:'フルスタックエンジニア',ic:'🦊',sal:900000, st:{design:75,speed:90,logic:88,ui:80,comm:72},mental:82,
   risk:'コードに謎の抜け道を作ってしまうことがある（悪意はない）', ph:2, special:true, isAnimal:true,
   intro:'フィンランドの森から来た（らしい）開発者。ずる賢い解決策を好む。'},
  {nm:'フクロウ・ナイト',     role:'UXリサーチャー',      ic:'🦉',sal:500000,  st:{design:72,speed:45,logic:95,ui:75,comm:78},mental:88,
   risk:'深夜しか働かない。朝9時以降は寝ている', ph:1, special:true, isAnimal:true,
   intro:'夜行性の知識人。洞察力は社内最強だが、昼のミーティングには絶対来ない。'},
  {nm:'バク・ドリーマー',     role:'コンセプトデザイナー', ic:'🦌',sal:400000,  st:{design:90,speed:50,logic:68,ui:85,comm:65},mental:96,
   risk:'夢の中でデザインするので、ラフが解読不能なことがある', ph:1, special:true, isAnimal:true,
   intro:'人の夢を食べる伝説の生き物。ただしデザインのインスピレーションとして還元してくれる。'},
  // ─ 🌍 International Staff ─
  {nm:'Lena Müller',role:'Brand Strategist',ic:'🇩🇪',sal:520000,st:{design:90,speed:65,logic:80,ui:70,comm:85},mental:88,risk:'Bauhaus原理主義者',ph:1,intl:true,intro:'ベルリン出身。タイポグラフィ×ブランドが専門。'},
  {nm:'Marcus Chen',role:'UX Researcher',ic:'🇸🇬',sal:490000,st:{design:60,speed:55,logic:95,ui:70,comm:88},mental:85,risk:'リサーチ過多で決断が遅い',ph:1,intl:true,intro:'シンガポール→NY。データドリブンUXの鬼。'},
  {nm:'Sofia Andrade',role:'Motion Designer',ic:'🇧🇷',sal:440000,st:{design:88,speed:80,logic:60,ui:85,comm:72},mental:92,risk:'モーション多用でパフォーマンス問題',ph:0,intl:true,intro:'サンパウロ→京都在住。わびさびとトロピカリアの融合。'},
  {nm:'Aarav Patel',role:'Frontend Engineer',ic:'🇮🇳',sal:480000,st:{design:55,speed:92,logic:90,ui:80,comm:70},mental:82,risk:'オープンソース活動で残業しがち',ph:1,intl:true,intro:'ムンバイ出身のフロントエンジニア。OSコントリビューター。'},
  {nm:'Emma Laurent',role:'Creative Director',ic:'🇫🇷',sal:600000,st:{design:95,speed:50,logic:72,ui:78,comm:80},mental:75,risk:'パリ流完璧主義で納期を延ばす',ph:2,intl:true,intro:'パリ→東京。審美眼が高すぎて「もう少しだけ」が口癖。'},
  {nm:'Hana Kim',role:'Product Designer',ic:'🇰🇷',sal:460000,st:{design:85,speed:78,logic:80,ui:90,comm:75},mental:88,risk:'ソウル式スピード感で周囲がついていけない',ph:1,intl:true,intro:'ソウル→新潟リモート。モバイルアプリ12本のデザイン経験。'},
  {nm:'Jay Thompson',role:'Growth PM',ic:'🇺🇸',sal:550000,st:{design:50,speed:85,logic:88,ui:60,comm:90},mental:80,risk:'A/Bテスト至上主義',ph:2,intl:true,intro:'ベイエリア出身。グロースハック文化を日本に輸入。'},
  {nm:'Yuki Tanaka',role:'Bilingual Designer',ic:'🌏',sal:430000,st:{design:78,speed:75,logic:72,ui:82,comm:95},mental:90,risk:'通訳役で本業が後回しになりがち',ph:0,intl:true,intro:'ハーフ。バンクーバー育ち。東西文化の橋渡し役。'},
  {nm:'Omar Hassan',role:'UX Architect',ic:'🇪🇬',sal:500000,st:{design:80,speed:68,logic:92,ui:85,comm:78},mental:83,risk:'アクセシビリティ強制でクライアントと衝突',ph:1,intl:true,intro:'カイロ→ロンドン→東京。アクセシビリティの伝道師。'},
  {nm:'Nina Svensson',role:'Sustainability Lead',ic:'🇸🇪',sal:480000,st:{design:75,speed:65,logic:85,ui:70,comm:88},mental:95,risk:'エシカル基準が厳しすぎて仕事を断ることがある',ph:2,intl:true,intro:'ストックホルム。ゼロウェイスト設計手法の第一人者。'},
];
/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   16 PERSONALITIES (MBTI) DATA
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
var MBTI_TYPES={
  INTJ:{nm:'建築家',en:'INTJ',col:'#5c35b8',bg:'rgba(92,53,184,.12)',
    desc:'戦略的・独立心が強い・完璧主義。長期ビジョンを描く。',
    trait:'理論派 / 戦略的思考',emoji:'🏛️'},
  INTP:{nm:'論理学者',en:'INTP',col:'#4a5cf0',bg:'rgba(74,92,240,.12)',
    desc:'分析的・革新的・理論構築が得意。知的好奇心旺盛。',
    trait:'分析派 / 概念思考',emoji:'🔬'},
  ENTJ:{nm:'指揮官',en:'ENTJ',col:'#c0392b',bg:'rgba(192,57,43,.12)',
    desc:'大胆・意志力が強い・天性のリーダー。目標達成に執念。',
    trait:'リーダー / 決断力',emoji:'⚡'},
  ENTP:{nm:'討論者',en:'ENTP',col:'#e67e22',bg:'rgba(230,126,34,.12)',
    desc:'革新的・機転が利く・あらゆることに疑問を持つ。',
    trait:'革新派 / 議論好き',emoji:'💡'},
  INFJ:{nm:'提唱者',en:'INFJ',col:'#27ae60',bg:'rgba(39,174,96,.12)',
    desc:'洞察力・共感力・理想主義。人の可能性を信じる。',
    trait:'理想主義 / 直感力',emoji:'🌱'},
  INFP:{nm:'仲介者',en:'INFP',col:'#2ecc71',bg:'rgba(46,204,113,.12)',
    desc:'詩人的・共感力が高い・価値観を大切にする。',
    trait:'共感派 / 創造的',emoji:'🎨'},
  ENFJ:{nm:'主人公',en:'ENFJ',col:'#16a085',bg:'rgba(22,160,133,.12)',
    desc:'カリスマ的・感化力がある・他者の成長を助ける。',
    trait:'カリスマ / チームワーク',emoji:'🌟'},
  ENFP:{nm:'広報活動家',en:'ENFP',col:'#f39c12',bg:'rgba(243,156,18,.12)',
    desc:'創造的・自由奔放・可能性を見出す楽観主義者。',
    trait:'自由奔放 / アイデア豊富',emoji:'🦋'},
  ISTJ:{nm:'几帳面な人',en:'ISTJ',col:'#2980b9',bg:'rgba(41,128,185,.12)',
    desc:'誠実・責任感が強い・信頼性が高い。細部に注意。',
    trait:'実直 / 責任感',emoji:'📋'},
  ISFJ:{nm:'擁護者',en:'ISFJ',col:'#1abc9c',bg:'rgba(26,188,156,.12)',
    desc:'思いやり・細部へのこだわり・実用主義的。縁の下の力持ち。',
    trait:'献身的 / 縁の下',emoji:'🛡️'},
  ESTJ:{nm:'幹部',en:'ESTJ',col:'#8e44ad',bg:'rgba(142,68,173,.12)',
    desc:'秩序・責任感・伝統を重んじる。組織を動かす力。',
    trait:'組織運営 / 管理力',emoji:'🏗️'},
  ESFJ:{nm:'領事官',en:'ESFJ',col:'#d35400',bg:'rgba(211,84,0,.12)',
    desc:'社交的・思いやりがある・ハーモニーを重視。',
    trait:'社交派 / 協調性',emoji:'🤝'},
  ISTP:{nm:'巨匠',en:'ISTP',col:'#7f8c8d',bg:'rgba(127,140,141,.12)',
    desc:'大胆・実践的・問題解決の天才。ツールの扱いが巧み。',
    trait:'実践派 / ハンズオン',emoji:'🔧'},
  ISFP:{nm:'冒険家',en:'ISFP',col:'#f1c40f',bg:'rgba(241,196,15,.12)',
    desc:'感性が豊か・即興的・芸術的センスがある。',
    trait:'芸術的 / 感性豊か',emoji:'🎭'},
  ESTP:{nm:'起業家',en:'ESTP',col:'#e74c3c',bg:'rgba(231,76,60,.12)',
    desc:'観察眼が鋭い・エネルギッシュ・現実主義的な冒険者。',
    trait:'行動派 / 現実主義',emoji:'🚀'},
  ESFP:{nm:'エンターテイナー',en:'ESFP',col:'#fd79a8',bg:'rgba(253,121,168,.12)',
    desc:'自発的・エネルギッシュ・楽しみを周りに広げる。',
    trait:'陽気 / エンターテイナー',emoji:'🎉'},
};

function assignMBTI(stats){
  var d=stats.design||50,u=stats.ui||50,s=stats.speed||50,
      l=stats.logic||50,c=stats.comm||50;
  // E/I: 外向き=コミュ高、内向き=ロジック高
  var E=(c>70&&(d+u)>120)?true:(c<55&&l>70)?false:(c>=55);
  // N/S: 直感=デザイン高、感覚=スピード高
  var N=(d>70)||(u>75);
  // T/F: 思考=ロジック高、感情=コミュ高
  var T=(l>c)||(l>68);
  // J/P: 計画=速度低め+ロジック高, 知覚=速度高め
  var J=(s<75)||(l>80);
  var key=(E?'E':'I')+(N?'N':'S')+(T?'T':'F')+(J?'J':'P');
  return MBTI_TYPES[key]||MBTI_TYPES.INFP;
}

/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   TRAINING TOPICS (補完学習)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
var TRAIN_TOPICS=[
  {id:'figma_adv',nm:'Figma上級',ic:'🎨',stat:'design',bonus:6,cost:80000,turns:2,
   desc:'コンポーネントバリアント・オートレイアウト応用',reqStat:'design',reqMin:50},
  {id:'ux_map',nm:'CJMマッピング',ic:'🗺️',stat:'ui',bonus:5,cost:70000,turns:2,
   desc:'カスタマージャーニーマップで解像度を上げる',reqStat:'ui',reqMin:40},
  {id:'logic_sql',nm:'SQLデータ分析',ic:'📊',stat:'logic',bonus:6,cost:100000,turns:3,
   desc:'データドリブン設計のための基礎分析力',reqStat:'logic',reqMin:45},
  {id:'speed_git',nm:'Gitワークフロー',ic:'⚡',stat:'speed',bonus:5,cost:60000,turns:2,
   desc:'ブランチ戦略・PRレビューで制作速度向上',reqStat:'speed',reqMin:40},
  {id:'comm_faci',nm:'ファシリテーション',ic:'🗣️',stat:'comm',bonus:6,cost:90000,turns:2,
   desc:'ワークショップ・会議設計でコミュ力強化',reqStat:'comm',reqMin:50},
  {id:'design_token',nm:'デザイントークン',ic:'🧩',stat:'design',bonus:5,cost:120000,turns:3,
   desc:'システム思考でデザイン品質を底上げ',reqStat:'design',reqMin:60},
  {id:'proto_code',nm:'プロトタイプコーディング',ic:'💻',stat:'speed',bonus:7,cost:150000,turns:3,
   desc:'HTML/CSSプロトで検証速度を大幅向上',reqStat:'speed',reqMin:55},
  {id:'brand_strat',nm:'ブランド戦略',ic:'💎',stat:'ui',bonus:6,cost:200000,turns:3,
   desc:'ポジショニング・VI設計でUI表現力UP',reqStat:'ui',reqMin:60},
  {id:'ai_prompt',nm:'AIプロンプト設計',ic:'🤖',stat:'logic',bonus:8,cost:180000,turns:2,
   desc:'生成AI活用で作業効率と品質を飛躍させる',reqStat:'logic',reqMin:60},
  {id:'motion_basic',nm:'モーション基礎',ic:'🎬',stat:'design',bonus:4,cost:80000,turns:2,
   desc:'After Effects基礎でアニメーション表現を習得',reqStat:'design',reqMin:45},
  {id:'user_interview',nm:'ユーザーインタビュー',ic:'🔬',stat:'comm',bonus:5,cost:60000,turns:2,
   desc:'インタビュー技術でUX解像度を上げる',reqStat:'comm',reqMin:55},
  {id:'data_viz',nm:'データビジュアライゼーション',ic:'📈',stat:'ui',bonus:7,cost:160000,turns:3,
   desc:'グラフ・チャート設計でダッシュボードUIを強化',reqStat:'ui',reqMin:55},
];

var ENDINGS=[
  // ─── ✅ 最初の成功エンディング（到達しやすい） ───
  // ─── ✅ 最初の成功エンディング（中盤到達可能）───
  {id:'good',tt:'🎨 いいデザインスタジオを作った',col:'#22c55e',
   cond:function(s){return s.turn>=gcfg("eTurn",80)&&s.rep>=gcfg("eRep",55)&&s.totalRev>=gcfg("eRev",8000000)&&s.projDone>=gcfg("eProj",25)&&s.black<=65&&s.fire<=30;},
   story:'派手さはないが、クライアントから信頼されるスタジオになった。\n「あの会社に頼めば間違いない」\nそう言われるのが、一番の勲章だった。'},

  // ─── 🌱 サステナブルエンディング ───
  {id:'kyoto_forever',tt:'🍵 京都、ずっとここで',col:'#a67c52',
   cond:function(s){return s.turn>=180&&(s.bases||[]).includes('kyoto')&&(s.policies||{})['kyoto_base']&&(s.wb||0)>=70&&s.rep>=65&&s.totalRev>=30000000;},
   story:'東京に移転しない選択をした。\n京都の町家スタジオに、世界中のデザイナーが訪れるようになった。\n\n「スケールより、根っこ。スピードより、深さ」\n\nその選択が、本物のブランドになった。'},
  {id:'niigata_slow',tt:'🌾 新潟から世界へ',col:'#7cb87c',
   cond:function(s){var am=s.staff.length>0?s.staff.reduce(function(a,x){return a+x.mental;},0)/s.staff.length:0;return s.turn>=220&&(s.bases||[]).includes('niigata')&&(s.wb||0)>=65&&s.staff.length>=4&&am>=60&&s.totalRev>=20000000;},
   story:'新潟のサテライト拠点が、いつの間にかメイン拠点になった。\n田んぼのあぜ道を歩きながら考えたデザインが、\n世界のコンペで一位を取った。\n\n都市じゃなくても、世界クラスの仕事はできる。それを証明した。'},
  {id:'wellbeing_studio',tt:'🧘 ウェルビーイング企業の先駆者',col:'#6366f1',
   cond:function(s){var am=s.staff.length>0?s.staff.reduce(function(a,x){return a+x.mental;},0)/s.staff.length:0;return s.turn>=280&&(s.wb||0)>=78&&s.black<=25&&s.staff.length>=6&&am>=70&&s.rep>=75;},
   story:'「社員の幸せが最高のアウトプットを生む」\nその仮説を、数字で証明した。\n\n業界紙の特集、講演依頼、模倣する会社が続出した。\nウェルビーイング経営の教科書として、ビジネススクールで使われるようになった。'},
  {id:'global_wellbeing',tt:'🌍 グローバル・サステナブルスタジオ',col:'#00b4d8',
   cond:function(s){return s.turn>=350&&s.offLevel>=4&&(s.wb||0)>=70&&s.black<=30&&(s.intlStaff||0)>=3&&s.rep>=85&&s.totalRev>=300000000;},
   story:'京都→東京→新潟、そして世界へ。\n8カ国、20人のチームが、それぞれの文化を持ち寄った。\n\nFast Company「最もイノベーティブな企業」に選出。\nグローバルでサステナブルなスタジオの、新しい形ができた。'},

  {id:'balanced_growth',tt:'⚖️ 持続可能な成長',col:'#22c55e',
   cond:function(s){return s.turn>=250&&s.rep>=72&&s.totalRev>=80000000&&(s.wb||0)>=50&&s.black<=50&&s.projDone>=50;},
   story:'急成長でも燃え尽きでもない、第三の道を選んだ。\n年間成長率15%、平均メンタル80点。\n\n「ちょうどいいスピードで、ちょうどいいクオリティを」\nその哲学が、業界に持続可能な成長のケーススタディとして語り継がれた。'},
  // ─── オリジナルエンディング ───
  {id:'world', tt:'🌍 世界的デザインスタジオ',col:'var(--gold)',
   cond:function(s){return s.turn>=400&&s.rep>=90&&s.awards>=5&&s.tech['global']&&s.totalRev>=500000000;},
   story:'ADCグランプリ受賞。NY、LDN、TOKYOにオフィスを構えた。\n世界中のブランドが「あなたの会社に頼みたい」と言ってくれる。\n最初の2畳のコワーキングスペースが、遠い昔のように感じられる。\n\nすべてのデザインに込めた愛は、ちゃんと世界に届いていた。'},
  {id:'product',tt:'🚀 プロダクト企業への転身',col:'var(--teal)',
   cond:function(s){return s.turn>=200&&s.tech['ai_design']&&s.projDone>=80&&s.totalRev>=200000000&&!s.tech['product_mgmt'];},
   story:'「元デザイン会社」として業界に語り継がれることになる。\n自社プロダクトのDAUが10万を超えた。\nデザインの力で、世界の使い方を変えることができた。'},
  {id:'god',   tt:'✨ 神スタジオ（Best Ending）',col:'var(--acc2)',
   cond:function(s){var am=s.staff.length>0?s.staff.reduce(function(a,x){return a+x.mental;},0)/s.staff.length:0;return s.turn>=280&&s.staff.length>=8&&am>=68&&s.rep>=80&&s.projDone>=80&&s.totalRev>=150000000;},
   story:'小さいけれど、最高の会社。\n社員全員のメンタルが高く、クオリティも評判も申し分ない。\n「規模じゃない、愛だ」という結論に至った。\n\n誰もが羨む、本物のスタジオ。\n社員全員が「ここで働けてよかった」と言ってくれた。'},
  {id:'saas_unicorn',tt:'⚡ SaaSユニコーン達成！',col:'#00d4aa',
   cond:function(s){return s.turn>=350&&(s.dau||0)>=1000000&&(s.arr||0)>=5000000000;},
   story:'DAU 50万人、ARR 20億円を突破。\nシリーズCで300億円の資金調達に成功した。\nかつてロゴを頼んでいたクライアントが\n「うちのデザインもお願いできますか」と言ってくる。\n\nデザイン会社が、世界を変えるプロダクトになった。'},
  {id:'platform_empire',tt:'🌐 プラットフォーム帝国',col:'#6366f1',
   cond:function(s){return s.tech['platform_biz']&&(s.dau||0)>=5000000&&s.totalRev>=20000000000;},
   story:'100カ国のクリエイターが使うプラットフォームへ成長。\nApple・Google・Microsoftから買収オファーが届いた。\n\nあの2畳のコワーキングスペースで\n「とりあえず名刺作ります」と言っていた自分に見せたい景色がある。'},
  {id:'acquired',tt:'🤝 テックジャイアントに買収！',col:'#f59e0b',
   cond:function(s){return s.tech['platform_biz']&&s.totalRev>=10000000000&&(s.dau||0)>=2000000;},
   story:'GAFAクラスのテック企業からの買収オファー。\n金額は非公開だが、全社員が生涯遊んで暮らせる額だという。\n\n「デザイン会社を買収する」という前例のないM&A。\n業界に新しい文脈を作ることができた。'},
  {id:'ipo',   tt:'📈 上場！',col:'var(--gold)',
   cond:function(s){return s.turn>=300&&s.tech['corp_gov']&&s.totalRev>=500000000&&s.fire<=20&&s.staff.length>=30;},
   story:'株式上場を果たした。\nCFO採用・IR資料作成・投資家説明会。\n「デザインよりIR資料の方が忙しい」という\n想定外の日常が待っていた。\n\nそれでも、会社は大きくなった。'},
  {id:'burnout_collapse',tt:'😵 急成長の代償',col:'#ef4444',
   cond:function(s){return s.black>=85&&(s.wb||50)<35;},
   story:'DAUは増え続けているのに、社員が次々と倒れていく。\n「スケールするプロダクト」と「スケールしない人間」の間で\n会社は崩壊した。\n\n成長の速度を、人の限界に合わせるべきだった。'},
  {id:'fire',  tt:'🔥 炎上解散…',col:'var(--red)',
   cond:function(s){return s.fire>=gcfg("fireGO",85);},
   story:'炎上メーターが限界を超えた。\n社長のXポストが発端で業界全体を敵に回した。\n\n「あの時代の反面教師」として、業界に貢献することができた。\nある意味、これも一つのレガシー。'},
  {id:'nft',   tt:'🎨 NFTで破滅',col:'#e040fb',
   cond:function(s){return s.fire>=60&&s.money<=0;},
   story:'受け取ったトークンが全部紙くずになった。\n「信じてたのに」というテロップが流れ続ける。\n\n次のバブルには乗らないと誓った。\nでも、また乗ってしまうかもしれない。それが人間だから。'},
  {id:'broke', tt:'💸 資金ショート倒産',col:'var(--red)',
   cond:function(s){return s.money<=gcfg("brokeLine",0);},
   story:'口座がマイナスになった。\nキャッシュフローはデザインより重要という\n残酷な真実を知った。\n\n次は経営を学んでから始めよう。'},

  // ─── 🍎 自社プロダクト帝国エンディング ───
  {id:'apple_empire',tt:'🍎 デザインで世界を再定義',col:'#1d1d1f',
   cond:function(s){return s.phase>=6&&s.tech['os_design']&&s.tech['ai_design']&&(s.dau||0)>=5000000&&s.rep>=90&&s.totalRev>=30000000000&&s.awards>=8;},
   story:'ハードウェアとソフトウェアを統合したデザイン企業。\n「Designed in Kyoto」のロゴが世界で最も信頼されるシンボルになった。\n\nAppleが「美しさ」を再定義したように\nこの会社は「デザインの次」を定義した。\n\nすべては2畳のコワーキングから始まった。'},

  {id:'google_scale',tt:'🔍 情報で世界をデザインする',col:'#4285f4',
   cond:function(s){return s.phase>=6&&s.tech['data_infra']&&s.tech['platform_biz']&&(s.dau||0)>=20000000&&s.totalRev>=50000000000;},
   story:'デザインから始まり、情報インフラを握った。\n10億人のUIを日々設計し、\n検索・地図・メッセージ・OS——\nあらゆる「世界の窓」をデザインする企業になった。\n\n「使いやすさ」が、世界最大の権力になった。'},

  {id:'tesla_mobility',tt:'⚡ テスラ的モビリティ革命',col:'#cc0000',
   cond:function(s){return s.phase>=5&&s.tech['ar_xr']&&s.tech['ai_design']&&(s.dau||0)>=1000000&&s.totalRev>=20000000000&&s.staff.length>=100;},
   story:'クルマのUI設計から始まり、\nモビリティそのものをデザインするようになった。\n\nダッシュボード・自動運転HMI・充電体験——\nすべてに「デザインファースト」を叩き込んだ。\n\n内燃機関の時代が終わるとき、\nこの会社が次の時代のインターフェースを作っていた。'},

  {id:'spacex_frontier',tt:'🚀 宇宙産業のデザインスタジオ',col:'#005288',
   cond:function(s){return s.phase>=6&&s.tech['global']&&s.tech['os_design']&&(s.bases||[]).length>=5&&s.rep>=95&&s.totalRev>=100000000000;},
   story:'宇宙船のUI、宇宙服のデザイン、\n星間通信のビジュアルシステム——\n\nデザイン会社が、地球の外に出た。\n\n「デザインの最後のフロンティアは宇宙だった」\n創業時には想像もしなかった一文が、\n会社の公式ミッションになった。'},

  {id:'toyota_kaizen',tt:'🚗 カイゼンとデザインの融合',col:'#eb0a1e',
   cond:function(s){return s.turn>=400&&s.tech['design_system']&&s.totalMods>=200&&s.projDone>=200&&s.totalRev>=10000000000&&s.black<=30&&(s.wb||50)>=65;},
   story:'修正200回——それは恥ではなく、カイゼンの証だった。\n\n「完璧なものを初回で出す」より\n「毎回少しだけ良くする」を選んだ。\n\nその哲学が、製造業・行政・医療まで波及し\nデザインカイゼンという新概念を生み出した。\n日本が誇る、世界に通じるデザイン経営。'},

  {id:'samsung_vertical',tt:'📱 垂直統合型グローバル企業',col:'#1428a0',
   cond:function(s){return s.phase>=6&&(s.bases||[]).length>=4&&s.tech['platform_biz']&&s.tech['data_infra']&&s.staff.length>=200&&s.totalRev>=80000000000;},
   story:'デバイス・OS・アプリ・コンテンツ・EC——\nあらゆる層を自社で設計する垂直統合企業になった。\n\nソウル・東京・NY・ロンドン・シンガポール——\n各拠点が独自の強みを持ちながら\nひとつのデザイン哲学でつながっている。\n\n多様性が、最大の強さになった。'},
,

  // ── 新：評判崩壊エンディング ──
  {id:'reputation_ruin',tt:'💔 評判崩壊：誰も頼まなくなった',col:'#7f1d1d',
   story:'クライアントからのクレームが積み重なり\nSNSに「このスタジオには頼むな」という投稿が拡散した。\n\n問い合わせは止まり、受注はゼロ。\n電話が鳴らない日々が続く。\n\n評判は、一度失うと取り戻すのが難しい。\nデザインの仕事は「信頼」でできている。',
   cond:function(s){return s.turn>=20&&s.rep<=15;}},

  // ── 新：無人オフィスエンディング ──
  {id:'ghost_office',tt:'👻 無人オフィス：全員去った',col:'#374151',
   story:'一人、また一人と去っていった。\n\n最初は「少し休みたい」と言っていた。\n次は「他のオファーが来た」と。\n最後の一人が荷物をまとめて出ていく日\nオフィスはただの部屋になった。\n\n経営者として、働く人を守れなかった。',
   cond:function(s){return s.turn>=15&&s.staff.filter(function(x){return!x.isSelf;}).length===0&&s.staff.length<=1&&s.projDone>=3;}},
];

// ─── POLICIES: ウェルビーイング制度 ───────────────────────
var POLICY_CATS={
  work:'働き方',reward:'評価・報酬',learn:'成長・学習',health:'健康・ライフ',culture:'文化・多様性'
};
var POLICIES=[
  {id:'flex_time',  nm:'フレックスタイム',ic:'⏰',cat:'work',  cost:200000, wb:8, black:-10,desc:'コアタイム廃止。自律的な時間管理。',eff:function(s){s.staff.forEach(function(x){x.mental=Math.min(100,x.mental+5);});}},
  {id:'remote_ok',  nm:'リモートワーク制',ic:'🏠',cat:'work',  cost:300000, wb:10,black:-12,desc:'フルリモート可。場所を選ばない働き方。',eff:function(s){s.staff.forEach(function(x){x.mental=Math.min(100,x.mental+4);});}},
  {id:'four_day',   nm:'週4日勤務',      ic:'🗓️',cat:'work', cost:0,      wb:18,black:-20,desc:'金曜休み。生産性向上が狙い。',reqPhase:2,eff:function(s){s.staff.forEach(function(x){x.mental=Math.min(100,x.mental+10);});}},
  {id:'no_crunch',  nm:'ノーサービス残業',ic:'🚫',cat:'work',  cost:0,      wb:12,black:-18,desc:'残業ゼロ宣言。スピードより持続性。'},
  {id:'paid_leave', nm:'有給消化100%',   ic:'🌴',cat:'work',  cost:100000, wb:10,black:-10,desc:'有給を全員取得。制度として保証。',eff:function(s){s.staff.forEach(function(x){x.mental=Math.min(100,x.mental+6);});}},
  {id:'peer_review',nm:'ピアレビュー制度',ic:'🤝',cat:'reward',cost:150000, wb:7, black:-5, desc:'360度評価。上司だけでなく同僚も評価者。'},
  {id:'bonus_sys',  nm:'成果ボーナス制度',ic:'💰',cat:'reward',cost:500000, wb:9, black:-8, desc:'業績連動ボーナス。頑張りが報われる文化。',reqPhase:1},
  {id:'esop',       nm:'ストックオプション',ic:'📈',cat:'reward',cost:0,     wb:15,black:-8, desc:'社員も会社のオーナーに。長期コミット促進。',reqPhase:3,eff:function(s){s.staff.forEach(function(x){x.mental=Math.min(100,x.mental+8);});}},
  {id:'transparent_sal',nm:'給与公開制', ic:'👁️',cat:'reward',cost:0,      wb:6, black:-7, desc:'全員の給与を社内公開。公平性の担保。'},
  {id:'learn_budget',nm:'学習予算月5万', ic:'📚',cat:'learn', cost:50000,  wb:8, black:-6, desc:'書籍・セミナー・資格を会社が全額負担。'},
  {id:'mentorship', nm:'メンタリングプログラム',ic:'🎓',cat:'learn',cost:200000,wb:9,black:-7,desc:'先輩→後輩の成長サポート体制。',reqPhase:1},
  {id:'intl_exchange',nm:'グローバル交流制度',ic:'🌏',cat:'learn',cost:300000,wb:12,black:-5,desc:'海外スタッフとのクロスカルチャー研修。',reqPhase:2,eff:function(s){s.intlStaff=(s.intlStaff||0)+1;}},
  {id:'health_check',nm:'産業医・メンタルケア',ic:'💚',cat:'health',cost:100000,wb:12,black:-10,desc:'月1回の産業医面談。メンタルヘルスを制度化。',eff:function(s){s.staff.forEach(function(x){if(x.mental<50)x.mental=Math.min(100,x.mental+15);});}},
  {id:'childcare',  nm:'育休・保育補助',  ic:'👶',cat:'health',cost:200000, wb:11,black:-8, desc:'育休取得100%を保証。保育費補助も。'},
  {id:'wellness_room',nm:'ウェルネスルーム',ic:'🛋️',cat:'health',cost:500000,wb:8,black:-6, desc:'仮眠室・瞑想スペース・マッサージチェア完備。',reqPhase:1},
  {id:'dei_program',nm:'DEI推進',         ic:'🌈',cat:'culture',cost:200000,wb:10,black:-8, desc:'多様性・公平性・包括性の推進プログラム。'},
  {id:'eng_ok',     nm:'社内英語公用語化',ic:'🗣️',cat:'culture',cost:100000,wb:7, black:-3, desc:'英語OK文化。国際スタッフが活躍しやすい環境。',eff:function(s){s.intlStaff=(s.intlStaff||0)+2;}},
  {id:'kintsugi_val',nm:'失敗文化（金継ぎ）',ic:'🏺',cat:'culture',cost:0,   wb:9, black:-12,desc:'失敗を責めない文化。金継ぎ精神で失敗を価値に変える。'},
  {id:'kyoto_base', nm:'京都本社維持宣言',ic:'🍵',cat:'culture',cost:0,     wb:8, black:-8, desc:'東京移転しない宣言。京都のアイデンティティを守る。',eff:function(s){if(!(s.bases||[]).includes('kyoto'))s.bases.push('kyoto');}},
  {id:'niigata_base',nm:'新潟サテライト正式化',ic:'🌾',cat:'culture',cost:800000,wb:10,black:-10,desc:'新潟拠点を正式なサテライトオフィスに格上げ。',eff:function(s){if(!(s.bases||[]).includes('niigata'))s.bases.push('niigata');}},
];

// ─── STATE & LOG ─────────────────────────────────────────────
var gLog=[];
function addLog(txt,type){gLog.unshift({t:txt,ty:type||'',w:G.s.turn});if(gLog.length>60)gLog.pop();renderLog();}
function renderLog(){var el=q('glog');if(!el)return;var h='';gLog.slice(0,30).forEach(function(l){h+='<div class="le '+l.ty+'"><span class="le-t">T'+l.w+'▶</span><span class="le-x">'+esc(l.t)+'</span></div>';});el.innerHTML=h;}
function fireRandom(){var ns=G.s.staff.filter(function(s){return!s.isSelf;});if(!ns.length)return;var s=pick(ns);G.s.actives.forEach(function(p){if(p.asgn===s.id)p.asgn=null;});G.s.staff=G.s.staff.filter(function(x){return x.id!==s.id;});G.s.rep=clamp(G.s.rep-3,0,100);addLog(s.nm+'が退職した。','bad');notify(s.nm+'が退職してしまいました…','danger');SFX.bad();}



// ─── CFG BRIDGE: 管理画面の設定をゲームに橋渡し ────────────────
function gcfg(key, fallback) {
  return (window.CFG && window.CFG[key] !== undefined) ? window.CFG[key] : fallback;
}

// ─── MAIN GAME OBJECT ────────────────────────────────────────
var G={
  s:{},
  busy:false,
  curTab:'dash',
  ocId:null,tcId:null,
  revCb:null,

  initState:function(){
    G.gameOver=false; // ゲームオーバーフラグをリセット
    G.s={
      turn:1,money:gcfg("startMoney",350000),rep:12,fire:0,sns:84,black:5,
      phase:0,offLevel:0,compName:'KYOTO STUDIO',
      wb:50,policies:{},intlStaff:0,bases:['kyoto'],starPerf:[],
      tech:{figma_basic:true},
      totalRev:0,totalProj:0,projDone:0,totalMods:0,awards:0,portfolio:[],
      dau:0,arr:0,burnRate:0,prodStage:0,funding:0,
      staff:[],actives:[],avail:[],hirePool:[],monthNum:0,oAnim:0
    };
    G.staffPos=[];
    G.murmurLog=[];
    G._murmurShown={};
    G._murmurActive={};
    G.aiMode=true;
    G.autoSpeed=2500;
    G.autoTimer=null;
    G.aiMode=false;
    G.aiActionLog=[];
  },

  toggleAuto:function(){/* AUTO削除済 */},


  // ══════════════════════════════════════
  // AI MODE — 全経営をAIエージェントに委譲
  // ══════════════════════════════════════
  toggleAI:function(){
    G.aiMode=!G.aiMode;
    var btn=q('btn-ai');
    if(G.aiMode){
      // ── ON ──
      if(btn){
        btn.innerHTML='<span class="ai-dot"></span>🤖 AI稼働中';
        btn.classList.add('on');
      }
      document.body.classList.add('ai-mode');
      var lf=q('ai-live-feed');if(lf){lf.innerHTML='';lf.style.display='flex';}
      var ls=q('ai-live-sh');if(ls)ls.style.display='';
      G.aiThink('BOOT',
        'AI AGENT 起動完了。\n' +
        '全経営権限を委譲されました。\n' +
        '受注・採用・配置・技術・移転\n' +
        '全て自動で判断します。');
      addLog('🤖 AIモード ON ─ 全経営権限を委譲','sys');
      notify('🤖 AIモード ON ─ 週が自動で進みます（速度変更可）','ok',4000);
      var sc=q('ai-speed-ctrl');if(sc)sc.style.display='block';
      if(G.curTab==='ai')G.renderAI();
      if(!G.busy)G.scheduleAuto();
    } else {
      // ── OFF ──
      if(btn){
        btn.innerHTML='<span class="ai-dot" style="display:none"></span>🤖 AIモード';
        btn.classList.remove('on');
      }
      document.body.classList.remove('ai-mode');
      G.aiThink('SHUTDOWN','経営権限を人間に返還。\nお疲れ様でした。');
      var lf2=q('ai-live-feed');if(lf2)lf2.style.display='none';
      var ls2=q('ai-live-sh');if(ls2)ls2.style.display='none';
      var sc2=q('ai-speed-ctrl');if(sc2)sc2.style.display='none';
      addLog('🤖 AIモード OFF ─ 経営権を取り戻した','sys');
      notify('🤖 AIモード OFF ─ 経営権を取り戻した','warn',3000);
      if(G.curTab==='ai')G.renderAI();
    }
  },

  // AI思考バブルを画面左下に表示
  aiThink:function(tag,msg){
    // ライブフィード（AIタブ内）に表示
    var feed=q('ai-live-feed');
    if(feed){
      var sh=q('ai-live-sh');if(sh)sh.style.display='';
      feed.style.display='flex';
      var div=document.createElement('div');
      div.className='ai-bubble';
      div.style.animation='bubbleIn .2s ease';
      var lines=msg.split('\n').map(function(l){return esc(l);}).join('<br>');
      div.innerHTML='<div class="ai-tag">'+esc(tag)+'</div>'+lines;
      feed.insertBefore(div,feed.firstChild);
      while(feed.children.length>8){feed.removeChild(feed.lastChild);}
    }
    // AIタブが開いていなければバッジ表示
    if(G.curTab!=='ai'){
      var nb=q('nb-ai');if(nb&&!nb.classList.contains('on')){
        nb.style.outline='2px solid #6366f1';
        setTimeout(function(){if(nb)nb.style.outline='';},3000);
      }
    } else {
      G.renderAI();
    }
  },

  // AIエージェントの経営判断エンジン（nextTurn冒頭で呼ばれる）
  aiDecide:function(){
    if(!G.aiMode)return;
    var s=G.s;
    var acts=[];

    // ① 受注判断
    // 実際にアサイン可能な人数 = idle状態の人（自分含む）
    var idleStaff=s.staff.filter(function(st){return st.status==='idle';});
    // 同時進行できる数 = idleスタッフ数（1人=1案件、solo時は1件のみ）
    var maxSlots=s.staff.length; // 人数分だけ（max(2,...)を廃止）
    var freeSlots=Math.max(0,maxSlots-s.actives.length);
    var fireRisk=s.fire>=50;
    // 炎上60%超なら新規受注を停止（以前の70%より厳しく）
    if(s.fire>=60){
      freeSlots=0;
      G.aiThink('WARNING','🔥 炎上'+s.fire+'% → 受注停止。炎上対応優先');
    }
    if(freeSlots>0&&s.avail.length>0&&idleStaff.length>0){
      var ranked=s.avail.slice().sort(function(a,b){
        function score(p){
          var base=p.price;
          base*=(p.cli.id==='god'?1.3:p.cli.id==='norm'?1.05:p.cli.id==='agency'?0.7:1.0);
          base*=(p.diff<=2?1.15:p.diff===3?1.0:p.diff>=4?0.7:1.0);
          base*=(p.urg?(fireRisk?0.6:0.9):1.0);
          return base;
        }
        return score(b)-score(a);
      });
      // AIミス率（管理画面から調整可）
      var pickList;
      if(Math.random()<gcfg("aiErr",0.25)){
        pickList=ranked.slice().sort(function(a,b){return (b.cli.mr||0)-(a.cli.mr||0);}).slice(0,Math.min(freeSlots,idleStaff.length));
        G.aiThink('MISTAKE','⚠ 受注ミス: 修正地獄クライアントを引いた');
      } else {
        pickList=ranked.slice(0,Math.min(freeSlots,idleStaff.length));
      }
      pickList.forEach(function(proj){
        var ap=JSON.parse(JSON.stringify(proj));
        ap.prog=0;ap.asgn=null;ap.modCnt=0;
        s.actives.push(ap);
        s.avail=s.avail.filter(function(x){return x.id!==proj.id;});
        acts.push('受注:「'+proj.nm+'」'+fY(proj.price));
        addLog('🤖「'+proj.nm+'」をAIが受注','sys');
        G.aiActionLog.push({turn:G.s.turn,type:'order',msg:'「'+proj.nm+'」受注 '+fY(proj.price)});
      });
    }

    // ② アサイン判断：未アサイン案件にスキルマッチ最優先でアサイン
    s.actives.forEach(function(proj){
      if(proj.asgn)return;
      var avl=s.staff.filter(function(st){return st.status==='idle'&&st.mental>20;});
      if(!avl.length)return;
      var best=avl.slice().sort(function(a,b){
        function sc(st){
          var v=(st.stats.design+st.stats.ui+st.stats.speed)/3*(st.mental/100);
          if(proj.sk)proj.sk.forEach(function(k){if(st.stats[k])v+=st.stats[k]*0.35;});
          return v;
        }
        return sc(b)-sc(a);
      })[0];
      proj.asgn=best.id;best.status='working';
      acts.push('担当:'+best.nm+'→「'+proj.nm+'」');
      addLog('🤖 '+best.nm+'を「'+proj.nm+'」にアサイン','sys');
      G.aiActionLog.push({turn:G.s.turn,type:'assign',msg:best.nm+' → 「'+proj.nm+'」'});
    });

    // ③ 採用判断：人手不足 & 資金余裕 → コスパ最良の人材を採用
    var staffMax=[4,10,16,22,200,1000,5000][Math.min(s.phase,6)];
    // 常にstaffMaxまで採用可能（資金制約のみ）
    var targetStaff=staffMax;
    var monthlyCost=s.staff.reduce(function(a,st){return a+st.sal;},0)*1.5;
    // 資金が少ない時は採用を絞る（以前より厳しい条件）
    if(s.money<monthlyCost*6)targetStaff=Math.min(s.staff.length+1,staffMax);
    if(s.money<monthlyCost*3)targetStaff=s.staff.length;// 採用凍結
    if(s.hirePool.length<4)G.genHire();
    if(s.staff.length<targetStaff&&s.money>1200000&&s.hirePool.length>0){
      var bh=s.hirePool.slice().sort(function(a,b){
        var va=(a.st.design+a.st.ui+a.st.speed+a.st.logic)/4/a.sal;
        var vb=(b.st.design+b.st.ui+b.st.speed+b.st.logic)/4/b.sal;
        return vb-va;
      })[0];
      var hcost=bh.sal*2;
      if(s.money>hcost*3){
        var emp={
          id:'e'+Date.now(),nm:bh.nm,role:bh.role,ic:bh.ic,sal:bh.sal,
          stats:JSON.parse(JSON.stringify(bh.st)),mental:bh.mental,
          status:'idle',isSelf:false,sense:ri(40,85)
        };
        s.money-=hcost;s.staff.push(emp);
        s.hirePool=s.hirePool.filter(function(h){return h.nm!==bh.nm;});
        acts.push('採用:'+emp.nm+'('+emp.role+') '+fY(hcost));
        addLog('🤖 '+emp.nm+'をAIが採用','sys');
        G.aiActionLog.push({turn:G.s.turn,type:'hire',msg:emp.nm+'('+emp.role+') 採用 '+fY(hcost)});
        SFX.good();G.updateHUD();G.renderAll();
      }
    }

    // ④ 技術習得：資金2M超 & 前提クリア済みを優先順で1つ習得（マイナス時はスキップ）
    if(s.money>2000000&&s.money>0){
      var allN=TECHS.reduce(function(a,r){return a.concat(r.nodes);},[]);
      var buyable=allN.filter(function(n){
        return !s.tech[n.id]
          &&n.req.every(function(r){return s.tech[r];})
          &&s.money>n.cost*4.0;  // 4倍の余裕がある時だけ購入
      });
      var prio=['design_system','figma_basic','ux_research','motion','branding','three_d','ai_design','global','product_mgmt','growth_hack','data_infra','platform_biz','corp_gov','global_expand'];
      var toLearn=null;
      for(var pi=0;pi<prio.length;pi++){
        toLearn=buyable.find(function(n){return n.id===prio[pi];});
        if(toLearn)break;
      }
      if(!toLearn&&buyable.length)toLearn=buyable[0];
      if(toLearn){
        s.money-=toLearn.cost;s.tech[toLearn.id]=true;
        acts.push('習得:「'+toLearn.nm+'」 '+fY(toLearn.cost));
        addLog('🤖「'+toLearn.nm+'」をAIが習得','sys');
        G.aiActionLog.push({turn:G.s.turn,type:'tech',msg:'「'+toLearn.nm+'」習得 '+fY(toLearn.cost)});
        SFX.lvup();PTCL.burst(window.innerWidth/2,window.innerHeight*0.4,'lvup');G.updateHUD();G.renderTech();
      }
    }

    // ⑤ オフィス移転：評判・資金・フェーズが揃えば移転
    var nextLv=s.offLevel+1;
    if(nextLv<OFFICES.length){
      var od=OFFICES[nextLv];
      if(s.money>od.cost*2.5&&s.rep>=nextLv*20&&s.phase>=nextLv-1){
        s.money-=od.cost;s.offLevel=nextLv;s.rep=clamp(s.rep+od.rp,0,100);
        q('olb').textContent=OFF_LB[nextLv];
        acts.push('移転:「'+od.nm+'」 評判+'+od.rp);
        addLog('🤖「'+od.nm+'」にAIが移転','sys');
        G.aiActionLog.push({turn:G.s.turn,type:'other',msg:'「'+od.nm+'」に移転 評判+'+od.rp});
        SFX.lvup();G.updateHUD();G.renderProg();
      }
    }

    // ⑥ 炎上対策：炎上60%超なら難案件を辞退してリスク低減
    if(s.fire>=60&&s.actives.length>1){
      var dp=s.actives.find(function(p){return p.diff>=4||p.cli.id==='agency';});
      if(dp){
        if(dp.asgn){var dSt=s.staff.find(function(x){return x.id===dp.asgn;});if(dSt)dSt.status='idle';}
        s.actives=s.actives.filter(function(p){return p.id!==dp.id;});
        acts.push('炎上対策:「'+dp.nm+'」辞退');
        addLog('🤖 炎上対策で「'+dp.nm+'」を辞退','sys');
        G.aiActionLog.push({turn:G.s.turn,type:'risk',msg:'炎上対策:「'+dp.nm+'」辞退'});
      }
    }

    // ⑦ ウェルビーイング制度採択：資金に余裕があれば積極的に導入
    (function(){
      if(typeof POLICIES==='undefined')return;
      // 資金が十分ある時のみ（月次コストの4ヶ月分以上）
      var monthlyCost=s.staff.reduce(function(a,st){return a+st.sal;},0)+((typeof OFFICES!=='undefined')?OFFICES[s.offLevel].mc:0);
      if(s.money<monthlyCost*3)return;
      // まだ導入していないポリシーを候補に
      var un採択=POLICIES.filter(function(p){
        if(s.policies[p.id])return false;
        if(p.reqPhase&&s.phase<p.reqPhase)return false;
        var cost=p.cost||0;
        return s.money>cost+monthlyCost*3;// 導入後も3ヶ月分残るか
      });
      if(!un採択.length)return;
      // 優先順位: WBボーナスが高い＋ブラック削減効果が高いものを優先
      // 特に重要な制度を優先リストで指定
      var prio=['flex_time','no_crunch','four_day','health_check','remote_ok',
                'kintsugi_val','paid_leave','learn_budget','peer_review','dei_program',
                'bonus_sys','mentorship','childcare','wellness_room','esop',
                'transparent_sal','eng_ok','intl_exchange','kyoto_base','niigata_base'];
      // 現在の状態に応じたスコアリング
      var avgM=s.staff.length>0?s.staff.reduce(function(a,x){return a+x.mental;},0)/s.staff.length:80;
      var bestPol=null, bestScore=-999;
      un採択.forEach(function(p){
        var score=(p.wb||0)*2+(Math.abs(p.black||0));// WB+ブラック改善を重視
        if(avgM<50)score+=(p.black||0)<-10?15:0;// メンタル低下時は労働制度優先
        if(s.black>60)score+=(p.black||0)<-10?20:0;// ブラック高時は残業系優先
        if((s.wb||50)<50)score+=p.wb>10?10:0;// WB低い時は高効果を優先
        var prioIdx=prio.indexOf(p.id);
        if(prioIdx>=0)score+=Math.max(0,(prio.length-prioIdx)*0.5);// 優先リスト補正
        if(score>bestScore){bestScore=score;bestPol=p;}
      });
      // ターン8の倍数かつ確率50%で採択（採用・技術習得と分散させる）
      if(bestPol&&s.turn%gcfg("aiPol",8)===0&&Math.random()<0.5){
        G.adoptPolicy(bestPol.id);
        acts.push('制度導入:「'+bestPol.nm+'」WB+'+bestPol.wb);
        G.aiActionLog.push({turn:s.turn,type:'policy',msg:'「'+bestPol.nm+'」導入 WB+'+bestPol.wb});
        G.aiThink('POLICY','🌿 '+bestPol.ic+' 「'+bestPol.nm+'」を導入\\nWB+'+bestPol.wb+' ブラック'+(bestPol.black||0));
      }
    })();

    // ⑧ メンタル管理：メンタル30以下のスタッフを強制休養
    s.actives.forEach(function(proj){
      if(!proj.asgn)return;
      var wk=s.staff.find(function(x){return x.id===proj.asgn;});
      if(wk&&wk.mental<25){
        wk.status='idle';proj.asgn=null;
        acts.push('休養:'+wk.nm+' (メンタル低下)');
        addLog('🤖 '+wk.nm+'をメンタル回復のため休養させた','sys');
      }
    });

    // ⑧ 思考ログ出力
    if(acts.length>0){
      var tags=['STRATEGY','OPTIMIZE','EXECUTE','ANALYZE','DECIDE','MANAGE'];
      var tagIdx=s.turn%tags.length;
      G.aiThink(tags[tagIdx],acts.slice(0,3).join('\n')+(acts.length>3?'\n他'+(acts.length-3)+'件':''));
    } else if(s.turn%3===0){
      var status=[];
      status.push('案件'+s.actives.length+'件進行中');
      if(s.fire>30)status.push('炎上警戒 '+s.fire+'%');
      status.push('資金 '+fY(s.money));
      G.aiThink('MONITOR',status.join('\n'));
    }

    // AI KPI更新
    if(G.curTab==='ai')G.renderAI();

    // ステータスバーのテキストをリアルタイム生成
    var stEl=q('ai-status-txt');
    if(stEl){
      var idleCount=s.staff.filter(function(x){return x.status==='idle';}).length;
      var busyCount=s.actives.filter(function(x){return x.asgn;}).length;
      var msgs=[
        'AI AGENT 稼働中 ─ 案件'+s.actives.length+'件 進行中',
        'AI AGENT ─ 余裕資金 '+fY(s.money),
        'AI AGENT ─ 空きスタッフ '+idleCount+'名',
        'AI AGENT ─ 担当中 '+busyCount+'件',
        'AI AGENT ─ 炎上リスク '+s.fire+'%',
        'AI AGENT ─ 評判スコア '+s.rep,
      ];
      stEl.textContent=msgs[s.turn%msgs.length];
    }
  },

  setAISpeed:function(s){
    G.aiSpeed=s;
    [1,2,4].forEach(function(v){var el=q('spd-'+v);if(el)el.classList.toggle('on',v===s);});
    if(G.aiMode&&G.autoTimer){clearTimeout(G.autoTimer);G.scheduleAuto();}
  },
  scheduleAuto:function(){
    if(!G.aiMode)return;
    if(G.autoTimer)clearTimeout(G.autoTimer);
    var delay={1:2000,2:900,4:300}[G.aiSpeed||1]||2000;
    G.autoTimer=setTimeout(function(){
      if(!G.aiMode)return;
      if(G.busy){G.scheduleAuto();return;}
      if(G.gameOver)return; // エンディング後はAI自動進行を停止
      var anyModal=q('modal-ev').classList.contains('open')||q('modal-mod').classList.contains('open')||q('modal-rev').classList.contains('open')||q('SCR_END').classList.contains('open');
      if(anyModal){G.scheduleAuto();return;} // モーダル中は待機
      G.nextTurn();
    },delay);
  },

  mkSelf:function(){
    var selfStats={design:65,speed:70,logic:60,ui:72,comm:65};
    return{id:'self',nm:'あなた',role:'UIデザイナー',ic:'🧑‍💻',sal:0,stats:selfStats,mental:90,status:'idle',isSelf:true,sense:70,
      mbti:assignMBTI(selfStats).en,trainData:[]};
  },

  // 外部オーダーページからのオーダーをゲームに取り込む
  checkExtOrders:function(){
    try{
      var eo=JSON.parse(localStorage.getItem('dcfk_ext_orders')||'[]');
      if(!eo.length)return;
      var processed=JSON.parse(localStorage.getItem('dcfk_ext_processed')||'[]');
      var newOnes=eo.filter(function(o){return!processed.includes(o.id);});
      if(!newOnes.length)return;
      newOnes.forEach(function(o){
        processed.push(o.id);
        var pt=PTYPES.find(function(p){return p.id===o.tid;})||PTYPES[0];
        var phase=G.s.phase;
        var price=pt.base*(1+phase*0.4)*1.2; // 外部オーダーはプレミアム価格
        G.s.avail.unshift({
          id:'ext-'+o.id, tid:o.tid||'logo', tlb:o.tlb||'ロゴ', tic:o.tic||'🔤',
          tcss:pt.css||'logo', nm:o.nm,
          cli:{id:'god',lb:o.from||'外部クライアント',ic:'🌐',mr:5,pm:1.3,rg:4,rl:-1},
          price:Math.round(price), days:pt.days||7,
          diff:3, dead:o.dl||14, urg:true, sk:pt.sk||['design'],
          prog:0, asgn:null, modCnt:0, isExt:true,
          extDesc:o.desc, extBudget:o.budget
        });
      });
      localStorage.setItem('dcfk_ext_processed',JSON.stringify(processed));
      if(newOnes.length>0){
        notify('📬 外部オーダーが'+newOnes.length+'件届きました！案件タブを確認してください','ok',5000);
        addLog('📬 外部から'+newOnes.length+'件のオーダーが届いた！','good');
        var pb=q('bdg-proj');if(pb){pb.style.display='inline';pb.textContent=parseInt(pb.textContent||'0')+newOnes.length;}
        var mpb=q('mbdg-proj');if(mpb){mpb.style.display='flex';mpb.textContent=G.s.avail.length;}
      }
    }catch(e){console.log('extOrders error',e);}
  },

  genProjects:function(){
    var avail=PTYPES.filter(function(p){return p.ph<=G.s.phase;});
    var cnt=5+G.s.phase;G.s.avail=[];
    for(var i=0;i<cnt;i++){
      var pt=pick(avail),ct=pick(CTYPES);
      var nm=pick(PNAMES[pt.id]||[pt.lb+'案件']);
      var pm=0.85+Math.random()*0.55,diff=clamp(1+Math.floor(Math.random()*3+G.s.phase*0.6),1,5);
      var tb=G.s.tech['design_system']?1.1:1;
      G.s.avail.push({id:'p'+Date.now()+i,tid:pt.id,tlb:pt.lb,tic:pt.ic,tcss:pt.css,nm:nm,cli:ct,
        price:Math.round(pt.base*pm*(1+G.s.phase*0.8)*ct.pm*tb),days:pt.days+ri(0,3),
        diff:diff,
        // 締め切りをタイトに（以前より2-3週短縮）
        dead:ri(3,6+G.s.phase*2),
        urg:Math.random()>0.65,// 緊急案件を増やす（0.75→0.65）
        sk:pt.sk,prog:0,asgn:null,modCnt:0});
    }
    G.checkExtOrders();
  },

  // ── 手続き的スタッフ生成（フェーズ4以上で無制限採用を実現）──
  genStaff:function(seed){
    var LAST=['田中','鈴木','佐藤','山田','伊藤','渡辺','中村','小林','加藤','吉田',
              '松本','井上','木村','林','清水','山本','森','池田','橋本','阿部',
              '石川','山口','前田','藤田','後藤','岡田','村上','長谷川','近藤','石井',
              '坂本','遠藤','青木','藤井','西村','福田','太田','三浦','岡本','高橋'];
    var FIRST=['あおい','ゆき','さくら','みなみ','はな','れな','ひかり','まい','りな','ゆうな',
               'たける','こうた','しょう','りょう','けんた','しんや','そら','はると','ゆうき','なお',
               'あきら','みお','かな','つばさ','えま','ふみ','まゆ','のあ','いと','せな'];
    var r=function(n){seed=(seed*1664525+1013904223)&0x7fffffff;return seed%n;};
    var nm=LAST[r(LAST.length)]+' '+FIRST[r(FIRST.length)];
    var ph=G.s.phase;
    // フェーズ別ロール
    var ROLES_BY_PHASE=[
      [{role:'UIデザイナー',ic:'🎨',salBase:320000,sk:{design:[65,90],ui:[75,95],speed:[55,80],logic:[50,75],comm:[55,80]}},
       {role:'グラフィック',ic:'✏️',salBase:300000,sk:{design:[70,95],ui:[50,70],speed:[50,75],logic:[40,65],comm:[55,75]}},
       {role:'UX',ic:'🔬',salBase:370000,sk:{design:[55,75],ui:[70,90],speed:[55,75],logic:[75,92],comm:[70,90]}},
       {role:'PM',ic:'📋',salBase:410000,sk:{design:[40,60],ui:[50,70],speed:[65,85],logic:[80,95],comm:[85,98]}}],
      [{role:'エンジニア',ic:'💻',salBase:490000,sk:{design:[30,55],ui:[55,80],speed:[80,97],logic:[80,97],comm:[55,80]}},
       {role:'モーショナー',ic:'🎬',salBase:440000,sk:{design:[70,90],ui:[65,85],speed:[55,75],logic:[50,70],comm:[58,80]}},
       {role:'コピーライター',ic:'✍️',salBase:300000,sk:{design:[50,70],ui:[40,60],speed:[60,80],logic:[65,85],comm:[85,98]}}],
      [{role:'AIデザイナー',ic:'🤖',salBase:580000,sk:{design:[55,80],ui:[70,92],speed:[85,98],logic:[75,95],comm:[55,80]}},
       {role:'ブランドデザイナー',ic:'💎',salBase:500000,sk:{design:[80,98],ui:[65,85],speed:[50,75],logic:[60,80],comm:[70,90]}}],
      [{role:'プロダクトマネジャー',ic:'🎯',salBase:850000,sk:{design:[50,70],ui:[65,85],speed:[70,90],logic:[88,98],comm:[85,98]}},
       {role:'データサイエンティスト',ic:'📊',salBase:1050000,sk:{design:[25,45],ui:[40,65],speed:[80,95],logic:[92,99],comm:[60,80]}},
       {role:'エンジニアリングマネジャー',ic:'⚙️',salBase:1200000,sk:{design:[30,50],ui:[55,75],speed:[85,98],logic:[90,99],comm:[75,92]}},
       {role:'グロースPM',ic:'📈',salBase:950000,sk:{design:[45,65],ui:[65,85],speed:[82,97],logic:[85,97],comm:[80,95]}}],
      [{role:'BizDevマネジャー',ic:'🤝',salBase:1100000,sk:{design:[40,60],ui:[50,70],speed:[70,90],logic:[82,97],comm:[90,99]}},
       {role:'プロダクトリード',ic:'🌟',salBase:1400000,sk:{design:[65,85],ui:[80,97],speed:[75,95],logic:[88,99],comm:[85,98]}}],
      [{role:'テックリード',ic:'🔧',salBase:1600000,sk:{design:[40,65],ui:[60,80],speed:[90,99],logic:[92,99],comm:[72,90]}},
       {role:'VPoE',ic:'🏗️',salBase:2000000,sk:{design:[45,65],ui:[60,80],speed:[85,98],logic:[92,99],comm:[85,98]}}]
    ];
    var roleList=ROLES_BY_PHASE[Math.min(ph,ROLES_BY_PHASE.length-1)];
    if(ph>=2&&r(3)===0)roleList=ROLES_BY_PHASE[Math.max(0,Math.min(ph-1,ROLES_BY_PHASE.length-1))];
    var rd=roleList[r(roleList.length)];
    var stat=function(rng){return clamp(rng[0]+r(rng[1]-rng[0]),0,99);};
    var salVar=0.8+r(40)/100;
    var ICS=['🎨','✏️','🔬','📋','💻','🎬','✍️','🤖','💎','🎯','📊','⚙️','📈','🤝','🌟','🔧'];
    var stObj={design:stat(rd.sk.design),ui:stat(rd.sk.ui),speed:stat(rd.sk.speed),logic:stat(rd.sk.logic),comm:stat(rd.sk.comm)};
    var mbtiData=assignMBTI(stObj);
    return {
      nm:nm,role:rd.role,ic:rd.ic||ICS[r(ICS.length)],
      sal:Math.round(rd.salBase*salVar/10000)*10000,
      st:stObj,
      mental:70+r(25),ph:Math.min(ph,5),
      mbti:mbtiData.en,
      trainData:[],  // [{topicId, nm, stat, bonus, completedAt}]
    };
  },

  genHire:function(){
    var phase=G.s.phase;
    var hasEngOk=!!(G.s.policies&&(G.s.policies['eng_ok']||G.s.policies['intl_exchange']));
    // 通常プール（specialでないもの）
    var fixed=HIRE_POOL.filter(function(h){
      if(h.special)return false;  // legend/robot/animalは別処理
      if(h.ph>phase)return false;
      if(h.role==='AIデザイナー'&&!G.s.tech['ai_design'])return false;
      if(G.s.staff.some(function(s){return s.nm===h.nm;}))return false;
      // 国際スタッフは英語OK制度または国際交流制度がないと出現しにくい
      if(h.intl&&!hasEngOk&&Math.random()>0.15)return false;
      return true;
    });
    // 🌟 特別枠：伝説・ロボット・動物は20%の確率で1名だけ混入
    var specialPool=HIRE_POOL.filter(function(h){
      if(!h.special)return false;
      if(h.ph>phase)return false;
      if(G.s.staff.some(function(s){return s.nm===h.nm;}))return false;
      // 未採用のspecialのみ
      return true;
    });
    var specialSlot=[];
    if(specialPool.length>0&&Math.random()<0.30){
      specialSlot=[pick(specialPool)];
    }
    var showCount=Math.min(4+phase*2,20);
    var existNames=new Set(G.s.staff.map(function(s){return s.nm;}));
    fixed.forEach(function(h){existNames.add(h.nm);});
    specialSlot.forEach(function(h){existNames.add(h.nm);});
    var generated=[],attempts=0,seed=Date.now()^(G.s.turn*7919+Math.random()*9999);
    var normalCount=showCount-specialSlot.length;
    while(generated.length<normalCount&&attempts<500){
      attempts++;
      seed=(seed*1664525+1013904223)&0x7fffffff;
      var gen=G.genStaff(seed);
      if(!existNames.has(gen.nm)){existNames.add(gen.nm);generated.push(gen);}
    }
    // specialを先頭に配置してから通常候補
    G.s.hirePool=specialSlot.concat(shuffle(fixed)).concat(generated).slice(0,showCount);
  },

  // ─ CANVAS: OFFICE ─
  ocZoom:1.0,  // アイソメ ズーム倍率（0.4〜2.5）

  zoomOC:function(dir){
    var steps=[0.4,0.5,0.6,0.75,0.85,1.0,1.2,1.4,1.6,1.9,2.2,2.5];
    var cur=steps.reduce(function(best,s,i){
      return Math.abs(s-G.ocZoom)<Math.abs(best.v-G.ocZoom)?{v:s,i:i}:best;
    },{v:steps[0],i:0});
    var next=Math.max(0,Math.min(steps.length-1, cur.i+dir));
    G.ocZoom=steps[next];
    var el=q('oc-zoom-val');
    if(el)el.textContent=Math.round(G.ocZoom*100)+'%';
    // localStorage保存
    localStorage.setItem('dcfk_oczoom',G.ocZoom);
  },

  startOC:function(){
    var cv=q('ocv');if(!cv)return;
    // ズーム復元
    var saved=parseFloat(localStorage.getItem('dcfk_oczoom')||'1');
    if(saved>=0.4&&saved<=2.5)G.ocZoom=saved;
    var el=q('oc-zoom-val');
    if(el)el.textContent=Math.round(G.ocZoom*100)+'%';
    // DPR対応: バッファサイズを表示サイズ×devicePixelRatioに設定
    G.resizeOC(cv);
    if(G.ocId)cancelAnimationFrame(G.ocId);
    (function loop(){G.drawOC(cv);G.ocId=requestAnimationFrame(loop);})();
  },

  // Canvasのバッファサイズを正しく設定（DPR対応）
  resizeOC:function(cv){
    if(!cv)cv=q('ocv');if(!cv)return;
    var wrap=cv.parentElement;if(!wrap)return;
    var dpr=window.devicePixelRatio||1;
    var cssW=wrap.clientWidth;
    var cssH=wrap.clientHeight||240;
    // CSS表示サイズを明示
    cv.style.width=cssW+'px';
    cv.style.height=cssH+'px';
    // バッファサイズ = CSS表示サイズ × DPR（シャープに描画）
    cv.width =Math.round(cssW*dpr);
    cv.height=Math.round(cssH*dpr);
    G._ocDPR=dpr;
  },

  drawOC:function(cv){
    var ctx=cv.getContext('2d');
    var dpr=G._ocDPR||window.devicePixelRatio||1;
    // CSS論理サイズで計算（DPRで割り戻す）
    var W=cv.width/dpr, H=cv.height/dpr;

    G.s.oAnim=(G.s.oAnim||0)+1;
    var t=G.s.oAnim, lv=G.s.offLevel;

    ctx.save();
    ctx.scale(dpr,dpr);  // DPRスケール適用
    ctx.clearRect(0,0,W,H);

    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    // ISOMETRIC CORE
    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    var Z=G.ocZoom||1.0;  // ズーム倍率
    var TW=48*Z, TH=24*Z; // タイル幅・高さ（ズーム反映）
    var WALL=36*Z;        // 壁の高さ（ズーム反映）
    var ROWS=9, COLS=16;
    // 原点：画面上部中央（ズームに関わらず安定した位置）
    var OX=W*0.5, OY=TH*1.2+10;

    // グリッド座標 → スクリーン座標（タイル左上）
    function toIso(gx,gy){
      return {
        x: OX + (gx - gy) * (TW/2),
        y: OY + (gx + gy) * (TH/2)
      };
    }
    // タイル中心
    function isoCenter(gx,gy){
      var p=toIso(gx,gy);
      return {x:p.x, y:p.y+TH/2};
    }

    // フェーズ別カラーテーマ
    // ─── Level themes ───────────────────────────────────────────────
    // Lv0: 京都 町家スタジオ（温かみある木目・和テイスト）
    // Lv1: 渋谷 オフィス（ライトグレー・モダン）
    // Lv2: 新潟 クリエイティブ（グリーンアクセント・自然光）
    // Lv3: デュアル本社（深みある高級感）
    // Lv4+: グローバル（ダーク・ハイテク）
    var themes=[
      {floor1:'#c8a878',floor2:'#bc9c6a',wall:'#7a5c3c',wallTop:'#5c4228',walldark:'#4a3220',ceiling:'#d4b880',sky:'#e8d4b0',accent:'#d4926a',isKyoto:true},
      {floor1:'#dcd8d2',floor2:'#d0ccc6',wall:'#a8a09a',wallTop:'#908a85',walldark:'#807870',ceiling:'#e8e4e0',sky:'#c4d4e8',accent:'#6080c0'},
      {floor1:'#d0d8c8',floor2:'#c4cebb',wall:'#8a9878',wallTop:'#7a8868',walldark:'#6a7858',ceiling:'#dce8d0',sky:'#b8d8c0',accent:'#5a9060',isNiigata:true},
      {floor1:'#28242e',floor2:'#201e28',wall:'#3a3450',wallTop:'#504878',walldark:'#2a2440',ceiling:'#302c3a',sky:'#181420',accent:'#9080e0'},
      {floor1:'#1e2236',floor2:'#1a1e30',wall:'#2a3060',wallTop:'#3040a0',walldark:'#1a2050',ceiling:'#252840',sky:'#0a1030',accent:'#6366f1'},
      {floor1:'#12141e',floor2:'#0e1018',wall:'#1a1e3a',wallTop:'#252850',walldark:'#10122a',ceiling:'#181a28',sky:'#060810',accent:'#00d4aa'},
      {floor1:'#080a10',floor2:'#06080c',wall:'#10122a',wallTop:'#181a38',walldark:'#08091a',ceiling:'#0e1020',sky:'#040508',accent:'#f59e0b'},
    ];
    var TH2=themes[Math.min(lv,themes.length-1)];
    var isDark=lv>=3;
    var isKyoto=lv===0;
    var isNiigata=lv===2;

    // ━━ SKY / BACKGROUND ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    var skyGrad=ctx.createLinearGradient(0,0,0,H);
    if(isKyoto){
      // 町家: 土壁の暖かみある朝の光
      skyGrad.addColorStop(0,'#f0dfc0');
      skyGrad.addColorStop(0.5,'#e8d0a8');
      skyGrad.addColorStop(1,TH2.floor1);
    } else if(isNiigata){
      // 新潟: 緑豊かな自然光
      skyGrad.addColorStop(0,'#b8dfc8');
      skyGrad.addColorStop(0.4,'#c8e8d0');
      skyGrad.addColorStop(1,TH2.floor1);
    } else if(isDark){
      skyGrad.addColorStop(0,TH2.sky);
      skyGrad.addColorStop(0.6,TH2.sky);
      skyGrad.addColorStop(1,TH2.floor1);
    } else {
      skyGrad.addColorStop(0,'#c8ddf0');
      skyGrad.addColorStop(0.4,TH2.sky);
      skyGrad.addColorStop(1,TH2.floor1);
    }
    ctx.fillStyle=skyGrad;
    ctx.fillRect(0,0,W,H);
    // 京都: 暖かいアンビエント光効果
    if(isKyoto){
      var sunGlow=ctx.createRadialGradient(W*0.8,H*0.1,0,W*0.8,H*0.1,W*0.5);
      sunGlow.addColorStop(0,'rgba(255,210,140,0.25)');
      sunGlow.addColorStop(1,'rgba(255,210,140,0)');
      ctx.fillStyle=sunGlow;ctx.fillRect(0,0,W,H);
    }
    // 新潟: 緑のアンビエント
    if(isNiigata){
      var natureFog=ctx.createLinearGradient(0,0,W,H);
      natureFog.addColorStop(0,'rgba(100,180,100,0.08)');
      natureFog.addColorStop(1,'rgba(100,180,100,0)');
      ctx.fillStyle=natureFog;ctx.fillRect(0,0,W,H);
    }

    // ━━ BACK WALL ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    ctx.save();
    ctx.beginPath();
    var p0=toIso(0,0), pC=toIso(COLS,0);
    ctx.moveTo(p0.x, p0.y);
    ctx.lineTo(pC.x, pC.y);
    ctx.lineTo(pC.x, pC.y-WALL);
    ctx.lineTo(p0.x, p0.y-WALL);
    ctx.closePath();
    var wGrad=ctx.createLinearGradient(p0.x,p0.y-WALL,p0.x,p0.y);
    wGrad.addColorStop(0,TH2.wallTop);
    wGrad.addColorStop(1,TH2.wall);
    ctx.fillStyle=wGrad;ctx.fill();

    if(isKyoto){
      // 京都: 土壁テクスチャ感（細かい横ライン）
      ctx.strokeStyle='rgba(100,70,40,0.08)';ctx.lineWidth=1;
      for(var ky=0;ky<8;ky++){var kyy=p0.y-WALL+ky*(WALL/8);ctx.beginPath();ctx.moveTo(p0.x,kyy);ctx.lineTo(pC.x,kyy);ctx.stroke();}
      // 障子（縦格子窓）× 2
      [COLS*0.25,COLS*0.65].forEach(function(wx){
        var wp=toIso(wx,0);
        var sx=wp.x-TW*0.55,sy=wp.y-WALL*0.85,sw=TW*1.1,sh=WALL*0.7;
        ctx.fillStyle='#7a5c3c';ctx.fillRect(sx-2,sy-2,sw+4,sh+4);
        ctx.fillStyle='rgba(255,250,230,0.85)';ctx.fillRect(sx,sy,sw,sh);
        // 障子格子
        ctx.strokeStyle='rgba(100,70,40,0.35)';ctx.lineWidth=1.5;
        for(var gi=1;gi<4;gi++){ctx.beginPath();ctx.moveTo(sx+sw*gi/4,sy);ctx.lineTo(sx+sw*gi/4,sy+sh);ctx.stroke();}
        for(var gj=1;gj<3;gj++){ctx.beginPath();ctx.moveTo(sx,sy+sh*gj/3);ctx.lineTo(sx+sw,sy+sh*gj/3);ctx.stroke();}
        // 光の滲み
        ctx.save();ctx.globalAlpha=0.15+Math.sin(t*0.015)*0.05;
        ctx.fillStyle='rgba(255,230,150,1)';ctx.fillRect(sx,sy,sw,sh);ctx.restore();
      });
    } else {
      // 通常: 縦ストライプ（パネル感）
      ctx.strokeStyle=isDark?'rgba(255,255,255,0.04)':'rgba(0,0,0,0.06)';ctx.lineWidth=1;
      for(var wi=1;wi<COLS;wi++){var wp=toIso(wi,0);ctx.beginPath();ctx.moveTo(wp.x,wp.y);ctx.lineTo(wp.x,wp.y-WALL);ctx.stroke();}
      // 通常窓
      var winNum=lv>=1?Math.min(2+lv,5):0;
      for(var wni=0;wni<winNum;wni++){
        var wgx=Math.round(COLS/(winNum+1))*(wni+1);
        var wp2=toIso(wgx,0);
        var wsx=wp2.x-(TW/4), wsy=wp2.y-WALL*0.82;
        var wwW=isNiigata?TW*0.7:TW*0.45,wwH=isNiigata?WALL*0.65:WALL*0.55;
        ctx.fillStyle=isDark?'#304080':isNiigata?'#6a8858':'#c8b090';
        ctx.fillRect(wsx-2,wsy-2,wwW+4,wwH+4);
        var skyCol=isDark?'#1a2850':isNiigata?'#a8d0b0':'#88c0e8';
        ctx.fillStyle=skyCol;ctx.fillRect(wsx,wsy,wwW,wwH);
        ctx.fillStyle='rgba(255,255,255,0.3)';ctx.fillRect(wsx+2,wsy+2,wwW*0.3,wwH*0.4);
        ctx.strokeStyle=isDark?'rgba(100,140,255,0.4)':isNiigata?'#5a7848':'#b0a080';ctx.lineWidth=1.5;
        ctx.beginPath();ctx.moveTo(wsx+wwW/2,wsy);ctx.lineTo(wsx+wwW/2,wsy+wwH);ctx.stroke();
        ctx.beginPath();ctx.moveTo(wsx,wsy+wwH/2);ctx.lineTo(wsx+wwW,wsy+wwH/2);ctx.stroke();
        // 新潟: 窓外の緑シルエット
        if(isNiigata&&wni===0){
          ctx.save();ctx.globalAlpha=0.5;
          ctx.fillStyle='#5a9048';
          ctx.beginPath();ctx.ellipse(wsx+wwW*0.3,wsy+wwH*0.6,wwW*0.25,wwH*0.5,0,0,Math.PI*2);ctx.fill();
          ctx.beginPath();ctx.ellipse(wsx+wwW*0.7,wsy+wwH*0.55,wwW*0.2,wwH*0.45,-0.3,0,Math.PI*2);ctx.fill();
          ctx.restore();
        }
        // ダーク: 窓の光ライン
        if(isDark){
          ctx.save();ctx.globalAlpha=0.3+Math.sin(t*0.02+wni)*0.1;
          ctx.strokeStyle=TH2.accent;ctx.lineWidth=0.5;
          ctx.strokeRect(wsx,wsy,wwW,wwH);ctx.restore();
        }
      }
    }
    ctx.restore();

    // 左壁（col=0）
    ctx.save();
    ctx.beginPath();
    var pl0=toIso(0,0), plR=toIso(0,ROWS);
    ctx.moveTo(pl0.x, pl0.y);ctx.lineTo(plR.x, plR.y);
    ctx.lineTo(plR.x, plR.y-WALL);ctx.lineTo(pl0.x, pl0.y-WALL);ctx.closePath();
    var wGrad2=ctx.createLinearGradient(pl0.x,0,plR.x,0);
    wGrad2.addColorStop(0,TH2.walldark);wGrad2.addColorStop(1,TH2.wall);
    ctx.fillStyle=wGrad2;ctx.fill();
    // 京都: 木の柱
    if(isKyoto){
      for(var ki=0;ki<=ROWS;ki+=3){
        var kp=toIso(0,ki);
        ctx.fillStyle='#4a3020';
        ctx.fillRect(kp.x-2,kp.y-WALL,4,WALL);
      }
    }
    // 新潟: 緑の苔感
    if(isNiigata){
      ctx.save();ctx.globalAlpha=0.06;ctx.fillStyle='#40a040';ctx.fill();ctx.restore();
    }
    ctx.restore();

    // ━━ FLOOR TILES ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    for(var gy=0;gy<ROWS;gy++){
      for(var gx=0;gx<COLS;gx++){
        var fp=toIso(gx,gy);
        var isEven=((gx+gy)%2===0);
        ctx.beginPath();
        ctx.moveTo(fp.x,fp.y);ctx.lineTo(fp.x+(TW/2),fp.y+(TH/2));
        ctx.lineTo(fp.x,fp.y+TH);ctx.lineTo(fp.x-(TW/2),fp.y+(TH/2));
        ctx.closePath();
        var fc=isEven?TH2.floor1:TH2.floor2;
        // 京都: 畳グリーン系でランダムな明度変化
        if(isKyoto){
          var tatami=Math.sin(gx*3.1+gy*7.3)*0.03;
          var hue=38+tatami*20;
          fc=isEven?'hsl('+hue+',40%,'+(51+tatami*8)+'%)':'hsl('+(hue-4)+',38%,'+(47+tatami*6)+'%)';
        }
        ctx.fillStyle=fc;ctx.fill();
        // AO
        var aoAlpha=0;
        if(gy<1.5)aoAlpha=0.1*(1.5-gy);
        else if(gx<1.5)aoAlpha=0.07*(1.5-gx);
        if(aoAlpha>0){ctx.fillStyle='rgba(0,0,0,'+aoAlpha.toFixed(3)+')';ctx.fill();}
        // 境界線
        ctx.strokeStyle=isDark?'rgba(255,255,255,0.04)':isKyoto?'rgba(80,50,20,0.12)':'rgba(0,0,0,0.07)';
        ctx.lineWidth=0.5;ctx.stroke();
        // 畳の縁（gy方向の偶数行に細い線）
        if(isKyoto&&gy%2===0){
          ctx.strokeStyle='rgba(80,55,25,0.2)';ctx.lineWidth=0.8;ctx.stroke();
        }
        // 新潟: 木目の方向感
        if(isNiigata&&isEven){
          ctx.save();ctx.strokeStyle='rgba(60,40,20,0.06)';ctx.lineWidth=0.5;
          var fpc=isoCenter(gx+0.5,gy+0.5);
          ctx.beginPath();ctx.moveTo(fpc.x-TW*0.3,fpc.y);ctx.lineTo(fpc.x+TW*0.3,fpc.y);ctx.stroke();
          ctx.restore();
        }
      }
    }

    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    // ISOMETRIC DRAW HELPERS
    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    // アイソメ「箱」：底面(gx,gy)、幅gdw×深さgdh、高さpxH
    function isoBox(gx,gy,gdw,gdh,pxH,colTop,colLeft,colRight,outline){
      // 4隅のスクリーン座標
      var pNW=toIso(gx,gy),      pNE=toIso(gx+gdw,gy);
      var pSW=toIso(gx,gy+gdh),  pSE=toIso(gx+gdw,gy+gdh);
      ctx.save();
      if(outline){ctx.strokeStyle=outline;ctx.lineWidth=0.8;}

      // 上面（天板）
      ctx.beginPath();
      ctx.moveTo(pNW.x,pNW.y-pxH);
      ctx.lineTo(pNE.x,pNE.y-pxH);
      ctx.lineTo(pSE.x,pSE.y-pxH);
      ctx.lineTo(pSW.x,pSW.y-pxH);
      ctx.closePath();
      ctx.fillStyle=colTop;ctx.fill();
      if(outline)ctx.stroke();

      // 左面（南西）
      ctx.beginPath();
      ctx.moveTo(pSW.x,pSW.y-pxH);
      ctx.lineTo(pSE.x,pSE.y-pxH);
      ctx.lineTo(pSE.x,pSE.y);
      ctx.lineTo(pSW.x,pSW.y);
      ctx.closePath();
      ctx.fillStyle=colLeft;ctx.fill();
      if(outline)ctx.stroke();

      // 右面（南東）
      ctx.beginPath();
      ctx.moveTo(pNE.x,pNE.y-pxH);
      ctx.lineTo(pSE.x,pSE.y-pxH);
      ctx.lineTo(pSE.x,pSE.y);
      ctx.lineTo(pNE.x,pNE.y);
      ctx.closePath();
      ctx.fillStyle=colRight;ctx.fill();
      if(outline)ctx.stroke();
      ctx.restore();
    }

    // アイソメ上面のみ（平面オブジェクト用）
    function isoFlat(gx,gy,gdw,gdh,col){
      var pNW=toIso(gx,gy),pNE=toIso(gx+gdw,gy);
      var pSW=toIso(gx,gy+gdh),pSE=toIso(gx+gdw,gy+gdh);
      ctx.beginPath();
      ctx.moveTo(pNW.x,pNW.y);ctx.lineTo(pNE.x,pNE.y);
      ctx.lineTo(pSE.x,pSE.y);ctx.lineTo(pSW.x,pSW.y);
      ctx.closePath();
      ctx.fillStyle=col;ctx.fill();
    }

    // ━━ DESK ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawIsoDesk(gx,gy,sIdx){
      var hasS=(sIdx>=0&&sIdx<G.s.staff.length);
      var s2=hasS?G.s.staff[sIdx]:null;
      var busy=hasS&&s2.status==='working';

      // デスク本体（テーマ別）
      var dTop=isKyoto?'#c8a060':isDark?'#2a2e3a':isNiigata?'#d8e0d0':'#f4f2ec';
      var dL=isKyoto?'#8a6028':isDark?'#1a1e28':isNiigata?'#b0c0a8':'#d8d4cc';
      var dR=isKyoto?'#a07038':isDark?'#20232e':isNiigata?'#c0c8b8':'#ccc8c0';
      var dOutline=isKyoto?'#6a4820':isDark?'#404558':isNiigata?'#8a9880':'#b0aca4';
      isoBox(gx,gy,1.8,0.9,14,dTop,dL,dR,dOutline);

      // モニター
      var mc=busy?[[90,140,240],[60,200,130],[220,80,140]][sIdx%3]:[70,75,90];
      var mBase=isoCenter(gx+0.7, gy+0.3);
      // モニター台座
      ctx.fillStyle=isDark?'#303440':'#383838';
      ctx.fillRect(mBase.x-3, mBase.y-20, 6, 4);
      ctx.fillRect(mBase.x-6, mBase.y-18, 12, 2);
      // モニターフレーム
      ctx.fillStyle=isDark?'#252830':'#1a1a1a';
      ctx.fillRect(mBase.x-13, mBase.y-34, 26, 17);
      // モニター画面
      var mCol='rgb('+mc[0]+','+mc[1]+','+mc[2]+')';
      ctx.fillStyle=busy?mCol:(isDark?'#1a1e2a':'#282828');
      ctx.fillRect(mBase.x-12, mBase.y-33, 24, 15);
      // 画面グロー（作業中）
      if(busy){
        ctx.save();
        ctx.shadowColor=mCol;ctx.shadowBlur=12;
        ctx.fillStyle='rgba('+mc[0]+','+mc[1]+','+mc[2]+',0.4)';
        ctx.fillRect(mBase.x-12, mBase.y-33, 24, 15);
        ctx.restore();
        // スクリーン上のライン
        var li=Math.floor(t*0.1)%4;
        for(var rr=0;rr<4;rr++){
          ctx.fillStyle=rr===li?'rgba(255,255,255,0.9)':'rgba(255,255,255,0.3)';
          ctx.fillRect(mBase.x-10+rr, mBase.y-31+rr*3, 14-rr*2, 1.5);
        }
      }
      // キーボード（デスク上）
      var kp=isoCenter(gx+0.75, gy+0.7);
      isoFlat(gx+0.3,gy+0.55,0.9,0.35,isDark?'#2a2e3a':'#dcdcd8');
      // コーヒーカップ
      if(sIdx%2===0){
        var cp=isoCenter(gx+0.2,gy+0.25);
        isoBox(gx+0.1,gy+0.15,0.35,0.3,8,'#c07830','#a05010','#b06020');
        ctx.fillStyle='#3a1808';
        ctx.beginPath();ctx.ellipse(cp.x,cp.y-8,5,3,0,0,Math.PI*2);ctx.fill();
        // 湯気
        if(Math.sin(t*0.08+sIdx)>0){
          ctx.fillStyle='rgba(220,220,240,0.5)';
          var voff=Math.sin(t*0.1+sIdx)*2;
          ctx.fillRect(cp.x-1,cp.y-14+voff,2,5);
          ctx.fillRect(cp.x+2,cp.y-16+voff,2,4);
        }
      }
    }

    // ━━ PLANT ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawPlant(gx,gy,big){
      var sz=big?1.2:0.7;
      var base=isoCenter(gx,gy);
      if(isKyoto){
        // 竹（細長い茎と葉）
        var sw=Math.sin(t*0.018+gx)*2;
        isoBox(gx-sz*0.2,gy-sz*0.2,sz*0.4,sz*0.4,sz*8,'#8a6040','#6a4828','#785030');
        var bambooH=big?3:2;
        for(var bi=0;bi<bambooH;bi++){
          var bh=sz*20*(0.9-bi*0.2);
          var bx=base.x+(bi%2===0?0:2)+sw*(bi+1)*0.5;
          var by=base.y-sz*8-bh*(bi);
          ctx.fillStyle=bi===0?'#5a8840':'#4a7838';
          ctx.fillRect(bx-2, by, 4, bh);
          // 節
          ctx.fillStyle='rgba(0,0,0,0.2)';
          ctx.fillRect(bx-2.5, by+bh*0.5, 5, 2);
        }
        // 葉（サイドに広がる）
        ctx.save();ctx.translate(base.x+sw*0.5,base.y-sz*45);
        for(var li=0;li<5;li++){
          var angle=-0.8+li*0.4;
          ctx.save();ctx.rotate(angle);
          ctx.fillStyle=li%2===0?'#5aaa30':'#4a9028';
          ctx.beginPath();ctx.ellipse(0,-12,3,14,0,0,Math.PI*2);ctx.fill();ctx.restore();
        }
        ctx.restore();
      } else {
        // 通常観葉植物
        isoBox(gx-sz*0.3,gy-sz*0.3,sz*0.6,sz*0.6,sz*10,
          isNiigata?'#8a7050':isDark?'#303040':'#a06030',
          isNiigata?'#6a5038':isDark?'#202030':'#7a4820',
          isNiigata?'#7a6044':isDark?'#282838':'#8a5428');
        ctx.fillStyle=isDark?'#1a1a28':'#5a3010';
        ctx.beginPath();ctx.ellipse(base.x,base.y-sz*10,sz*12,sz*5,0,0,Math.PI*2);ctx.fill();
        var leafSwing=Math.sin(t*0.025)*3;
        var leafCols=isDark?['#1a6030','#228840','#2aaa50']:
          isNiigata?['#3a9040','#4ab050','#58c060']:['#2a7a30','#38a040','#48c050'];
        [[0,-sz*28,sz*16],[sz*10,-sz*22,sz*12],[-sz*10,-sz*22,sz*12],
         [sz*5,-sz*34,sz*10],[-sz*5,-sz*34,sz*10],[0,-sz*40,sz*8]].forEach(function(l,li){
          ctx.fillStyle=leafCols[li%3];
          ctx.save();ctx.translate(base.x+l[0]+leafSwing*(li%2?1:-1)*0.3,base.y+l[1]);
          ctx.beginPath();ctx.ellipse(0,0,l[2]*0.7,l[2],0.3,0,Math.PI*2);ctx.fill();ctx.restore();
        });
      }
    }

    // ━━ SOFA ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawSofa(gx,gy){
      // テーマ別色
      var sCol=isKyoto?['#6a4028','#4a2818','#582010']:
               isNiigata?['#5a7040','#405030','#4e6038']:
               isDark?['#2a3050','#1a2038','#222840']:
               ['#d07030','#a85020','#c06828'];
      var sCushion=isKyoto?['#8a5038','#6a3828','#7a4430']:
                   isNiigata?['#7a9050','#5a7040','#6a8048']:
                   isDark?['#3a4070','#283060','#323868']:
                   ['#c86828','#a05020','#b86030'];
      // 背もたれ
      isoBox(gx,gy,2,0.4,22,sCol[0],sCol[1],sCol[2]);
      // 座面
      isoBox(gx,gy+0.4,2,1,14,isDark?'#303858':'#e89850',isDark?'#202840':'#c07838',isDark?'#283060':'#d08848');
      // アームレスト左右
      isoBox(gx,gy,0.2,1.4,22,sCol[1],sCol[2],sCol[1]);
      isoBox(gx+1.8,gy,0.2,1.4,22,sCol[1],sCol[2],sCol[1]);
      // クッション
      isoBox(gx+0.25,gy+0.5,0.65,0.8,18,sCushion[0],sCushion[1],sCushion[2]);
      isoBox(gx+1.1,gy+0.5,0.65,0.8,18,sCushion[0],sCushion[1],sCushion[2]);
      // 京都: 座布団（クッションに和柄テクスチャ）
      if(isKyoto){
        var cp1=isoCenter(gx+0.55,gy+0.8);var cp2=isoCenter(gx+1.4,gy+0.8);
        ctx.save();ctx.globalAlpha=0.4;ctx.strokeStyle='#d4b080';ctx.lineWidth=1;
        ctx.beginPath();ctx.arc(cp1.x,cp1.y-16,5,0,Math.PI*2);ctx.stroke();
        ctx.beginPath();ctx.arc(cp2.x,cp2.y-16,5,0,Math.PI*2);ctx.stroke();
        ctx.restore();
      }
    }

    // ━━ COFFEE TABLE ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawCoffeeTable(gx,gy){
      if(isKyoto){
        // 座卓（低めの和テーブル）
        isoBox(gx,gy,1.4,0.7,6,'#9a6a30','#7a5020','#8a6028','rgba(0,0,0,0.2)');
        // 漆器のお盆
        isoFlat(gx+0.3,gy+0.1,0.5,0.4,'rgba(180,30,10,0.7)');
        // 茶器
        var tp=isoCenter(gx+0.5,gy+0.25);
        isoBox(gx+0.45,gy+0.2,0.3,0.25,5,'#7a4820','#5a3010','#6a3818');
        ctx.fillStyle='rgba(100,180,80,0.6)';ctx.beginPath();ctx.ellipse(tp.x,tp.y-5,4,2,0,0,Math.PI*2);ctx.fill();
      } else {
        isoBox(gx,gy,1.4,0.7,8,isDark?'#282838':'#d4aa78',isDark?'#181828':'#b08858',isDark?'#202030':'#c89a68','rgba(0,0,0,0.15)');
        isoFlat(gx+0.2,gy+0.1,0.6,0.4,'rgba(220,80,80,0.6)');
        isoFlat(gx+0.6,gy+0.25,0.5,0.35,'rgba(80,120,220,0.6)');
      }
    }

    // ━━ BOOKSHELF ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawBookshelf(gx,gy){
      var bsTop=isKyoto?'#9a7850':isDark?'#2a2e3c':isNiigata?'#a8b898':'#c8b898';
      var bsL=isKyoto?'#6a5030':isDark?'#1a1e2c':isNiigata?'#889878':'#a89878';
      var bsR=isKyoto?'#806040':isDark?'#202430':isNiigata?'#98a888':'#b8a888';
      isoBox(gx,gy,1.5,0.4,40,bsTop,bsL,bsR,isDark?'#404558':'rgba(0,0,0,0.2)');
      // 棚板
      var shelfY=toIso(gx,gy).y-40+18;
      ctx.strokeStyle=bsL;ctx.lineWidth=1.5;
      var p1=toIso(gx,gy),p2=toIso(gx+1.5,gy);
      ctx.beginPath();ctx.moveTo(p1.x-(0*TW/2),shelfY);ctx.lineTo(p2.x+(0*TW/2),shelfY);ctx.stroke();
      // 本（テーマ別）
      var bookCols=isKyoto?['#8a3020','#4060a0','#206040','#806010','#502050','#2a7070']:
        isDark?['#6366f1','#00d4aa','#f59e0b','#ec4899','#3b82f6','#10b981']:
        ['#e04040','#4060d0','#40a040','#d0a020','#a040c0','#40b0a0','#d06030'];
      for(var bi=0;bi<6;bi++){
        var bp=toIso(gx+bi*0.24+0.05,gy+0.05);
        ctx.fillStyle=bookCols[bi%bookCols.length];
        ctx.fillRect(bp.x-3,bp.y-32+bi%2*4,5,22);
        // 本の背表紙の光沢
        ctx.fillStyle='rgba(255,255,255,0.15)';ctx.fillRect(bp.x-3,bp.y-32+bi%2*4,1.5,22);
      }
      // 小物（京都: 和の置物）
      if(isKyoto){
        var op=isoCenter(gx+1.2,gy+0.1);
        ctx.fillStyle='#c8d0e0';ctx.beginPath();ctx.ellipse(op.x,op.y-35,5,8,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#a0a8c0';ctx.beginPath();ctx.ellipse(op.x,op.y-35,3,6,0,0,Math.PI*2);ctx.fill();
      }
    }

    // ━━ WHITEBOARD / 掛け軸 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawWhiteboard(gx,gy){
      var p=toIso(gx,gy);
      if(isKyoto){
        // 掛け軸
        var kx=p.x-TW*0.25, ky=p.y-WALL+3, kw=TW*0.5, kh=WALL*0.7;
        // 掛け軸本体
        ctx.fillStyle='#f0e8d0';ctx.fillRect(kx,ky,kw,kh);
        ctx.strokeStyle='#6a4820';ctx.lineWidth=1.5;ctx.strokeRect(kx,ky,kw,kh);
        // 上下の軸棒
        ctx.fillStyle='#5a3818';ctx.fillRect(kx-3,ky-3,kw+6,5);
        ctx.fillStyle='#5a3818';ctx.fillRect(kx-3,ky+kh-2,kw+6,5);
        // 筆文字風
        ctx.fillStyle='rgba(30,20,10,0.8)';ctx.font='bold 9px serif';
        ctx.textAlign='center';
        ctx.fillText('設計',p.x,ky+kh*0.35);
        ctx.fillText('美意識',p.x,ky+kh*0.6);
        ctx.textAlign='left';
        // 印
        ctx.fillStyle='#c02020';
        ctx.fillRect(p.x+TW*0.1,ky+kh*0.72,8,8);
        ctx.fillStyle='rgba(240,220,180,0.8)';ctx.font='5px serif';
        ctx.fillText('KY',p.x+TW*0.11,ky+kh*0.72+6);
      } else {
        // 通常ホワイトボード
        ctx.fillStyle=isDark?'#1e2238':'#888880';
        ctx.fillRect(p.x-(TW*0.5), p.y-WALL+2, TW, 2);
        ctx.fillStyle=isDark?'#242840':'#f8f8f0';
        ctx.fillRect(p.x-(TW*0.45), p.y-WALL+4, TW*0.9, WALL*0.65);
        if(isDark){
          ctx.strokeStyle=TH2.accent;ctx.lineWidth=0.5;ctx.globalAlpha=0.3;
          ctx.strokeRect(p.x-(TW*0.45), p.y-WALL+4, TW*0.9, WALL*0.65);ctx.globalAlpha=1;
        }
        ctx.fillStyle=isDark?'rgba('+TH2.accent.replace('#','').match(/.{2}/g).map(function(h){return parseInt(h,16)}).join(',')+',0.7)':'rgba(50,70,200,0.6)';
        ctx.font='8px monospace';ctx.fillText('UI FLOW',p.x-(TW*0.35),p.y-WALL*0.5);
        ctx.strokeStyle=isDark?'rgba(200,80,80,0.6)':'rgba(180,50,50,0.6)';
        ctx.lineWidth=1.5;
        ctx.beginPath();ctx.moveTo(p.x-(TW*0.35),p.y-WALL*0.28);ctx.lineTo(p.x-(TW*0.1),p.y-WALL*0.18);ctx.lineTo(p.x+(TW*0.15),p.y-WALL*0.28);ctx.stroke();
        ctx.fillStyle=isDark?'rgba(40,160,100,0.6)':'rgba(30,140,80,0.5)';
        ctx.fillRect(p.x+(TW*0.08),p.y-WALL*0.5,TW*0.22,WALL*0.2);
      }
    }

    // ━━ BIG SCREEN (lv>=4) ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawBigScreen(gx,gy){
      var p=toIso(gx,gy);
      var sw=TW*1.8, sh=WALL*0.75;
      ctx.fillStyle=isDark?'#10123a':'#181840';
      ctx.fillRect(p.x-sw/2, p.y-WALL+2, sw, sh);
      // データビジュアライゼーション
      var barColors=isDark?['#6366f1','#00d4aa','#f59e0b']:['#4f46e5','#059669','#d97706'];
      for(var di=0;di<8;di++){
        var bh=Math.floor(6+Math.sin(t*0.04+di*1.2)*8+8);
        ctx.fillStyle=barColors[di%3];
        ctx.globalAlpha=0.6+Math.sin(t*0.06+di)*0.3;
        ctx.fillRect(p.x-sw/2+8+di*(sw/9), p.y-WALL+sh-bh, sw/10, bh);
      }
      ctx.globalAlpha=1;
      ctx.fillStyle=isDark?'#00d4aa':'#4f46e5';
      ctx.font='9px monospace';
      var label=lv>=6?'GLOBAL HQ ×8':lv>=5?'NY·LDN·TYO':lv>=4?'ASIA EXPANSION':'PRODUCT HQ';
      ctx.fillStyle=TH2.accent||'#6366f1';
      ctx.fillText(label, p.x-sw/2+6, p.y-WALL+sh+12);
    }

    // ━━ LAMP ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawLamp(gx,gy){
      var base=isoCenter(gx,gy);
      // 台座
      isoBox(gx-0.1,gy-0.1,0.2,0.2,3,'#888','#666','#777');
      // ポール
      ctx.fillStyle='#777';
      ctx.fillRect(base.x-1, base.y-40, 2, 37);
      // シェード
      ctx.fillStyle='#f0c040';
      ctx.beginPath();
      ctx.moveTo(base.x-12, base.y-40);
      ctx.lineTo(base.x+12, base.y-40);
      ctx.lineTo(base.x+7,  base.y-32);
      ctx.lineTo(base.x-7,  base.y-32);
      ctx.closePath(); ctx.fill();
      // 光の輪
      ctx.save();
      ctx.globalAlpha=0.12+Math.sin(t*0.04)*0.04;
      ctx.fillStyle='#f0c040';
      ctx.beginPath();
      ctx.ellipse(base.x, base.y-20, 28, 14, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // ━━ SERVER RACK (lv>=5) ━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawServerRack(gx,gy){
      isoBox(gx,gy,0.6,0.4,50,
        isDark?'#1a1e30':'#2a2e40',
        isDark?'#101420':'#1e2230',
        isDark?'#161a28':'#242838');
      var rp=isoCenter(gx+0.15,gy+0.1);
      for(var ri=0;ri<5;ri++){
        var on=Math.sin(t*0.12+ri*2.1)>0;
        ctx.fillStyle=on?'#6366f1':'#232538';
        ctx.fillRect(rp.x, rp.y-40+ri*8, 4, 3);
        ctx.fillStyle=on?'#00d4aa':'#1a2030';
        ctx.fillRect(rp.x+6, rp.y-40+ri*8, 3, 3);
      }
    }

    // ━━ CEILING LIGHT ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawCeilingLight(gx,gy){
      var p=toIso(gx,gy);
      var pulse=0.85+Math.sin(t*0.02)*0.05;
      ctx.save();
      ctx.strokeStyle=isDark?'#555':isKyoto?'#8a5c28':'#888';
      ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(p.x,p.y-WALL+2);ctx.lineTo(p.x,p.y-WALL+18);ctx.stroke();

      if(isKyoto){
        // 提灯スタイル
        var lcx=p.x, lcy=p.y-WALL+18;
        ctx.fillStyle='#d44020';
        ctx.beginPath();ctx.ellipse(lcx,lcy+6,10,14,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='rgba(255,180,80,0.8)';
        ctx.beginPath();ctx.ellipse(lcx,lcy+6,7,10,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.4)';
        ctx.beginPath();ctx.ellipse(lcx-2,lcy+3,3,5,0,0,Math.PI*2);ctx.fill();
        // 上下の輪
        ctx.strokeStyle='#8a2010';ctx.lineWidth=1;
        ctx.beginPath();ctx.ellipse(lcx,lcy+2,10,4,0,0,Math.PI*2);ctx.stroke();
        ctx.beginPath();ctx.ellipse(lcx,lcy+18,10,4,0,0,Math.PI*2);ctx.stroke();
        // タッセル
        ctx.strokeStyle='#c83020';ctx.lineWidth=0.8;
        for(var ti=0;ti<5;ti++){ctx.beginPath();ctx.moveTo(lcx-8+ti*4,lcy+22);ctx.lineTo(lcx-8+ti*4,lcy+30+ti%2*4);ctx.stroke();}
      } else {
        // シェード（逆台形）
        ctx.fillStyle=isDark?'#2a2e40':'#e8e0d0';
        ctx.beginPath();
        ctx.moveTo(p.x-10,p.y-WALL+18);ctx.lineTo(p.x+10,p.y-WALL+18);
        ctx.lineTo(p.x+7,p.y-WALL+28);ctx.lineTo(p.x-7,p.y-WALL+28);
        ctx.closePath();ctx.fill();
        if(isDark){
          // ネオン縁取り
          ctx.save();ctx.strokeStyle=TH2.accent;ctx.lineWidth=1;ctx.globalAlpha=0.4+Math.sin(t*0.03)*0.2;
          ctx.beginPath();ctx.moveTo(p.x-10,p.y-WALL+18);ctx.lineTo(p.x+10,p.y-WALL+18);
          ctx.lineTo(p.x+7,p.y-WALL+28);ctx.lineTo(p.x-7,p.y-WALL+28);ctx.closePath();ctx.stroke();
          ctx.restore();
        }
      }
      // 光グロー
      var lgY=p.y-WALL+(isKyoto?30:28);
      var lg=ctx.createRadialGradient(p.x,lgY,0,p.x,lgY,TW*1.5);
      if(isDark){
        var ac=TH2.accent||'255,240,200';
        lg.addColorStop(0,'rgba(255,240,200,'+(.15*pulse)+')');
        lg.addColorStop(0.4,'rgba(255,230,180,'+(.06*pulse)+')');
        lg.addColorStop(1,'rgba(255,220,160,0)');
      }else{
        lg.addColorStop(0,'rgba(255,250,230,'+(.18*pulse)+')');
        lg.addColorStop(0.5,'rgba(255,245,220,'+(.06*pulse)+')');
        lg.addColorStop(1,'rgba(255,245,210,0)');
      }
      ctx.fillStyle=lg;
      ctx.beginPath();ctx.ellipse(p.x,lgY+TH,TW*1.5,TH*3,0,0,Math.PI*2);ctx.fill();
      // 電球の輝き
      ctx.fillStyle=isDark?'rgba(255,240,180,.7)':'rgba(255,255,220,.9)';
      ctx.beginPath();ctx.arc(p.x,p.y-WALL+26,3,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }

    // ━━ RUG / CARPET ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawRug(gx,gy,gw,gh,col1,col2){
      // 外枠
      var border=0.15;
      ctx.save();
      var pNW=toIso(gx,gy),pNE=toIso(gx+gw,gy);
      var pSW=toIso(gx,gy+gh),pSE=toIso(gx+gw,gy+gh);
      ctx.beginPath();
      ctx.moveTo(pNW.x,pNW.y);ctx.lineTo(pNE.x,pNE.y);
      ctx.lineTo(pSE.x,pSE.y);ctx.lineTo(pSW.x,pSW.y);
      ctx.closePath();
      ctx.fillStyle=col1;ctx.globalAlpha=0.55;ctx.fill();
      // 内枠
      var i2NW=toIso(gx+border,gy+border),i2NE=toIso(gx+gw-border,gy+border);
      var i2SW=toIso(gx+border,gy+gh-border),i2SE=toIso(gx+gw-border,gy+gh-border);
      ctx.beginPath();
      ctx.moveTo(i2NW.x,i2NW.y);ctx.lineTo(i2NE.x,i2NE.y);
      ctx.lineTo(i2SE.x,i2SE.y);ctx.lineTo(i2SW.x,i2SW.y);
      ctx.closePath();
      ctx.fillStyle=col2;ctx.fill();
      ctx.globalAlpha=1;
      ctx.restore();
    }

    // ━━ RECEPTION DESK ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawReceptionDesk(gx,gy){
      // カウンター
      var cTop=isDark?'#3a3060':'#f0ece4';
      var cL=isDark?'#2a2050':'#d8d2c8';
      var cR=isDark?'#302858':'#ccc6bc';
      isoBox(gx,gy,2.5,0.6,24,cTop,cL,cR,isDark?'#504878':'rgba(0,0,0,0.15)');
      // 飾り（小物）
      var desk2p=isoCenter(gx+0.5,gy+0.2);
      ctx.fillStyle=isDark?'#5566cc':'#e84060';
      ctx.beginPath();ctx.arc(desk2p.x,desk2p.y-24,3,0,Math.PI*2);ctx.fill(); // 花
      ctx.fillStyle=isDark?'#4a5080':'#f0f0f0';
      ctx.fillRect(desk2p.x+6,desk2p.y-27,8,5); // カード
      // フロントパネル
      isoBox(gx,gy+0.6,2.5,0.1,12,cL,cL,cR);
      // 会社名テキスト
      var namep=isoCenter(gx+1.25,gy+0.6);
      ctx.fillStyle=isDark?'rgba(150,180,255,.7)':'rgba(80,80,200,.5)';
      ctx.font='bold 7px sans-serif';
      ctx.textAlign='center';
      ctx.fillText('STUDIO',namep.x,namep.y-8);
      ctx.textAlign='left';
    }

    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    // ROOM LAYOUT（フェーズ別オブジェクト配置）
    // ━━ MEETING TABLE ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawMeetingTable(gx,gy){
      // 大きな楕円テーブル
      var tTop=isDark?'#2e3248':'#e8e0d4';
      var tL=isDark?'#1e2238':'#c8c0b4';
      var tR=isDark?'#252840':'#d0c8bc';
      isoBox(gx,gy,2.8,1.2,10,tTop,tL,tR,isDark?'rgba(255,255,255,.06)':'rgba(0,0,0,.15)');
      // テーブル脚
      var legC=isDark?'#1a1e30':'#a0988c';
      isoBox(gx+0.1,gy+0.1,0.2,0.2,12,legC,legC,legC);
      isoBox(gx+2.5,gy+0.1,0.2,0.2,12,legC,legC,legC);
      isoBox(gx+0.1,gy+0.9,0.2,0.2,12,legC,legC,legC);
      isoBox(gx+2.5,gy+0.9,0.2,0.2,12,legC,legC,legC);
      // テーブル上のアイテム（コーヒー、ノート）
      var mp=isoCenter(gx+1.4,gy+0.6);
      // 小物
      ctx.fillStyle=isDark?'rgba(99,102,241,.6)':'rgba(60,80,180,.4)';
      ctx.beginPath();ctx.ellipse(mp.x-8,mp.y-10,5,3,0,0,Math.PI*2);ctx.fill(); // ノート
      ctx.fillStyle=isDark?'rgba(239,68,68,.5)':'rgba(200,50,50,.4)';
      ctx.beginPath();ctx.ellipse(mp.x+6,mp.y-10,4,2.5,0,0,Math.PI*2);ctx.fill(); // ノート2
      // コーヒーカップ
      isoBox(gx+0.5,gy+0.3,0.3,0.25,7,'#c07830','#a05010','#b06020');
      isoBox(gx+1.8,gy+0.7,0.3,0.25,7,'#c07830','#a05010','#b06020');
      // チェア6脚
      var chairC=isDark?'#3a3060':'#8a7060';
      var chairTop=isDark?'#2a2050':'#a09080';
      var chairPos=[[gx-0.6,gy+0.1],[gx-0.6,gy+0.8],[gx+3.1,gy+0.1],[gx+3.1,gy+0.8],[gx+1.0,gy-0.6],[gx+1.6,gy+1.7]];
      chairPos.forEach(function(cp){
        isoBox(cp[0],cp[1],0.55,0.55,8,chairTop,chairC,chairC);
        isoBox(cp[0],cp[1]-0.05,0.55,0.1,14,chairC,chairC,chairC); // 背もたれ
      });
    }

    // ━━ KITCHEN / SNACK AREA ━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawKitchen(gx,gy){
      // カウンター本体
      var kTop=isDark?'#2e3248':'#d8d0c4';
      var kL=isDark?'#1e2238':'#b8b0a4';
      var kR=isDark?'#252840':'#c0b8ac';
      isoBox(gx,gy,2,0.6,20,kTop,kL,kR,isDark?'rgba(255,255,255,.05)':'rgba(0,0,0,.12)');
      // コーヒーメーカー
      isoBox(gx+0.1,gy+0.05,0.5,0.4,22,
        isDark?'#2a2a3a':'#303030',
        isDark?'#1a1a28':'#222222',
        isDark?'#222230':'#282828');
      // 操作パネルLED
      var cfP=isoCenter(gx+0.35,gy+0.25);
      ctx.fillStyle='#00d4aa';ctx.globalAlpha=0.7+Math.sin(t*0.08)*0.3;
      ctx.beginPath();ctx.arc(cfP.x,cfP.y-28,2,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=1;
      // カップ
      isoBox(gx+0.7,gy+0.1,0.25,0.22,10,'#f0ede5','#d0cdc5','#e0ddd5');
      // 電子レンジ
      isoBox(gx+1.1,gy+0.05,0.7,0.45,20,
        isDark?'#1a2030':'#e0e0e0',
        isDark?'#101520':'#c0c0c0',
        isDark?'#151828':'#d0d0d0');
      var mwP=isoCenter(gx+1.45,gy+0.27);
      ctx.fillStyle=isDark?'#304080':'#888888';
      ctx.fillRect(mwP.x-6,mwP.y-26,12,8); // 扉
      ctx.strokeStyle=isDark?'#4a5898':'#666666';ctx.lineWidth=0.8;
      ctx.strokeRect(mwP.x-5,mwP.y-25,10,6);
      // フリッジ（lv>=3）
      if(lv>=3){
        isoBox(gx+1.85,gy,0.6,0.6,38,
          isDark?'#1e2238':'#e8e8e8',
          isDark?'#111828':'#c8c8c8',
          isDark?'#181e30':'#d8d8d8');
      }
      // 棚の上の植物
      drawPlant(gx+0.1,gy-0.5,false);
    }

    // ━━ PARTITION WALL ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawPartition(gx,gy,horizontal){
      var h=horizontal;
      var pTop=isDark?'#282c40':'#e0dcd4';
      var pL=isDark?'#181c2c':'#c0bcb4';
      var pR=isDark?'#202438':'#ccc8c0';
      if(h){
        isoBox(gx,gy,2,0.1,28,pTop,pL,pR);
        // ガラス部分
        ctx.fillStyle=isDark?'rgba(100,130,200,.15)':'rgba(140,180,220,.25)';
        var p1=toIso(gx,gy),p2=toIso(gx+2,gy);
        ctx.fillRect(Math.min(p1.x,p2.x),p1.y-28, Math.abs(p2.x-p1.x), 20);
      } else {
        isoBox(gx,gy,0.1,2,28,pTop,pL,pR);
        var p3=toIso(gx,gy),p4=toIso(gx,gy+2);
        ctx.fillStyle=isDark?'rgba(100,130,200,.15)':'rgba(140,180,220,.25)';
        ctx.beginPath();
        ctx.moveTo(p3.x,p3.y-28);ctx.lineTo(p3.x,p3.y);
        ctx.lineTo(p4.x,p4.y);ctx.lineTo(p4.x,p4.y-28);
        ctx.closePath();ctx.fill();
      }
    }

    // ━━ WINDOW LIGHT RAYS ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    function drawWindowLight(gx,gy){
      if(isDark)return;
      var p=toIso(gx,gy);
      ctx.save();
      ctx.globalAlpha=0.06+Math.sin(t*0.012)*0.02;
      var rayGrad=ctx.createLinearGradient(p.x,p.y-WALL,p.x+TW*2,p.y+TH*3);
      rayGrad.addColorStop(0,'rgba(255,250,230,.8)');
      rayGrad.addColorStop(1,'rgba(255,250,230,0)');
      // 光柱（2本）
      ctx.beginPath();
      ctx.moveTo(p.x-TW*0.1,p.y-WALL+4);
      ctx.lineTo(p.x+TW*0.1,p.y-WALL+4);
      ctx.lineTo(p.x+TW*2.1,p.y+TH*3);
      ctx.lineTo(p.x+TW*1.9,p.y+TH*3);
      ctx.closePath();
      ctx.fillStyle=rayGrad;ctx.fill();
      ctx.globalAlpha=1;
      ctx.restore();
    }

    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    var staffCount=G.s.staff.length;
    var maxDesks=lv===0?1:lv<=1?3:lv<=2?6:lv<=3?12:lv<=4?20:lv<=5?32:50;
    var visCount=Math.min(staffCount,maxDesks);

    // デスク配置グリッド（アイソメ座標）
    var desks=[];
    var dcols=Math.max(1,Math.min(Math.ceil(Math.sqrt(visCount*2)),7));
    var drows=Math.max(1,Math.ceil(visCount/dcols));
    var dStartX=1.5, dStartY=1.5;
    var dSpX=Math.min(3.2,(COLS-3)/Math.max(dcols,1));
    var dSpY=Math.min(2.8,(ROWS-3)/Math.max(drows,1));
    for(var dr=0;dr<drows;dr++){
      for(var dc=0;dc<dcols;dc++){
        var didx=dr*dcols+dc;
        if(didx>=visCount)break;
        desks.push({
          gx:dStartX+dc*dSpX,
          gy:dStartY+dr*dSpY,
          idx:didx,
          sortY:dStartY+dr*dSpY+1
        });
      }
    }

    // ━━ STATIC OBJECTS（後ろから前の順で描画） ━━━━━━━━━
    // 京都: 窓から差し込む和の光
    if(isKyoto){
      ctx.save();ctx.globalAlpha=0.08+Math.sin(t*0.012)*0.03;
      var rg=ctx.createLinearGradient(W*0.2,0,W*0.6,H);
      rg.addColorStop(0,'rgba(255,220,130,1)');rg.addColorStop(1,'rgba(255,220,130,0)');
      ctx.fillStyle=rg;
      ctx.beginPath();ctx.moveTo(W*0.22,0);ctx.lineTo(W*0.28,0);ctx.lineTo(W*0.7,H);ctx.lineTo(W*0.62,H);ctx.closePath();ctx.fill();
      ctx.globalAlpha=0.05+Math.sin(t*0.015+1)*0.02;
      ctx.beginPath();ctx.moveTo(W*0.6,0);ctx.lineTo(W*0.66,0);ctx.lineTo(W*0.9,H);ctx.lineTo(W*0.84,H);ctx.closePath();ctx.fill();
      ctx.restore();
    }
    // 通常: 窓の光柱
    if(lv>=1&&!isDark&&!isKyoto){
      var winNum2=Math.min(2+lv,5);
      for(var wni2=0;wni2<winNum2;wni2++){
        var wgx2=Math.round(COLS/(winNum2+1))*(wni2+1);
        drawWindowLight(wgx2, 0);
      }
    }
    // ホワイトボード（後壁）
    if(lv>=1) drawWhiteboard(COLS*0.5, 0);
    // 大型スクリーン（lv4+）
    if(lv>=4) drawBigScreen(COLS*0.5, 0);
    // 本棚（左後ろ角）
    if(lv>=2) drawBookshelf(0.2, 0.3);
    if(lv>=4) drawBookshelf(COLS-2, 0.3);
    // サーバーラック（lv5+）
    if(lv>=5){ drawServerRack(0.3, 1.2); drawServerRack(0.3, 2.0); }

    // 天井ライト（ペンダント）
    if(lv>=1){
      var cLightNum=Math.min(2+lv,5);
      for(var cli=0;cli<cLightNum;cli++){
        drawCeilingLight(COLS*(cli+1)/(cLightNum+1), ROWS*0.4);
      }
    }

    // カーペット / ラグ
    if(lv>=1){
      var rugCols=isDark?['#403060','#603080']:isKyoto?['#7a3020','#5a2010']:isNiigata?['#5a7040','#4a6030']:['#a08060','#806040'];
      drawRug(COLS*0.6,ROWS-2.8,3.5,2.5,rugCols[0],rugCols[1]);
    }
    if(lv>=3){
      var rugCols2=isDark?['#204060','#104050']:isNiigata?['#6a8058','#5a7048']:['#c0a888','#a08868'];
      drawRug(1.2,ROWS-2.8,3.2,2.2,rugCols2[0],rugCols2[1]);
    }
    // 会議テーブルエリアのラグ
    if(lv>=2){
      var rugCols3=isDark?['#303858','#404868']:['#b8a898','#c8b8a8'];
      drawRug(COLS*0.35,ROWS*0.45,4,2.8,rugCols3[0],rugCols3[1]);
    }

    // 奥の植物（後壁沿い）
    drawPlant(0.5, 0, false);
    drawPlant(COLS-0.8, 0, false);
    if(lv>=2){ drawPlant(COLS*0.35, 0.1, true); drawPlant(COLS*0.65, 0.1, false); }
    if(lv>=4){ drawPlant(COLS*0.2, 0.2, false); }

    // キッチン・スナックエリア（lv>=2）
    if(lv>=2) drawKitchen(0.3, 0.8);

    // パーティション（lv>=3）- ゾーン分け
    if(lv>=3){
      drawPartition(COLS*0.38, ROWS*0.4, false);
      drawPartition(COLS*0.38, ROWS*0.4+2, true);
    }

    // 会議テーブル（lv>=2）
    if(lv>=2) drawMeetingTable(COLS*0.38, ROWS*0.48);

    // Reception desk (lv>=1)
    if(lv>=1) drawReceptionDesk(COLS*0.7, 0.4);

    // デスクを描画（Y順ソート済み）
    desks.sort(function(a,b){return a.sortY-b.sortY;});
    desks.forEach(function(d){ drawIsoDesk(d.gx, d.gy, d.idx); });

    // 手前オブジェクト（前方配置）
    if(lv>=1){
      drawSofa(COLS-4, ROWS-2.2);
      drawCoffeeTable(COLS-2.8, ROWS-1.2);
      drawLamp(COLS-1, ROWS-2.8);
    }
    if(lv>=3){
      drawSofa(1.5, ROWS-2.2);
      drawPlant(0.5, ROWS-1.5, true);
    }
    if(lv>=2){
      drawPlant(COLS*0.5, ROWS-1.2, false);
      drawLamp(COLS*0.3, ROWS-1.5);
    }

    // 多数社員カウンター
    if(staffCount>maxDesks){
      ctx.fillStyle='rgba(99,102,241,0.9)';
      ctx.beginPath();ctx.roundRect(W-80,8,72,20,4);ctx.fill();
      ctx.fillStyle='#fff';ctx.font='10px monospace';
      ctx.fillText('👥 '+staffCount+'名',W-73,22);
    }
    // ダーク: 床のアクセントライン（ネオン）
    if(isDark){
      ctx.save();ctx.globalAlpha=0.25+Math.sin(t*0.02)*0.08;
      ctx.strokeStyle=TH2.accent;ctx.lineWidth=1.5;
      // 対角ネオンライン
      var nl1=toIso(0,ROWS*0.6),nl2=toIso(COLS,ROWS*0.6);
      ctx.beginPath();ctx.moveTo(nl1.x,nl1.y);ctx.lineTo(nl2.x,nl2.y);ctx.stroke();
      ctx.globalAlpha=0.15;
      var nl3=toIso(0,ROWS*0.3),nl4=toIso(COLS,ROWS*0.3);
      ctx.beginPath();ctx.moveTo(nl3.x,nl3.y);ctx.lineTo(nl4.x,nl4.y);ctx.stroke();
      ctx.restore();
    }
    // 新潟: 外の景色（山のシルエット）
    if(isNiigata){
      ctx.save();ctx.globalAlpha=0.06;ctx.fillStyle='#3a7840';
      ctx.beginPath();ctx.moveTo(W*0.65,0);ctx.lineTo(W*0.75,-H*0.1);ctx.lineTo(W*0.85,0);ctx.closePath();ctx.fill();
      ctx.beginPath();ctx.moveTo(W*0.8,0);ctx.lineTo(W*0.92,-H*0.08);ctx.lineTo(W,0);ctx.closePath();ctx.fill();
      ctx.restore();
    }

    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    // STAFF CHARACTERS（アイソメキャラ）
    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if(!G.staffPos) G.staffPos=[];

    var HAIR=['#3a2010','#c8b060','#102840','#501010','#282828','#8060a0','#204030'];
    var SKIN=['#f0c890','#d4a070','#a06840','#805028','#c09878'];
    var SHIRTS=isKyoto?['#5a3020','#3a6040','#7a3040','#6a5020','#4a4060','#8a4830','#3a7070']:
      isDark?['#4050a0','#208050','#a03050','#907010','#505070','#903020','#20807a']:
      ['#5060d0','#30a060','#c04060','#d0a020','#606080','#c06030','#40a0b0'];

    G.s.staff.forEach(function(s,i){
      var desk=desks[i]||desks[desks.length-1];
      var dcp=desk?isoCenter(desk.gx+0.9, desk.gy+1.0):{x:W/2,y:H/2};

      if(!G.staffPos[i]){
        G.staffPos[i]={sx:dcp.x, sy:dcp.y, tx:dcp.x, ty:dcp.y, timer:0, state:'sit', isRobot:s.isRobot||false, isAnimal:s.isAnimal||false, special:s.special||false};
      }
      var sp=G.staffPos[i];
      sp.timer--;
      if(sp.timer<=0){
        var r=Math.random();
        if(s.status==='working'||r<0.6){
          sp.tx=dcp.x+(Math.random()-0.5)*6;
          sp.ty=dcp.y+(Math.random()-0.5)*4;
          sp.state='sit'; sp.timer=90+Math.floor(Math.random()*130);
        } else if(r<0.75&&desks.length>1){
          var other=desks[Math.floor(Math.random()*desks.length)];
          var ocp=isoCenter(other.gx+0.9, other.gy+1.0);
          sp.tx=ocp.x+(Math.random()-0.5)*8; sp.ty=ocp.y+(Math.random()-0.5)*6;
          sp.state='walk'; sp.timer=40+Math.floor(Math.random()*50);
        } else {
          // ラウンジエリアへ
          var lx=lv>=1?(W*0.7+Math.random()*W*0.15):(W*0.3+Math.random()*W*0.4);
          sp.tx=lx; sp.ty=H*0.65+Math.random()*H*0.2;
          sp.state='relax'; sp.timer=30+Math.floor(Math.random()*50);
        }
      }
      sp.sx+=(sp.tx-sp.sx)*0.07;
      sp.sy+=(sp.ty-sp.sy)*0.07;

      var px2=sp.sx, py2=sp.sy;
      var tired=s.mental<30, busy=s.status==='working';
      var bob=sp.state==='sit'? Math.sin(t*0.025+i*1.4)*0.5
             :sp.state==='walk'?Math.sin(t*0.2+i)*2
             :Math.sin(t*0.04+i)*0.5;

      ctx.save();
      // 影
      var shadowW=s.isAnimal?14:10;
      ctx.fillStyle='rgba(0,0,0,0.18)';
      ctx.beginPath();ctx.ellipse(px2,py2+10,shadowW,3.5,0,0,Math.PI*2);ctx.fill();

      ctx.translate(px2, py2+bob);

      // アイソメ向きキャラ（斜め前向き）
      var S=1.4; // スケール

      if(s.isRobot){
        // 🤖 ロボット描画
        var rC=busy?'#5566cc':'#778899';
        // 胴体（金属製ボックス）
        ctx.fillStyle=rC;
        ctx.fillRect(-6*S,-1*S,12*S,9*S);
        ctx.fillStyle='rgba(255,255,255,0.2)';
        ctx.fillRect(-6*S,-1*S,12*S,2.5*S);
        // 胸パネル（LED）
        var ledC=busy?'#00ffcc':'#00cc88';
        ctx.fillStyle=ledC;
        ctx.globalAlpha=0.7+Math.sin(t*0.12)*0.3;
        ctx.fillRect(-2*S,2*S,4*S,3*S);
        ctx.globalAlpha=1;
        // 脚（シリンダー）
        var legL2=sp.state==='walk'?Math.sin(t*0.22+i)*3:0;
        ctx.fillStyle='#556677';
        ctx.fillRect(-4*S,(8+legL2)*S,3.5*S,5*S);
        ctx.fillRect(0.5*S,(8-legL2)*S,3.5*S,5*S);
        ctx.fillStyle='#334455';
        ctx.fillRect(-4.5*S,(12+legL2)*S,4.5*S,2*S);
        ctx.fillRect(0*S,(12-legL2)*S,4.5*S,2*S);
        // アーム
        ctx.fillStyle='#667788';
        ctx.fillRect(-9*S,-1*S,3.5*S,6*S);
        ctx.fillRect(5.5*S,-1*S,3.5*S,6*S);
        // 頭（ボックス型）
        ctx.fillStyle='#889aaa';
        ctx.fillRect(-5*S,-10*S,10*S,10*S);
        // 目（グリーンLED）
        var eyeC=busy?'#00ff88':'#44cc88';
        ctx.fillStyle=eyeC;
        ctx.globalAlpha=0.8+Math.sin(t*0.15+i)*0.2;
        ctx.beginPath();ctx.arc(-2*S,-5.5*S,1.8*S,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(2*S,-5.5*S,1.8*S,0,Math.PI*2);ctx.fill();
        ctx.globalAlpha=1;
        // アンテナ
        ctx.fillStyle='#aabbcc';
        ctx.fillRect(-0.5*S,-14*S,1*S,4*S);
        ctx.beginPath();ctx.arc(0,-14.5*S,2*S,0,Math.PI*2);
        ctx.fillStyle=busy?'#ffcc00':'#888';ctx.fill();
      } else if(s.isAnimal){
        // 🐾 動物描画（丸っこいシルエット）
        var aColors=['#c8a060','#808080','#ff8844','#4466cc','#cc4488','#88aa44','#aa6688','#dd8833','#6688cc','#55aa77'];
        var ac=aColors[i%aColors.length];
        // 体（大きな楕円）
        ctx.fillStyle=ac;
        ctx.beginPath();ctx.ellipse(0,3*S,9*S,8*S,0,0,Math.PI*2);ctx.fill();
        // 腹（明るめ）
        ctx.fillStyle='rgba(255,255,255,0.35)';
        ctx.beginPath();ctx.ellipse(0,4*S,5*S,5.5*S,0,0,Math.PI*2);ctx.fill();
        // 脚（小さな丸）
        var legL3=sp.state==='walk'?Math.sin(t*0.22+i)*3:0;
        ctx.fillStyle=ac;
        ctx.beginPath();ctx.ellipse(-4*S,(10+legL3)*S,3*S,4*S,0,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.ellipse(4*S,(10-legL3)*S,3*S,4*S,0,0,Math.PI*2);ctx.fill();
        // 頭（大きな円）
        ctx.fillStyle=ac;
        ctx.beginPath();ctx.arc(0,-6*S,7*S,0,Math.PI*2);ctx.fill();
        // 目（キラキラ）
        ctx.fillStyle='#fff';
        ctx.beginPath();ctx.arc(-2.5*S,-7*S,2.2*S,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(2.5*S,-7*S,2.2*S,0,Math.PI*2);ctx.fill();
        ctx.fillStyle=busy?'#3366cc':'#333';
        ctx.beginPath();ctx.arc(-2.5*S,-7*S,1.3*S,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(2.5*S,-7*S,1.3*S,0,Math.PI*2);ctx.fill();
        // キラキラ
        ctx.fillStyle='rgba(255,255,255,0.8)';
        ctx.beginPath();ctx.arc(-2*S,-7.5*S,0.5*S,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(3*S,-7.5*S,0.5*S,0,Math.PI*2);ctx.fill();
        // 耳（三角 or 丸）
        ctx.fillStyle=ac;
        ctx.beginPath();
        ctx.moveTo(-6*S,-10*S);ctx.lineTo(-3*S,-14*S);ctx.lineTo(0,-10*S);
        ctx.closePath();ctx.fill();
        ctx.beginPath();
        ctx.moveTo(0,-10*S);ctx.lineTo(3*S,-14*S);ctx.lineTo(6*S,-10*S);
        ctx.closePath();ctx.fill();
        // 鼻
        ctx.fillStyle='rgba(0,0,0,0.3)';
        ctx.beginPath();ctx.ellipse(0,-5*S,1.5*S,1*S,0,0,Math.PI*2);ctx.fill();
      } else {
        // 通常人間キャラ
        var legL=sp.state==='walk'?Math.sin(t*0.22+i)*3:0;
        ctx.fillStyle=SKIN[i%5];
        ctx.fillRect(-4*S,(6+legL)*S,4*S,5*S);
        ctx.fillRect(0*S,(6-legL)*S,4*S,5*S);
        // 靴
        ctx.fillStyle='#303030';
        ctx.fillRect(-5*S,(10+legL)*S,5*S,2.5*S);
        ctx.fillRect(-1*S,(10-legL)*S,5*S,2.5*S);

        // 体
        var shirtC=tired?'#806060':SHIRTS[i%7];
        ctx.fillStyle=shirtC;
        ctx.fillRect(-5*S,0*S,10*S,7*S);
        // 体のハイライト
        ctx.fillStyle='rgba(255,255,255,0.15)';
        ctx.fillRect(-5*S,0*S,10*S,2*S);
        // ベルト
        ctx.fillStyle='rgba(0,0,0,0.25)';
        ctx.fillRect(-5*S,5.5*S,10*S,1.5*S);

        // 腕
        ctx.fillStyle=SKIN[i%5];
        ctx.fillRect(-8*S,0*S,4*S,5*S);
        ctx.fillRect(4*S,0*S,4*S,5*S);

        // 頭
        ctx.fillStyle=SKIN[i%5];
        ctx.fillRect(-4*S,-9*S,8*S,9*S);
        // 顔
        ctx.fillStyle='rgba(0,0,0,0.2)';
        ctx.fillRect(-2*S,-7*S,2*S,1.5*S); // 左眉
        ctx.fillRect(0.5*S,-7*S,1.5*S,1.5*S); // 右眉
        ctx.fillStyle=busy?'#4060c0':'rgba(0,0,0,0.3)';
        ctx.fillRect(-2*S,-5*S,2*S,1.5*S); // 左目
        ctx.fillRect(0.5*S,-5*S,1.5*S,1.5*S); // 右目
        // 笑顔
        ctx.strokeStyle=tired?'rgba(180,50,50,0.5)':'rgba(0,0,0,0.25)';
        ctx.lineWidth=1.2;
        ctx.beginPath();
        ctx.arc(0,-3.5*S,2*S,0,Math.PI,tired);
        ctx.stroke();
        // 耳
        ctx.fillStyle=SKIN[(i+1)%5];
        ctx.fillRect(-6*S,-7*S,2.5*S,3*S);
        ctx.fillRect(3.5*S,-7*S,2.5*S,3*S);

        // 髪
        ctx.fillStyle=HAIR[i%7];
        ctx.fillRect(-4*S,-10*S,8*S,3*S);
        ctx.fillRect(-5*S,-9*S,2*S,4*S);
        ctx.fillRect(3*S,-9*S,2*S,4*S);

        // ヘッドフォン（作業中）
        if(busy){
          ctx.fillStyle='#1a1a1a';
          ctx.fillRect(-7*S,-10*S,2.5*S,6*S);
          ctx.fillRect(4.5*S,-10*S,2.5*S,6*S);
          ctx.fillRect(-7*S,-12*S,14*S,2.5*S);
          ctx.fillStyle='#333';
          ctx.fillRect(-8*S,-8*S,3*S,4*S);
          ctx.fillRect(5*S,-8*S,3*S,4*S);
        }

        // タイピング手
        if(sp.state==='sit'&&busy){
          var tk=Math.sin(t*0.2+i)>0;
          ctx.fillStyle=SKIN[i%5];
          ctx.fillRect(-8*S,(3+(!tk?1:0))*S,3.5*S,2*S);
          ctx.fillRect(4.5*S,(3+(tk?1:0))*S,3.5*S,2*S);
        }

        // zzz（疲弊）
        if(tired){
          ctx.fillStyle='rgba(255,80,80,0.9)';
          ctx.font=(7*S)+'px monospace';
          ctx.fillText('z',3*S,-13*S);
          if(Math.sin(t*0.04+i)>0)ctx.fillText('z',7*S,-19*S);
        }
      } // end else（人間ブロック終了）

      ctx.restore();

      // 名前バッジ
      var nm2=s.nm.split(' ')[0];
      var bw=nm2.length*5+12;
      ctx.fillStyle=busy?'rgba(20,20,60,0.9)':'rgba(15,15,30,0.78)';
      ctx.beginPath();
      ctx.roundRect(px2-bw/2, py2+bob+14, bw, 12, 3);
      ctx.fill();
      ctx.fillStyle=busy?'#a0c0ff':'#c8c8ee';
      ctx.font='9px monospace';
      ctx.fillText(nm2, px2-bw/2+3, py2+bob+24);
      // ステータスドット
      ctx.fillStyle=tired?'#ff4040':busy?'#6366f1':'#34d399';
      ctx.beginPath();ctx.arc(px2+bw/2-6, py2+bob+19, 3, 0, Math.PI*2);ctx.fill();

      // 吹き出しシステム（既存ロジック流用）
      var murmurKey=i+'_'+G.s.turn;
      if(!G._murmurShown)G._murmurShown={};
      if(Math.sin(t*0.004+i*7.3)>0.97&&!G._murmurShown[murmurKey]){
        G._murmurShown[murmurKey]=true;
        var MURMURS_WORK=['またデザインし直し…','締め切り明日だっけ','Figmaフリーズした','コーヒー3杯目','レビュー待ちつらい','FBくるの怖い','デザイン迷走中','寝れてない','神案件ありたい','このフォント違う気が','もう少しで完成！','集中！','ユーザー視点は？','いい感じかも','あとは微調整のみ'];
        var MURMURS_IDLE=['今日ランチどこ','Slack通知多すぎ','眠い','在宅の方がよかった','あのデザイナー上手い','コードうまく書けない','帰りたい（定時後）','今月も頑張った','給料上がらないかな','スタバ行きたい','週末何しよ','転職サイト見てた（内緒）'];
        // 🌍 海外スタッフ英語呟き
        var MURMURS_INTL_WORK=['Figma crashed again…','Almost done with this comp','Client feedback is wild','Too many iterations…','Coffee #4 today','Need a stronger font','This layout feels off','Can I get an extension?','Deep in the zone 🎯','Just ship it.','The grid is everything','One more refinement…'];
        var MURMURS_INTL_IDLE=['Where should we eat?','Slack is overwhelming','Is it Friday yet?','Miss my home country rn','That typeface is 🔥','WFH life hits different','Salary review when?','Tokyo weather is wild','Anyone want coffee?','Cultural differences are real','Jet lag is brutal','Love the team here tho'];
        // 🤖 ロボット専用呟き
        var MURMURS_ROBOT_WORK=['演算中… 99.97%完成','クロック周波数が上がっている','このピクセル許容範囲外','最適解を計算中','効率0.3%向上を検出','前回より12ms高速化','エラー率ゼロを維持中'];
        var MURMURS_ROBOT_IDLE=['充電残量94%','アイドル状態：エネルギー節約中','人間はなぜ休憩するのか','バックグラウンドで別の処理中','感情回路：未実装','スタバのWiFiは接続不安定'];
        // 🐾 動物専用呟き
        var MURMURS_ANIMAL_WORK=['（なんか感じる）','（いいにおいがする）','ふさふさしたい','（集中している）','なんかいい感じ！','走り回りたい','（そういうことか！）'];
        var MURMURS_ANIMAL_IDLE=['おやつはまだか','昼寝したい…','外に行きたい','誰かなでて','（うーん…）','もふもふが恋しい'];
        var msgList2;
        if(s.isRobot){
          msgList2=busy?MURMURS_ROBOT_WORK:MURMURS_ROBOT_IDLE;
        } else if(s.isAnimal){
          msgList2=busy?MURMURS_ANIMAL_WORK:MURMURS_ANIMAL_IDLE;
        } else if(s.intl){
          // 海外スタッフは70%英語、30%日本語
          var useEn=Math.sin(i*3.7+G.s.turn*0.3)>-0.4;
          msgList2=useEn?(busy?MURMURS_INTL_WORK:MURMURS_INTL_IDLE):(busy?MURMURS_WORK:MURMURS_IDLE);
        } else {
          msgList2=busy?MURMURS_WORK:MURMURS_IDLE;
        }
        var msg2=msgList2[(i*13+Math.floor(t*0.005))%msgList2.length];
        if(!G.murmurLog)G.murmurLog=[];
        G.murmurLog.unshift({nm:s.nm,ic:s.ic,msg:msg2,turn:G.s.turn,t:Date.now()});
        if(G.murmurLog.length>100)G.murmurLog.pop();
        if(G.curTab==='murmur'){G.renderMurmur();}
        else{var bdg2=q('bdg-murmur');if(bdg2)bdg2.style.display='inline';}
        if(!G._murmurActive)G._murmurActive={};
        G._murmurActive[i]={msg:msg2, until:t+180};
      }
      var ma=G._murmurActive&&G._murmurActive[i];
      if(ma&&t<ma.until){
        var tw=ctx.measureText(ma.msg).width;
        var bw2=tw+12;
        ctx.fillStyle='rgba(255,255,255,0.96)';
        ctx.beginPath();ctx.roundRect(px2-bw2/2,py2+bob-42,bw2,16,4);ctx.fill();
        ctx.strokeStyle='rgba(100,100,200,0.25)';ctx.lineWidth=0.8;ctx.stroke();
        ctx.fillStyle='rgba(255,255,255,0.96)';
        ctx.beginPath();
        ctx.moveTo(px2-3,py2+bob-27);ctx.lineTo(px2,py2+bob-22);ctx.lineTo(px2+4,py2+bob-27);
        ctx.closePath();ctx.fill();
        ctx.fillStyle='rgba(30,30,90,0.9)';
        ctx.font='9px monospace';
        ctx.fillText(ma.msg, px2-bw2/2+5, py2+bob-30);
      }
    });

    // ━━ PROGRESS BAR (bottom overlay) ━━━━━━━━━━━━━━━━━━━━━━━━━━
    var pr=G.s.actives.length>0?
      G.s.actives.reduce(function(a,p){return a+p.prog;},0)/G.s.actives.length:0;
    var tpEl=q('tp-bar'), ttEl=q('tp-txt');
    if(tpEl)tpEl.style.setProperty('--tp',Math.min(100,pr)+'%');
    if(ttEl){
      if(G.busy)ttEl.textContent='処理中...';
      else if(G.aiMode)ttEl.textContent='🤖 AI管理中 ─ 進捗 '+Math.round(pr)+'%';
      else if(G.s.actives.length===0)ttEl.textContent='案件なし ─ 受注してください';
      else ttEl.textContent='案件進捗 '+Math.round(pr)+'%'+(G.aiMode?' 🤖 AI稼働中':'　▶ 次の週へ');
    }
    ctx.restore();  // DPRスケールを元に戻す
  },


  startTC:function(){
    (function loop(){G.drawTC();G.tcId=requestAnimationFrame(loop);})();
  },
  drawTC:function(){
    var cv=q('tcv');if(!cv)return;
    var ctx=cv.getContext('2d'),W=cv.width,H=cv.height,t=Date.now()/1000;
    ctx.fillStyle='#f0efff';ctx.fillRect(0,0,W,H);
    for(var i=0;i<65;i++){var blink=Math.sin(t*0.5+i)*0.5+0.5;ctx.fillStyle='rgba(120,100,220,'+(blink*0.6)+')';ctx.fillRect((Math.sin(i*127.1)*0.5+0.5)*W,(Math.cos(i*311.7)*0.5+0.5)*H*0.65,1,1);}
    var blds=[{x:0,w:.08,y:.30},{x:.07,w:.06,y:.50},{x:.12,w:.11,y:.20},{x:.22,w:.07,y:.40},{x:.28,w:.13,y:.15},{x:.40,w:.08,y:.45},{x:.47,w:.14,y:.18},{x:.60,w:.09,y:.35},{x:.68,w:.11,y:.22},{x:.78,w:.07,y:.42},{x:.84,w:.10,y:.28},{x:.92,w:.08,y:.48}];
    blds.forEach(function(b){
      ctx.fillStyle='#d8d5f8';ctx.fillRect(b.x*W,b.y*H,b.w*W,(1-b.y)*H);
      var wc=Math.floor(b.w*W/9),wr=Math.floor((1-b.y)*H*0.55/11);
      var cols=[[124,112,245],[240,98,146],[69,212,168],[240,192,64]];
      for(var r=0;r<wr;r++)for(var c=0;c<wc;c++)if(Math.sin(t*0.3+b.x*10+r*3.8+c*2.2)>0.15){var cl=cols[(r+c)%4];ctx.fillStyle='rgba('+cl[0]+','+cl[1]+','+cl[2]+',.62)';ctx.fillRect(b.x*W+c*9+2,b.y*H+10+r*11,4,5);}
    });
    var gg=ctx.createLinearGradient(0,H*.83,0,H);gg.addColorStop(0,'rgba(124,112,245,0.1)');gg.addColorStop(1,'rgba(124,112,245,0.03)');ctx.fillStyle=gg;ctx.fillRect(0,H*.83,W,H*.17);
    ctx.fillStyle='#e8e6ff';ctx.fillRect(0,H*.84,W,H*.16);
    var ds=(t*20)%40;for(var rx=-40+ds;rx<W;rx+=40){ctx.fillStyle='rgba(240,192,64,0.3)';ctx.fillRect(rx,H*.91,18,2);}
    ctx.font='18px serif';ctx.fillText('🧑‍💻',W/2-9,H*.82+Math.sin(t*2)*2);
  },

  // ─ GAME FLOW ─
  newGame:function(){
    SFX.click();G.initState();G.s.staff=[G.mkSelf()];G.genProjects();G.genHire();G.portfolioFilter='all';
    G.staffPos=[];G.murmurLog=[];G._murmurShown={};G._murmurActive={};
    G.aiMode=false;document.body.classList.remove('ai-mode');G.aiActionLog=[];
    if(G.tcId){cancelAnimationFrame(G.tcId);G.tcId=null;}
    q('SCR_TITLE').style.display='none';q('GAME').style.display='flex';
    G.startOC();gLog=[];
    addLog('フリーランスとしてのキャリアをスタート！','sys');
    addLog('口座残高：38,000円。まずは案件を受注しよう！','sys');
    G.aiMode=false;document.body.classList.remove('ai-mode');G.aiActionLog=[];
    var aib=q('btn-ai');if(aib){aib.innerHTML='<span class="ai-dot" style="display:none"></span>🤖 AIモード';aib.classList.remove('on');}
    G.renderAll();G.tab('proj');
    setTimeout(function(){
      notify('案件タブから受注して制作を始めよう！🤖AIモードONで自動進行します。','ok',5000);
    },500);
    window.addEventListener('resize',function(){G.resizeOC();});
  },

  save:function(){
    SFX.click();
    var d=JSON.parse(JSON.stringify(G.s));
    d.tech=G.s.tech;
    localStorage.setItem('dcfk_v3',JSON.stringify(d));
    notify('セーブしました！','ok');SFX.coin();
  },

  load:function(){
    SFX.click();var raw=localStorage.getItem('dcfk_v3');
    if(!raw){notify('セーブデータがありません','warn');return;}
    try{G.initState();var d=JSON.parse(raw);G.s=d;
      G.staffPos=[];
      if(G.tcId){cancelAnimationFrame(G.tcId);G.tcId=null;}
      q('SCR_TITLE').style.display='none';q('GAME').style.display='flex';
      if(!G.s.portfolio)G.s.portfolio=[];
      G.portfolioFilter='all';
      G.startOC();gLog=[];addLog('ロード完了！','sys');G.renderAll();G.tab('dash');
      G.aiMode=false;document.body.classList.remove('ai-mode');G.aiActionLog=[];
      var aib2=q('btn-ai');if(aib2){aib2.innerHTML='<span class="ai-dot" style="display:none"></span>🤖 AIモード';aib2.classList.remove('on');}
      setTimeout(function(){
        if(G.aiMode)G.scheduleAuto();
      },500);
      notify('ロードしました！','ok');SFX.good();
    }catch(e){notify('セーブデータが壊れています','danger');console.error(e);}
  },

  restart:function(){
    q('SCR_END').classList.remove('open');q('GAME').style.display='none';
    q('SCR_TITLE').style.display='flex';
    if(G.ocId){cancelAnimationFrame(G.ocId);G.ocId=null;}
    G.startTC();
  },

  howto:function(){
    alert('デザイン会社発展国 - 遊び方\n\n▶ 基本の流れ\n1.「案件」タブで案件を選んで受注\n2.「制作」タブで社員をアサインする\n3.「次の週へ」ボタンで時間を進める\n4. 案件完了→評価・報酬を受け取る\n5. 収益で社員採用・技術習得・オフィス拡張\n\n▶ 重要パラメータ\n💰 資金：月次コスト（給与+家賃）が払えないとゲームオーバー\n⭐ 評判：高いと高単価案件が来る\n🔥 炎上：90%超えで炎上エンド\n😈 ブラック度：高いと社員が辞める\n\n▶ エンディング7種\n・神スタジオ（Best）・世界進出・プロダクト企業\n・上場・炎上解散・NFT破滅・資金ショート\n\n▶ キーボード\nスペース: 次の週へ\n1-7: タブ切替\nCtrl+S: セーブ');
  },

  // ─ TURN ENGINE ─
  nextTurn:function(){
    if(G.gameOver)return; // エンディング後は進めない
    if(G.busy)return;G.busy=true;SFX.click();
    var btn=q('btn-turn');if(btn){btn.disabled=true;btn.textContent='処理中...';}
    var bth2=q('btn-turn-hud');if(bth2){bth2.disabled=true;bth2.textContent='処理中...';}
    // 週次スナップショット記録（グラフ用）
    if(!G.s.weeklySnap)G.s.weeklySnap=[];
    if(G.s.weeklySnap.length===0||G.s.turn%2===0){// 2週ごとに記録（データ量を抑える）
      G.s.weeklySnap.push({t:G.s.turn,m:G.s.money,r:G.s.rep,f:G.s.fire,b:G.s.black,wb:G.s.wb||50,st:G.s.staff.length,tr:G.s.totalRev||0});
      if(G.s.weeklySnap.length>100)G.s.weeklySnap.shift();// 最大100ポイント
    }
    // AIモード：ターン開始前に経営判断を実行
    if(G.aiMode)G.aiDecide();
    G.s.turn++;
    // ── 週次コスト（給与の1/4を毎週先払い） ──
    // 月次払いを待たずにキャッシュフロー圧力をかける
    var weeklyWage=Math.round(G.s.staff.filter(function(s){return!s.isSelf;}).reduce(function(a,s){return a+s.sal;},0)/4);
    if(weeklyWage>0){
      G.s.money-=weeklyWage;
      if(G.s.money<gcfg("brokeLine",-100000)){// 破産閾値チェック
        var brokeEnd=ENDINGS.find(function(e){return e.id==='broke';});
        if(brokeEnd&&brokeEnd.cond(G.s)){G.busy=false;G.showEnding(brokeEnd);return;}
      }
      if(G.s.money<0)addLog('🔴 週次人件費'+fY(weeklyWage)+'支払い → 資金マイナス！','bad');
    }
    G.s.actives.forEach(function(p){
      var spd=G.projSpeed(p);p.prog=Math.min(100,p.prog+spd);
      if(p.asgn){var s=G.s.staff.find(function(x){return x.id===p.asgn;});
        if(s&&!s.isRobot){
          // ブラック度が高いほど疲弊が速い
          var _md=gcfg("mentalDmg",4);var dmg=G.s.black>70?_md+2:G.s.black>50?_md+1:_md;
          s.mental=clamp(s.mental-dmg,0,100);
        }
      } else {
        // 未アサイン案件は締め切りプレッシャーで評判微減
        if(p.dead<=2&&Math.random()<0.3){
          G.s.rep=clamp(G.s.rep-1,0,100);
        }
      }
    });
    // 待機中スタッフも少しずつ不満が溜まる（やることない状態）
    G.s.staff.forEach(function(s){
      if(!s.isRobot&&s.status==='idle'&&G.s.actives.length>0){
        s.mental=clamp(s.mental-1,0,100);// 仕事があるのに暇なストレス
      }
    });
    var done=G.s.actives.filter(function(p){return p.prog>=100;});
    G.s.actives=G.s.actives.filter(function(p){return p.prog<100;});
    var idx=0;
    function nextDone(){
      try{
        if(idx>=done.length){G.doMonthly();return;}
        G.complete(done[idx],function(){idx++;setTimeout(nextDone,120);});
      }catch(ndErr){
        console.error('[nextDone error]',ndErr);
        // エラーでも必ずdoMonthlyに到達させる
        try{G.doMonthly();}catch(e2){G.busy=false;var __b=q('btn-turn');if(__b&&!G.gameOver){__b.disabled=false;__b.textContent='▶▶ 次の週へ';}var __h=q('btn-turn-hud');if(__h&&!G.gameOver){__h.disabled=false;__h.textContent='▶ 次の週へ';}if(G.aiMode)G.scheduleAuto();}
      }
    }
    nextDone();
  },

  doMonthly:function(){
    try{
    if(G.s.turn%4===0){
      G.s.monthNum++;
      // 給与は週次で1/4ずつ払い済み → 月次は家賃のみ + 調整差分
      var sals=G.s.staff.filter(function(s){return!s.isSelf;}).reduce(function(a,s){return a+s.sal;},0);
      var rent=OFFICES[G.s.offLevel].mc;
      var total=rent; // 給与は週次払い済みなので家賃のみ
      if(total>0){G.s.money-=total;addLog('月次コスト：家賃'+fY(rent)+'（給与は週払い済）','bad');
        if(G.s.money<0)notify('🔴 資金がマイナスです！案件を早急に完了してください','danger',7000);
        else if(G.s.money<200000)notify('🔴 資金が危険水域です！（'+fY(G.s.money)+'）','danger',5000);
        else if(G.s.money<500000)notify('🟡 資金が少なくなっています（'+fY(G.s.money)+'）','warn',4000);}
      // ── メンタル回復（削減：回復しすぎ防止）──
      var _mr=gcfg("mentalRec",5);var mentalBonus=G.s.phase>=5?_mr+3:G.s.phase>=4?_mr+2:_mr;
      // ブラック度が高いほど回復が鈍る
      var blackPenalty=G.s.black>70?4:G.s.black>50?2:0;
      var actualBonus=Math.max(0,mentalBonus-blackPenalty);
      G.s.staff.forEach(function(s){if(!s.isRobot)s.mental=clamp(s.mental+actualBonus,0,100);});
      G.s.staff.forEach(function(s){if(s.status==='working'){var k=pick(Object.keys(s.stats));s.stats[k]=clamp(s.stats[k]+1,0,99);}});
      var avgM=G.s.staff.reduce(function(a,s){return a+s.mental;},0)/Math.max(1,G.s.staff.length);

      // ── ブラック度スパイラル ──
      if(avgM<30)G.s.black=clamp(G.s.black+15,0,100);
      else if(avgM<40)G.s.black=clamp(G.s.black+8,0,100);
      else if(avgM<55)G.s.black=clamp(G.s.black+3,0,100);
      else if(avgM>80)G.s.black=clamp(G.s.black-4,0,100);
      else if(avgM>70)G.s.black=clamp(G.s.black-2,0,100);
      // 稼働率が高いほどブラック度が上がる（仕事量の圧力）
      var activeRatio=G.s.actives.length/Math.max(1,G.s.staff.length);
      if(activeRatio>=1.5)G.s.black=clamp(G.s.black+ri(2,4),0,100);
      else if(activeRatio>=1.0)G.s.black=clamp(G.s.black+1,0,100);

      // ── 炎上の自然変動（要注意：炎上は消えにくくなった）──
      // 炎上70%超: バイラル炎上（手がつけられない）
      if(G.s.fire>70){G.s.fire=clamp(G.s.fire+ri(4,8),0,100);addLog('🔥🔥 炎上が制御不能！（'+G.s.fire+'%）','bad');}
      // 炎上50〜70%: 少しずつ広がる
      else if(G.s.fire>gcfg("fireSp",50)){G.s.fire=clamp(G.s.fire+ri(1,2),0,100);addLog('🔥 炎上が広がっている（'+G.s.fire+'%）','bad');}
      // 炎上20〜50%: ほぼ収束しない（対処しないと危険）
      else if(G.s.fire>20&&Math.random()<0.2){G.s.fire=clamp(G.s.fire+1,0,100);}
      else if(G.s.fire>0&&G.s.fire<=20){G.s.fire=clamp(G.s.fire-1,0,100);}// 小炎上のみ収束
      // 評判が非常に高い(80+)だけが炎上収束ボーナス
      if(G.s.rep>=80&&G.s.fire>0)G.s.fire=clamp(G.s.fire-1,0,100);

      // ── 評判の自然低下（高評判ほど維持コストが高い）──
      if(G.s.rep>70){
        var repDecay=G.s.rep>90?3:G.s.rep>80?2:1;
        if(Math.random()<0.5)G.s.rep=clamp(G.s.rep-repDecay,0,100);
      } else if(G.s.rep>40){
        if(Math.random()<0.5)G.s.rep=clamp(G.s.rep-1,0,100);
      }
      // フェーズ4-6: 社員規模ボーナス（大幅削減：収益はあくまで案件から）
      if(G.s.phase>=4&&G.s.staff.length>15){
        var orgBonus=Math.floor(G.s.staff.length*(G.s.phase>=5?25000:15000));
        G.s.money+=orgBonus;G.s.totalRev+=orgBonus;
        addLog('🏢 組織力ボーナス +'+fY(orgBonus),'good');
      }
      // ── プロダクトフェーズ: DAU/ARR成長 ──
      if(G.s.phase>=4&&G.s.dau>0){
        var gr=1.08;  // Phase4初期はゆっくり8%
        if(G.s.tech['growth_hack'])gr+=0.10;   // tech解放で+10%
        if(G.s.tech['data_infra'])gr+=0.08;    // データ基盤で+8%
        if(G.s.tech['platform_biz'])gr+=0.15;  // プラットフォーム化で+15%（爆発）
        if(G.s.tech['global_expand'])gr+=0.12; // グローバル展開で+12%
        if(avgM<50)gr*=0.90;  // チーム疲弊でより大きくペナルティ
        if(avgM>80)gr*=1.05;  // チーム健全なら+5%ボーナス
        if(G.s.offLevel>=4)gr+=0.05;
        if(G.s.offLevel>=5)gr+=0.10;
        if(G.s.offLevel>=6)gr+=0.15;
        var dauNoise=ri(200,2000)+Math.floor(G.s.dau*0.005);
        G.s.dau=Math.round(G.s.dau*gr+dauNoise);
        // prodStage
        if(G.s.dau>=10000&&G.s.prodStage<1)G.s.prodStage=1;
        if(G.s.dau>=100000&&G.s.prodStage<2)G.s.prodStage=2;
        if(G.s.dau>=1000000&&G.s.prodStage<3)G.s.prodStage=3;
        G.s.arr=Math.round(G.s.dau*ri(1200,3000)); // ARPU
        G.s.burnRate=Math.round(G.s.staff.reduce(function(a,s){return a+s.sal;},0)*1.8);
        var prodRev=Math.round(G.s.arr/12);
        G.s.money+=prodRev;G.s.totalRev+=prodRev;
        addLog('📱 プロダクト月収 +'+fY(prodRev)+' / DAU '+G.s.dau.toLocaleString(),'good');
        // 急成長でブラック増
        if(G.s.dau>50000&&G.s.black<70)G.s.black=clamp(G.s.black+4,0,100);
      }
      // 20年長期プレイ: ターン数に応じて月次更新メッセージを変化
    var yr2=2025+Math.floor((G.s.monthNum||0)/12);
    G.genProjects();G.genHire();
    var yMsg=G.s.monthNum%12===0&&G.s.monthNum>0?'🗓️ '+yr2+'年が始まった。':'月次更新。新案件が届いた。';
    addLog(yMsg,'sys');
    // 20年節目メッセージ
    var totalWeeksNow=G.s.turn;
    if(totalWeeksNow===104) notify('🎉 2年目突入！着実に成長している','ok',5000);
    if(totalWeeksNow===260) notify('🌱 5年目！中堅デザイン会社の風格が出てきた','ok',6000);
    if(totalWeeksNow===520) notify('🎉 10年目に突入！ここまで来たのはすごい！','ok',7000);
    if(totalWeeksNow===780) notify('⭐ 15年！業界の重鎮になりつつある','ok',7000);
    if(totalWeeksNow===1040)notify('🏆 20年！伝説のデザイン会社だ！','ok',8000);
    }
    G.s.avail.forEach(function(p){p.dead--;});
    var exp=G.s.avail.filter(function(p){return p.dead<=0;});
    exp.forEach(function(p){
      addLog('「'+p.nm+'」の締め切りが過ぎた。','bad');
      // 締め切り過ぎは評判ダメージ + 炎上リスク
      G.s.rep=clamp(G.s.rep-ri(2,5),0,100);
      if(Math.random()<0.20){G.s.fire=clamp(G.s.fire+ri(5,12),0,100);addLog('😡 締め切り遅延がSNSで拡散した','bad');}
    });
    G.s.avail=G.s.avail.filter(function(p){return p.dead>0;});
    // ── 退職リスク: ブラック度に応じて確率UP ──
    if(G.s.black>80){var qr2=G.s.staff.filter(function(s){return!s.isSelf&&s.mental<50;});
      if(qr2.length>0&&Math.random()<0.55){G.showEv(EVTS.find(function(e){return e.id==='quit';}),G.afterEv);return;}}
    if(G.s.black>60){var qr=G.s.staff.filter(function(s){return!s.isSelf&&s.mental<30;});
      if(qr.length>0&&Math.random()<0.5){G.showEv(EVTS.find(function(e){return e.id==='quit';}),G.afterEv);return;}}
    // ── 炎上SNSイベント: 炎上30%超からも発生 ──
    if(G.s.fire>=70&&Math.random()<0.45){G.showEv(EVTS.find(function(e){return e.id==='fire_sns';}),G.afterEv);return;}
    if(G.s.fire>=40&&Math.random()<gcfg("fireEv",0.25)){G.showEv(EVTS.find(function(e){return e.id==='fire_sns';}),G.afterEv);return;}
    if(G.s.fire>=25&&Math.random()<0.12){G.showEv(EVTS.find(function(e){return e.id==='fire_sns';}),G.afterEv);return;}
    // ── プロダクトフェーズ専用イベント ──
    if(G.s.phase>=4&&Math.random()<0.20){
      var prodEvts=EVTS.filter(function(e){return e.id==='vc_offer'||e.id==='dau_spike'||e.id==='competitor_entry'||e.id==='talent_poach'||e.id==='media_unicorn';});
      if(prodEvts.length>0){G.showEv(pick(prodEvts),G.afterEv);return;}
    }
    // ── 資金ショック系イベント（ターン40以降・資金危機時のみ）──
    var hardEvtIds=['payment_delay','tax_bill','design_theft','system_hack'];
    var hardEvts=EVTS.filter(function(e){return hardEvtIds.indexOf(e.id)>=0;});
    if(G.s.turn>=gcfg("hdTurn",40)&&G.s.money<300000&&hardEvts.length>0&&Math.random()<gcfg("hdProb",0.15)){G.showEv(pick(hardEvts),G.afterEv);return;}
    // ── 集団不満イベント（ターン50以降・ブラック高時のみ）──
    var massRes=EVTS.find(function(e){return e.id==='mass_resignation';});
    if(G.s.turn>=50&&G.s.black>=75&&G.s.staff.length>=3&&massRes&&Math.random()<0.12){G.showEv(massRes,G.afterEv);return;}
    // ── 通常イベント: 確率35% & 危機時はさらに上昇 ──
    var evtProb=gcfg("evProb",0.35);
    if(G.s.money<200000)evtProb+=0.15;// 資金危機時はイベント多発
    if(G.s.rep<30)evtProb+=0.10;// 評判低下時も多発
    if(G.s.black>60)evtProb+=0.10;// ブラック時も多発
    var prodExclIds=['vc_offer','dau_spike','competitor_entry','talent_poach','media_unicorn'];
    var normalEvts=EVTS.filter(function(e){return prodExclIds.indexOf(e.id)<0;});
    if(Math.random()<evtProb){G.showEv(pick(normalEvts),G.afterEv);return;}
    G.afterEv();
    }catch(dmErr){
      console.error('[doMonthly error]',dmErr);
      // 例外でも必ずafterEvを通してbusy解除する
      try{G.afterEv();}catch(e2){G.busy=false;var __b=q('btn-turn');if(__b&&!G.gameOver){__b.disabled=false;__b.textContent='▶▶ 次の週へ';}var __h=q('btn-turn-hud');if(__h&&!G.gameOver){__h.disabled=false;__h.textContent='▶ 次の週へ';}if(G.aiMode)G.scheduleAuto();}
    }
  },

  afterEv:function(){
    try{
      G.phaseCheck();
      // ── Policy monthly effects ──
      if(G.s.policies){
        Object.keys(G.s.policies).forEach(function(pid){
          var pol=POLICIES.find(function(p){return p.id===pid;});
          if(pol&&pol.eff)try{pol.eff(G.s);}catch(pe){console.error('policy eff err',pe);}
        });
      }
      // ── WB monthly drift ──
      var wbTarget=55; // 基準を55に（制度なしでもやや高め）
      var adoptedCount=Object.keys(G.s.policies||{}).length;
      wbTarget+=adoptedCount*4; // 制度1個あたり+4（最大20個=+80で上限95）
      // 平均メンタルがWBに影響
      var avgMwb=G.s.staff.length>0?G.s.staff.reduce(function(a,x){return a+x.mental;},0)/G.s.staff.length:60;
      wbTarget+=(avgMwb-60)*0.3; // メンタル60基準でプラマイ
      // ブラック度のペナルティ
      if(G.s.black>70)wbTarget-=20;
      else if(G.s.black>50)wbTarget-=10;
      else if(G.s.black<=30)wbTarget+=5; // 健全な職場はボーナス
      G.s.wb=clamp(Math.round(G.s.wb+(wbTarget-G.s.wb)*0.18),0,100);
      // ── Star performer detection ──
      G.s.starPerf=[];
      G.s.staff.forEach(function(st){
        var avg=(st.stats.design+st.stats.speed+st.stats.logic+st.stats.ui+st.stats.comm)/5;
        if(avg>=80&&st.mental>=80)G.s.starPerf.push(st.id);
      });
      if(G.s.starPerf.length>0)PTCL.burst(window.innerWidth/2,window.innerHeight*0.3,'star');
      if(G.endingCheck())return;
      G.updateHUD();
      try{G.renderAll();}catch(re){console.error('renderAll err',re);}
    }catch(e){
      console.error('[afterEv error]',e);
    }finally{
      // エラー時もreturn時も必ずボタンリセット・busy解除・AI継続を保証
      G.busy=false;
      if(!G.gameOver){
        var _btn=q('btn-turn');if(_btn){_btn.disabled=false;_btn.textContent='▶▶ 次の週へ';}
        var _bth=q('btn-turn-hud');if(_bth){_bth.disabled=false;_bth.textContent='▶ 次の週へ';}
      }
      if(G.aiMode)G.scheduleAuto();
    }
  },

  // ─ PROJECT LOGIC ─
  projSpeed:function(p){
    // フェーズが高い案件ほど進みが遅い（難易度・ボリューム増）
    var phaseSlow=[1.0,1.0,0.95,0.90,0.82,0.75,0.68][Math.min(p.phase||0,6)];
    var base=Math.round(6*phaseSlow);
    if(p.asgn){var s=G.s.staff.find(function(x){return x.id===p.asgn;});
      if(s){base=Math.max(2,Math.round((s.stats.speed+s.stats.design+s.stats.ui)/3*(s.mental/100)*0.80*phaseSlow));
        if(G.s.tech['design_system'])base=Math.round(base*1.1);
        if(G.s.tech['ux_research']&&(p.tid==='app'||p.tid==='web'))base=Math.round(base*1.1);}}
    return base;
  },

  quality:function(p){
    // 未アサインは超低品質（誰もやってない）
    if(!p.asgn)return clamp(15+Math.floor(Math.random()*10),0,30);
    var s=G.s.staff.find(function(x){return x.id===p.asgn;});
    if(!s)return 20;
    // スキルベース（stats平均がそのまま基礎品質）
    var skill=(s.stats.design+s.stats.ui+s.stats.speed)/3;
    var q2=skill; // stats70なら70点スタート
    // メンタルが低いと品質が急落する（疲弊したデザイナーは良い仕事ができない）
    var mentalFactor;
    if(s.mental>=80)mentalFactor=1.0;       // フル稼働
    else if(s.mental>=65)mentalFactor=0.88; // 少し疲れてる
    else if(s.mental>=50)mentalFactor=0.73; // 疲弊
    else if(s.mental>=35)mentalFactor=0.55; // かなり消耗
    else if(s.mental>=20)mentalFactor=0.38; // 限界
    else mentalFactor=0.20;                 // 完全崩壊
    q2*=mentalFactor;
    // 修正回数が多いほど品質が下がる（やりなおしの疲弊）
    var modPenalty=Math.min(0.35,(p.modCnt||0)*0.07);
    q2*=(1-modPenalty);
    // 技術ボーナス
    if(G.s.tech['design_system'])q2*=1.08;
    if(G.s.tech['ux_research']&&(p.tid==='app'||p.tid==='web'))q2*=1.10;
    if(G.s.tech['branding']&&p.tid==='brand')q2*=1.12;
    // ランダムなブレ（±10点・より波がある）
    q2+=ri(-10,10);
    return clamp(Math.round(q2),0,100);
  },

  complete:function(p,cb){
    var qual=G.quality(p);G.s.projDone++;G.s.totalProj++;
    if(Math.random()*100<p.cli.mr){var mod=pick(MODS);G.showMod(mod,p,function(){G.doFinish(p,qual,cb);});return;}
    G.doFinish(p,qual,cb);
  },

  doFinish:function(p,qual,cb){
    var earned=Math.round(p.price*p.cli.pm);
    if(qual>=90)earned=Math.round(earned*1.3);
    else if(qual>=85)earned=Math.round(earned*1.15);
    else if(qual<30){
      // 超低品質: 支払い拒否リスク
      if(Math.random()<0.35){earned=0;G.s.rep=clamp(G.s.rep-8,0,100);addLog('「'+p.nm+'」支払い拒否…品質問題が深刻。','bad');}
      else earned=Math.round(earned*0.5);
    }
    else if(qual<40)earned=Math.round(earned*0.65);
    else if(qual<50)earned=Math.round(earned*0.85);
    G.s.money+=earned;G.s.totalRev+=earned;
    G.s.rep=clamp(G.s.rep+Math.floor(qual/14)+p.cli.rg,0,100);
    if(Math.random()<0.3)G.s.sns+=ri(10,55);
    // 低品質完了 → 評判さらに落下 + 炎上リスク
    if(qual<40){
      G.s.rep=clamp(G.s.rep-ri(3,8),0,100);
      if(Math.random()<0.25){G.s.fire=clamp(G.s.fire+ri(8,20),0,100);addLog('⚠ 品質'+qual+'点…クライアントがSNSに投稿した','bad');}
    } else if(qual<55){
      if(Math.random()<0.10){G.s.fire=clamp(G.s.fire+ri(3,8),0,100);}
    }
    var assignedStaff=null;
    if(p.asgn){var s=G.s.staff.find(function(x){return x.id===p.asgn;});
      if(s){assignedStaff=s.nm;s.status='idle';if(p.sk)p.sk.forEach(function(k){if(s.stats[k]!==undefined)s.stats[k]=clamp(s.stats[k]+ri(1,3),0,99);});}}
    var rv=G.getReview(qual,p.cli);
    // ── 作品集に記録 ──
    if(!G.s.portfolio)G.s.portfolio=[];
    // 対応するPTYPEのdeliverables情報を取得
    var ptype=PTYPES.find(function(pt){return pt.id===(p.tid||'logo');});
    var deliv=ptype?ptype.deliv:null;
    G.s.portfolio.unshift({
      id:p.id, nm:p.nm, tid:p.tid||'logo', tlb:p.tlb, tic:p.tic,
      cli:p.cli.lb, cliIc:p.cli.ic, cliId:p.cli.id||'norm', qual:qual,
      earned:earned, stars:rv[0], comment:rv[1],
      turn:G.s.turn, staff:assignedStaff,
      modCnt:p.modCnt||0, phase:G.s.phase,
      deliv:deliv, mjPrompt:G.genMJPrompt(p.tid||'logo',p.nm,qual)
    });
    if(G.s.portfolio.length>200)G.s.portfolio=G.s.portfolio.slice(0,200);
    // 作品集バッジ更新
    var pb=q('bdg-portfolio');if(pb){pb.style.display='inline';pb.textContent=G.s.portfolio.length;}
    // AI生成キック（APIキーがある場合、非同期でSVGを生成）
    var newEntry=G.s.portfolio[0];
    if(newEntry&&G.aiDesign.getKey()){
      setTimeout(function(){G.aiDesign.generate(newEntry.id,newEntry.tid,newEntry.nm,newEntry.cli,newEntry.qual);},1500);
    }
    G.showRev(rv[0],rv[1],earned,p.tlb,function(){addLog('「'+p.nm+'」完了！'+rv[0]+' +'+fY(earned),'good');SFX.coin();PTCL.burst(window.innerWidth/2,window.innerHeight*0.4,'coin');G.updateHUD();if(cb)cb();});
  },

  getReview:function(qual,ct){
    var d=[['★★★★★','完璧です！次もよろしくお願いします！'],['★★★★☆','とても良かったです。ありがとうございました。'],['★★★☆☆','まあ良かったです（そっけない）'],['★★☆☆☆','もうちょっと何とかなりませんでしたか…'],['★☆☆☆☆','思ってたのと違いました（最初から言え）']];
    if(ct.id==='god'&&qual>=70)return['★★★★★','完璧です！SNSに上げていいですか？'];
    if(ct.id==='pres')return['★★★☆☆','悪くないですね。息子も気に入ってました。'];
    if(ct.id==='gov')return['★★★☆☆','ありがとうございます。検収書を送付します。'];
    return d[qual>=85?0:qual>=70?1:qual>=55?2:qual>=40?3:4];
  },

  // ─ ACTIONS ─
  accept:function(id){
    SFX.click();var p=G.s.avail.find(function(x){return x.id===id;});if(!p)return;
    var mx=Math.max(2,G.s.staff.length);
    if(G.s.actives.length>=mx){notify('同時進行は最大'+mx+'件です！','warn');return;}
    var ap=JSON.parse(JSON.stringify(p));ap.prog=0;ap.asgn=null;ap.modCnt=0;
    G.s.actives.push(ap);G.s.avail=G.s.avail.filter(function(x){return x.id!==id;});
    addLog('「'+p.nm+'」を受注！社員をアサインしよう！','good');
    notify('「'+p.nm+'」受注！制作タブでアサインしてください！','ok');
    SFX.good();G.renderAll();G.tab('active');
  },

  assign:function(pid,sid){
    SFX.click();var p=G.s.actives.find(function(x){return x.id===pid;});var s=G.s.staff.find(function(x){return x.id===sid;});
    if(!p||!s)return;
    if(s.status==='working'&&p.asgn!==sid){notify(s.nm+'は別の案件担当中です！','warn');return;}
    if(p.asgn){var prev=G.s.staff.find(function(x){return x.id===p.asgn;});if(prev)prev.status='idle';}
    p.asgn=sid;s.status='working';
    addLog('「'+p.nm+'」に'+s.nm+'をアサイン','');notify(s.nm+'をアサインしました！','ok');G.renderAll();
  },

  unassign:function(pid){
    SFX.click();var p=G.s.actives.find(function(x){return x.id===pid;});if(!p)return;
    if(p.asgn){var s=G.s.staff.find(function(x){return x.id===p.asgn;});if(s)s.status='idle';}
    p.asgn=null;notify('アサインを解除しました','warn');G.renderAll();
  },

  hire:function(idx){
    SFX.click();var h=G.s.hirePool[idx];if(!h)return;
    var cost=h.sal*2;if(G.s.money<cost){notify('資金不足！採用コスト：'+fY(cost),'danger');return;}
    var mx=[4,10,16,22,200,1000,5000][Math.min(G.s.phase,6)];if(G.s.staff.length>=mx){notify('社員数上限（'+mx+'名）に達しています！','warn');return;}
    G.s.money-=cost;
    var emp={id:'e'+Date.now()+Math.random(),nm:h.nm,role:h.role,ic:h.ic,sal:h.sal,
      stats:JSON.parse(JSON.stringify(h.st)),mental:h.mental,status:'idle',isSelf:false,
      sense:ri(40,85),isRobot:h.isRobot||false,isAnimal:h.isAnimal||false,special:h.special||false,
      intl:h.intl||false,mbti:h.mbti||(assignMBTI(h.st).en),trainData:[]};
    if(h.intl){G.s.intlStaff=(G.s.intlStaff||0)+1;}
    G.s.staff.push(emp);G.s.hirePool.splice(idx,1);
    G.genHire();
    // 特別採用演出
    if(h.isRobot){
      addLog('🤖 ロボット社員「'+emp.nm+'」が起動！疲れを知らない！','good');
      notify('🤖 '+emp.nm+' が起動しました！ メンタルは常時100%です','ok',6000);
      SFX.fanfare();
    } else if(h.isAnimal){
      addLog('🐾 動物社員「'+emp.nm+'」が出社！独自のオーラを放っている！','good');
      notify('🐾 '+emp.nm+' が仲間になった！ オフィスの空気が変わった','ok',6000);
      SFX.fanfare();
    } else if(h.special){
      addLog('🌟 伝説の人物「'+emp.nm+'」が電撃入社！','good');
      notify('🌟 '+emp.nm+' が入社！ 業界がざわついている…','ok',6000);
      SFX.fanfare();
    } else {
      addLog(emp.nm+'（'+emp.role+'）が入社！','good');
      notify(emp.nm+'が入社しました！採用コスト：'+fY(cost),'ok');
      SFX.good();PTCL.burst(window.innerWidth/2,window.innerHeight*0.5,'hire');
    }
    G.updateHUD();G.renderAll();
  },

  fire:function(id){
    if(!confirm('本当に解雇しますか？'))return;SFX.click();
    var s=G.s.staff.find(function(x){return x.id===id;});if(!s||s.isSelf)return;
    G.s.actives.forEach(function(p){if(p.asgn===id)p.asgn=null;});
    G.s.staff=G.s.staff.filter(function(x){return x.id!==id;});
    G.s.rep=clamp(G.s.rep-3,0,100);addLog(s.nm+'が退職した。評判-3。','bad');
    notify(s.nm+'が退職しました。','warn');SFX.bad();G.updateHUD();G.renderAll();
  },

  unlock:function(id){
    SFX.click();var nd=TECHS.reduce(function(a,r){return a.concat(r.nodes);},[]).find(function(n){return n.id===id;});if(!nd)return;
    if(G.s.tech[id]){notify('既に習得済みです','warn');return;}
    if(!nd.req.every(function(r){return G.s.tech[r];})){notify('前提技術を先に習得してください','warn');return;}
    if(G.s.money<nd.cost){notify('資金不足！必要：'+fY(nd.cost),'danger');return;}
    G.s.money-=nd.cost;G.s.tech[id]=true;
    addLog('技術「'+nd.nm+'」を習得！'+nd.ef,'good');notify('「'+nd.nm+'」を習得！'+nd.ef,'ok');
    SFX.lvup();G.updateHUD();G.renderTech();
  },

  office:function(lv){
    SFX.click();var od=OFFICES[lv];
    if(G.s.offLevel>=lv){notify('既にこのレベル以上です','warn');return;}
    if(G.s.money<od.cost){notify('資金不足！必要：'+fY(od.cost),'danger');return;}
    G.s.money-=od.cost;G.s.offLevel=lv;G.s.rep=clamp(G.s.rep+od.rp,0,100);
    addLog('オフィスを「'+od.nm+'」に移転！評判+'+od.rp,'good');notify('「'+od.nm+'」に移転！評判+'+od.rp,'ok');
    q('olb').textContent=OFF_LB[lv];SFX.lvup();G.updateHUD();G.renderProg();
  },

  // ─ PHASE / ENDING ─
  phaseCheck:function(){
    var old=G.s.phase;
    var s=G.s;
    // Phase 6: テックジャイアント（tech解放 + DAU1000万 + 累計500億円）
    if(s.tech['global_expand']&&(s.dau||0)>=10000000&&s.totalRev>=50000000000)s.phase=Math.max(s.phase,6);
    // Phase 5: プラットフォーム（tech解放 + DAU100万 + 累計100億円）
    else if(s.tech['platform_biz']&&(s.dau||0)>=1000000&&s.totalRev>=10000000000)s.phase=Math.max(s.phase,5);
    // Phase 4: プロダクト企業（tech解放 + 累計10億円 + 15名）
    else if(s.tech['product_mgmt']&&s.totalRev>=1000000000&&s.staff.length>=15)s.phase=Math.max(s.phase,4);
    // Phase 3: デザイン会社（累計3億円 + 15名）
    else if(s.totalRev>=300000000&&s.staff.length>=15)s.phase=Math.max(s.phase,3);
    // Phase 2: デザインスタジオ（累計3000万円 + 6名）
    else if(s.totalRev>=30000000&&s.staff.length>=6)s.phase=Math.max(s.phase,2);
    // Phase 1: デザイン事務所（累計500万円 + 2名）
    else if(s.totalRev>=5000000&&s.staff.length>=2)s.phase=Math.max(s.phase,1);
    if(s.phase>old){
      var ns=['個人事務所','デザイン事務所','デザインスタジオ','デザイン会社','プロダクト企業','プラットフォーム企業','テックジャイアント'];
      var msgs=['','🎉 事務所を卒業！','🌟 スタジオに昇格！','🏢 会社になった！','🚀 プロダクト企業へ転身！','🌐 プラットフォーム帝国の夜明け！','⚡ テックジャイアントへ到達！！'];
      addLog('🎉 フェーズアップ！→「'+ns[s.phase]+'」','sys');
      notify((msgs[s.phase]||'🎉')+' '+ns[s.phase]+'へ進化！','ok',7000);
      SFX.fanfare();G.genProjects();
      // フェーズアップ時にオフィスビューを一時的に強調
      var ow=document.getElementById('owrap');
      if(ow){ow.style.boxShadow='0 0 40px rgba(99,102,241,0.6)';setTimeout(function(){if(ow)ow.style.boxShadow='';},3000);}
      if(s.phase>=4&&!s.dau){s.dau=10000;addLog('📱 自社プロダクト開発を開始！DAU 10,000からスタート！','sys');}
      if(s.phase===6){addLog('⚡ テックジャイアントへ到達！社員5000名まで採用可能になった！','sys');}
    }
  },

  // デバッグ用: コンソールで G.testEnding() を実行するとエンディング画面テスト
  testEnding:function(){
    // ダミーのスナップショット生成
    G.s.weeklySnap=[];
    for(var i=0;i<50;i++){
      var t_=i*4;
      G.s.weeklySnap.push({
        t:t_,
        m:300000+Math.random()*2000000,
        r:Math.min(100,30+i*1.2+Math.sin(i)*8),
        f:Math.max(0,20+Math.sin(i*0.5)*15),
        b:Math.max(0,30+Math.cos(i*0.3)*10),
        wb:Math.min(100,50+i*0.5+Math.sin(i)*10),
        st:1+Math.floor(i/5),
        tr:i*i*200000
      });
    }
    G.s.totalRev=50000000;G.s.rep=72;G.s.projDone=45;G.s.awards=3;
    G.s.turn=200;G.s.phase=3;G.s.fire=25;G.s.wb=68;G.s.black=30;
    if(!G.s.staff||!G.s.staff.length)G.s.staff=[{mental:75,intl:false}];
    G.showEnding({id:'good',tt:'🏆 優れたデザインスタジオ',col:'#22c55e',
      story:'修正とやり直しを繰り返しながら、着実に成長した。'});
  },

  endingCheck:function(){
    // 破産・炎上は常時チェック
    var urgentIds=['broke','nft','fire','burnout_collapse','reputation_ruin','ghost_office'];
    for(var i=0;i<ENDINGS.length;i++){
      var e=ENDINGS[i];
      if(urgentIds.indexOf(e.id)>=0&&e.cond(G.s)){G.showEnding(e);return true;}
    }
    // それ以外はターン数50以上の時だけ（序盤の誤発動を防ぐ）
    if(G.s.turn<50)return false;
    for(var i=0;i<ENDINGS.length;i++){
      var e=ENDINGS[i];
      if(urgentIds.indexOf(e.id)<0&&e.cond(G.s)){G.showEnding(e);return true;}
    }
    return false;
  },

  showEnding:function(e){
    G.gameOver=true; // これ以上ターンを進めない
    var s=G.s;
    var scr=q('SCR_END');
    // ヒーロー
    q('end-t').textContent=e.tt;q('end-t').style.color=e.col;
    q('end-s').textContent=e.story;
    var phNames=['個人事務所','デザイン事務所','スタジオ','デザイン会社','プロダクト企業','プラットフォーム','テックジャイアント'];
    q('end-phase-label').textContent=phNames[Math.min(s.phase,6)]+' — '+s.compName;

    // ── スコアカード ──────────────────────────────────────────
    var avgM=s.staff.length>0?Math.round(s.staff.reduce(function(a,st){return a+st.mental;},0)/s.staff.length):0;
    var scores=[
      {val:fY(s.totalRev),lbl:'累計収益',fill:Math.min(100,s.totalRev/1000000000*100),col:'#6366f1'},
      {val:s.projDone+'件',lbl:'完了案件',fill:Math.min(100,s.projDone/200*100),col:'#22c55e'},
      {val:s.rep+'pt',lbl:'最終評判',fill:s.rep,col:'#f59e0b'},
      {val:s.staff.length+'名',lbl:'社員数',fill:Math.min(100,s.staff.length/50*100),col:'#3b82f6'},
      {val:s.awards+'件',lbl:'受賞歴',fill:Math.min(100,s.awards/10*100),col:'#a855f7'},
      {val:s.turn+'週',lbl:'プレイ期間',fill:Math.min(100,s.turn/400*100),col:'#06b6d4'},
      {val:avgM+'pt',lbl:'平均メンタル',fill:avgM,col:'#10b981'},
      {val:(s.wb||50)+'pt',lbl:'WBスコア',fill:s.wb||50,col:'#f97316'},
    ];
    q('end-scorecard').innerHTML=scores.map(function(sc){
      return '<div class="end-sc-item">'
        +'<div class="end-sc-val">'+sc.val+'</div>'
        +'<div class="end-sc-lbl">'+sc.lbl+'</div>'
        +'<div class="end-sc-bar"><div class="end-sc-bar-fill" style="width:'+sc.fill+'%;background:'+sc.col+'"></div></div>'
        +'</div>';
    }).join('');

    // ── チャート描画 ──────────────────────────────────────────
    var snap=s.weeklySnap||[];
    setTimeout(function(){
      // 売上チャート
      G._drawEndChart(q('chart-rev'),snap.map(function(p){return p.tr;}),
        snap.map(function(p){return p.t;}), '#6366f1','累計売上',true);
      // KPIチャート（評判・炎上・WB）
      G._drawEndMultiChart(q('chart-kpi'),snap,[
        {key:'r',col:'#f59e0b',lbl:'評判'},
        {key:'f',col:'#ef4444',lbl:'炎上'},
        {key:'wb',col:'#22c55e',lbl:'WB'},
      ]);
    },100);

    // ── タイムライン ──────────────────────────────────────────
    var tl=[];
    tl.push({t:1,tag:'🚀',col:'#6366f1',msg:'デザイン会社を創業'});
    if(s.turn>=20)tl.push({t:Math.round(s.turn*0.1),tag:'📋',col:'#06b6d4',msg:'最初の10案件を完了'});
    if(s.phase>=1)tl.push({t:Math.round(s.turn*0.2),tag:'🏢',col:'#22c55e',msg:'デザイン事務所に昇格'});
    if(s.phase>=2)tl.push({t:Math.round(s.turn*0.3),tag:'🌟',col:'#f59e0b',msg:'スタジオとして認知される'});
    if(s.phase>=3)tl.push({t:Math.round(s.turn*0.45),tag:'💼',col:'#a855f7',msg:'デザイン会社へ成長'});
    if(s.phase>=4)tl.push({t:Math.round(s.turn*0.6),tag:'🚀',col:'#3b82f6',msg:'プロダクト企業へ転換'});
    if(s.phase>=5)tl.push({t:Math.round(s.turn*0.75),tag:'🌐',col:'#06b6d4',msg:'プラットフォーム帝国の夜明け'});
    if(s.phase>=6)tl.push({t:Math.round(s.turn*0.9),tag:'⚡',col:'#6366f1',msg:'テックジャイアントへ到達'});
    if(s.awards>0)tl.push({t:Math.round(s.turn*0.5),tag:'🏆',col:'#f59e0b',msg:'業界アワード受賞 計'+s.awards+'件'});
    if(s.intlStaff>0)tl.push({t:Math.round(s.turn*0.4),tag:'🌍',col:'#22c55e',msg:'国際人材'+s.intlStaff+'名を採用'});
    if(s.projDone>=50)tl.push({t:Math.round(s.turn*0.65),tag:'📦',col:'#f97316',msg:'案件50件完了マイルストーン'});
    tl.push({t:s.turn,tag:'🎬',col:e.col||'#6366f1',msg:'エンディング: '+e.tt});
    tl.sort(function(a,b){return a.t-b.t;});
    q('end-tl').innerHTML=tl.map(function(ev){
      return '<div class="end-tl-row">'
        +'<div class="end-tl-turn">第'+ev.t+'週</div>'
        +'<div class="end-tl-tag" style="background:'+ev.col+'22;color:'+ev.col+'">'+ev.tag+'</div>'
        +'<div style="color:var(--t2)">'+ev.msg+'</div>'
        +'</div>';
    }).join('');

    // ── コンサルタントアドバイス ─────────────────────────────
    G._buildConsultAdvice(e,s,avgM);

    // G.endingDataを保存（シェア・レポート用）
    G.endingData={e:e,s:s,avgM:avgM,scores:scores,snap:snap,tl:tl};

    // グレードバッジをヒーローに表示
    var scoreRaw2=Math.min(100,Math.round(
      (s.rep||0)*0.25+
      Math.min(100,(s.totalRev||0)/500000000*100)*0.25+
      (avgM||0)*0.20+
      ((s.wb||50))*0.15+
      Math.min(100,(s.awards||0)*10)*0.10+
      Math.min(100,(s.phase||0)/6*100)*0.05
    ));
    var grade2=scoreRaw2>=85?'S':scoreRaw2>=70?'A+':scoreRaw2>=60?'A':scoreRaw2>=50?'B':scoreRaw2>=35?'C':'D';
    var gradeColors={S:'#d4a017','A+':'#16a34a',A:'#22c55e',B:'#d97706',C:'#f97316',D:'#dc2626'};
    var gCol2=gradeColors[grade2]||'#6366f1';
    // グレードバッジをヒーローエリアに追加
    var existBadge=document.getElementById('end-grade-badge');
    if(!existBadge){
      var badge2=document.createElement('div');
      badge2.id='end-grade-badge';
      badge2.style.cssText='display:inline-flex;align-items:center;gap:8px;margin-bottom:12px;'
        +'padding:6px 16px;border-radius:99px;border:2px solid;font-weight:800;font-size:13px;';
      q('end-hero').insertBefore(badge2,q('end-t'));
    }
    var bdg=document.getElementById('end-grade-badge');
    bdg.style.color=gCol2;bdg.style.borderColor=gCol2;
    bdg.style.background=gCol2+'15';
    bdg.textContent='GRADE  '+grade2+'  ('+scoreRaw2+'点)';

    scr.classList.add('open');
    SFX.fanfare();G.busy=false;

    // confetti風パーティクル（成功エンディングのみ）
    var goodEnds=['good','good_studio','balanced_growth','kyoto_artisan','niigata_creative','wellbeing_utopia','global_studio','legacy','acquisition','apple_empire','google_scale','tesla_mobility','spacex_frontier','toyota_kaizen','samsung_vertical','saas_unicorn','platform_empire','ipo','listed','god','world','product'];
    if(goodEnds.indexOf(e.id)>=0){
      G._confetti(scr);
    }
  },

  // シンプルなconfetti
  _confetti:function(container){
    var colors=['#6366f1','#22c55e','#f59e0b','#ef4444','#3b82f6','#a855f7','#06b6d4','#d4a017'];
    for(var i=0;i<60;i++){
      (function(ii){
        setTimeout(function(){
          var el=document.createElement('div');
          var col=colors[Math.floor(Math.random()*colors.length)];
          var size=4+Math.random()*6;
          el.style.cssText='position:fixed;pointer-events:none;z-index:701;'
            +'width:'+size+'px;height:'+size+'px;'
            +'background:'+col+';border-radius:'+(Math.random()>0.5?'50%':'2px')+';'
            +'left:'+(10+Math.random()*80)+'%;top:-20px;'
            +'animation:confettiFall '+(1.5+Math.random()*2)+'s ease-in forwards;'
            +'transform:rotate('+(Math.random()*360)+'deg);';
          container.appendChild(el);
          setTimeout(function(){el.remove();},4000);
        },ii*40);
      })(i);
    }
  },

  // チャート描画（単一折れ線）
  _drawEndChart:function(cv,vals,labels,col,title,isMoney){
    if(!cv||vals.length<2)return;
    var rect=cv.getBoundingClientRect();
    var W=rect.width>0?Math.round(rect.width):300;
    var H=80;
    cv.width=W; cv.height=H;
    var ctx=cv.getContext('2d');
    ctx.clearRect(0,0,W,H);
    var min=0,max=Math.max.apply(null,vals)||1;
    var padL=isMoney?2:2,padR=2,padT=6,padB=4;
    var toX=function(i){return padL+(i/(vals.length-1))*(W-padL-padR);};
    var toY=function(v){return padT+(1-(v-min)/(max-min))*(H-padT-padB);};
    // グリッド
    ctx.strokeStyle='rgba(0,0,0,0.05)';ctx.lineWidth=0.5;
    [0.25,0.5,0.75].forEach(function(f){
      var gy=padT+f*(H-padT-padB);
      ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(W,gy);ctx.stroke();
    });
    ctx.setLineDash([]);
    // エリアグラデ
    var grd=ctx.createLinearGradient(0,padT,0,H);
    grd.addColorStop(0,col+'55');grd.addColorStop(1,col+'05');
    ctx.beginPath();ctx.moveTo(toX(0),H);
    for(var i=0;i<vals.length;i++)ctx.lineTo(toX(i),toY(vals[i]));
    ctx.lineTo(toX(vals.length-1),H);ctx.closePath();
    ctx.fillStyle=grd;ctx.fill();
    // 折れ線（スムース）
    ctx.beginPath();ctx.moveTo(toX(0),toY(vals[0]));
    for(var i=1;i<vals.length;i++){
      var px1=toX(i-1),py1=toY(vals[i-1]),px2=toX(i),py2=toY(vals[i]);
      ctx.bezierCurveTo(px1+(px2-px1)/2,py1,px1+(px2-px1)/2,py2,px2,py2);
    }
    ctx.strokeStyle=col;ctx.lineWidth=2;ctx.stroke();
    // 最終値ドット＋ラベル
    var last=vals[vals.length-1];
    var lx=toX(vals.length-1),ly=toY(last);
    ctx.fillStyle=col;ctx.beginPath();ctx.arc(lx,ly,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(lx,ly,1.5,0,Math.PI*2);ctx.fill();
    ctx.font='bold 8px sans-serif';ctx.fillStyle=col;ctx.textAlign='right';
    ctx.fillText(isMoney?fY(last):(last+''),W-4,10);
    ctx.textAlign='left';
  },

  // チャート描画（複数折れ線）
  _drawEndMultiChart:function(cv,snap,lines){
    if(!cv||snap.length<2)return;
    var rect=cv.getBoundingClientRect();
    var W=rect.width>0?Math.round(rect.width):300;
    var H=80;
    cv.width=W; cv.height=H;
    var ctx=cv.getContext('2d');
    ctx.clearRect(0,0,W,H);
    var pad=4;
    // グリッド
    ctx.strokeStyle='rgba(0,0,0,0.06)';ctx.lineWidth=0.5;
    for(var i=0;i<3;i++){var gy=pad+(i/2)*(H-pad*2);ctx.beginPath();ctx.moveTo(0,gy);ctx.lineTo(W,gy);ctx.stroke();}
    lines.forEach(function(ln){
      var vals=snap.map(function(p){return p[ln.key]||0;});
      var toX=function(i){return pad+(i/(snap.length-1))*(W-pad*2);};
      var toY=function(v){return H-pad-(v/100)*(H-pad*2);};
      ctx.beginPath();ctx.moveTo(toX(0),toY(vals[0]));
      for(var i=1;i<vals.length;i++)ctx.lineTo(toX(i),toY(vals[i]));
      ctx.strokeStyle=ln.col;ctx.lineWidth=1.5;ctx.stroke();
    });
    // 凡例
    var lx=4;
    lines.forEach(function(ln){
      ctx.fillStyle=ln.col;ctx.fillRect(lx,3,8,4);
      ctx.font='7px sans-serif';ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillText(ln.lbl,lx+10,8);
      lx+=ctx.measureText(ln.lbl).width+18;
    });
  },

  // コンサルタントアドバイス生成
  _buildConsultAdvice:function(e,s,avgM){
    var el=q('end-consult');if(!el)return;
    // コンサルタントをエンディングタイプで選択
    var consultants={
      good:{ic:'👔',nm:'田中 誠一郎',role:'シニア経営コンサルタント（McKinsey出身）'},
      bad: {ic:'🩺',nm:'Sophia Chen',role:'ビジネスターンアラウンド・スペシャリスト'},
      tech:{ic:'🤖',nm:'Marcus Tanaka',role:'テック系スタートアップ・アドバイザー'},
    };
    var isBad=['fire','broke','nft','burnout_collapse'].indexOf(e.id)>=0;
    var isTech=['apple_empire','google_scale','tesla_mobility','spacex_frontier','samsung_vertical','saas_unicorn','platform_empire'].indexOf(e.id)>=0;
    var c=isBad?consultants.bad:isTech?consultants.tech:consultants.good;

    // データに基づいた具体的アドバイス生成
    var advices=[];

    // 財務分析
    if(s.totalRev>0){
      if(s.totalRev>=1000000000){
        advices.push({ic:'💰',txt:'累計収益'+fY(s.totalRev)+'は業界平均を大幅に上回ります。特に後半の成長曲線は投資家が注目するレベルです。'});
      }else if(s.totalRev>=100000000){
        advices.push({ic:'💰',txt:'累計収益'+fY(s.totalRev)+'は堅実な成長を示しています。次のフェーズでの収益多角化を検討する時期です。'});
      }else{
        advices.push({ic:'💰',txt:'収益規模はまだ成長段階です。単価の高い案件への集中と、リピートクライアントの獲得が優先課題です。'});
      }
    }

    // 評判分析
    if(s.rep>=80){
      advices.push({ic:'⭐',txt:'評判'+s.rep+'ptは非常に高く、業界内でのブランド価値が確立されています。この評判を活かしたプレミアム価格戦略を推奨します。'});
    }else if(s.rep>=50){
      advices.push({ic:'⭐',txt:'評判'+s.rep+'ptは中程度です。受賞活動・SNS発信・PR強化で次の四半期で70pt超を目指せる水準にあります。'});
    }else{
      advices.push({ic:'⭐',txt:'評判'+s.rep+'ptは改善が必要です。品質管理プロセスの見直しと、クライアントコミュニケーションの強化を即座に実施すべきです。'});
    }

    // 組織健全性
    if(avgM>=75){
      advices.push({ic:'🌿',txt:'平均メンタル'+avgM+'ptは「健全な組織」の証明です。この水準を維持できた経営判断は、長期的な競争優位に直結します。'});
    }else if(avgM>=50){
      advices.push({ic:'🌿',txt:'メンタル'+avgM+'ptはやや低下傾向です。週4日制・リモートワーク制度の導入が効果的なWB向上策として実績があります。'});
    }else{
      advices.push({ic:'🌿',txt:'メンタル'+avgM+'ptは危険ラインです。燃え尽き症候群による退職連鎖のリスクが高く、即座の業務量調整が必要でした。'});
    }

    // フェーズ別アドバイス
    if(s.phase>=5){
      advices.push({ic:'🌐',txt:'プラットフォーム・テックジャイアントへの到達は、デザイン会社としては前例のない快挙です。次の一手はM&Aによる機能拡充か、IPOによる資本調達です。'});
    }else if(s.phase>=3){
      advices.push({ic:'🚀',txt:'プロダクト企業への転換ステップが鍵でした。tech投資とDAU成長を連動させることで、収益の「受注依存」から脱却できます。'});
    }else{
      advices.push({ic:'📋',txt:'フェーズ移行が早期の課題です。採用・評判・技術力の3点を同時に引き上げる「三角形成長戦略」を次回は試してみてください。'});
    }

    // 炎上リスク
    if(s.fire>40){
      advices.push({ic:'🔥',txt:'炎上リスク'+s.fire+'%は高水準でした。クライアント選定基準の厳格化と、SNS危機管理マニュアルの整備が必要です。'});
    }

    // 修正回数ポジティブ評価
    if(s.totalMods>0){
      var modPerProj=s.projDone>0?(s.totalMods/s.projDone).toFixed(1):0;
      if(modPerProj<=1.5){
        advices.push({ic:'✅',txt:'案件あたり修正'+modPerProj+'回は業界平均を下回ります。初回提案の精度の高さが収益性に直結しています。'});
      }else if(modPerProj<=3){
        advices.push({ic:'🔄',txt:'修正回数は平均的です。ヒアリング精度向上とビジュアル方向性の早期合意プロセスを導入することで、20〜30%削減できます。'});
      }
    }

    // 総合格付け
    var score=Math.min(100,Math.round(
      (s.rep||0)*0.25 +
      Math.min(50,(s.totalRev||0)/10000000)*0.5 +
      (avgM||0)*0.15 +
      ((s.wb||50))*0.1
    ));
    var grade=score>=85?'S':score>=70?'A':score>=55?'B':score>=40?'C':'D';
    var gradeCol={S:'#6366f1',A:'#22c55e',B:'#f59e0b',C:'#f97316',D:'#ef4444'}[grade];

    el.innerHTML='<div class="end-consult-hdr">'
      +'<div class="end-consult-avatar">'+c.ic+'</div>'
      +'<div class="end-consult-meta">'
      +'<div class="end-consult-nm">'+c.nm+'</div>'
      +'<div class="end-consult-role">'+c.role+'</div>'
      +'</div>'
      +'<div style="margin-left:auto;text-align:center">'
      +'<div style="font-size:28px;font-weight:800;color:'+gradeCol+'">'+grade+'</div>'
      +'<div style="font-size:9px;color:var(--t4)">総合評価</div>'
      +'</div>'
      +'</div>'
      +'<div class="end-consult-body">'
      +advices.slice(0,5).map(function(adv){
        return '<div class="end-consult-item">'
          +'<span class="end-consult-bullet">'+adv.ic+'</span>'
          +'<span>'+adv.txt+'</span>'
          +'</div>';
      }).join('')
      +'</div>';
  },

  // レポートダウンロード
  downloadReport:function(){
    var cv=q('report-cv');if(!cv)return;
    var a=document.createElement('a');
    var nm=(G.s&&G.s.compName?G.s.compName:'company').replace(/\s/g,'_');
    a.download=nm+'-design-report.png';
    a.href=cv.toDataURL('image/png');
    a.click();
  },

  // Xシェア
  shareX:function(){
    if(!G.endingData)return;
    var d=G.endingData;
    var txt=d.e.tt+'\n\n'
      +'💰 '+fY(d.s.totalRev)+' ⭐ 評判'+d.s.rep+' 👥 '+d.s.staff.length+'名\n'
      +'📋 '+d.s.projDone+'件完了 🏆 受賞'+d.s.awards+'件\n'
      +'第'+d.s.turn+'週でゲームクリア！\n'
      +'#デザイン会社シミュレーター';
    window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');
  },

  // A4レポートCanvas生成
  generateReport:function(){
    if(!G.endingData)return;
    var modal=q('end-report-modal');
    var cv=q('report-cv');
    if(!modal||!cv)return;
    modal.classList.add('open');
    var d=G.endingData;
    // A4 @2x解像度（Retina/高品質PNG用）
    var W=794*2, H=1123*2;
    cv.width=W; cv.height=H;
    cv.style.width='794px'; cv.style.height='1123px';
    var ctx=cv.getContext('2d');
    ctx.scale(2,2);// 2x スケール
    G._renderReportCanvas(ctx,794,1123,d);
  },

  // A4レポートCanvas描画（高品質版）
  _renderReportCanvas:function(ctx,W,H,d){
    var s=d.s, e=d.e, avgM=d.avgM||0;
    var P={
      ACC:'#6366f1', ACC2:'#7c3aed', TEAL:'#0891b2',
      OK:'#16a34a', WARN:'#d97706', RED:'#dc2626',
      T1:'#0f172a', T2:'#334155', T3:'#64748b', T4:'#94a3b8',
      BG:'#f8fafc', BG2:'#f1f5f9', BORD:'#e2e8f0',
      GOLD:'#d4a017'
    };
    var pad=44;

    // ── ヘルパー関数 ─────────────────────────────────────────
    // テキスト折り返し
    function wrapText(text, x, y, maxW, lineH){
      var words=text.split('');// 日本語は文字単位
      var line='';
      words.forEach(function(ch){
        var test=line+ch;
        if(ctx.measureText(test).width>maxW&&line!==''){
          ctx.fillText(line,x,y);y+=lineH;line=ch;
        }else{line+=ch;}
      });
      if(line)ctx.fillText(line,x,y);
      return y+lineH;
    }
    function card(x,y,w,h,r){
      ctx.fillStyle='#fff';
      ctx.shadowColor='rgba(0,0,0,0.07)';ctx.shadowBlur=12;ctx.shadowOffsetY=2;
      ctx.beginPath();ctx.roundRect(x,y,w,h,r||10);ctx.fill();
      ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetY=0;
      ctx.strokeStyle=P.BORD;ctx.lineWidth=1;
      ctx.beginPath();ctx.roundRect(x,y,w,h,r||10);ctx.stroke();
    }
    function badge(x,y,text,col){
      ctx.font='bold 8px sans-serif';
      var tw=ctx.measureText(text).width+10;
      ctx.fillStyle=col+'22';
      ctx.beginPath();ctx.roundRect(x,y-9,tw,14,99);ctx.fill();
      ctx.fillStyle=col;ctx.fillText(text,x+5,y);
    }

    // ── 背景 ──────────────────────────────────────────────────
    ctx.fillStyle=P.BG;ctx.fillRect(0,0,W,H);
    // 右上装飾円
    ctx.fillStyle='rgba(99,102,241,0.04)';
    ctx.beginPath();ctx.arc(W+60,-60,200,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(W+20,H-200,280,0,Math.PI*2);ctx.fill();

    // ── ヘッダー ──────────────────────────────────────────────
    var hg=ctx.createLinearGradient(0,0,W,140);
    hg.addColorStop(0,'#312e81');hg.addColorStop(0.5,'#4f46e5');hg.addColorStop(1,'#7c3aed');
    ctx.fillStyle=hg;ctx.fillRect(0,0,W,148);
    // ヘッダー装飾
    ctx.fillStyle='rgba(255,255,255,0.04)';
    ctx.beginPath();ctx.arc(W-100,-30,160,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(W-40,130,80,0,Math.PI*2);ctx.fill();
    // LOGO
    ctx.fillStyle='rgba(255,255,255,0.35)';
    ctx.font='bold 9px sans-serif';ctx.letterSpacing='2px';
    ctx.fillText('DESIGN COMPANY SIMULATOR',pad,28);
    ctx.letterSpacing='0px';
    // タイトル
    ctx.fillStyle='#fff';
    ctx.font='bold 28px sans-serif';ctx.fillText(e.tt,pad,72);
    // サブ
    ctx.fillStyle='rgba(255,255,255,0.65)';
    ctx.font='12px sans-serif';ctx.fillText(s.compName+' • 第'+s.turn+'週 • Phase '+s.phase,pad,100);
    // 日付
    var now=new Date();
    ctx.font='10px sans-serif';ctx.fillText(now.getFullYear()+'年'+('0'+(now.getMonth()+1)).slice(-2)+'月'+('0'+now.getDate()).slice(-2)+'日 生成',pad,120);

    // 総合グレード（右上サークル）
    // 総合スコア: 評判25% + 収益正規化25% + メンタル20% + WB15% + 受賞10% + フェーズ5%
    var revScore=Math.min(100,(s.totalRev||0)/500000000*100);// 5億円=100点
    var scoreRaw=Math.min(100,Math.round(
      (s.rep||0)*0.25+
      revScore*0.25+
      (avgM||0)*0.20+
      ((s.wb||50))*0.15+
      Math.min(100,(s.awards||0)*10)*0.10+
      Math.min(100,(s.phase||0)/6*100)*0.05
    ));
    var grade=scoreRaw>=85?'S':scoreRaw>=70?'A+':scoreRaw>=60?'A':scoreRaw>=50?'B':scoreRaw>=35?'C':'D';
    var gCol={S:P.GOLD,'A+':P.OK,A:'#22c55e',B:P.WARN,C:P.RED,D:'#7f1d1d'}[grade]||P.ACC;
    ctx.fillStyle='rgba(255,255,255,0.12)';
    ctx.beginPath();ctx.arc(W-pad-40,74,50,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.arc(W-pad-40,74,50,0,Math.PI*2);ctx.stroke();
    ctx.fillStyle=gCol;ctx.font='bold 36px sans-serif';ctx.textAlign='center';
    ctx.fillText(grade,W-pad-40,89);
    ctx.fillStyle='rgba(255,255,255,0.6)';ctx.font='bold 8px sans-serif';
    ctx.fillText('OVERALL GRADE',W-pad-40,108);
    ctx.textAlign='left';

    var y=168;

    // ── KPIカード 4列×2行 ────────────────────────────────────
    var kpis=[
      {lbl:'累計収益',val:fY(s.totalRev),icon:'💰',col:P.ACC,
       sub:'目標: '+fY(1000000000),pct:Math.min(100,s.totalRev/1000000000*100)},
      {lbl:'完了案件',val:s.projDone+'件',icon:'📋',col:P.TEAL,
       sub:'修正計'+s.totalMods+'回',pct:Math.min(100,s.projDone/200*100)},
      {lbl:'最終評判',val:s.rep+'pt',icon:'⭐',col:P.WARN,
       sub:s.rep>=80?'業界TOP':'改善余地あり',pct:s.rep},
      {lbl:'最終炎上',val:s.fire+'%',icon:'🔥',col:s.fire>50?P.RED:P.OK,
       sub:s.fire>50?'要注意':'安全圏',pct:s.fire},
      {lbl:'社員数',val:s.staff.length+'名',icon:'👥',col:'#3b82f6',
       sub:'INT\'L '+((s.intlStaff||0))+'名',pct:Math.min(100,s.staff.length/50*100)},
      {lbl:'受賞歴',val:s.awards+'件',icon:'🏆',col:P.GOLD,
       sub:s.awards>=5?'グランプリ級':'もう少し',pct:Math.min(100,s.awards/10*100)},
      {lbl:'平均メンタル',val:avgM+'pt',icon:'🌿',col:P.OK,
       sub:avgM>=75?'健全':'要ケア',pct:avgM},
      {lbl:'WBスコア',val:(s.wb||50)+'pt',icon:'☀️',col:'#f97316',
       sub:'Black: '+s.black+'%',pct:s.wb||50},
    ];
    var cols=4, cw=(W-pad*2-10*3)/cols, ch=76;
    kpis.forEach(function(k,i){
      var cx=pad+(i%cols)*(cw+10);
      var cy=y+Math.floor(i/cols)*(ch+10);
      card(cx,cy,cw,ch,8);
      // アイコン
      ctx.font='16px serif';ctx.fillText(k.icon,cx+12,cy+26);
      // 値
      ctx.fillStyle=k.col;ctx.font='bold 16px sans-serif';
      ctx.fillText(k.val,cx+36,cy+26);
      // ラベル
      ctx.fillStyle=P.T3;ctx.font='8px sans-serif';
      ctx.fillText(k.lbl,cx+12,cy+40);
      // サブ
      ctx.fillStyle=P.T4;ctx.font='8px sans-serif';
      ctx.fillText(k.sub,cx+12,cy+52);
      // プログレスバー
      ctx.fillStyle=P.BG2;
      ctx.beginPath();ctx.roundRect(cx+12,cy+60,cw-24,3,99);ctx.fill();
      ctx.fillStyle=k.col;
      ctx.beginPath();ctx.roundRect(cx+12,cy+60,(cw-24)*k.pct/100,3,99);ctx.fill();
    });
    y+=ch*2+10*3+10;

    // ── グラフエリア（売上折れ線 + KPIレーダー） ─────────────
    var snap=d.snap||[];
    var ghH=150, ghW=(W-pad*2-20)/2;

    // 売上グラフ
    card(pad,y,ghW,ghH+44,10);
    ctx.fillStyle=P.T2;ctx.font='bold 10px sans-serif';
    ctx.fillText('📈 累計売上推移',pad+14,y+18);
    if(snap.length>=2){
      var revVals=snap.map(function(p){return p.tr||0;});
      var maxRev=Math.max.apply(null,revVals)||1;
      var gx=pad+16,gy=y+28,gw=ghW-32,gh=ghH-8;
      // グリッド線 + ラベル
      ctx.strokeStyle='rgba(0,0,0,0.05)';ctx.lineWidth=0.6;
      [0,0.25,0.5,0.75,1].forEach(function(f){
        var hy=gy+gh*(1-f);
        ctx.beginPath();ctx.moveTo(gx,hy);ctx.lineTo(gx+gw,hy);ctx.stroke();
        if(f>0){
          ctx.fillStyle=P.T4;ctx.font='7px sans-serif';
          ctx.fillText(fY(maxRev*f),gx+2,hy-2);
        }
      });
      // 面グラデ
      var rg=ctx.createLinearGradient(0,gy,0,gy+gh);
      rg.addColorStop(0,'rgba(99,102,241,0.25)');rg.addColorStop(1,'rgba(99,102,241,0.0)');
      ctx.beginPath();ctx.moveTo(gx,gy+gh);
      revVals.forEach(function(v,i){
        var rx=gx+(i/(revVals.length-1))*gw;
        var ry=gy+gh*(1-v/maxRev);
        ctx.lineTo(rx,ry);
      });
      ctx.lineTo(gx+gw,gy+gh);ctx.closePath();
      ctx.fillStyle=rg;ctx.fill();
      // 折れ線
      ctx.beginPath();
      revVals.forEach(function(v,i){
        var rx=gx+(i/(revVals.length-1))*gw;
        var ry=gy+gh*(1-v/maxRev);
        i===0?ctx.moveTo(rx,ry):ctx.lineTo(rx,ry);
      });
      ctx.strokeStyle=P.ACC;ctx.lineWidth=2;ctx.stroke();
      // 最終値dot
      var lastRx=gx+gw, lastRy=gy+gh*(1-revVals[revVals.length-1]/maxRev);
      ctx.fillStyle=P.ACC;ctx.beginPath();ctx.arc(lastRx,lastRy,4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(lastRx,lastRy,2,0,Math.PI*2);ctx.fill();
      // 最終値ラベル
      ctx.fillStyle=P.ACC;ctx.font='bold 8px sans-serif';ctx.textAlign='right';
      ctx.fillText(fY(revVals[revVals.length-1]),gx+gw,lastRy-6);
      ctx.textAlign='left';
    }else{
      ctx.fillStyle=P.T4;ctx.font='11px sans-serif';ctx.textAlign='center';
      ctx.fillText('データなし（プレイ中に記録されます）',pad+ghW/2,y+ghH/2);
      ctx.textAlign='left';
    }

    // KPIマルチライン（評判/炎上/WB）
    var ch2x=pad+ghW+20;
    card(ch2x,y,ghW,ghH+44,10);
    ctx.fillStyle=P.T2;ctx.font='bold 10px sans-serif';
    ctx.fillText('📊 評判 / 炎上 / WB 推移',ch2x+14,y+18);
    if(snap.length>=2){
      var gx2=ch2x+16,gy2=y+28,gw2=ghW-32,gh2=ghH-8;
      ctx.strokeStyle='rgba(0,0,0,0.05)';ctx.lineWidth=0.6;
      [0,50,100].forEach(function(v){
        var hy=gy2+gh2*(1-v/100);
        ctx.beginPath();ctx.moveTo(gx2,hy);ctx.lineTo(gx2+gw2,hy);ctx.stroke();
        ctx.fillStyle=P.T4;ctx.font='7px sans-serif';
        ctx.fillText(v+'pt',gx2+2,hy-2);
      });
      [{key:'r',col:P.WARN,lbl:'評判'},{key:'f',col:P.RED,lbl:'炎上'},{key:'wb',col:P.OK,lbl:'WB'}].forEach(function(ln,li){
        var vals=snap.map(function(p){return p[ln.key]||0;});
        ctx.beginPath();
        vals.forEach(function(v,i){
          var rx=gx2+(i/(vals.length-1))*gw2;
          var ry=gy2+gh2*(1-v/100);
          i===0?ctx.moveTo(rx,ry):ctx.lineTo(rx,ry);
        });
        ctx.strokeStyle=ln.col;ctx.lineWidth=2;ctx.stroke();
      });
      // 凡例
      var lx=ch2x+16,lly=y+ghH+30;
      [{col:P.WARN,lbl:'評判'},{col:P.RED,lbl:'炎上'},{col:P.OK,lbl:'WB'}].forEach(function(leg){
        ctx.fillStyle=leg.col;
        ctx.beginPath();ctx.roundRect(lx,lly-6,20,4,2);ctx.fill();
        ctx.fillStyle=P.T3;ctx.font='8px sans-serif';ctx.fillText(leg.lbl,lx+24,lly);
        lx+=50;
      });
    }
    y+=ghH+44+16;

    // ── レーダーチャート + フェーズ年表 ──────────────────────
    var radarW=220, radarH=200;
    // レーダー
    card(pad,y,radarW,radarH+16,10);
    ctx.fillStyle=P.T2;ctx.font='bold 10px sans-serif';
    ctx.fillText('🕸 スキルレーダー',pad+14,y+18);
    var rcx=pad+radarW/2, rcy=y+22+radarH/2, rr=Math.min(radarW,radarH)/2-28;
    var axes=[
      {lbl:'収益力',val:Math.min(1,(s.totalRev||0)/5000000000)},
      {lbl:'評判',val:(s.rep||0)/100},
      {lbl:'組織力',val:Math.min(1,(s.staff.length||0)/50)},
      {lbl:'受賞',val:Math.min(1,(s.awards||0)/10)},
      {lbl:'WB',val:((s.wb||50))/100},
      {lbl:'技術力',val:Math.min(1,Object.keys(s.tech||{}).length/20)},
    ];
    var N=axes.length;
    function radarPt(i,r){
      var ang=-Math.PI/2+(i/N)*Math.PI*2;
      return {x:rcx+Math.cos(ang)*r, y:rcy+Math.sin(ang)*r};
    }
    // グリッド
    [0.25,0.5,0.75,1.0].forEach(function(f){
      ctx.strokeStyle=f===1?'rgba(99,102,241,0.2)':'rgba(0,0,0,0.06)';
      ctx.lineWidth=f===1?1:0.5;ctx.setLineDash(f<1?[2,2]:[]);
      ctx.beginPath();
      for(var i=0;i<N;i++){var p=radarPt(i,rr*f);i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y);}
      ctx.closePath();ctx.stroke();ctx.setLineDash([]);
    });
    // 軸線
    for(var i=0;i<N;i++){
      var p=radarPt(i,rr);
      ctx.strokeStyle='rgba(0,0,0,0.08)';ctx.lineWidth=0.5;
      ctx.beginPath();ctx.moveTo(rcx,rcy);ctx.lineTo(p.x,p.y);ctx.stroke();
      // ラベル
      var lp=radarPt(i,rr+14);
      ctx.fillStyle=P.T3;ctx.font='bold 8px sans-serif';ctx.textAlign='center';
      ctx.fillText(axes[i].lbl,lp.x,lp.y+3);
    }
    ctx.textAlign='left';
    // 塗り
    var rg2=ctx.createLinearGradient(rcx-rr,rcy-rr,rcx+rr,rcy+rr);
    rg2.addColorStop(0,'rgba(99,102,241,0.3)');rg2.addColorStop(1,'rgba(124,58,237,0.15)');
    ctx.beginPath();
    for(var i=0;i<N;i++){var p=radarPt(i,rr*axes[i].val);i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y);}
    ctx.closePath();ctx.fillStyle=rg2;ctx.fill();
    ctx.strokeStyle=P.ACC;ctx.lineWidth=2;ctx.stroke();
    // 頂点ドット
    for(var i=0;i<N;i++){
      var p=radarPt(i,rr*axes[i].val);
      ctx.fillStyle=P.ACC;ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(p.x,p.y,1.5,0,Math.PI*2);ctx.fill();
    }

    // フェーズ年表（レーダーの右側）
    var tlX=pad+radarW+16, tlW=W-pad-tlX;
    card(tlX,y,tlW,radarH+16,10);
    ctx.fillStyle=P.T2;ctx.font='bold 10px sans-serif';
    ctx.fillText('🗓 会社の歩み',tlX+14,y+18);
    var tlItems=d.tl||[];
    var tlY=y+32;
    tlItems.slice(0,7).forEach(function(ev,i){
      var dot={x:tlX+20,y:tlY+i*26+4};
      // ドット
      ctx.fillStyle=ev.col||P.ACC;
      ctx.beginPath();ctx.arc(dot.x,dot.y,5,0,Math.PI*2);ctx.fill();
      // 縦線
      if(i<tlItems.length-1){
        ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=1;ctx.setLineDash([2,2]);
        ctx.beginPath();ctx.moveTo(dot.x,dot.y+5);ctx.lineTo(dot.x,dot.y+21);ctx.stroke();
        ctx.setLineDash([]);
      }
      // テキスト
      ctx.fillStyle=P.T4;ctx.font='8px sans-serif';ctx.fillText('第'+ev.t+'週',tlX+32,dot.y+1);
      ctx.fillStyle=P.T1;ctx.font='bold 9px sans-serif';ctx.fillText(ev.msg,tlX+32,dot.y+12);
    });
    y+=radarH+16+16;

    // ── コンサルタント総評 ────────────────────────────────────
    var cH=210;
    card(pad,y,W-pad*2,cH,10);
    // アクセントバー
    var cg=ctx.createLinearGradient(0,y,0,y+cH);
    cg.addColorStop(0,P.ACC);cg.addColorStop(1,P.ACC2);
    ctx.fillStyle=cg;ctx.beginPath();ctx.roundRect(pad,y,4,cH,99);ctx.fill();

    // コンサルタント情報
    var isBad=['fire','broke','nft','burnout_collapse'].indexOf(e.id)>=0;
    var isTech=['apple_empire','google_scale','tesla_mobility','spacex_frontier','samsung_vertical','saas_unicorn','platform_empire'].indexOf(e.id)>=0;
    var consultant=isBad?{ic:'🩺',nm:'Sophia Chen CPA',role:'ビジネスターンアラウンド・スペシャリスト'}
      :isTech?{ic:'🤖',nm:'Marcus K. Tanaka',role:'テック系スタートアップ・アドバイザー（YC出身）'}
      :{ic:'👔',nm:'田中 誠一郎 MBA',role:'シニア経営コンサルタント（元McKinsey）'};
    ctx.font='24px serif';ctx.fillText(consultant.ic,pad+18,y+34);
    ctx.fillStyle=P.T1;ctx.font='bold 11px sans-serif';ctx.fillText(consultant.nm,pad+50,y+24);
    ctx.fillStyle=P.T3;ctx.font='9px sans-serif';ctx.fillText(consultant.role,pad+50,y+38);
    // グレードバッジ
    badge(W-pad-80,y+30,grade+' GRADE',gCol);
    badge(W-pad-140,y+30,scoreRaw+'点',P.T3);

    // アドバイス本文（データ連動）
    var advices=[];
    // 財務
    var revBn=(s.totalRev/100000000).toFixed(1);
    if(s.totalRev>=10000000000)
      advices.push({ic:'💰',txt:'累計売上'+fY(s.totalRev)+'は希少なユニコーン級の実績です。この規模に達した企業はIPO・戦略的M&Aのいずれも現実的な出口として検討できます。'});
    else if(s.totalRev>=1000000000)
      advices.push({ic:'💰',txt:'累計売上'+fY(s.totalRev)+'（'+revBn+'億円）は業界上位10%に相当します。次の1〜2億円の投資でPlatform化を加速させることを推奨します。'});
    else if(s.totalRev>=100000000)
      advices.push({ic:'💰',txt:'累計売上'+fY(s.totalRev)+'は「健全なスタジオ」の水準です。リピートクライアント比率を高め、月次MRRの安定化が次の課題です。'});
    else
      advices.push({ic:'💰',txt:'収益'+fY(s.totalRev)+'はまだ初期段階。案件単価を30%引き上げるだけで1年後の収益は倍増します。価格改定を恐れないでください。'});
    // 評判
    if(s.rep>=85)
      advices.push({ic:'⭐',txt:'評判'+s.rep+'ptは「業界ブランド確立済み」のシグナルです。このレベルに達すると口コミ営業比率が70%を超え、マーケティングコストが劇的に下がります。'});
    else if(s.rep>=60)
      advices.push({ic:'⭐',txt:'評判'+s.rep+'ptは成長中のスタジオとして標準的です。受賞活動（ADC・Good Design等）とクライアントの成功事例発信で+20pt達成は現実的です。'});
    else
      advices.push({ic:'⭐',txt:'評判'+s.rep+'ptは改善が急務です。1件でも「世の中を変えた実績」を作ることが最優先。量より質への転換を強くお勧めします。'});
    // 組織
    if(avgM>=80)
      advices.push({ic:'🌿',txt:'平均メンタル'+avgM+'ptは「最高の職場」レベルです。この組織資産は財務諸表に表れない競争優位です。採用ブランドとして積極的に対外発信すべきです。'});
    else if(avgM>=55)
      advices.push({ic:'🌿',txt:'メンタル'+avgM+'ptはもう一歩。週4日勤務制・産業医面談の制度化で3ヶ月以内に+10〜15pt改善できます。離職コスト（採用費+引継ぎ期間）は年収の30%に相当します。'});
    else
      advices.push({ic:'🌿',txt:'メンタル'+avgM+'ptは危機的水準です。業務量の即時削減と1on1面談の実施が不可欠です。このまま放置すると1年以内にコアメンバーの離職が連鎖します。'});
    // フェーズ/戦略
    if(s.phase>=5)
      advices.push({ic:'🚀',txt:'テックジャイアントへの到達はデザイン会社からの出発点としては前例のない快挙です。次の5年は「買い手」として業界再編に参加する立場になりました。'});
    else if(s.phase>=3)
      advices.push({ic:'🚀',txt:'プロダクト企業への転換が最大の成長ドライバーです。DAU×ARPPUで収益をストック型に変換することで、受注依存体質から脱却できます。'});
    else
      advices.push({ic:'🚀',txt:'フェーズ移行が今後の最大課題です。技術投資（AI・Platform）を早期に開始し、5年後のビジネスモデル転換に備えた布石を今から打つことを勧めます。'});
    // 炎上
    if(s.fire>60)
      advices.push({ic:'🔥',txt:'炎上リスク'+s.fire+'%は経営の最大リスクです。クライアント選定フィルターの強化と、SNS危機対応マニュアルの整備を今すぐ実施してください。'});
    else if(s.fire>30)
      advices.push({ic:'💛',txt:'炎上'+s.fire+'%は管理可能な範囲ですが油断は禁物。守りの広報体制（報道対応・SNSモニタリング）を構築しておくことを勧めます。'});

    var ayOffset=0;
    advices.slice(0,4).forEach(function(adv,i){
      var ay=y+58+i*36+ayOffset;
      ctx.font='11px serif';ctx.fillText(adv.ic,pad+18,ay+2);
      ctx.fillStyle=P.T1;ctx.font='9.5px sans-serif';
      // テキスト1行（折り返しなし、省略）
      var maxTw=W-pad*2-80;
      var txt=adv.txt;
      if(ctx.measureText(txt).width>maxTw){
        while(ctx.measureText(txt+'…').width>maxTw&&txt.length>10)txt=txt.slice(0,-1);
        txt+='…';
      }
      ctx.fillText(txt,pad+36,ay+2);
      if(i<3){
        ctx.strokeStyle=P.BORD;ctx.lineWidth=0.5;
        ctx.beginPath();ctx.moveTo(pad+16,ay+12);ctx.lineTo(W-pad-16,ay+12);ctx.stroke();
      }
    });
    y+=cH+16;

    // ── フッター ────────────────────────────────────────────
    ctx.fillStyle=P.BG2;ctx.fillRect(0,H-40,W,40);
    ctx.strokeStyle=P.BORD;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(0,H-40);ctx.lineTo(W,H-40);ctx.stroke();
    ctx.fillStyle=P.T4;ctx.font='8px sans-serif';ctx.textAlign='center';
    ctx.fillText('Design Company Simulator — Final Report  |  '+s.compName+'  |  Phase '+s.phase+'  |  '+now.getFullYear()+'年'+('0'+(now.getMonth()+1)).slice(-2)+'月'+('0'+now.getDate()).slice(-2)+'日',W/2,H-16);
    ctx.textAlign='left';

    // ※ダウンロードはモーダル内ボタンから
  },

  // ─ MODALS ─
  showEv:function(ev,cb){
    if(!ev){if(cb)cb();return;}
    // ── AIモード: モーダル非表示で即判断 ──
    if(G.aiMode){
      G.aiChooseEv(ev,cb);return;
    }
    SFX.ev();
    var mb=q('mbox-ev');mb.className='mbox '+(ev.ty||'');
    q('mev-ic').textContent=ev.ic;q('mev-tt').textContent=ev.tt;q('mev-ds').textContent=ev.ds;
    var el=q('mev-ch');el.innerHTML='';
    ev.ch.forEach(function(c){
      var btn=document.createElement('button');btn.className='mch';
      btn.innerHTML='<span>'+esc(c.tx)+'</span><span class="ef">'+esc(c.ef)+'</span>';
      btn.onclick=function(){SFX.click();try{c.fn();}catch(e2){console.error(e2);}
        q('modal-ev').classList.remove('open');G.updateHUD();G.renderAll();addLog('[イベント] '+ev.tt,'evt');if(cb)cb();};
      el.appendChild(btn);
    });
    q('modal-ev').classList.add('open');
  },

  // AIがイベントを自動判断
  aiChooseEv:function(ev,cb){
    if(!ev||!ev.ch||ev.ch.length===0){if(cb)cb();return;}
    // 選択肢のefテキストを解析してスコアリング
    var best=0;
    var bestScore=-9999;
    ev.ch.forEach(function(ch,i){
      var score=0;
      var ef=ch.ef||'';
      // ポジティブ指標
      if(ef.match(/評判\+|rep\+/))score+=3;
      if(ef.match(/資金\+|money\+/))score+=4;
      if(ef.match(/SNS\+/))score+=2;
      if(ef.match(/メンタル\+/))score+=2;
      if(ef.match(/技術|スキル\+/))score+=2;
      // ネガティブ指標
      if(ef.match(/評判-/))score-=3;
      if(ef.match(/資金-/))score-=4;
      if(ef.match(/炎上\+|fire\+/))score-=5;
      if(ef.match(/メンタル-/))score-=2;
      if(ef.match(/退職|quit/))score-=8;
      if(ef.match(/ブラック\+/))score-=3;
      // 現在の状態に応じた補正
      if(G.s.fire>60&&ef.match(/炎上-|fire-/))score+=4;// 以前の6から削減
      if(G.s.money<300000&&ef.match(/資金\+/))score+=5;
      if(G.s.black>70&&ef.match(/ブラック-/))score+=4;
      // 最初の選択肢は基本的に「受け入れ」系が多い → 微加点
      if(i===0)score+=0.5;
      if(score>bestScore){bestScore=score;best=i;}
    });
    // AIのミス確率: 12%でランダム選択（完璧ではないAI）
    var chosen;
    if(Math.random()<0.12){
      chosen=ev.ch[Math.floor(Math.random()*ev.ch.length)];
      G.aiThink('MISTAKE','⚠ 判断ミス: ランダム選択してしまいました');
    } else {
      chosen=ev.ch[best];
    }
    // 実行
    try{chosen.fn();}catch(e2){console.error('[aiChooseEv.fn]',e2);}
    addLog('[AI判断] '+ev.tt+' → 「'+chosen.tx+'」','sys');
    G.aiThink('EVENT',ev.ic+' '+ev.tt+'\n→ 「'+chosen.tx+'」\n'+chosen.ef);
    try{G.updateHUD();G.renderAll();}catch(re){console.error('[aiChooseEv.render]',re);}
    // cbは必ず呼ぶ（呼ばないとbusy=trueのまま固まる）
    try{if(cb)cb();}catch(ce){console.error('[aiChooseEv.cb]',ce);}
  },

  showMod:function(mod,proj,cb){
    proj.modCnt=(proj.modCnt||0)+1;G.s.totalMods++;
    var modBlackAdd=proj.modCnt>=3?6:3;// 繰り返し修正でブラック度加速
    var choices=[
      {tx:mod.at,ef:'メンタル'+mod.dm+', ブラック+'+modBlackAdd,fn:function(){
        if(proj.asgn){var s=G.s.staff.find(function(x){return x.id===proj.asgn;});if(s)s.mental=clamp(s.mental+mod.dm,0,100);}
        G.s.black=clamp(G.s.black+modBlackAdd,0,100);
        // 4回以上の修正は炎上リスク
        if(proj.modCnt>=4){G.s.fire=clamp(G.s.fire+ri(3,8),0,100);addLog('修正'+proj.modCnt+'回目…炎上リスクが高まってきた','warn');}
      }},
      {tx:mod.rt,ef:'評判'+mod.rp+', 収益-10%',fn:function(){
        G.s.rep=clamp(G.s.rep+mod.rp,0,100);
        proj.price=Math.round(proj.price*0.85);// 以前の0.9から0.85に強化
      }}
    ];
    // ── AIモード: 即判断 ──
    if(G.aiMode){
      // 評判が高い時は評判優先、メンタルが低い時はメンタル優先
      var avgMental=G.s.staff.length>0?G.s.staff.reduce(function(a,s){return a+s.mental;},0)/G.s.staff.length:80;
      var chooseRep=(avgMental>50&&G.s.rep<70);
      var chosen=chooseRep?choices[1]:choices[0];
      try{chosen.fn();}catch(e2){console.error(e2);}
      addLog('[AI修正対応] 「'+proj.nm+'」修正'+proj.modCnt+'回目 → '+chosen.tx,'sys');
      var face=proj.modCnt<=3?'😤':proj.modCnt<=6?'😡':'💀';
      G.aiThink('REVISION',face+' 修正依頼 '+proj.modCnt+'回目\n「'+proj.nm+'」\n→ '+chosen.tx);
      G.updateHUD();if(cb)cb();return;
    }
    SFX.alert();
    q('mod-cnt').textContent='第'+proj.modCnt+'回';
    q('mod-face').textContent=proj.modCnt<=3?'😤':proj.modCnt<=6?'😡':'💀';
    q('mod-pn').textContent='「'+proj.nm+'」';q('mod-tx').textContent=mod.tx;
    var el=q('mod-ch');el.innerHTML='';
    choices.forEach(function(c){
      var btn=document.createElement('button');btn.className='mch';
      btn.innerHTML='<span>'+esc(c.tx)+'</span><span class="ef">'+esc(c.ef)+'</span>';
      btn.onclick=function(){SFX.click();c.fn();q('modal-mod').classList.remove('open');G.updateHUD();if(cb)cb();};
      el.appendChild(btn);
    });
    q('modal-mod').classList.add('open');
  },

  showRev:function(stars,comment,earned,typeLb,cb){
    // AIモード: 即スキップ（ログだけ出す）
    if(G.aiMode){
      SFX.coin();
      G.aiThink('COMPLETE',stars+' '+typeLb+'完了\n'+comment+'\n+'+fY(earned));
      try{if(cb)cb();}catch(ce){console.error('[showRev.cb]',ce);}
      return;
    }
    q('rev-st').textContent=stars;q('rev-cm').textContent=comment;
    q('rev-ef').innerHTML='<span style="color:var(--ok)">+'+fY(earned)+'</span>　<span style="color:var(--t3)">'+esc(typeLb)+'案件完了</span>';
    q('modal-rev').classList.add('open');G.revCb=cb;
    q('btn-ok-rev').onclick=function(){q('modal-rev').classList.remove('open');SFX.coin();if(G.revCb){G.revCb();G.revCb=null;}};
  },

  // ─ HUD ─
  updateHUD:function(){
    q('hco').textContent=G.s.compName||'個人事務所';
    var m=G.s.money,hm=q('hmoney');hm.textContent=fY(m).replace('円','');hm.className='hs-v g'+(m<100000?' blink':'');
    q('hrep').textContent=G.s.rep;
    var hf=q('hfire');hf.textContent=G.s.fire;hf.className='hs-v r'+(G.s.fire>=40?' blink':'');
    q('hsns').textContent=fM(G.s.sns);q('hstaff').textContent=G.s.staff.length;q('hblack').textContent=G.s.black;
    var wbEl=q('hwb');if(wbEl){var wbv=G.s.wb||50;wbEl.textContent=wbv;wbEl.style.color=wbv>=70?'var(--ok)':wbv>=40?'var(--acc)':'var(--red)';}
    q('hph').textContent='PHASE '+G.s.phase;
    // 作品集バッジ
    var pb2=q('bdg-portfolio');if(pb2&&G.s.portfolio&&G.s.portfolio.length>0){pb2.style.display='inline';pb2.textContent=G.s.portfolio.length;}
    q('olb').textContent=OFF_LB[G.s.offLevel];
    // 年月日計算: 2025年4月スタート / 1週=7日
    var startY=2025, startM=4;
    var totalWeeks=G.s.turn-1;
    var totalMonths=Math.floor(totalWeeks/4);
    var weekInMonth=(totalWeeks%4)+1;
    var absMonth=startM-1+totalMonths;
    var dispY=startY+Math.floor(absMonth/12);
    var dispM=(absMonth%12)+1;
    var jpM=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
    var dm=q('hdate-main'); if(dm)dm.textContent=dispY+'年'+jpM[dispM-1];
    var dd=q('hdate-day'); if(dd)dd.textContent='第'+weekInMonth+'週';
    var fw=q('wb-fire');if(fw)fw.style.display=G.s.fire>=35?'block':'none';
    var mw=q('wb-money');if(mw)mw.style.display=(G.s.money<200000&&G.s.money>=0)?'block':'none';
    var bp=q('bdg-proj');if(bp)bp.textContent=G.s.avail.length;
    var mbp=q('mbdg-proj');if(mbp){var cnt=G.s.avail.length;mbp.style.display=cnt>0?'flex':'none';mbp.textContent=cnt;}
    var phN=['個人事務所','デザイン事務所','デザインスタジオ','デザイン会社','プロダクト企業','プラットフォーム企業','テックジャイアント'];
    var hdau=q('hdau-wrap');if(hdau)hdau.style.display=G.s.phase>=4?'flex':'none';
    var harr=q('harr-wrap');if(harr)harr.style.display=G.s.phase>=4?'flex':'none';
    if(G.s.phase>=4){var dv=q('hdau');if(dv)dv.textContent=(G.s.dau||0)>=10000?Math.round((G.s.dau||0)/10000)+'万':(G.s.dau||0).toLocaleString();var av=q('harr');if(av)av.textContent=(G.s.arr||0)>=100000000?Math.round((G.s.arr||0)/100000000)+'億':(G.s.arr||0)>=10000?Math.round((G.s.arr||0)/10000)+'万':'--';}
    var ti=q('tinfo');if(ti){var wInM=(G.s.turn%4||4);var remW=4-wInM;
    var prodInfo=G.s.phase>=4?' ／ DAU '+((G.s.dau||0)>=10000?Math.round((G.s.dau||0)/10000)+'万':(G.s.dau||0).toLocaleString()):'';
  if(G.aiMode){
    ti.innerHTML='<b>'+dispY+'年'+jpM[dispM-1]+'・第'+weekInMonth+'週</b> ／ '+phN[Math.min(G.s.phase,6)]+prodInfo+'<br><span class="hint" style="color:#6366f1;font-weight:600">🤖 AI AGENT が全経営を管理中 ─ あなたは見ているだけでOK</span>';
  } else {
    // 次のフェーズ目標をヒントに表示
    var ph2=G.s.phase;
    var nextGoal='';
    if(ph2===0)nextGoal='次：累計500万円 + 2名採用 → 事務所開設';
    else if(ph2===1)nextGoal='次：累計3000万円 + 6名 → スタジオ昇格';
    else if(ph2===2)nextGoal='次：累計3億円 + 15名 → デザイン会社';
    else if(ph2===3)nextGoal='次：product_mgmt習得 + 累計10億円 + 15名 → プロダクト企業';
    else if(ph2===4)nextGoal='次：platform_biz習得 + DAU100万 + 累計100億円 → プラットフォーム';
    else if(ph2===5)nextGoal='次：global_expand習得 + DAU1000万 + 累計500億円 → テックジャイアント';
    else nextGoal='🏆 テックジャイアント達成！';
    ti.innerHTML='<b>'+dispY+'年'+jpM[dispM-1]+'・第'+weekInMonth+'週</b> ／ '+phN[Math.min(G.s.phase,6)]+prodInfo+'<br><span class="hint">月次コスト あと'+remW+'週 ／ 案件'+G.s.avail.length+'件 ／ '+nextGoal+'</span>';
  }}
  },

  // ─ TAB ─
  // ━━━ モバイル専用メソッド ━━━
  mobToggleOffice:function(){
    var w=q('owrap');if(!w)return;
    var tog=q('mob-office-toggle');
    var togIc=q('mob-office-toggle-ic');
    var togTxt=q('mob-office-toggle-txt');
    var isOpen=w.classList.toggle('mob-open');
    tog.classList.toggle('open',isOpen);
    if(togIc)togIc.textContent=isOpen?'✕':'🏢';
    if(togTxt)togTxt.textContent=isOpen?'オフィスを閉じる':'オフィスを見る';
    if(isOpen){
      // 保存済み高さをstyle.heightで直接復元（CSS変数不要）
      var h=G._savedMobOfficeH||240;
      w.style.height=h+'px';
      setTimeout(function(){G.resizeOC&&G.resizeOC();G.renderOffice&&G.renderOffice();},30);
    }else{
      w.style.height='0px';
    }
  },
  setMobOfficeH:function(h){
    var w=q('owrap');if(!w)return;
    w.style.height=h+'px';
    G._savedMobOfficeH=h;
    localStorage.setItem('dcfk_mob_owrap_h',h);
    G.resizeOC&&G.resizeOC();
    G.renderOffice&&G.renderOffice();
  },
  mobToggleMore:function(){
    var drawer=q('mob-more-drawer');
    var overlay=q('mob-more-overlay');
    if(!drawer)return;
    var isOpen=drawer.classList.toggle('open');
    if(overlay)overlay.classList.toggle('open',isOpen);
  },
  mobCloseMore:function(){
    var drawer=q('mob-more-drawer');
    var overlay=q('mob-more-overlay');
    if(drawer)drawer.classList.remove('open');
    if(overlay)overlay.classList.remove('open');
  },

  tab:function(id){
    SFX.click();G.curTab=id;
    document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('on');});
    document.querySelectorAll('.nb').forEach(function(b){b.classList.remove('on');});
    document.querySelectorAll('.mnb').forEach(function(b){b.classList.remove('on');});
    document.querySelectorAll('.mob-drawer-item').forEach(function(b){b.classList.remove('on');});
    var pan=q('pan-'+id),nav=q('nb-'+id),mnav=q('mnb-'+id);
    if(pan)pan.classList.add('on');
    if(nav)nav.classList.add('on');
    if(mnav){mnav.classList.add('on');}
    // ドロワーアイテムもアクティブ更新
    var di=document.querySelector('.mob-drawer-item[data-tab="'+id+'"]');
    if(di)di.classList.add('on');
    // パネルスクロールをトップへ
    var panels=q('panels');if(panels)panels.scrollTop=0;
    switch(id){
      case 'dash':   G.renderDash();break;
      case 'proj':   G.renderProj();break;
      case 'active': G.renderActive();break;
      case 'staff':  G.renderStaff();break;
      case 'hire':   G.renderHire();break;
      case 'tech':   G.renderTech();break;
      case 'prog':   G.renderProg();break;
      case 'ai':     G.renderAI();break;
      case 'murmur': G.renderMurmur();break;
      case 'portfolio': G.renderPortfolio();G.aiDesign.updateKeyStatus();break;
      case 'policy':    G.renderPolicy();break;
      case 'world':
        if(G._worldMapRaf){cancelAnimationFrame(G._worldMapRaf);G._worldMapRaf=null;}
        G.renderWorld();break;
    }
  },

  renderAll:function(){
    G.updateHUD();renderLog();
    switch(G.curTab){
      case 'dash':   G.renderDash();break;
      case 'proj':   G.renderProj();break;
      case 'active': G.renderActive();break;
      case 'staff':  G.renderStaff();break;
      case 'hire':   G.renderHire();break;
      case 'tech':   G.renderTech();break;
      case 'prog':   G.renderProg();break;
      case 'ai':     G.renderAI();break;
      case 'murmur': G.renderMurmur();break;
      case 'portfolio': G.renderPortfolio();break;
      case 'policy':    G.renderPolicy();break;
      case 'world':
        if(G._worldMapRaf){cancelAnimationFrame(G._worldMapRaf);G._worldMapRaf=null;}
        G.renderWorld();break;
    }
  },

  // ─ RENDER AI ─
  renderAI:function(){
    var s=G.s;
    var atb=q('ai-toggle-big');
    if(atb){
      atb.textContent=G.aiMode?'🛑 AIモード OFF':'🤖 AIモード ON';
      atb.className='ai-toggle-big'+(G.aiMode?' on':'');
    }
    var dt=q('ai-dash-title');
    var ds=q('ai-dash-sub');
    if(G.aiMode){
      if(dt)dt.textContent='AI経営エージェント 稼働中';
      if(ds)ds.innerHTML='受注・アサイン・採用・技術習得・移転を全自動処理中。<br><strong>あなたは週を進めるだけです。</strong>';
    } else {
      if(dt)dt.textContent='AI経営エージェント';
      if(ds)ds.innerHTML='受注・アサイン・採用・技術習得・オフィス移転を<br>全自動で最適判断します。あなたは働くだけ。';
    }
    // KPI
    var totalOrders=G.aiActionLog.filter(function(l){return l.type==='order';}).length;
    var totalHires=G.aiActionLog.filter(function(l){return l.type==='hire';}).length;
    var totalTechs=G.aiActionLog.filter(function(l){return l.type==='tech';}).length;
    var totalRisks=G.aiActionLog.filter(function(l){return l.type==='risk';}).length;
    var avgMental=s.staff.length>0?Math.round(s.staff.reduce(function(a,st){return a+st.mental;},0)/s.staff.length):0;
    var kpis=[
      {l:'自動受注数',v:totalOrders+'件',d:'累計'},
      {l:'自動採用数',v:totalHires+'名',d:'累計'},
      {l:'技術習得',v:totalTechs+'件',d:'累計'},
      {l:'炎上対策',v:totalRisks+'回',d:'累計'},
      {l:'現在の資金',v:fY(s.money).replace('円',''),d:''},
      {l:'平均メンタル',v:avgMental,d:avgMental>=70?'😊 良好':avgMental>=45?'😐 普通':'😰 危険'},
    ];
    var kg=q('ai-kpi-grid');
    if(kg){
      kg.innerHTML=kpis.map(function(k){
        return '<div class="ai-kpi"><div class="ai-kpi-l">'+esc(k.l)+'</div><div class="ai-kpi-v">'+esc(k.v)+'</div><div class="ai-kpi-d">'+esc(k.d)+'</div></div>';
      }).join('');
    }
    // アクションログ
    var lp=q('ai-action-log');
    var lc=q('ai-log-cnt');
    if(lp){
      if(G.aiActionLog.length===0){
        lp.innerHTML='<div class="empty">AIモードをONにするとここに経営判断が記録されます</div>';
      } else {
        var typeMap={'order':'受注','hire':'採用','tech':'技術','risk':'炎上対策','assign':'配置','other':'その他'};
        var rows=G.aiActionLog.slice().reverse().slice(0,50).map(function(lg){
          return '<div class="ai-log-row"><span class="ai-log-turn">W'+lg.turn+'</span><span class="ai-log-action">'+esc(lg.msg)+'</span><span class="ai-log-type '+lg.type+'">'+esc(typeMap[lg.type]||'その他')+'</span></div>';
        }).join('');
        lp.innerHTML=rows;
        if(lc)lc.textContent=G.aiActionLog.length+'件';
      }
    }
  },

  // ─ RENDER DASH ─
  renderDash:function(){
    var avgM=G.s.staff.length>0?Math.round(G.s.staff.reduce(function(a,s){return a+s.mental;},0)/G.s.staff.length):0;
    var stats=[
      {l:'評　判',v:G.s.rep,mx:100,c:'var(--teal)'},
      {l:'炎上率',v:G.s.fire,mx:100,c:'var(--red)'},
      {l:'SNSフォロワー',v:G.s.sns,mx:Math.max(10000,G.s.sns),c:'var(--acc2)'},
      {l:'社員メンタル平均',v:avgM,mx:100,c:avgM<40?'var(--red)':'var(--ok)'},
      {l:'累計収益',v:G.s.totalRev,mx:Math.max(100000000,G.s.totalRev),c:'var(--gold)',fmt:'Y'},
      {l:'ブラック度',v:G.s.black,mx:100,c:'var(--warn)'},
    ];
    var h='';stats.forEach(function(s){h+='<div class="dc"><div class="dc-l">'+s.l+'</div><div class="dc-v" style="color:'+s.c+'">'+(s.fmt==='Y'?fY(s.v):s.v.toLocaleString())+'</div><div class="dc-b"><div class="dc-bf" style="width:'+Math.min(100,s.v/s.mx*100)+'%;background:'+s.c+'"></div></div></div>';});
    q('dgrid').innerHTML=h;
    var cnt=q('dash-cnt');if(cnt)cnt.textContent=G.s.actives.length+'件';
    var el=q('dash-ap');if(!el)return;
    if(!G.s.actives.length){el.innerHTML='<div class="empty">進行中の案件なし。<br>案件受注タブから受注してください。</div>';return;}
    el.innerHTML=G.s.actives.map(function(p){return G.buildAP(p,true);}).join('');
    renderLog();
  },

  // ─ RENDER PROJ ─
  renderProj:function(){
    var hint=q('proj-hint');if(hint)hint.textContent='次の更新まで'+(4-(G.s.turn%4||4))+'週';
    var el=q('proj-list');if(!el)return;
    if(!G.s.avail.length){el.innerHTML='<div class="empty">受注可能な案件なし。<br>「次の週へ」で新案件が届きます。</div>';return;}
    var mx=Math.max(2,G.s.staff.length);
    el.innerHTML=G.s.avail.map(function(p){
      return '<div class="pc"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span class="ptype '+p.tcss+'">'+p.tic+' '+p.tlb+'</span><span class="pst">'+'★'.repeat(p.diff)+'☆'.repeat(5-p.diff)+'</span></div>'
        +'<div class="pn">'+esc(p.nm)+'</div>'
        +'<div class="cli '+p.cli.cls+'">'+p.cli.ic+' '+p.cli.lb+'</div>'
        +'<div class="pm"><span>修正リスク:'+p.cli.mr+'%</span><span>難易度:'+p.diff+'</span><span>〆'+p.dead+'週</span></div>'
        +'<div class="pdesc">「'+p.cli.desc+'」</div>'
        +'<div class="pf"><span class="ppr">'+fY(p.price)+'</span>'
        +'<span class="pdl'+(p.urg?' urg':'')+'">'+( p.urg?'⚡緊急 ':'')+p.dead+'週</span>'
        +'<button class="btn-acc" '+(G.s.actives.length>=mx?'disabled':'')+' onclick="G.accept(\''+p.id+'\')">受注する</button></div></div>';
    }).join('');
  },

  // ─ RENDER ACTIVE ─
  renderActive:function(){
    var el=q('active-list');if(!el)return;
    if(!G.s.actives.length){el.innerHTML='<div class="empty">進行中の案件なし。<br>案件受注タブから受注してください。</div>';return;}
    el.innerHTML=G.s.actives.map(function(p){return G.buildAP(p,false);}).join('');
  },

  buildAP:function(p,compact){
    var assigned=p.asgn?G.s.staff.find(function(s){return s.id===p.asgn;}):null;
    var spd=G.projSpeed(p),left=spd>0?Math.ceil((100-p.prog)/spd):99;
    var html='<div class="ap"><div class="ap-h"><div><span class="ptype '+p.tcss+'" style="font-size:6px;padding:1px 4px">'+p.tic+' '+p.tlb+'</span><div class="ap-n" style="margin-top:3px">'+esc(p.nm)+'</div></div><div style="text-align:right"><div class="ap-pct">'+p.prog+'%</div><div style="font-size:7px;color:var(--t3)">残約'+left+'週</div></div></div>'
      +'<div class="ap-m"><span>'+p.cli.ic+' '+p.cli.lb+'</span><span>'+fY(p.price)+'</span>'+(assigned?'<span>👤 '+assigned.nm+'</span>':'<span style="color:var(--warn)">⚠ 未アサイン</span>')+'<span>修正'+( p.modCnt||0)+'回</span></div>'
      +'<div class="apbar"><div class="apbf" style="width:'+p.prog+'%"></div></div>';
    if(!compact){
      var idle=G.s.staff.filter(function(s){return s.status==='idle'||s.id===p.asgn;});
      var chips=idle.map(function(s){var cur=p.asgn===s.id;var busy=s.status==='working'&&!cur;return'<button class="ach'+(cur?' sel':'')+(busy?' bsy':'')+'" onclick="G.assign(\''+p.id+'\',\''+s.id+'\')">'+s.ic+' '+s.nm+'</button>';}).join('');
      var unBtn=assigned?'<button class="ach" style="color:var(--red)" onclick="G.unassign(\''+p.id+'\')">✕ 解除</button>':'';
      html+='<div class="apass"><span class="apal">アサイン：</span>'+chips+unBtn+'</div>';
    }
    html+='</div>';return html;
  },

  // ─ FACE AVATAR GENERATOR ─
  faceCache:{},
  genFaceDataURL:function(nm,idx,mental){
    if(!nm)nm='';
    mental=mental===undefined?100:mental;
    var ckey=nm+'_'+idx+'_'+Math.floor(mental/20); // 20%刻みでキャッシュ
    if(G.faceCache[ckey])return G.faceCache[ckey];
    // Deterministic seed from name
    var seed=0;for(var i=0;i<nm.length;i++)seed=(seed*31+nm.charCodeAt(i))>>>0;
    seed^=(idx*7919);
    var rng=function(n){seed=(seed*1664525+1013904223)>>>0;return seed%n;};
    var SIZE=64;
    var cv2=document.createElement('canvas');cv2.width=SIZE;cv2.height=SIZE;
    var c=cv2.getContext('2d');
    // ─ Palettes ─
    var SKIN_COLS=['#fde8c8','#f0c898','#e0a870','#c88850','#a06030','#80501a'];
    var HAIR_COLS=['#1a0a02','#3a1e08','#c8a030','#d08020','#3a2860','#182840','#601818','#f0a0a0','#40b888','#808090'];
    var EYE_COLS=['#2a1a08','#183020','#18184a','#481818','#184848'];
    var SHIRT_COLS=['#4a5ad0','#2a9050','#b03050','#c09010','#5050a0','#c05020','#30a0b0','#7040a0','#208070','#a04080'];
    var skin=SKIN_COLS[rng(SKIN_COLS.length)];
    var hair=HAIR_COLS[rng(HAIR_COLS.length)];
    var eyes=EYE_COLS[rng(EYE_COLS.length)];
    var shirt=SHIRT_COLS[rng(SHIRT_COLS.length)];
    var hairStyle=rng(6); // 0=short, 1=medium, 2=long, 3=bun, 4=fade, 5=curly
    var glasses=rng(5)===0; // 20% chance
    var hasBlush=rng(4)===0;
    var isTired=mental<35;
    var isHappy=mental>=70;
    var hasTie=rng(4)===0;
    var hasHoops=rng(5)===0; // earrings

    c.fillStyle='transparent';

    // Body / shirt gradient
    var shirtGrad=c.createLinearGradient(0,36,0,64);
    shirtGrad.addColorStop(0,shirt);
    shirtGrad.addColorStop(1,shirt.replace(/([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})/i,function(m,r,g,b){
      return Math.max(0,parseInt(r,16)-20).toString(16).padStart(2,'0')+
             Math.max(0,parseInt(g,16)-20).toString(16).padStart(2,'0')+
             Math.max(0,parseInt(b,16)-20).toString(16).padStart(2,'0');
    }));
    c.fillStyle=shirtGrad;
    c.beginPath();c.ellipse(SIZE/2,SIZE+4,22,18,0,0,Math.PI*2);c.fill();
    c.fillStyle=shirtGrad;
    c.fillRect(10,40,44,SIZE);

    // Collar
    c.fillStyle='rgba(255,255,255,0.2)';
    c.beginPath();
    c.moveTo(SIZE/2-6,40);c.lineTo(SIZE/2,46);c.lineTo(SIZE/2+6,40);
    c.closePath();c.fill();
    if(hasTie){
      var tieG=c.createLinearGradient(SIZE/2-3,40,SIZE/2+3,60);
      tieG.addColorStop(0,'#c82020');tieG.addColorStop(1,'#801010');
      c.fillStyle=tieG;
      c.beginPath();c.moveTo(SIZE/2-3,40);c.lineTo(SIZE/2,58);c.lineTo(SIZE/2+3,40);c.closePath();c.fill();
    }

    // Neck
    c.fillStyle=skin;
    c.beginPath();c.ellipse(SIZE/2,38,7,8,0,0,Math.PI*2);c.fill();

    // Head - more rounded
    c.fillStyle=skin;
    c.beginPath();c.ellipse(SIZE/2,23,15,17,0,0,Math.PI*2);c.fill();
    // Head shadow
    c.fillStyle='rgba(0,0,0,0.07)';
    c.beginPath();c.ellipse(SIZE/2,26,13,10,0,0,Math.PI*2);c.fill();

    // Ears
    c.fillStyle=skin;
    c.beginPath();c.ellipse(SIZE/2-15,24,4,5,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(SIZE/2+15,24,4,5,0,0,Math.PI*2);c.fill();
    // Ear shadow
    c.fillStyle='rgba(0,0,0,0.1)';
    c.beginPath();c.ellipse(SIZE/2-14,24,2.5,3.5,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(SIZE/2+14,24,2.5,3.5,0,0,Math.PI*2);c.fill();
    // Earrings
    if(hasHoops){
      c.strokeStyle='#c8a020';c.lineWidth=1.5;
      c.beginPath();c.arc(SIZE/2-15,27,3,0,Math.PI*2);c.stroke();
      c.beginPath();c.arc(SIZE/2+15,27,3,0,Math.PI*2);c.stroke();
    }

    // Hair - multiple styles
    c.fillStyle=hair;
    c.beginPath();c.ellipse(SIZE/2,16,15,12,0,Math.PI,Math.PI*2);c.fill();
    if(hairStyle===0){// short undercut
      c.fillRect(SIZE/2-15,10,30,10);
      c.beginPath();c.arc(SIZE/2,11,15,Math.PI,0);c.fill();
    }else if(hairStyle===1){// medium sides
      c.fillRect(SIZE/2-16,10,32,10);
      c.fillRect(SIZE/2-16,10,6,16);
      c.fillRect(SIZE/2+10,10,6,16);
      c.beginPath();c.arc(SIZE/2,11,16,Math.PI,0);c.fill();
    }else if(hairStyle===2){// long
      c.fillRect(SIZE/2-16,10,32,10);
      c.fillRect(SIZE/2-16,10,5,26);
      c.fillRect(SIZE/2+11,10,5,26);
      c.beginPath();c.arc(SIZE/2,11,16,Math.PI,0);c.fill();
      c.beginPath();c.ellipse(SIZE/2-14,28,4,10,0.2,0,Math.PI*2);c.fill();
      c.beginPath();c.ellipse(SIZE/2+14,28,4,10,-0.2,0,Math.PI*2);c.fill();
    }else if(hairStyle===3){// bun
      c.fillRect(SIZE/2-15,10,30,8);
      c.beginPath();c.arc(SIZE/2,10,15,Math.PI,0);c.fill();
      c.beginPath();c.arc(SIZE/2,8,7,0,Math.PI*2);c.fill();
      // bun highlight
      c.fillStyle='rgba(255,255,255,0.2)';
      c.beginPath();c.arc(SIZE/2-2,6,3,0,Math.PI*2);c.fill();
      c.fillStyle=hair;
    }else if(hairStyle===4){// fade/shaved sides
      c.fillRect(SIZE/2-10,9,20,12);
      c.beginPath();c.arc(SIZE/2,10,10,Math.PI,0);c.fill();
      c.fillStyle=hair+'88';// lighter fade sides
      c.fillRect(SIZE/2-16,12,8,8);
      c.fillRect(SIZE/2+8,12,8,8);
    }else{// curly
      c.fillRect(SIZE/2-15,10,30,8);
      c.beginPath();c.arc(SIZE/2,11,15,Math.PI,0);c.fill();
      // curly bumps
      for(var ci=0;ci<5;ci++){
        c.beginPath();c.arc(SIZE/2-12+ci*6,10,4,0,Math.PI*2);c.fill();
      }
    }
    // Hair highlight
    c.fillStyle='rgba(255,255,255,0.15)';
    c.beginPath();c.ellipse(SIZE/2-3,13,6,4,-0.3,0,Math.PI*2);c.fill();

    // Eyebrows
    var browY=18;
    var browThick=isTired?2.5:1.8;
    c.strokeStyle=hair;c.lineWidth=browThick;c.lineCap='round';
    if(isTired){// furrowed brows
      c.beginPath();c.moveTo(SIZE/2-10,browY+1);c.lineTo(SIZE/2-4,browY);c.stroke();
      c.beginPath();c.moveTo(SIZE/2+4,browY);c.lineTo(SIZE/2+10,browY+1);c.stroke();
    } else if(isHappy){// raised happy brows
      c.beginPath();c.moveTo(SIZE/2-10,browY-1);c.bezierCurveTo(SIZE/2-7,browY-3,SIZE/2-4,browY-3,SIZE/2-3,browY-1);c.stroke();
      c.beginPath();c.moveTo(SIZE/2+3,browY-1);c.bezierCurveTo(SIZE/2+4,browY-3,SIZE/2+7,browY-3,SIZE/2+10,browY-1);c.stroke();
    } else {
      c.beginPath();c.moveTo(SIZE/2-10,browY);c.lineTo(SIZE/2-3,browY-1);c.stroke();
      c.beginPath();c.moveTo(SIZE/2+3,browY-1);c.lineTo(SIZE/2+10,browY);c.stroke();
    }

    // Eyes with proper whites
    var eyeY=22;
    [[SIZE/2-7,eyeY],[SIZE/2+7,eyeY]].forEach(function(ep){
      // White
      c.fillStyle='#fff';
      c.beginPath();c.ellipse(ep[0],ep[1],5,4,0,0,Math.PI*2);c.fill();
      // Iris
      c.fillStyle=eyes;
      c.beginPath();c.arc(ep[0],ep[1]+(isTired?1:0),3,0,Math.PI*2);c.fill();
      // Pupil
      c.fillStyle='rgba(0,0,0,0.8)';
      c.beginPath();c.arc(ep[0],ep[1]+(isTired?1:0),1.5,0,Math.PI*2);c.fill();
      // Shine
      c.fillStyle='rgba(255,255,255,0.9)';
      c.beginPath();c.arc(ep[0]+1,ep[1]+(isTired?1:0)-1.5,0.9,0,Math.PI*2);c.fill();
      // Tired half-lids
      if(isTired){
        c.fillStyle=skin;
        c.beginPath();c.ellipse(ep[0],ep[1]-2,5,3,0,0,Math.PI*2);c.fill();
      }
    });

    // Nose
    var noseShadow=skin==='#fde8c8'?'rgba(210,140,90,.35)':'rgba(140,80,30,.3)';
    c.strokeStyle=noseShadow;c.lineWidth=1.2;c.lineCap='round';
    c.beginPath();c.moveTo(SIZE/2-2,26);c.lineTo(SIZE/2-3,29);c.lineTo(SIZE/2+3,29);c.stroke();
    c.beginPath();c.arc(SIZE/2,29,3,0.1,Math.PI-0.1);c.stroke();

    // Mouth
    var mouthY=34;
    c.lineWidth=1.8;c.lineCap='round';
    if(isTired){
      c.strokeStyle='rgba(160,80,80,.7)';
      c.beginPath();c.arc(SIZE/2,mouthY+1,3,-Math.PI*0.7,-Math.PI*0.3,true);c.stroke();
    } else if(isHappy){
      c.strokeStyle='rgba(160,80,80,.7)';
      c.beginPath();c.arc(SIZE/2,mouthY-2,4.5,0.1,Math.PI-0.1);c.stroke();
      // teeth
      c.fillStyle='rgba(255,255,255,0.6)';
      c.beginPath();c.arc(SIZE/2,mouthY-0.5,3.5,0.15,Math.PI-0.15);c.fill();
    } else {
      c.strokeStyle='rgba(160,80,80,.65)';
      c.beginPath();c.arc(SIZE/2,mouthY-1,3,0.15,Math.PI-0.15);c.stroke();
    }

    // Blush
    if(hasBlush||isHappy){
      c.fillStyle=isHappy?'rgba(255,120,140,.22)':'rgba(255,150,150,.18)';
      c.beginPath();c.ellipse(SIZE/2-12,28,6,3.5,0,0,Math.PI*2);c.fill();
      c.beginPath();c.ellipse(SIZE/2+12,28,6,3.5,0,0,Math.PI*2);c.fill();
    }

    // Glasses
    if(glasses){
      c.strokeStyle='rgba(40,40,80,.65)';c.lineWidth=1.5;
      c.beginPath();c.roundRect(SIZE/2-13,18,11,9,2);c.stroke();
      c.beginPath();c.roundRect(SIZE/2+2,18,11,9,2);c.stroke();
      c.beginPath();c.moveTo(SIZE/2-2,22.5);c.lineTo(SIZE/2+2,22.5);c.stroke();
      // temples
      c.beginPath();c.moveTo(SIZE/2-13,21);c.lineTo(SIZE/2-17,19);c.stroke();
      c.beginPath();c.moveTo(SIZE/2+13,21);c.lineTo(SIZE/2+17,19);c.stroke();
    }

    // zzz badge if very tired
    if(isTired){
      c.fillStyle='rgba(239,68,68,.1)';
      c.beginPath();c.roundRect(SIZE/2+10,2,18,14,6);c.fill();
      c.fillStyle='rgba(239,68,68,.85)';
      c.font='7px sans-serif';c.fillText('💤',SIZE/2+12,13);
    }

    // Clip to circle
    var cv3=document.createElement('canvas');cv3.width=SIZE;cv3.height=SIZE;
    var c3=cv3.getContext('2d');
    c3.beginPath();c3.arc(SIZE/2,SIZE/2,SIZE/2-1,0,Math.PI*2);c3.clip();
    c3.drawImage(cv2,0,0);
    // subtle border
    c3.strokeStyle='rgba(0,0,0,0.08)';c3.lineWidth=1;
    c3.beginPath();c3.arc(SIZE/2,SIZE/2,SIZE/2-1,0,Math.PI*2);c3.stroke();
    var url=cv3.toDataURL();
    G.faceCache[ckey]=url;
    return url;
  },
  // ─ TRAIN STAFF ─
  trainStaff:function(staffId,topicId){
    var s=G.s.staff.find(function(x){return x.id===staffId;});
    if(!s){notify('社員が見つかりません','warn');return;}
    var topic=TRAIN_TOPICS.find(function(t){return t.id===topicId;});
    if(!topic){notify('学習トピックが見つかりません','warn');return;}
    // Already trained?
    if((s.trainData||[]).some(function(td){return td.topicId===topicId;})){
      notify('「'+topic.nm+'」は既に学習済みです','warn');return;
    }
    if(G.s.money<topic.cost){notify('資金不足！必要：'+fY(topic.cost),'danger');return;}
    G.s.money-=topic.cost;
    // Apply bonus
    var statKey=topic.stat==='design'?'design':topic.stat==='ui'?'ui':topic.stat==='speed'?'speed':topic.stat==='logic'?'logic':'comm';
    var old=s.stats[statKey]||0;
    s.stats[statKey]=Math.min(99,old+topic.bonus);
    if(!s.trainData)s.trainData=[];
    s.trainData.push({topicId:topicId,nm:topic.nm,stat:statKey,bonus:topic.bonus,completedAt:G.s.turn});
    addLog(s.nm+'が「'+topic.nm+'」を習得！'+statKey+' +'+topic.bonus,'good');
    notify('📚 '+s.nm+'「'+topic.nm+'」習得！'+fY(topic.cost),'ok');
    SFX.good();
    G.closeModal('modal-train');
    G.updateHUD();G.renderAll();
  },

  openTrainModal:function(staffId){
    var s=G.s.staff.find(function(x){return x.id===staffId;});
    if(!s)return;
    var stats=s.stats;
    var statNames={design:'デザイン',ui:'UI力',speed:'スピード',logic:'ロジック',comm:'コミュ力'};
    var statKeys=['design','ui','speed','logic','comm'];
    var minStat=statKeys.reduce(function(mn,k){return stats[k]<stats[mn]?k:mn;},statKeys[0]);

    // MBTI-based recommended stats
    var mbtiData=s.mbti?MBTI_TYPES[s.mbti]:null;
    var mbtiRecStats=[];
    if(s.mbti){
      var m=s.mbti;
      if(m.indexOf('N')>=0)mbtiRecStats.push('design','ui');
      if(m.indexOf('T')>=0)mbtiRecStats.push('logic');
      if(m.indexOf('E')>=0)mbtiRecStats.push('comm');
      if(m.indexOf('P')>=0)mbtiRecStats.push('speed');
      if(m.indexOf('J')>=0){mbtiRecStats.push('logic');mbtiRecStats.push('design');}
    }

    var availTopics=TRAIN_TOPICS.filter(function(t){
      return !(s.trainData||[]).some(function(td){return td.topicId===t.id;});
    });
    availTopics.sort(function(a,b){return (stats[a.stat]||50)-(stats[b.stat]||50);});

    // ─ Header with face + MBTI ─
    var faceUrl=(!s.isRobot&&!s.isAnimal)?G.genFaceDataURL(s.nm,G.s.staff.indexOf(s),s.mental):'';
    var html='<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">'
      +(faceUrl?'<img src="'+faceUrl+'" style="width:52px;height:52px;border-radius:50%;border:2px solid var(--bord2);flex-shrink:0">':'<div style="font-size:28px">'+s.ic+'</div>')
      +'<div><div style="font-size:13px;font-weight:700;color:var(--t1)">'+esc(s.nm)+'</div>'
      +'<div style="font-size:11px;color:var(--t3)">'+esc(s.role)+'</div>'
      +(mbtiData?'<div style="margin-top:4px"><span style="font-size:9px;padding:2px 7px;border-radius:99px;background:'+mbtiData.bg+';color:'+mbtiData.col+';font-weight:700;border:1px solid '+mbtiData.col+'22">'+mbtiData.emoji+' '+mbtiData.en+' '+mbtiData.nm+'</span></div>':'')
      +'</div></div>';

    // ─ Radar-style skill chart (canvas) ─
    html+='<div style="display:flex;gap:12px;margin-bottom:14px;align-items:center">';
    html+='<canvas id="train-radar" width="110" height="110" style="flex-shrink:0"></canvas>';
    html+='<div style="flex:1">';
    statKeys.forEach(function(k){
      var v=stats[k]||0;
      var col=v<50?'var(--red)':v<70?'var(--warn)':'var(--ok)';
      var isMin=k===minStat;
      var isMbtiRec=mbtiRecStats.indexOf(k)>=0;
      html+='<div style="margin-bottom:5px">';
      html+='<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px">';
      html+='<span style="color:var(--t2)">'+(isMin?'📍 ':'')+(isMbtiRec?'⚡ ':'')+statNames[k]+'</span>';
      html+='<b style="color:'+col+'">'+v+'</b>';
      html+='</div>';
      html+='<div style="height:6px;background:var(--bg3);border-radius:3px;overflow:hidden">';
      html+='<div style="width:'+v+'%;height:100%;background:'+col+';border-radius:3px;transition:width .4s"></div>';
      html+='</div></div>';
    });
    html+='</div></div>';

    // ─ MBTI personality card ─
    if(mbtiData){
      html+='<div style="border:1px solid '+mbtiData.col+'33;border-radius:var(--r-lg);padding:10px 12px;background:'+mbtiData.bg+';margin-bottom:12px">';
      html+='<div style="font-size:10.5px;font-weight:700;color:'+mbtiData.col+';margin-bottom:4px">'+mbtiData.emoji+' '+mbtiData.nm+'（'+mbtiData.en+'）の学習スタイル</div>';
      html+='<div style="font-size:10px;color:var(--t2);line-height:1.6">'+esc(mbtiData.desc)+'</div>';
      html+='<div style="font-size:9.5px;color:'+mbtiData.col+';margin-top:5px;font-weight:600">得意分野: '+mbtiData.trait+'</div>';
      if(mbtiRecStats.length){
        html+='<div style="font-size:9px;color:var(--t3);margin-top:3px">⚡ この性格タイプへの推奨強化: '+mbtiRecStats.filter(function(v,i,a){return a.indexOf(v)===i;}).map(function(k){return statNames[k];}).join(' / ')+'</div>';
      }
      html+='</div>';
    }

    // ─ Already trained ─
    if((s.trainData||[]).length>0){
      html+='<div style="margin-bottom:10px"><div style="font-size:10px;color:var(--t3);margin-bottom:5px;font-weight:600">✅ 習得済みスキル</div>';
      html+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
      html+=s.trainData.map(function(td){
        return'<span style="font-size:9px;padding:2px 8px;border-radius:99px;background:var(--bg3);color:var(--t2);border:1px solid var(--bord2)">📚 '+td.nm+' <span style="color:var(--ok)">+'+td.bonus+'</span></span>';
      }).join('');
      html+='</div></div>';
    }

    // ─ Training menu ─
    html+='<div style="font-size:11px;font-weight:700;margin-bottom:8px;color:var(--t1);letter-spacing:.3px">📋 トレーニングメニュー</div>';
    html+='<div style="display:flex;flex-direction:column;gap:6px">';
    availTopics.forEach(function(t){
      var canAff=G.s.money>=t.cost;
      var currStat=stats[t.stat]||0;
      var newStat=Math.min(99,currStat+t.bonus);
      var isGap=currStat<60;
      var isMbtiRec=mbtiRecStats.indexOf(t.stat)>=0;
      var isTop=isGap||isMbtiRec;
      html+='<div style="border:1px solid '+(isTop?'rgba(99,102,241,.35)':'var(--bord)')+';border-radius:var(--r);padding:10px 12px;background:'+(isTop?'rgba(99,102,241,.03)':'var(--bg1)')+'">';
      html+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">';
      html+='<div style="display:flex;align-items:center;gap:6px"><span style="font-size:16px">'+t.ic+'</span>';
      html+='<div><b style="font-size:11.5px">'+esc(t.nm)+'</b>';
      html+=(isGap?'<span style="font-size:8.5px;background:rgba(99,102,241,.12);color:var(--acc);padding:1px 6px;border-radius:99px;margin-left:5px;font-weight:700">📍 GAP</span>':'');
      html+=(isMbtiRec?'<span style="font-size:8.5px;background:rgba(234,179,8,.12);color:#b45309;padding:1px 6px;border-radius:99px;margin-left:4px;font-weight:700">⚡ 適性</span>':'');
      html+='</div></div>';
      html+='<span style="font-size:10.5px;color:var(--t3);white-space:nowrap">'+fY(t.cost)+'</span></div>';
      html+='<div style="font-size:10px;color:var(--t3);margin-bottom:7px;line-height:1.5">'+esc(t.desc)+'</div>';
      // Before→After bar
      html+='<div style="margin-bottom:7px">';
      html+='<div style="height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;margin-bottom:2px">';
      html+='<div style="width:'+currStat+'%;height:100%;background:var(--bord2);border-radius:3px"></div></div>';
      html+='<div style="height:5px;background:var(--bg3);border-radius:3px;overflow:hidden">';
      html+='<div style="width:'+newStat+'%;height:100%;background:var(--ok);border-radius:3px"></div></div>';
      html+='<div style="font-size:9.5px;color:var(--t3);margin-top:2px">'+statNames[t.stat]+' '+currStat+' → <b style="color:var(--ok)">'+newStat+'</b>（+'+t.bonus+'）</div>';
      html+='</div>';
      html+='<button onclick="G.trainStaff(\''+staffId+'\',\''+t.id+'\')" '+(canAff?'':'disabled ')+
        'style="width:100%;font-size:12px;padding:8px;font-weight:700;border-radius:var(--r);cursor:'+(canAff?'pointer':'not-allowed')+';background:'+(canAff?'var(--t1)':'var(--bg4)')+';color:'+(canAff?'#fff':'var(--t4)')+'">'+
        (canAff?'📚 学習する':'💸 資金不足')+'</button>';
      html+='</div>';
    });
    html+='</div>';
    if(availTopics.length===0)html+='<div class="empty" style="text-align:center;padding:20px">🎓 全トレーニング習得済み！</div>';

    var modalEl=document.getElementById('modal-train');
    if(!modalEl){
      modalEl=document.createElement('div');modalEl.id='modal-train';modalEl.className='mbg';
      modalEl.innerHTML='<div class="mbox" style="max-height:88vh;overflow-y:auto;padding-bottom:env(safe-area-inset-bottom,0px)"><div id="modal-train-body"></div><div class="mch-list" style="margin-top:12px"><button class="mch" onclick="G.closeModal(\'modal-train\')" style="background:var(--bg3);color:var(--t2)">閉じる</button></div></div>';
      document.body.appendChild(modalEl);
      modalEl.onclick=function(e){if(e.target===modalEl)G.closeModal('modal-train');};
    }
    document.getElementById('modal-train-body').innerHTML=html;
    modalEl.style.display='flex';

    // Draw radar chart after DOM update
    requestAnimationFrame(function(){
      var rc=document.getElementById('train-radar');
      if(!rc)return;
      var ctx2=rc.getContext('2d');
      var cx=55,cy=55,r=42;
      var n=statKeys.length;
      ctx2.clearRect(0,0,110,110);
      // Grid
      [0.25,0.5,0.75,1].forEach(function(f){
        ctx2.strokeStyle='rgba(0,0,0,0.07)';ctx2.lineWidth=1;
        ctx2.beginPath();
        for(var pi=0;pi<n;pi++){
          var a=pi*2*Math.PI/n - Math.PI/2;
          var px=cx+r*f*Math.cos(a),py=cy+r*f*Math.sin(a);
          pi===0?ctx2.moveTo(px,py):ctx2.lineTo(px,py);
        }
        ctx2.closePath();ctx2.stroke();
      });
      // Axes
      statKeys.forEach(function(k,pi){
        var a=pi*2*Math.PI/n - Math.PI/2;
        ctx2.strokeStyle='rgba(0,0,0,0.1)';ctx2.lineWidth=1;
        ctx2.beginPath();ctx2.moveTo(cx,cy);ctx2.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));ctx2.stroke();
        // Labels
        var lx=cx+(r+10)*Math.cos(a),ly=cy+(r+10)*Math.sin(a);
        ctx2.fillStyle='rgba(0,0,0,0.5)';ctx2.font='8px sans-serif';ctx2.textAlign='center';
        ctx2.fillText(statNames[k].slice(0,3),lx,ly+3);
      });
      // Filled polygon
      ctx2.beginPath();
      statKeys.forEach(function(k,pi){
        var a=pi*2*Math.PI/n - Math.PI/2;
        var v=(stats[k]||0)/100;
        var px=cx+r*v*Math.cos(a),py=cy+r*v*Math.sin(a);
        pi===0?ctx2.moveTo(px,py):ctx2.lineTo(px,py);
      });
      ctx2.closePath();
      ctx2.fillStyle='rgba(99,102,241,0.2)';ctx2.fill();
      ctx2.strokeStyle='rgba(99,102,241,0.7)';ctx2.lineWidth=1.5;ctx2.stroke();
      // Dots
      statKeys.forEach(function(k,pi){
        var a=pi*2*Math.PI/n - Math.PI/2;
        var v=(stats[k]||0)/100;
        ctx2.beginPath();ctx2.arc(cx+r*v*Math.cos(a),cy+r*v*Math.sin(a),3,0,Math.PI*2);
        ctx2.fillStyle='#6366f1';ctx2.fill();
      });
    });
  },

  closeModal:function(id){
    var el=document.getElementById(id);if(el)el.style.display='none';
  },

  // ─ RENDER STAFF ─
  renderStaff:function(){
    var mx=[4,10,16,22,200,1000,5000][Math.min(G.s.phase,6)];
    var cnt=q('staff-cnt');if(cnt)cnt.textContent=G.s.staff.length+'名 / 上限'+mx+'名';
    var el=q('staff-list');if(!el)return;
    if(!G.s.staff.length){el.innerHTML='<div class="empty">社員がいません</div>';return;}
    // 20人超えたらコンパクトグリッド表示
    if(G.s.staff.length>20){
      var avgM=Math.round(G.s.staff.reduce(function(a,s){return a+s.mental;},0)/G.s.staff.length);
      var working=G.s.staff.filter(function(s){return s.status==='working';}).length;
      var tired=G.s.staff.filter(function(s){return s.mental<30;}).length;
      var summary='<div style="background:var(--bg2);border-radius:8px;padding:10px;margin-bottom:8px;font-size:7.5px;line-height:2">'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">'
        +'<div>👥 社員数: <b>'+G.s.staff.length+'名</b></div>'
        +'<div>⚙️ 稼働中: <b>'+working+'名</b></div>'
        +'<div>😊 平均メンタル: <b>'+avgM+'</b></div>'
        +'<div>😫 疲弊中: <b style="color:var(--red)">'+tired+'名</b></div>'
        +'</div></div>';
      var grid=G.s.staff.map(function(s,i){
        var c2=s.mental<30?'var(--red)':s.status==='working'?'var(--acc)':'var(--ok)';
        var faceUrl=(!s.isRobot&&!s.isAnimal)?G.genFaceDataURL(s.nm,i,s.mental):'';
        var tip=s.nm+' '+s.role+' メンタル:'+s.mental;
        return'<div title="'+tip+'" style="display:flex;flex-direction:column;align-items:center;padding:4px;border:1px solid var(--bord2);border-radius:4px;cursor:default;gap:2px">'
          +(faceUrl?'<img src="'+faceUrl+'" style="width:30px;height:30px;border-radius:50%;object-fit:cover">':'<div style="font-size:14px">'+s.ic+'</div>')
          +'<div style="font-size:5.5px;color:var(--t2);text-align:center;max-width:36px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">'+s.nm.split(' ')[0]+'</div>'
          +'<div style="width:100%;height:3px;background:var(--bg3);border-radius:2px"><div style="width:'+s.mental+'%;height:100%;background:'+c2+';border-radius:2px"></div></div>'
          +(!s.isSelf?'<button onclick="G.fire(\''+s.id+'\')" style="font-size:5px;padding:1px 3px;background:none;border:1px solid var(--bord2);border-radius:2px;color:var(--t3);cursor:pointer">×</button>':'')
          +'</div>';
      }).join('');
      el.innerHTML=summary+'<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(44px,1fr));gap:4px">'+grid+'</div>';
      return;
    }
    el.innerHTML=G.s.staff.map(function(s,i){
      var dotC=s.mental<30?'var(--red)':s.status==='working'?'var(--acc)':'var(--ok)';
      var mCls='sbf mn'+(s.mental<40?' low':'');
      var stCls=s.mental<30?'st-tire':s.status==='working'?'st-work':'st-idle';
      var stTx=s.mental<30?'😫 疲弊中':s.status==='working'?'⚙️ 制作中':'✅ 待機中';
      var ap2=G.s.actives.find(function(p){return p.asgn===s.id;});
      // Face avatar
      var faceUrl=(!s.isRobot&&!s.isAnimal)?G.genFaceDataURL(s.nm,i,s.mental):'';
      var avatarHtml=faceUrl
        ?'<div class="sc-av" style="position:relative"><img src="'+faceUrl+'" style="width:40px;height:40px;border-radius:50%;border:2px solid var(--bord2);object-fit:cover"><div class="sc-dot" style="background:'+dotC+'"></div></div>'
        :'<div class="sc-av">'+s.ic+'<div class="sc-dot" style="background:'+dotC+'"></div></div>';
      // MBTI badge + description
      var mbtiData=s.mbti?MBTI_TYPES[s.mbti]:null;
      var mbtiBadge=mbtiData?'<span style="font-size:9px;padding:1px 6px;border-radius:99px;background:'+mbtiData.bg+';color:'+mbtiData.col+';font-weight:700;border:1px solid '+mbtiData.col+'22">'+mbtiData.emoji+' '+mbtiData.en+'</span>':'';
      var mbtiCard=mbtiData
        ?'<div style="border-left:3px solid '+mbtiData.col+';padding:5px 8px;background:'+mbtiData.bg+';border-radius:0 var(--r) var(--r) 0;margin-bottom:7px">'
          +'<div style="font-size:9.5px;font-weight:700;color:'+mbtiData.col+'">'+mbtiData.emoji+' '+mbtiData.nm+'（'+mbtiData.en+'）</div>'
          +'<div style="font-size:9px;color:var(--t2);line-height:1.5;margin-top:1px">'+mbtiData.desc+'</div>'
          +'<div style="font-size:8.5px;color:'+mbtiData.col+';margin-top:2px;font-weight:600">'+mbtiData.trait+'</div>'
        +'</div>'
        :'';
      // Training data tags
      var trainTags=(s.trainData&&s.trainData.length)?
        '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:4px">'+s.trainData.map(function(td){return'<span style="font-size:8.5px;padding:1px 6px;border-radius:99px;background:var(--acc-lt);color:var(--acc);border:1px solid rgba(99,102,241,.2)">📚'+td.nm+'<span style="opacity:.7"> +'+td.bonus+'</span></span>';}).join('')+'</div>':'';
      return'<div class="sc">'+avatarHtml
        +'<div class="sc-b"><div class="sc-n" style="display:flex;align-items:center;gap:5px;flex-wrap:wrap">'+esc(s.nm)+(s.isSelf?' <span style="font-size:7px;color:var(--t3)">(あなた)</span>':'')+mbtiBadge+'</div>'
        +'<div class="sc-r">'+esc(s.role)+(s.isSelf?'':' ／ 月給'+fY(s.sal))+'</div>'
        +mbtiCard
        +'<div class="sbars">'
        +'<div class="srow"><span class="sl">デザイン</span><div class="sb"><div class="sbf d" style="width:'+s.stats.design+'%"></div></div><span class="sn">'+s.stats.design+'</span></div>'
        +'<div class="srow"><span class="sl">スピード</span><div class="sb"><div class="sbf sp" style="width:'+s.stats.speed+'%"></div></div><span class="sn">'+s.stats.speed+'</span></div>'
        +'<div class="srow"><span class="sl">ロジック</span><div class="sb"><div class="sbf lg" style="width:'+s.stats.logic+'%"></div></div><span class="sn">'+s.stats.logic+'</span></div>'
        +'<div class="srow"><span class="sl">UI力</span><div class="sb"><div class="sbf ui" style="width:'+s.stats.ui+'%"></div></div><span class="sn">'+s.stats.ui+'</span></div>'
        +'<div class="srow"><span class="sl">コミュ力</span><div class="sb"><div class="sbf cm" style="width:'+s.stats.comm+'%"></div></div><span class="sn">'+s.stats.comm+'</span></div>'
        +'<div class="srow"><span class="sl">メンタル</span><div class="sb"><div class="'+mCls+'" style="width:'+s.mental+'%"></div></div><span class="sn">'+s.mental+'</span></div>'
        +'</div>'
        +trainTags
        +'<div class="sc-f"><span class="stbadge '+stCls+'">'+stTx+'</span>'+(ap2?'<span style="font-size:7px;color:var(--acc)">「'+ap2.nm+'」</span>':'')+(s.mental<40&&!s.isSelf?'<span style="font-size:7px;color:var(--red)">⚠ 休息が必要</span>':'')
        +(!s.isSelf?'<button style="font-size:10px;padding:4px 9px;background:var(--acc-lt);color:var(--acc);border:1px solid rgba(99,102,241,.25);border-radius:var(--r);cursor:pointer" onclick="G.openTrainModal(\''+s.id+'\')">📚 学習</button>':'')
        +(!s.isSelf?'<button class="btn-fir" onclick="G.fire(\''+s.id+'\')">解雇</button>':'')+'</div></div></div>';
    }).join('');
  },

  // ─ RENDER HIRE ─
  renderHire:function(){
    var el=q('hire-list');if(!el)return;
    // フェーズ4以上は常に補充
    if(G.s.hirePool.length<4)G.genHire();
    var mx=[4,10,16,22,200,1000,5000][Math.min(G.s.phase,6)];
    var atLimit=G.s.staff.length>=mx;
    var hdr='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 2px 8px;font-size:7.5px;color:var(--t3)">'
      +'<span>社員 '+G.s.staff.length+' / 上限 '+mx+'名</span>'
      +'<button onclick="G.genHire();G.renderHire();" style="font-size:7px;padding:3px 8px;background:var(--bg3);border:1px solid var(--bord2);border-radius:4px;cursor:pointer;color:var(--t2)">🔄 候補更新</button>'
      +'</div>';
    if(!G.s.hirePool.length){el.innerHTML=hdr+'<div class="empty">現在、採用候補がいません。<br>「候補更新」を押すか次の月次更新をお待ちください。</div>';return;}
    el.innerHTML=hdr+G.s.hirePool.map(function(h,i){
      var cost=h.sal*2,ok=G.s.money>=cost&&!atLimit;
      var riskTxt=h.risk?('<div class="hc-risk">⚠ '+esc(h.risk)+'</div>'):'';
      // 特別枠バッジ
      var specialBadge='';
      var cardExtra='';
      if(h.isRobot){
        specialBadge='<span style="font-size:8px;background:rgba(99,102,241,0.85);color:#fff;padding:2px 6px;border-radius:10px;margin-left:4px">🤖 ロボット</span>';
        cardExtra='<div style="font-size:9px;color:var(--acc);background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:4px;padding:5px 7px;margin:5px 0">疲労なし・メンタル常時100%</div>';
      }else if(h.isAnimal){
        specialBadge='<span style="font-size:8px;background:rgba(34,197,94,0.85);color:#fff;padding:2px 6px;border-radius:10px;margin-left:4px">🐾 アニマル</span>';
        cardExtra='<div style="font-size:9px;color:#22c55e;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:4px;padding:5px 7px;margin:5px 0">独自のセンスで空気を変える</div>';
      }else if(h.special){
        specialBadge='<span style="font-size:8px;background:rgba(234,179,8,0.85);color:#000;padding:2px 6px;border-radius:10px;margin-left:4px">🌟 レジェンド</span>';
      }
      var introBadge=h.intro?('<div style="font-size:9px;color:var(--t3);background:var(--bg3);border-radius:4px;padding:5px 7px;margin:5px 0;font-style:italic">'+esc(h.intro)+'</div>'):'';
      if(h.intl&&!specialBadge){specialBadge='<span style="font-size:8px;background:rgba(99,102,241,0.85);color:#fff;padding:2px 6px;border-radius:10px;margin-left:4px">🌍 GLOBAL</span>';
        cardExtra='<div style="font-size:9px;color:var(--acc);background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:4px;padding:5px 7px;margin:5px 0">グローバルスタッフ。英語OK文化でパフォーマンスUP</div>';}
      // Face avatar & MBTI
      var hFaceUrl=(!h.isRobot&&!h.isAnimal)?G.genFaceDataURL(h.nm,i):'';
      var hFaceHtml=hFaceUrl?'<img src="'+hFaceUrl+'" style="width:36px;height:36px;border-radius:50%;border:1.5px solid var(--bord2);object-fit:cover;flex-shrink:0">':'<span style="font-size:20px">'+h.ic+'</span>';
      var hMbtiData=h.mbti?MBTI_TYPES[h.mbti]:((!h.isRobot&&!h.isAnimal)?assignMBTI(h.st):null);
      var hMbtiBadge=hMbtiData?'<span style="font-size:8px;padding:1px 5px;border-radius:99px;background:'+hMbtiData.bg+';color:'+hMbtiData.col+';font-weight:700;border:1px solid '+hMbtiData.col+'22">'+hMbtiData.emoji+' '+hMbtiData.en+'</span>':'';
      return'<div class="hc" style="'+(h.special?'border-color:rgba(234,179,8,0.4);background:linear-gradient(135deg,var(--bg2),var(--bg3))':'')+(h.isRobot?'border-color:rgba(99,102,241,0.5)':'')+(h.isAnimal?'border-color:rgba(34,197,94,0.4)':'')+'"><div class="hc-h"><div style="display:flex;align-items:center;gap:8px">'+hFaceHtml+'<div><div class="hc-n">'+esc(h.nm)+specialBadge+'</div><div class="hc-ro" style="display:flex;align-items:center;gap:4px">'+esc(h.role)+(hMbtiBadge?' '+hMbtiBadge:'')+'</div></div></div><div class="hc-sl">'+fY(h.sal).replace('円','')+'<span>/月</span></div></div>'
        +introBadge
        +'<div class="sbars" style="margin-bottom:8px">'
        +'<div class="srow"><span class="sl">デザイン</span><div class="sb"><div class="sbf d" style="width:'+h.st.design+'%"></div></div><span class="sn">'+h.st.design+'</span></div>'
        +'<div class="srow"><span class="sl">スピード</span><div class="sb"><div class="sbf sp" style="width:'+h.st.speed+'%"></div></div><span class="sn">'+h.st.speed+'</span></div>'
        +'<div class="srow"><span class="sl">UI力</span><div class="sb"><div class="sbf ui" style="width:'+h.st.ui+'%"></div></div><span class="sn">'+h.st.ui+'</span></div>'
        +'<div class="srow"><span class="sl">コミュ力</span><div class="sb"><div class="sbf cm" style="width:'+h.st.comm+'%"></div></div><span class="sn">'+h.st.comm+'</span></div>'
        +'<div class="srow"><span class="sl">メンタル</span><div class="sb"><div class="sbf mn" style="width:'+h.mental+'%"></div></div><span class="sn">'+h.mental+'</span></div>'
        +'</div>'
        +cardExtra+riskTxt
        +'<div class="hc-f"><div class="hc-co">採用コスト：'+fY(cost)+'</div>'
        +'<button class="btn-hire" '+(ok?'':'disabled ')+' onclick="G.hire('+i+')">'+(atLimit?'定員満員':G.s.money<cost?'資金不足':'採用する')+'</button></div></div>';
    }).join('');
  },

  // ─ RENDER TECH ─
  renderTech:function(){
    var el=q('tech-tree');if(!el)return;
    var html='';
    TECHS.forEach(function(row){
      html+='<div class="tt-sec"><div class="sh" style="margin-bottom:8px">'+row.row+'</div><div class="tech-row">';
      row.nodes.forEach(function(n){
        var un=!!G.s.tech[n.id];
        var av=!un&&n.req.every(function(r){return G.s.tech[r];});
        var cls=un?'un':av?'av':'lk';
        var oc=av?' onclick="G.unlock(\'' +n.id+ '\')"':'';
        html+='<div class="tn '+cls+'"'+oc+'>';
        html+='<div class="tn-ic">'+n.ic+'</div>';
        html+='<div class="tn-nm">'+esc(n.nm)+'</div>';
        html+='<div class="tn-co">'+(n.cost?fY(n.cost):'無料')+'</div>';
        html+='<div class="tn-st">'+(un?'✓ 習得済み':av?'▶ 習得可能':'🔒 要前提')+'</div>';
        html+='<div class="tn-ef">'+esc(n.ef)+'</div>';
        html+='<div style="font-size:6px;color:var(--t4);margin-top:1px">'+esc(n.desc)+'</div>';
        html+='</div>';
      });
      html+='</div></div>';
    });
    el.innerHTML=html;
  },

  // ─ RENDER PROGRESS ─
  renderMurmur:function(){
    var el=q('murmur-log');if(!el)return;
    var ct=q('murmur-cnt');if(ct)ct.textContent=(G.murmurLog&&G.murmurLog.length)||0;
    var bdg=q('bdg-murmur');if(bdg)bdg.style.display='none';
    if(!G.murmurLog||!G.murmurLog.length){
      el.innerHTML='<div class="empty">まだ誰も呟いていません<br>社員がオフィスで働くと呟きます</div>';return;
    }
    var mentalColor=function(s2){
      var st=G.s.staff.find(function(x){return x.nm===s2;});
      if(!st)return'var(--t3)';
      return st.mental<30?'var(--red)':st.mental<60?'var(--warn)':'var(--ok)';
    };
    el.innerHTML=G.murmurLog.map(function(m){
      var mc=mentalColor(m.nm);
      var nm2=m.nm.split(' ')[0];
      return '<div class="murmur-item">'
        +'<div class="murmur-ic">'+m.ic+'</div>'
        +'<div class="murmur-body">'
        +'<div class="murmur-nm" style="color:'+mc+'">'+esc(nm2)+'</div>'
        +'<div class="murmur-txt">'+esc(m.msg)+'</div>'
        +'<div class="murmur-turn">第'+m.turn+'週</div>'
        +'</div></div>';
    }).join('');
  },


  // Midjourney プロンプト生成（将来の連携用）
  genMJPrompt:function(tid,nm,qual){
    var styleMap={
      logo:'minimalist logo design, clean vector, professional brand identity, white background',
      meishi:'business card design, elegant typography, premium print, clean layout',
      banner:'advertising banner, bold visual impact, digital design, high contrast',
      flyer:'print flyer design, editorial layout, eye-catching typography',
      icon:'flat icon set, clean vector icons, consistent style, pixel perfect',
      sns:'social media design, instagram template, cohesive visual identity',
      lp:'landing page hero section, conversion-focused UI, clean modern web design',
      poster:'poster design, bold typography, artistic composition, print ready',
      catalog:'editorial catalog design, product layout, magazine-quality photography',
      package:'product packaging design, retail-ready, premium materials, 3d mockup',
      photo:'commercial photography, studio lighting, product shot, professional retouching',
      app:'mobile app UI, iOS design language, clean interface, dark mode option',
      motion:'motion graphics, brand animation, kinetic typography, smooth transitions',
      web:'web application dashboard, data visualization, SaaS UI, enterprise-grade',
      brand:'brand identity system, comprehensive style guide, logo system, visual language',
      preso:'presentation slide design, pitch deck, data storytelling, professional',
      signage:'environmental design, office signage, wayfinding system, architectural integration',
      ux_research:'UX research deliverable, user journey map, persona card, insight report',
      design_system:'design system documentation, component library, token system, Storybook',
      ai:'AI product interface, futuristic UX, chat interface, machine learning tool',
      ar_xr:'augmented reality UI, spatial computing interface, Vision Pro app design',
      ir:'annual report design, IR material, financial data visualization, corporate design',
      saas:'SaaS product UI, multi-tenant dashboard, enterprise software, B2B interface',
      growth:'growth dashboard, A/B test result, analytics UI, funnel visualization',
      cx:'customer experience map, service blueprint, touchpoint design, CX strategy visual',
      platform:'platform UI, marketplace design, developer portal, API documentation',
      global_rebrand:'global brand system, multinational visual identity, brand guidelines',
      ma:'corporate M&A presentation, integration roadmap, brand architecture',
      os_design:'operating system UI, system-level design, component framework, HIG document',
      // 新タイプ
      tshirt:'streetwear tshirt graphic design, flat lay mockup, urban fashion, bold print',
      stamp:'cute sticker sheet design, kawaii illustration, pastel colors, flat vector style',
      thumbnail:'youtube thumbnail design, bold typography, high contrast, eye-catching click-bait style',
      menu:'elegant restaurant menu design, food typography, warm editorial layout, fine dining aesthetic',
      nengajo:'japanese new year card, traditional modern fusion, red and gold, washi paper texture',
      game_ui:'game HUD interface design, fantasy RPG UI, glowing elements, dark immersive aesthetic',
      ebook:'ebook cover design, professional business book, gradient background, modern typography',
      map:'illustrated custom map design, vintage cartographic style, warm sepia tones, hand-drawn elements',
      mascot:'cute mascot character design, chibi illustration, friendly expression, multiple poses, flat vector',
      infographic:'data visualization infographic, modern statistical design, colorful charts, clean layout',
      fashion:'high fashion editorial lookbook, luxury brand campaign, minimalist studio photography',
      food:'japanese restaurant branding, warm minimalist identity, hand-lettered logo, earth tones',
      realestate:'luxury real estate brochure, architectural visualization, premium clean layout',
      event:'music festival poster, vibrant illustration, bold typography, dynamic concert visual',
      nft:'generative NFT digital art, cyberpunk aesthetic, vibrant geometric patterns, blockchain visual',
      medical_app:'medical app UI design, clean clinical interface, healthcare blue white, accessible dashboard',
      edtech:'educational app UI for children, gamified learning, bright colorful, friendly characters',
      fintech:'fintech mobile app UI, modern banking interface, dark theme, data visualization, trust design',
      agri:'agricultural tech UI, rural japan branding, natural earthy tones, farmland digital transformation',
      sport:'professional sports team branding, bold athletic logo, dynamic motion graphics, jersey mockup',
      anime:'anime key visual illustration, dramatic composition, vibrant japanese animation style, detailed characters',
      govtech:'government digital service UI, accessible clean interface, formal blue tones, citizen portal',
      mobility:'automotive HMI interface, car dashboard UI, dark cockpit luxury interior, infotainment system',
      xrplatform:'spatial computing UI for Apple Vision Pro, immersive 3D interface, glass morphism, AR overlay',
    };
    var base=styleMap[tid]||'professional graphic design';
    var qualStr=qual>=90?', award-winning masterpiece, ultra-detailed, perfection':qual>=70?', high quality, professional grade':qual>=50?', competent design':'';
    return '/imagine prompt: '+base+qualStr+', by world-renowned designer, '+new Date().getFullYear()+' design award --ar 4:3 --style raw --v 6.1 --q 2';
  },

  // ══════════════════════════════════════════════
  // G.aiDesign  ─  AI SVGデザイン自動生成システム
  // ──────────────────────────────────────────────
  // 案件完了時にClaude Haiku APIを呼び出してSVGを生成。
  // 生成されたSVGはportfolioエントリのsvgプロパティに保存。
  // ══════════════════════════════════════════════
  aiDesign:{
    _viewerItem:null,

    // APIキー管理
    getKey:function(){return localStorage.getItem('dcfk_apikey')||'';},

    saveKey:function(){
      var inp=q('api-key-input');if(!inp)return;
      var key=inp.value.trim();
      if(!key){localStorage.removeItem('dcfk_apikey');}
      else{localStorage.setItem('dcfk_apikey',key);}
      this.updateKeyStatus();
      notify(key?'APIキーを保存しました。案件完了時にAIデザインが生成されます！':'APIキーを削除しました。','ok');
    },

    updateKeyStatus:function(){
      var key=this.getKey();
      var bar=q('api-key-bar');var st=q('api-key-status');var inp=q('api-key-input');
      if(!bar||!st)return;
      if(key){
        bar.classList.add('has-key');
        st.className='api-key-status ok';
        st.textContent='✓ 設定済み';
        if(inp)inp.value='';inp&&(inp.placeholder='設定済み（変更する場合は再入力）');
      }else{
        bar.classList.remove('has-key');
        st.className='api-key-status';
        st.textContent='未設定';
      }
    },

    // ────────────────────────────────────────────
    // SVGプロンプト生成 — タイプ・案件名・品質を考慮
    // ────────────────────────────────────────────
    buildPrompt:function(tid, nm, cliName, qual){
      var qualDesc = qual>=90?'award-winning, masterpiece quality, highly detailed':
                     qual>=75?'professional high quality, polished':
                     qual>=55?'standard professional quality':
                     'basic, somewhat rushed';

      var typePrompts = {
        logo: 'a professional logo design as SVG. Create a clean, modern logo with a unique geometric symbol/icon and the company name in elegant typography. Include a tagline if appropriate. Use a cohesive color palette of 2-3 colors.',
        meishi: 'a business card design as SVG (85mm x 55mm proportions). Show both sides if possible, with name, title, contact info in a clean elegant layout.',
        banner: 'a web banner design as SVG (728x90 or 300x250 proportions). Bold headline, supporting text, and a clear call-to-action button.',
        flyer: 'a print flyer design as SVG. Eye-catching headline, body text, and visual hierarchy. Include event details or product information.',
        lp: 'a landing page hero section as SVG. Show a realistic web layout with navigation bar, hero headline, subtext, CTA button, and decorative elements.',
        app: 'a mobile app UI mockup as SVG. Show a smartphone frame with a realistic app screen including navigation, content cards, and UI components.',
        web: 'a web dashboard/service UI as SVG. Show a browser window frame with a realistic dashboard including sidebar, data cards, charts, and navigation.',
        brand: 'a brand identity showcase as SVG. Show logo variations, color palette swatches, typography specimens, and brand applications on mockups.',
        motion: 'a motion graphics keyframe as SVG. Visualize an animated logo or kinetic typography composition with dynamic geometric elements.',
        poster: 'a creative poster design as SVG. Bold typography, strong visual composition, and artistic elements. Print-ready layout.',
        catalog: 'a catalog spread as SVG. Show two facing pages with product imagery placeholders, text columns, and editorial layout.',
        package: 'a product packaging design as SVG. Show packaging mockup with brand elements, typography, and color bands in 3D-ish perspective.',
        mascot: 'a cute mascot character as SVG. A friendly, expressive character illustration with distinct personality, shown in full body pose.',
        tshirt: 'a T-shirt graphic design as SVG on a flat-lay t-shirt mockup. Bold graphic, typography, and streetwear aesthetic.',
        game_ui: 'a game HUD/interface design as SVG. Dark fantasy or sci-fi aesthetic with health bars, inventory slots, map miniature, and action buttons.',
        infographic: 'an infographic design as SVG. Data visualization with charts, icons, statistics, and visual narrative flow.',
        food: 'a restaurant brand identity as SVG. Logo, menu header, color palette with warm food-appropriate tones.',
        fintech: 'a fintech app dashboard as SVG in a phone mockup. Show portfolio overview, balance, quick actions, and transaction list.',
        medical_app: 'a medical app interface as SVG in a phone frame. Clean clinical UI with patient data, health metrics, and appointment scheduling.',
        default: 'a professional design work as SVG. Clean, modern, well-crafted with appropriate typography and visual hierarchy.'
      };

      var typeDesc = typePrompts[tid] || typePrompts['default'];
      var colors = qual>=85 ?
        'Use a sophisticated, premium color palette appropriate for the industry.' :
        'Use a clean, professional color palette.';

      return 'Create ' + typeDesc + '\n\nProject name: "' + nm + '"\nClient: ' + cliName + '\n' + colors + '\nQuality level: ' + qualDesc + '\n\nIMPORTANT RULES:\n- Return ONLY the SVG code, nothing else\n- No markdown, no backticks, no explanation\n- Start with <svg and end with </svg>\n- viewBox should be appropriate for the type (e.g. "0 0 400 300")\n- Use embedded styles, no external CSS\n- Make it look realistic and well-designed\n- Include realistic text content related to the project name\n- SVG should be self-contained and render beautifully';
    },

    // ────────────────────────────────────────────
    // API呼び出し & SVG生成
    // ────────────────────────────────────────────
    generate:function(portfolioId, tid, nm, cliName, qual){
      var key=this.getKey();if(!key)return;
      var self=this;

      // 作品集エントリにgeneratingフラグを立てる
      var entry=G.s.portfolio.find(function(p){return p.id===portfolioId;});
      if(!entry)return;
      entry.svgStatus='generating';
      // UIを更新してスピナー表示
      G.renderPortfolio();

      var prompt=this.buildPrompt(tid, nm, cliName, qual);

      fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'x-api-key':key,
          'anthropic-version':'2023-06-01',
          'anthropic-dangerous-direct-browser-access':'true'
        },
        body:JSON.stringify({
          model:'claude-haiku-4-5-20251001',
          max_tokens:4000,
          messages:[{role:'user',content:prompt}]
        })
      })
      .then(function(r){return r.json();})
      .then(function(data){
        var text='';
        if(data.content&&data.content[0]&&data.content[0].text){
          text=data.content[0].text.trim();
        }else if(data.error){
          console.error('API error:',data.error.message);
          if(entry){entry.svgStatus='error';entry.svgError=data.error.message;}
          G.renderPortfolio();return;
        }
        // SVGを抽出
        var svgMatch=text.match(/<svg[\s\S]*<\/svg>/i);
        var svg=svgMatch?svgMatch[0]:text;
        if(svg.startsWith('<svg')){
          entry.svg=svg;entry.svgStatus='done';
          G.s.portfolio[G.s.portfolio.indexOf(entry)]=entry;
          G.save&&null; // 自動保存はしない（手動保存で反映）
          addLog('✨ AI生成完了！「'+nm+'」のデザインが作品集に追加された','good');
          G.renderPortfolio();
          // 完了フラッシュ
          notify('✨ AIデザイン生成完了！「'+nm+'」の作品集を確認しよう','ok',4000);
        }else{
          entry.svgStatus='error';entry.svgError='SVG形式ではありませんでした';
          G.renderPortfolio();
        }
      })
      .catch(function(e){
        console.error('fetch error',e);
        if(entry){entry.svgStatus='error';entry.svgError=e.message;}
        G.renderPortfolio();
        notify('AI生成エラー: '+e.message,'danger');
      });
    },

    // 手動で再生成
    regenerate:function(portfolioId){
      var entry=G.s.portfolio.find(function(p){return p.id===portfolioId;});
      if(!entry)return;
      entry.svgStatus=null;entry.svg=null;
      this.generate(portfolioId, entry.tid, entry.nm, entry.cli, entry.qual);
    },

    // ────────────────────────────────────────────
    // SVGビューワー
    // ────────────────────────────────────────────
    openViewer:function(portfolioId){
      var entry=G.s.portfolio.find(function(p){return p.id===portfolioId;});
      if(!entry)return;
      this._viewerItem=entry;
      var modal=q('modal-svg-view');if(!modal)return;
      var title=q('svg-view-title');
      var content=q('svg-view-content');
      var meta=q('svg-view-meta');
      if(title)title.textContent=entry.tic+' '+entry.nm;
      if(meta)meta.textContent=entry.tlb+' • '+entry.cli+' • 品質'+entry.qual+' • '+entry.stars;
      if(content){
        if(entry.svg){
          content.style.background='#fff';
          content.innerHTML=entry.svg;
        }else{
          // SVGなしの場合はCanvasサムネイルをSVGとして表示
          content.style.background='#1a1a2e';
          var cv=document.createElement('canvas');cv.width=400;cv.height=300;
          G.drawThumb(cv,entry.tid||'logo',entry.qual||50,(entry.turn||1)*997);
          content.innerHTML='';content.appendChild(cv);
        }
      }
      modal.classList.add('open');
    },

    closeViewer:function(){
      var modal=q('modal-svg-view');if(modal)modal.classList.remove('open');
      this._viewerItem=null;
    },

    downloadSVG:function(){
      var entry=this._viewerItem;if(!entry||!entry.svg)return;
      var blob=new Blob([entry.svg],{type:'image/svg+xml'});
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a');
      a.href=url;a.download=(entry.nm||'design').replace(/[^\w\-]/g,'_')+'.svg';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  },

  // ══════════════════════════════════════════════
  // G.ord  ─  オーダーシステム（ゲーム内完結）
  // ──────────────────────────────────────────────
  // データエンコード方式:
  //   注文データをJSONにして btoa(encodeURIComponent(JSON)) でBase64化
  //   プレフィックス DCFK- を付けて受注コードとする
  // ══════════════════════════════════════════════
  ord:{
    selectedType:null,
    recvOpen:false,

    BUDGET_STEPS:[
      30000,50000,80000,120000,200000,
      300000,500000,800000,1200000,2000000,
      3000000,5000000,8000000,12000000,20000000,
      30000000,50000000,80000000,120000000,200000000,500000000
    ],

    ORDER_TYPES:[
      {ic:'🔤',nm:'ロゴ',    tid:'logo',    tlb:'ロゴ',    tic:'🔤', price:'¥80K〜'},
      {ic:'💳',nm:'名刺',    tid:'meishi',  tlb:'名刺',    tic:'💳', price:'¥30K〜'},
      {ic:'🖼️',nm:'バナー',  tid:'banner',  tlb:'バナー',  tic:'🖼️', price:'¥50K〜'},
      {ic:'📄',nm:'チラシ',  tid:'flyer',   tlb:'フライヤー',tic:'📄',price:'¥45K〜'},
      {ic:'🖥️',nm:'LP/Web',  tid:'lp',      tlb:'LP',      tic:'🖥️', price:'¥200K〜'},
      {ic:'📱',nm:'アプリUI',tid:'app',     tlb:'アプリUI',tic:'📱', price:'¥800K〜'},
      {ic:'💎',nm:'ブランド',tid:'brand',   tlb:'ブランディング',tic:'💎',price:'¥3M〜'},
      {ic:'🌐',nm:'Webサービス',tid:'web',  tlb:'Webサービス',tic:'🌐',price:'¥1.5M〜'},
      {ic:'🎬',nm:'モーション',tid:'motion',tlb:'モーション',tic:'🎬',price:'¥300K〜'},
      {ic:'📦',nm:'パッケージ',tid:'package',tlb:'パッケージ',tic:'📦',price:'¥380K〜'},
      {ic:'👕',nm:'Tシャツ', tid:'tshirt',  tlb:'Tシャツ',  tic:'👕', price:'¥25K〜'},
      {ic:'🐻',nm:'マスコット',tid:'mascot',tlb:'マスコット',tic:'🐻',price:'¥350K〜'},
    ],

    fmtBudget:function(v){
      if(v>=100000000)return '¥'+(v/100000000).toFixed(1)+'億';
      if(v>=10000000)return '¥'+(v/10000000).toFixed(0)+'千万';
      if(v>=10000)return '¥'+(v/10000).toFixed(0)+'万';
      return '¥'+v.toLocaleString();
    },

    updateBudget:function(idx){
      var v=this.BUDGET_STEPS[Math.min(parseInt(idx),this.BUDGET_STEPS.length-1)];
      var el=q('ord-budget-val');if(el)el.textContent=this.fmtBudget(v);
      var rng=q('ord-budget');if(rng){var pct=(parseInt(idx)/20*100)+'%';rng.style.setProperty('--pct',pct);}
    },

    // オーダーページを開く（?orderパラメーター or 直接呼び出し）
    open:function(){
      var scr=q('SCR_ORDER');if(!scr)return;
      // 会社名をゲームデータから
      var PHASE_NAMES=['個人事務所','デザイン事務所','デザインスタジオ','デザイン会社','プロダクト企業','PF企業','テックジャイアント'];
      var cn=q('ord-company-name');
      if(cn)cn.textContent=G.s?PHASE_NAMES[G.s.phase||0]:'デザイン会社';
      // フォームリセット
      var fa=q('ord-form-area');var ca=q('ord-code-area');
      if(fa)fa.style.display='';if(ca)ca.style.display='none';
      var ni=q('ord-name');if(ni)ni.value='';
      var ci=q('ord-company');if(ci)ci.value='';
      var di=q('ord-desc');if(di)di.value='';
      this.selectedType=null;
      document.querySelectorAll('.ord-type-btn').forEach(function(b){b.classList.remove('sel');});
      scr.classList.add('open');
      // タイプグリッド生成（初回のみ）
      this.initTypeGrid();
    },

    initTypeGrid:function(){
      var grid=q('ord-type-grid');if(!grid||grid.children.length>0)return;
      var self=this;
      this.ORDER_TYPES.forEach(function(t){
        var btn=document.createElement('button');
        btn.className='ord-type-btn';
        btn.innerHTML='<div class="ord-type-ic">'+t.ic+'</div>'
          +'<div class="ord-type-nm">'+t.nm+'</div>'
          +'<div class="ord-type-pr">'+t.price+'</div>';
        btn.addEventListener('click',function(){
          document.querySelectorAll('.ord-type-btn').forEach(function(b){b.classList.remove('sel');});
          btn.classList.add('sel');
          self.selectedType=t;
        });
        grid.appendChild(btn);
      });
    },

    submit:function(){
      var name=q('ord-name')?q('ord-name').value.trim():'';
      var desc=q('ord-desc')?q('ord-desc').value.trim():'';
      if(!name){alert('お名前を入力してください');return;}
      if(!this.selectedType){alert('依頼内容を選んでください');return;}
      if(!desc){alert('プロジェクト詳細を入力してください');return;}

      var budgetIdx=parseInt(q('ord-budget')?q('ord-budget').value:5);
      var budget=this.BUDGET_STEPS[Math.min(budgetIdx,this.BUDGET_STEPS.length-1)];
      var deadline=parseInt(q('ord-deadline')?q('ord-deadline').value:14);
      var company=(q('ord-company')?q('ord-company').value.trim():'')||name;
      var t=this.selectedType;

      var data={
        id:'DCFK-'+Date.now().toString(36).toUpperCase()+'-'+Math.floor(Math.random()*9999),
        nm:(t.nm+' — '+company).slice(0,36),
        from:company.slice(0,20),
        tid:t.tid, tlb:t.tlb, tic:t.tic,
        desc:desc.slice(0,120),
        budget:budget, dl:deadline,
        ts:Date.now()
      };

      // Base64エンコード
      var code;
      try{code=data.id+'|'+btoa(unescape(encodeURIComponent(JSON.stringify(data))));}
      catch(e){code=data.id+'|ERR';}

      // コード表示画面に切替
      var fa=q('ord-form-area');var ca=q('ord-code-area');
      if(fa)fa.style.display='none';
      if(ca)ca.style.display='';
      var box=q('ord-code-output');
      if(box)box.textContent=code;
      this._lastCode=code;
      this._lastData=data;
      SFX.fanfare&&SFX.fanfare();
    },

    copyCode:function(){
      var code=this._lastCode;if(!code)return;
      if(navigator.clipboard){
        navigator.clipboard.writeText(code).then(function(){
          var box=q('ord-code-output');
          if(box){var orig=box.textContent;box.textContent='✅ コピーしました！';setTimeout(function(){box.textContent=orig;},1500);}
        });
      }else{
        var ta=document.createElement('textarea');ta.value=code;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
        notify('コードをコピーしました','ok');
      }
    },

    // 受注コードを受け取ってゲームに案件を追加
    receiveCode:function(){
      var inp=q('order-code-input');
      var raw=inp?inp.value.trim():'';
      if(!raw){notify('受注コードを入力してください','warn');return;}
      this._importCode(raw,inp);
    },

    _importCode:function(raw,inp){
      try{
        var parts=raw.split('|');
        if(parts.length<2)throw new Error('invalid format');
        var json=decodeURIComponent(escape(atob(parts[1])));
        var data=JSON.parse(json);
        if(!data.tid||!data.nm)throw new Error('missing fields');
        // ゲーム状態チェック
        if(!G.s){notify('ゲームを開始してから入力してください','warn');return;}
        // 重複チェック
        var already=G.s.avail.find(function(p){return p.id===data.id;});
        if(already){notify('このオーダーは既に届いています','warn');return;}
        // 案件として追加
        var pt=PTYPES.find(function(p){return p.id===data.tid;})||PTYPES[0];
        var price=Math.round((data.budget||pt.base)*1.1); // クライアント指定予算+10%
        G.s.avail.unshift({
          id:data.id,
          tid:data.tid, tlb:data.tlb, tic:data.tic, tcss:pt.css||'logo',
          nm:data.nm,
          cli:{id:'god',lb:data.from||'外部クライアント',ic:'🌐',mr:5,pm:1.3,rg:4,rl:-1,desc:'リアルオーダー'},
          price:price, days:pt.days||7,
          diff:3, dead:data.dl||14, urg:true, sk:pt.sk||['design'],
          prog:0, asgn:null, modCnt:0, isExt:true,
          extDesc:data.desc, extBudget:data.budget
        });
        if(inp)inp.value='';
        q('order-recv-form').style.display='none';
        this.recvOpen=false;
        addLog('📨 リアルオーダーが届いた！「'+data.nm+'」 '+fY(price),'good');
        notify('📨 新しいオーダー！「'+data.nm+'」が案件タブに届きました！','ok',6000);
        SFX.fanfare&&SFX.fanfare();
        G.updateHUD();G.renderAll();G.tab('proj');
      }catch(e){
        notify('受注コードが正しくありません','danger');
        console.error('order code error',e);
      }
    },

    toggleRecv:function(){
      this.recvOpen=!this.recvOpen;
      var f=q('order-recv-form');if(f)f.style.display=this.recvOpen?'':'none';
      if(this.recvOpen){var inp=q('order-code-input');if(inp)inp.focus();}
    },

    openOrderPage:function(){
      // クライアントが見るオーダー画面を開く
      G.ord.open();
    },

    openFromTitle:function(){
      // タイトル画面からコード入力
      var code=prompt('受注コードを貼り付けてください：');
      if(!code)return;
      // セーブデータがあればロードしてから
      var raw=localStorage.getItem('dcfk_v3');
      if(!raw){
        if(!confirm('セーブデータがありません。NEW GAMEを開始してオーダーを受け取りますか？'))return;
        G.newGame();
        setTimeout(function(){G.ord._importCode(code,null);},800);
      }else{
        G.load();
        setTimeout(function(){G.ord._importCode(code,null);},800);
      }
    },

    closeOrder:function(){
      var scr=q('SCR_ORDER');if(scr)scr.classList.remove('open');
    }
  },

  closeOrder:function(){G.ord.closeOrder();},

  // ─ 都市グラフィックビュー ─
  openWorldCity:function(id){
    var STUDIOS=G._getStudios();
    var st=STUDIOS.find(function(s){return s.id===id;});
    if(!st||st.locked)return;
    var modal=q('world-city-modal');
    var title=q('city-modal-title');
    var info=q('city-modal-info');
    var cv=q('city-cv');
    if(!modal||!title||!info||!cv)return;

    title.innerHTML=st.ic+' '+st.nm;
    modal.classList.add('open');

    // Canvas描画（アイソメビル風）
    var ctx=cv.getContext('2d');
    var W=cv.width,H=cv.height;
    ctx.clearRect(0,0,W,H);

    // 背景グラデーション（都市ごとに異なる空の色）
    var skyColors={
      kyoto:['#1a0a0a','#2d1b4e'],tokyo:['#0a0a1a','#1a1a3a'],
      niigata:['#0a1a0a','#1a2d1a'],seoul:['#0a0a2a','#1a2040'],
      singapore:['#1a1000','#2d2010'],berlin:['#0a0a0a','#1a1a2a'],
      london:['#0a0a14','#14141e'],ny:['#140a00','#2d1a00'],
    };
    var sky=skyColors[id]||['#0f0f1a','#1a1a2e'];
    var grad=ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,sky[0]);grad.addColorStop(1,sky[1]);
    ctx.fillStyle=grad;ctx.fillRect(0,0,W,H);

    // 星
    for(var i=0;i<50;i++){
      var sx=Math.abs(Math.sin(i*137.5)*W);
      var sy=Math.abs(Math.cos(i*73.1)*H*0.6);
      ctx.fillStyle='rgba(255,255,255,'+(0.3+Math.abs(Math.sin(i*0.7))*0.6)+')';
      ctx.fillRect(sx,sy,Math.random()>0.8?2:1,Math.random()>0.8?2:1);
    }

    // 地面
    var ground=ctx.createLinearGradient(0,H*0.72,0,H);
    ground.addColorStop(0,'rgba(30,30,50,.8)');ground.addColorStop(1,'rgba(15,15,30,1)');
    ctx.fillStyle=ground;ctx.fillRect(0,H*0.72,W,H*0.28);

    // アイソメビル（都市ごとに異なる形状・色）
    var col=st.color||'#6366f1';
    var buildingData={
      kyoto:[[120,80,50,140,'#a67c52'],[200,60,40,160,'#8b6543'],[310,90,45,130,'#c4956a'],[60,100,35,120,'#7a5c3d']],
      tokyo:[[100,40,60,160,'#334155'],[210,20,70,180,'#1e40af'],[340,50,55,150,'#1d4ed8'],[50,70,40,130,'#475569']],
      niigata:[[130,90,55,110,'#166534'],[250,80,45,120,'#14532d'],[360,100,40,100,'#15803d'],[60,95,35,105,'#166534']],
      seoul:[[110,30,65,170,'#1e3a5f'],[225,15,75,185,'#1e40af'],[355,40,60,160,'#2563eb'],[55,60,45,140,'#1d4ed8']],
      singapore:[[120,60,60,140,'#78350f'],[235,40,70,160,'#92400e'],[350,65,55,135,'#b45309'],[60,75,40,125,'#92400e']],
      berlin:[[125,50,70,150,'#1e1b4b'],[245,30,80,170,'#312e81'],[365,55,65,145,'#4338ca'],[55,65,50,135,'#3730a3']],
      london:[[115,45,65,155,'#374151'],[235,25,75,175,'#1f2937'],[350,50,60,150,'#111827'],[50,70,45,130,'#374151']],
      ny:[[100,20,70,180,'#9a3412'],[215,5,80,195,'#c2410c'],[340,25,65,175,'#ea580c'],[45,45,50,155,'#9a3412']],
    };
    var buildings=buildingData[id]||buildingData.tokyo;

    function drawIsoBuilding(cx,bh,bw,h,col){
      var gnd=H*0.75;
      // 正面
      ctx.fillStyle=col;
      ctx.fillRect(cx-bw/2,gnd-h,bw,h);
      // 窓
      ctx.fillStyle='rgba(255,255,255,.05)';
      for(var wr=0;wr<Math.floor(h/18);wr++){
        for(var wc=0;wc<Math.floor(bw/14);wc++){
          var lit=Math.sin(cx*0.1+wr*2.3+wc*1.7)>0.2;
          if(lit){ctx.fillStyle='rgba(255,220,100,.35)';}
          else{ctx.fillStyle='rgba(255,255,255,.04)';}
          ctx.fillRect(cx-bw/2+wc*14+3,gnd-h+wr*18+3,8,10);
        }
      }
      // 屋根（少し明るく）
      ctx.fillStyle='rgba(255,255,255,.08)';
      ctx.fillRect(cx-bw/2,gnd-h,bw,3);
    }

    buildings.forEach(function(b){drawIsoBuilding(b[0],b[1],b[2],b[3],b[4]);});

    // ランドマークアイコン表示
    ctx.font='28px serif';
    ctx.fillText(st.landmarks[0]||'🏙️',W*0.5-14,H*0.6);
    ctx.font='16px serif';
    ctx.fillText(st.landmarks[1]||'',W*0.65,H*0.65);
    ctx.fillText(st.landmarks[2]||'',W*0.35,H*0.67);

    // 都市名
    ctx.font='bold 13px sans-serif';
    ctx.fillStyle='rgba(255,255,255,.6)';
    ctx.fillText(st.vibe,12,H-10);

    // スタッフ情報
    var s=G.s;
    var totalStaff=s.staff.length;
    var studioStaff=s.staff.filter(function(m){
      return (id==='kyoto')||
             (id==='tokyo'&&m.intl)||
             (id==='niigata'&&(s.policies||{})['niigata_base'])||
             false;
    });
    // 全拠点共通で比例配分
    var ratio={kyoto:.5,tokyo:.25,niigata:.08,seoul:.06,singapore:.05,berlin:.03,london:.04,ny:.04};
    var stStaff=Math.max(id==='kyoto'?1:0,Math.floor(totalStaff*(ratio[id]||.03)));
    var stRev=Math.round((s.totalRev||0)*(ratio[id]||.03));

    var intlHere=s.staff.filter(function(m){return m.intl;});
    var staffList='';
    if(id!=='kyoto'){
      staffList='<div class="city-staff-list"><div style="font-size:10.5px;font-weight:700;color:var(--t2);margin-bottom:4px">駐在スタッフ</div>';
      if(intlHere.length){
        intlHere.slice(0,4).forEach(function(m){
          staffList+='<div class="city-staff-item"><span style="font-size:16px">'+m.ic+'</span><span style="font-weight:600;color:var(--t1)">'+m.nm+'</span><span style="color:var(--t3)">'+m.role+'</span></div>';
        });
      }else{
        staffList+='<div style="font-size:11px;color:var(--t4)">駐在スタッフなし（国際人材を採用してください）</div>';
      }
      staffList+='</div>';
    }

    info.innerHTML='<div class="city-stat-row">'
      +'<div class="city-stat-box"><div class="val">'+stStaff+'名</div><div class="lbl">スタッフ</div></div>'
      +'<div class="city-stat-box"><div class="val">'+fY(stRev)+'</div><div class="lbl">累計売上</div></div>'
      +'<div class="city-stat-box"><div class="val">'+st.country+'</div><div class="lbl">拠点</div></div>'
      +'</div>'
      +'<div style="font-size:11px;color:var(--t3);line-height:1.7">'+st.desc+'</div>'
      +staffList;
  },
  closeWorldCity:function(){
    var modal=q('world-city-modal');
    if(modal)modal.classList.remove('open');
  },

  // ─ 通知ドロップダウン ─
  toggleNotif:function(){
    var panel=q('notif-panel');if(!panel)return;
    panel.classList.toggle('open');
    if(panel.classList.contains('open')){
      // バッジリセット
      _notifCount=0;
      var bdg=q('notif-badge');if(bdg)bdg.style.display='none';
    }
  },
  clearNotif:function(){
    var list=q('notif-list');if(list)list.innerHTML='<div class="empty">通知はありません</div>';
    _notifCount=0;
    var bdg=q('notif-badge');if(bdg)bdg.style.display='none';
  },

  portfolioFilter:'all',

  // 作品集サムネイル：Canvas描画でタイプ別モックアップ生成
  drawThumb:function(canvas, tid, qual, seed){
    var ctx=canvas.getContext('2d');
    var W=canvas.width, H=canvas.height;
    var r=function(){seed=(seed*1664525+1013904223)&0x7fffffff;return seed;};
    var rc=function(lo,hi){return lo+r()%(hi-lo);};
    var rf=function(){return (r()%1000)/1000;};

    // 品質に応じたカラーパレット
    var palettes={
      logo:   [['#6366f1','#a78bfa','#e0e7ff','#f5f3ff'],['#f59e0b','#fcd34d','#fef3c7','#fffbeb'],['#10b981','#34d399','#d1fae5','#ecfdf5']],
      lp:     [['#3b82f6','#93c5fd','#dbeafe','#eff6ff'],['#ec4899','#f9a8d4','#fce7f3','#fdf2f8']],
      app:    [['#1e1b4b','#4338ca','#818cf8','#c7d2fe'],['#0f172a','#0f4c81','#3b82f6','#bfdbfe']],
      web:    [['#0f172a','#1e3a5f','#3b82f6','#e2e8f0'],['#1a1a2e','#16213e','#0f3460','#533483']],
      brand:  [['#92400e','#d97706','#fde68a','#fffbeb'],['#4c1d95','#7c3aed','#c4b5fd','#ede9fe']],
      saas:   [['#0f172a','#1e293b','#3b82f6','#7dd3fc'],['#064e3b','#065f46','#10b981','#a7f3d0']],
      growth: [['#7f1d1d','#991b1b','#ef4444','#fca5a5'],['#1e3a5f','#1d4ed8','#60a5fa','#bfdbfe']],
      ai:     [['#1e1b4b','#312e81','#6366f1','#c7d2fe'],['#0c0c1e','#1a1a3e','#7c3aed','#ddd6fe']],
      meishi: [['#f8fafc','#e2e8f0','#334155','#0f172a'],['#fefce8','#fef9c3','#713f12','#1c0a00']],
      banner: [['#ff6b35','#f7931e','#fff','#1a1a2e'],['#00c9ff','#92fe9d','#1a1a2e','#fff']],
      // 新タイプ
      tshirt:   [['#ffffff','#1a1a2e','#e2e8f0','#f8fafc'],['#000000','#ef4444','#fff','#fca5a5']],
      stamp:    [['#fce7f3','#ec4899','#fff','#fdf2f8'],['#d1fae5','#10b981','#fff','#ecfdf5']],
      thumbnail:[['#1e1b4b','#dc2626','#fef08a','#fff'],['#0f172a','#0284c7','#e0f2fe','#fff']],
      menu:     [['#1a0a00','#c4891a','#fef3c7','#fffbeb'],['#f8f4ef','#6b4226','#d4a96a','#1a0a00']],
      nengajo:  [['#7f1d1d','#dc2626','#fef2f2','#fff'],['#1c1917','#c4891a','#fef3c7','#fff']],
      game_ui:  [['#0a0a1e','#7c3aed','#c4b5fd','#1a1a3e'],['#0f172a','#dc2626','#fca5a5','#1e293b']],
      ebook:    [['#1e293b','#6366f1','#c7d2fe','#e2e8f0'],['#1a1a2e','#f59e0b','#fde68a','#e5e7eb']],
      map:      [['#78350f','#d97706','#fef3c7','#fef9c3'],['#166534','#22c55e','#dcfce7','#f0fdf4']],
      mascot:   [['#fce7f3','#f472b6','#fdf2f8','#fff'],['#d1fae5','#34d399','#ecfdf5','#fff']],
      infographic:[['#f0f9ff','#0284c7','#bae6fd','#e0f2fe'],['#faf5ff','#7c3aed','#ddd6fe','#ede9fe']],
      fashion:  [['#1a1a1a','#c4891a','#f5f0e8','#fff'],['#fafafa','#1a1a1a','#e5e7eb','#111']],
      food:     [['#1c1205','#d97706','#fef3c7','#fff7ed'],['#0f1c0a','#22c55e','#dcfce7','#f0fdf4']],
      realestate:[['#0f172a','#64748b','#f1f5f9','#fff'],['#1c0a00','#c4891a','#fef3c7','#fff']],
      event:    [['#1a0030','#a855f7','#fae8ff','#f0abfc'],['#0a1a00','#84cc16','#ecfccb','#d9f99d']],
      nft:      [['#0a0a1e','#00f5ff','#0a3a4a','#001a2e'],['#0f0a1e','#ff2d78','#3a0a2e','#1a0010']],
      medical_app:[['#f0f9ff','#0284c7','#bae6fd','#fff'],['#f0fdf4','#16a34a','#bbf7d0','#fff']],
      edtech:   [['#faf5ff','#7c3aed','#ddd6fe','#fff'],['#fff7ed','#ea580c','#fed7aa','#fff']],
      fintech:  [['#0f172a','#1d4ed8','#bfdbfe','#93c5fd'],['#0a0a1e','#06b6d4','#a5f3fc','#cffafe']],
      agri:     [['#1c2e04','#65a30d','#ecfccb','#f7fee7'],['#1a0f00','#d97706','#fef3c7','#fffbeb']],
      sport:    [['#1a0000','#dc2626','#fee2e2','#fff'],['#0a1a3e','#1d4ed8','#dbeafe','#eff6ff']],
      anime:    [['#0a0a1e','#7c3aed','#c4b5fd','#fff'],['#1a0a00','#c4891a','#fef3c7','#fff']],
      govtech:  [['#0f172a','#1d4ed8','#e2e8f0','#f8fafc'],['#042f2e','#0d9488','#ccfbf1','#f0fdfa']],
      mobility: [['#0a0a0a','#374151','#9ca3af','#1f2937'],['#030712','#1d4ed8','#bfdbfe','#0f172a']],
      xrplatform:[['#0a0a1e','#7c3aed','#c4b5fd','rgba(255,255,255,0.1)'],['#000a1e','#0284c7','#bae6fd','rgba(255,255,255,0.05)']],
    };
    var pal=palettes[tid]||palettes['logo'];
    var colors=pal[r()%pal.length];

    ctx.fillStyle=colors[2]||'#f0f0f0';
    ctx.fillRect(0,0,W,H);

    if(tid==='logo'){
      // ロゴモックアップ：幾何学的シンボル
      ctx.fillStyle=colors[3]||'#fff';ctx.fillRect(0,0,W,H);
      var shapes=r()%4;
      ctx.fillStyle=colors[0];
      if(shapes===0){// 円
        ctx.beginPath();ctx.arc(W/2,H/2-8,18,0,Math.PI*2);ctx.fill();
        ctx.fillStyle=colors[1];
        ctx.beginPath();ctx.arc(W/2+10,H/2-4,10,0,Math.PI*2);ctx.fill();
      } else if(shapes===1){// 三角
        ctx.beginPath();ctx.moveTo(W/2,10);ctx.lineTo(W/2-18,H/2+2);ctx.lineTo(W/2+18,H/2+2);ctx.closePath();ctx.fill();
        ctx.fillStyle=colors[1];
        ctx.beginPath();ctx.moveTo(W/2,18);ctx.lineTo(W/2-10,H/2+2);ctx.lineTo(W/2+10,H/2+2);ctx.closePath();ctx.fill();
      } else if(shapes===2){// 正方形
        ctx.fillRect(W/2-16,H/2-22,32,32);
        ctx.fillStyle=colors[1];ctx.fillRect(W/2-8,H/2-14,16,16);
        ctx.fillStyle=colors[2];ctx.fillRect(W/2-4,H/2-10,8,8);
      } else {// ひし形
        ctx.save();ctx.translate(W/2,H/2-8);ctx.rotate(Math.PI/4);ctx.fillRect(-14,-14,28,28);ctx.restore();
        ctx.fillStyle=colors[1];
        ctx.save();ctx.translate(W/2,H/2-8);ctx.rotate(Math.PI/4);ctx.fillRect(-8,-8,16,16);ctx.restore();
      }
      // ロゴ下のテキストバー
      ctx.fillStyle=colors[0];ctx.fillRect(W/2-22,H/2+10,44,5);
      ctx.fillStyle=colors[1];ctx.fillRect(W/2-14,H/2+18,28,3);

    } else if(tid==='app'){
      // アプリUIモックアップ：スマホ画面
      ctx.fillStyle='#1a1a2e';ctx.fillRect(0,0,W,H);
      // ステータスバー
      ctx.fillStyle='#222';ctx.fillRect(4,4,W-8,10);
      // ヘッダー
      ctx.fillStyle=colors[0];ctx.fillRect(4,14,W-8,18);
      ctx.fillStyle='rgba(255,255,255,0.9)';ctx.fillRect(10,19,40,8);
      // カードリスト
      for(var i=0;i<3;i++){
        ctx.fillStyle='#1e293b';ctx.fillRect(4,34+i*17,W-8,14);
        ctx.fillStyle=colors[1];ctx.fillRect(8,37+i*17,8,8);
        ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fillRect(20,38+i*17,30,3);
        ctx.fillStyle='rgba(255,255,255,0.4)';ctx.fillRect(20,43+i*17,20,2);
        ctx.fillStyle=colors[0];ctx.fillRect(W-16,37+i*17,10,8);
      }
      // ボトムナビ
      ctx.fillStyle='#0f172a';ctx.fillRect(4,H-16,W-8,12);
      for(var j=0;j<4;j++){
        ctx.fillStyle=j===0?colors[0]:'rgba(255,255,255,0.3)';
        ctx.fillRect(8+j*20,H-13,12,6);
      }

    } else if(tid==='web'){
      // WebサービスUI：ダッシュボード風
      ctx.fillStyle='#0f172a';ctx.fillRect(0,0,W,H);
      // サイドバー
      ctx.fillStyle='#1e293b';ctx.fillRect(0,0,20,H);
      for(var i=0;i<5;i++){ctx.fillStyle='rgba(99,102,241,'+(i===1?'0.9':'0.4')+')';ctx.fillRect(4,10+i*14,12,8);}
      // メインエリア
      ctx.fillStyle='#1e293b';ctx.fillRect(22,4,W-26,16);// ヘッダー
      ctx.fillStyle=colors[0];ctx.fillRect(26,7,30,10);
      // KPIカード
      var kpiC=[colors[0],colors[1],'#10b981','#f59e0b'];
      for(var i=0;i<4;i++){
        ctx.fillStyle=kpiC[i%kpiC.length];ctx.globalAlpha=0.15;
        ctx.fillRect(22+i*17,22,15,18);ctx.globalAlpha=1;
        ctx.fillStyle=kpiC[i%kpiC.length];
        ctx.fillRect(24+i*17,24,11,6);
        ctx.fillStyle='rgba(255,255,255,0.6)';ctx.fillRect(24+i*17,32,8,3);
      }
      // グラフ
      ctx.fillStyle='#1e293b';ctx.fillRect(22,42,W-26,H-46);
      for(var i=0;i<8;i++){
        var bh=8+rc(0,15);
        ctx.fillStyle=colors[0];ctx.globalAlpha=0.7;
        ctx.fillRect(26+i*8,H-6-bh,6,bh);ctx.globalAlpha=1;
      }

    } else if(tid==='brand'){
      // ブランディング：ラグジュアリーカード
      ctx.fillStyle=colors[0];ctx.fillRect(0,0,W,H);
      // ゴールドライン
      ctx.fillStyle=colors[1];ctx.fillRect(6,6,W-12,2);ctx.fillRect(6,H-8,W-12,2);
      ctx.fillRect(6,6,2,H-14);ctx.fillRect(W-8,6,2,H-14);
      // 中央シンボル
      ctx.fillStyle=colors[1];
      ctx.beginPath();ctx.arc(W/2,H/2-8,14,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=colors[0];
      ctx.beginPath();ctx.arc(W/2,H/2-8,9,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=colors[1];
      ctx.beginPath();ctx.arc(W/2,H/2-8,5,0,Math.PI*2);ctx.fill();
      // テキスト
      ctx.fillStyle=colors[1];ctx.fillRect(W/2-18,H/2+8,36,3);
      ctx.fillRect(W/2-10,H/2+14,20,2);

    } else if(tid==='saas'||tid==='growth'){
      // SaaS：モダンダッシュボード
      ctx.fillStyle='#f8fafc';ctx.fillRect(0,0,W,H);
      // ヘッダー
      ctx.fillStyle=colors[0];ctx.fillRect(0,0,W,14);
      ctx.fillStyle='rgba(255,255,255,0.9)';ctx.fillRect(4,4,24,6);ctx.fillRect(W-28,4,24,6);
      // メトリクス
      var mc=['#6366f1','#10b981','#f59e0b','#ef4444'];
      for(var i=0;i<4;i++){
        ctx.fillStyle=mc[i];ctx.globalAlpha=0.1;ctx.fillRect(2+i*22,16,20,16);ctx.globalAlpha=1;
        ctx.fillStyle=mc[i];ctx.fillRect(4+i*22,18,10,8);
        ctx.fillStyle='#64748b';ctx.fillRect(4+i*22,28,16,3);
      }
      // 折れ線グラフ
      ctx.fillStyle='#f1f5f9';ctx.fillRect(2,34,W-4,H-38);
      ctx.strokeStyle=colors[0];ctx.lineWidth=2;ctx.beginPath();
      var pts=[];for(var i=0;i<7;i++)pts.push([4+i*12,H-10-rc(4,24)]);
      ctx.moveTo(pts[0][0],pts[0][1]);
      pts.slice(1).forEach(function(pt){ctx.lineTo(pt[0],pt[1]);});ctx.stroke();
      ctx.fillStyle=colors[0];ctx.globalAlpha=0.15;
      ctx.beginPath();ctx.moveTo(pts[0][0],H-6);pts.forEach(function(pt){ctx.lineTo(pt[0],pt[1]);});ctx.lineTo(pts[pts.length-1][0],H-6);ctx.closePath();ctx.fill();ctx.globalAlpha=1;

    } else if(tid==='ai'){
      // AI：SF的なUI
      ctx.fillStyle='#0c0c1e';ctx.fillRect(0,0,W,H);
      // グリッド
      ctx.strokeStyle='rgba(99,102,241,0.15)';ctx.lineWidth=0.5;
      for(var i=0;i<W;i+=10){ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,H);ctx.stroke();}
      for(var i=0;i<H;i+=10){ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(W,i);ctx.stroke();}
      // 中央オーブ
      var grad=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,25);
      grad.addColorStop(0,'rgba(139,92,246,0.8)');grad.addColorStop(0.5,'rgba(99,102,241,0.4)');grad.addColorStop(1,'rgba(99,102,241,0)');
      ctx.fillStyle=grad;ctx.beginPath();ctx.arc(W/2,H/2-5,25,0,Math.PI*2);ctx.fill();
      // データライン
      for(var i=0;i<5;i++){
        ctx.strokeStyle='rgba(139,92,246,'+(0.2+rf()*0.4)+')';ctx.lineWidth=0.8;
        ctx.beginPath();ctx.moveTo(rc(0,W/3),rc(0,H));ctx.lineTo(W/2+rc(-10,10),H/2+rc(-10,10));ctx.stroke();
      }

    } else {
      // デフォルト：シンプルカード
      ctx.fillStyle=colors[3]||'#fff';ctx.fillRect(0,0,W,H);
      ctx.fillStyle=colors[0];ctx.fillRect(0,0,W,28);
      ctx.fillStyle='rgba(255,255,255,0.8)';ctx.fillRect(8,8,40,12);ctx.fillRect(8,22,24,4);
      // コンテンツブロック
      for(var i=0;i<4;i++){ctx.fillStyle=i%2?colors[1]:colors[0];ctx.globalAlpha=0.12;ctx.fillRect(8,32+i*12,W-16,9);ctx.globalAlpha=1;}
      ctx.fillStyle=colors[0];ctx.fillRect(8,32,W-16,3);
    }

    // 品質による輝き効果（高品質ほど光る）
    if(qual>=90){
      var shine=ctx.createRadialGradient(W*0.8,H*0.2,0,W*0.8,H*0.2,W*0.6);
      shine.addColorStop(0,'rgba(255,215,0,0.12)');shine.addColorStop(1,'rgba(255,215,0,0)');
      ctx.fillStyle=shine;ctx.fillRect(0,0,W,H);
    }
  },

  renderPortfolio:function(){
    var el=q('portfolio-list');if(!el)return;
    var cnt=q('portfolio-cnt');
    var portfolio=G.s.portfolio||[];
    if(cnt)cnt.textContent=portfolio.length+'件';

    // フィルターボタンのアクティブ状態
    ['all','logo','app','web','brand','saas'].forEach(function(f){
      var btn=q('pf-'+f);if(btn){btn.classList.toggle('on',G.portfolioFilter===f||(f==='saas'&&G.portfolioFilter==='growth'));}
    });

    // フィルターグループ定義
    var filterGroups={
      'print':['logo','meishi','banner','flyer','icon','poster','catalog','package','photo','signage','ir',
               'tshirt','stamp','thumbnail','menu','nengajo','map','mascot','infographic','fashion','event','nengajo','anime'],
      'app':['app','motion','game_ui','medical_app','edtech','fintech','mobility','xrplatform'],
      'web':['web','lp','sns','preso','ebook','food','realestate','agri','govtech'],
      'brand':['brand','ux_research','nft','sport'],
      'saas':['saas','growth','cx','platform','global_rebrand','ma','os_design','design_system','ai','ar_xr'],
      'mj':null // mjPromptがある全作品
    };
    var filtered=G.portfolioFilter==='all'?portfolio:portfolio.filter(function(w){
      if(G.portfolioFilter==='mj')return !!w.mjPrompt;
      var grp=filterGroups[G.portfolioFilter];
      if(grp)return grp.includes(w.tid);
      return w.tid===G.portfolioFilter;
    });

    if(!filtered.length){
      el.innerHTML='<div class="empty">'+(G.portfolioFilter==='all'?'まだ作品がありません。案件を完了すると記録されます。':'このカテゴリの作品はまだありません。')+'</div>';
      return;
    }

    // 年ごとにグルーピング
    var startY=2025, startM=4;
    function getYear(turn){return startY+Math.floor((startM-1+Math.floor((turn-1)/4))/12);}

    var grouped={};
    filtered.forEach(function(w){
      var yr=getYear(w.turn||0);
      if(!grouped[yr])grouped[yr]=[];
      grouped[yr].push(w);
    });

    var years=Object.keys(grouped).sort(function(a,b){return b-a;});
    var html='';

    years.forEach(function(yr){
      html+='<div class="pf-year-label">'+yr+'年</div>';
      html+='<div class="pf-grid-wrap">';
      grouped[yr].forEach(function(w,idx){
        var qualColor=w.qual>=85?'#10b981':w.qual>=60?'#6366f1':w.qual>=40?'#f59e0b':'#ef4444';
        var canvasId='thumb-'+w.id+'-'+idx;
        var starsNum=w.stars?w.stars.split('★').length-1:3;
        var mods=w.modCnt>0?'<span style="color:var(--warn)">修正'+w.modCnt+'回</span>':'<span style="color:var(--ok)">修正なし</span>';
        var staffTxt=w.staff?'担当: '+w.staff:'自分が担当';
        var phNames=['個人','事務所','スタジオ','会社','プロダクト','PF','Tech'];
        var phTag=phNames[Math.min(w.phase||0,6)];

        var delivHtml='';
        if(w.deliv&&w.deliv.files){
          delivHtml='<div style="margin-top:6px;border-top:1px solid var(--bord2);padding-top:6px">'
            +'<div style="font-size:6px;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">納品物</div>'
            +'<div style="display:flex;flex-direction:column;gap:2px">'
            +w.deliv.files.map(function(f2){return'<div style="font-size:6.5px;color:var(--t2);display:flex;align-items:center;gap:4px"><span style="color:var(--ok)">✓</span>'+esc(f2)+'</div>';}).join('')
            +'</div>'
            +(w.deliv.format?'<div style="font-size:6px;color:var(--t3);margin-top:3px">フォーマット: '+esc(w.deliv.format)+'</div>':'')
            +'</div>';
        }
        var mjHtml='';
        if(w.mjPrompt){
          // データ属性でプロンプトを保持してイベント委譲でコピー
          var mjIdx=G.s.portfolio.indexOf(w);
          mjHtml='<div style="margin-top:6px;border-top:1px solid var(--bord2);padding-top:5px">'
            +'<div style="font-size:6px;color:var(--t3);letter-spacing:1px;margin-bottom:3px">🎨 MJ PROMPT</div>'
            +'<div class="mj-prompt-copy" data-idx="'+mjIdx+'" style="font-size:6px;color:rgba(139,92,246,0.8);font-family:monospace;line-height:1.6;word-break:break-all;cursor:pointer;user-select:text" title="クリックでコピー">'+esc(w.mjPrompt.slice(0,100))+'…</div>'
            +'</div>';
        }
        // サムネイル部分: SVG生成済み/生成中/Canvas の3パターン
        var thumbInner='';
        if(w.svgStatus==='generating'){
          thumbInner='<div class="pf-generating"><div class="pf-gen-dot"></div><div class="pf-gen-txt">AI生成中…</div></div>';
        }else if(w.svg){
          // 生成済みSVGをサムネイルとして表示（縮小）
          var svgThumb=w.svg.replace(/<svg([^>]*)>/i,function(m,attrs){
            // viewBoxを保ってwidthとheightを削除してCSS側でフィット
            var a=attrs.replace(/\s+width="[^"]*"/g,'').replace(/\s+height="[^"]*"/g,'');
            return '<svg'+a+' style="width:100%;height:100%;object-fit:contain">';
          });
          thumbInner=svgThumb
            +'<div class="pf-thumb-overlay"><span class="pf-thumb-zoom">🔍</span></div>';
        }else{
          // Canvasサムネイル
          thumbInner='<canvas id="'+canvasId+'" width="100" height="100" style="display:block"></canvas>'
            +'<div class="pf-thumb-overlay"><span class="pf-thumb-zoom">🔍</span></div>';
          if(w.svgStatus==='error'){
            thumbInner+='<div style="position:absolute;bottom:0;left:0;right:0;font-size:6px;background:rgba(239,68,68,0.7);color:#fff;padding:2px;text-align:center">生成失敗 — 再試行可</div>';
          }else if(!G.aiDesign.getKey()){
            thumbInner+='<div style="position:absolute;bottom:0;left:0;right:0;font-size:5.5px;background:rgba(0,0,0,0.5);color:rgba(255,255,255,0.6);padding:2px;text-align:center">APIキー未設定</div>';
          }
        }
        var goldBar=w.qual>=90?'<div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),rgba(232,201,109,0.3))"></div>':'';
        var pfCardId='pf-card-'+w.id;

        html+='<div class="pf-card" id="'+pfCardId+'" onclick="G.aiDesign.openViewer(\''+w.id+'\')">'
          +'<div class="pf-thumb" style="background:#1a1a2e">'
          +thumbInner
          +goldBar
          +'</div>'
          +'<div class="pf-body">'
          +'<div class="pf-nm">'+w.tic+' '+esc(w.nm)+'</div>'
          +'<div class="pf-meta">'
          +'<span class="pf-tag">'+esc(w.tlb)+'</span>'
          +'<span class="pf-tag" style="background:rgba(99,102,241,0.1);color:#6366f1">'+phTag+'期</span>'
          +'<span style="color:var(--t3)">'+esc(w.cli)+' '+w.cliIc+'</span>'
          +'</div>'
          +'<div class="pf-stars">'+w.stars+'</div>'
          +'<div class="pf-qual">'
          +'<span style="font-size:6.5px;color:var(--t3)">品質</span>'
          +'<div class="pf-qual-bar"><div class="pf-qual-fill" style="width:'+w.qual+'%;background:'+qualColor+'"></div></div>'
          +'<span style="font-size:6.5px;color:'+qualColor+'">'+w.qual+'</span>'
          +'</div>'
          +'<div style="display:flex;justify-content:space-between;font-size:6.5px;color:var(--t3);margin-top:2px">'
          +'<span>'+staffTxt+'</span><span>'+mods+'</span>'
          +'</div>'
          +'<div class="pf-comment">'+esc(w.comment)+'</div>'
          +'<div style="font-size:6.5px;color:var(--ok);font-weight:700;margin-top:3px">'+fY(w.earned)+'</div>'
          +delivHtml
          +mjHtml
          +'<div style="margin-top:5px;display:flex;gap:5px;align-items:center">'
          +(w.svg?'<span style="font-size:6px;color:var(--ok)">✨ AI生成済み</span>':
            w.svgStatus==='generating'?'<span style="font-size:6px;color:var(--acc)">⚡ 生成中...</span>':
            w.svgStatus==='error'?'<button onclick="event.stopPropagation();G.aiDesign.regenerate(\''+w.id+'\')" style="font-size:6px;padding:2px 6px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:3px;color:var(--red);cursor:pointer">↻ 再生成</button>':
            G.aiDesign.getKey()?'<span style="font-size:6px;color:var(--t4)">（完了後に自動生成）</span>':
            '<span style="font-size:6px;color:var(--t4)">APIキーを設定するとリアルデザインに</span>')
          +'</div>'
          +'</div>'
          +'</div>';
      });
      html+='</div>';//pf-grid-wrap
    });

    el.innerHTML=html;

    // Canvas サムネイルを描画（SVG未生成のエントリのみ）
    years.forEach(function(yr){
      grouped[yr].forEach(function(w,idx){
        if(w.svg||w.svgStatus==='generating')return; // SVGあり/生成中はスキップ
        var cv=document.getElementById('thumb-'+w.id+'-'+idx);
        if(cv)G.drawThumb(cv, w.tid||'logo', w.qual||50, (w.turn||1)*997+(idx*31));
      });
    });
    // MJプロンプト コピー イベント委譲
    el.querySelectorAll('.mj-prompt-copy').forEach(function(div){
      div.addEventListener('click',function(){
        var idx=parseInt(div.getAttribute('data-idx'));
        var item=G.s.portfolio[idx];
        if(item&&item.mjPrompt){
          navigator.clipboard.writeText(item.mjPrompt).then(function(){
            div.style.color='var(--ok)';
            setTimeout(function(){div.style.color='rgba(139,92,246,0.8)';},1500);
          });
        }
      });
    });
  },

  renderProg:function(){
    var phDefs=[
      {nm:'個人事務所',    s:'収益150万+社員2名'},
      {nm:'デザイン事務所',s:'収益800万+社員5名'},
      {nm:'デザインスタジオ',s:'収益5000万+社員8名'},
      {nm:'デザイン会社',  s:'エンディング条件へ'},
      {nm:'🚀 プロダクト企業',s:'技術[プロダクト戦略]+収益1億+社員12名'},
      {nm:'🌐 プラットフォーム企業',s:'技術[PF化]+DAU20万+収益10億'},
      {nm:'⚡ テックジャイアント',s:'技術[グローバル本社]+DAU200万+収益100億'}
    ];
    q('phases').innerHTML=phDefs.map(function(p,i){return'<div class="ph '+(i<G.s.phase?'done':i===G.s.phase?'cur':'')+'"><div class="ph-n">'+(i<G.s.phase?'✓':i===G.s.phase?'●':i)+'</div><div class="ph-nm">'+p.nm+'</div><div class="ph-s">'+p.s+'</div></div>';}).join('');
    q('of-cards').innerHTML=OFFICES.map(function(o,i){var cur=G.s.offLevel===i,past=G.s.offLevel>i,can=G.s.offLevel===i-1;
      return'<div class="ofc'+(cur?' cur':past?' past':'')+'"><div class="ofc-ic">'+o.ic+'</div><div class="ofc-n">'+esc(o.nm)+(cur?' ✓':'')+'</div><div class="ofc-d">'+esc(o.desc)+'</div><div style="font-size:7px;color:var(--t3);margin-bottom:5px">評判+'+o.rp+' / 家賃'+fY(o.mc)+'/月</div><div class="ofc-f"><span class="ofc-p">'+(o.cost?fY(o.cost):'無料')+'</span>'+(can?'<button class="btn-up" '+(G.s.money<o.cost?'disabled':'')+' onclick="G.office('+i+')">移転する</button>':cur?'<span style="font-size:7px;color:var(--teal)">✓ 現在地</span>':past?'<span style="font-size:7px;color:var(--t4)">通過済み</span>':'<span style="font-size:7px;color:var(--t4)">🔒</span>')+'</div></div>';
    }).join('');
    var avgM=G.s.staff.length>0?Math.round(G.s.staff.reduce(function(a,s){return a+s.mental;},0)/G.s.staff.length):0;
    var stages=['MVP','PMF達成','スケール','グローバル展開'];
    var fmtDau=function(v){return v>=10000?Math.round(v/10000)+'万':v.toLocaleString();};
    var fmtArr=function(v){return v>=100000000?Math.round(v/100000000)+'億':v>=10000?Math.round(v/10000)+'万':'--';};
    // プロダクト指標（フェーズ4以上）
    var prodStats='';
    if(G.s.phase>=4){
      var pStage=stages[Math.min(G.s.prodStage||0,3)];
      var stageColor=G.s.prodStage>=3?'var(--gold)':G.s.prodStage>=2?'var(--ok)':G.s.prodStage>=1?'var(--acc)':'var(--t3)';
      // DAUプログレスバー
      var dauGoal=G.s.phase>=6?2000000:G.s.phase>=5?1000000:G.s.phase>=4?200000:10000;
      var dauPct=Math.min(100,Math.round((G.s.dau||0)/dauGoal*100));
      prodStats='<div style="background:linear-gradient(135deg,rgba(99,102,241,0.06),rgba(99,102,241,0.02));border:1px solid rgba(99,102,241,0.2);border-radius:10px;padding:12px;margin-top:10px">'
        +'<div style="font-size:8px;color:#6366f1;font-weight:800;letter-spacing:2px;margin-bottom:10px">📱 PRODUCT METRICS</div>'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
        +'<div style="background:var(--bg1);border-radius:6px;padding:8px"><div style="font-size:6.5px;color:var(--t3);margin-bottom:2px">DAU</div><div style="font-size:16px;font-weight:900;color:var(--acc)">'+fmtDau(G.s.dau||0)+'</div></div>'
        +'<div style="background:var(--bg1);border-radius:6px;padding:8px"><div style="font-size:6.5px;color:var(--t3);margin-bottom:2px">ARR</div><div style="font-size:16px;font-weight:900;color:var(--ok)">'+fmtArr(G.s.arr||0)+'</div></div>'
        +'<div style="background:var(--bg1);border-radius:6px;padding:8px"><div style="font-size:6.5px;color:var(--t3);margin-bottom:2px">バーンレート</div><div style="font-size:11px;font-weight:700;color:var(--warn)">'+fY(G.s.burnRate||0)+'/月</div></div>'
        +'<div style="background:var(--bg1);border-radius:6px;padding:8px"><div style="font-size:6.5px;color:var(--t3);margin-bottom:2px">調達累計</div><div style="font-size:11px;font-weight:700;color:var(--gold)">'+(G.s.funding>=100000000?Math.round(G.s.funding/100000000)+'億':'--')+'</div></div>'
        +'</div>'
        +'<div style="margin-bottom:6px">'
        +'<div style="display:flex;justify-content:space-between;font-size:6.5px;color:var(--t3);margin-bottom:3px"><span>プロダクトステージ：<b style="color:'+stageColor+'">'+pStage+'</b></span><span>次の目標 DAU '+fmtDau(dauGoal)+'</span></div>'
        +'<div style="background:var(--bg3);border-radius:4px;height:6px"><div style="width:'+dauPct+'%;height:100%;background:linear-gradient(90deg,#6366f1,#a78bfa);border-radius:4px;transition:width .5s"></div></div>'
        +'</div>'
        +'</div>';
    }
    q('statbox').innerHTML='<div class="si">累計収益<b>'+fY(G.s.totalRev)+'</b></div><div class="si">完了案件<b>'+G.s.projDone+'件</b></div><div class="si">総修正回数<b>'+G.s.totalMods+'回</b></div><div class="si">受賞歴<b>'+G.s.awards+'件</b></div><div class="si">社員数<b>'+G.s.staff.length+'名</b></div><div class="si">SNS<b>'+G.s.sns.toLocaleString()+'</b></div><div class="si">平均メンタル<b>'+avgM+'</b></div><div class="si">現在資産<b>'+fY(G.s.money)+'</b></div><div class="si">炎上<b>'+G.s.fire+'%</b></div><div class="si">ブラック度<b>'+G.s.black+'%</b></div><div class="si">WBスコア<b>'+(G.s.wb||50)+'</b></div><div class="si">制度数<b>'+Object.keys(G.s.policies||{}).length+'件</b></div><div class="si">国際スタッフ<b>'+(G.s.intlStaff||0)+'名</b></div>'+prodStats;
  },

  // ─── RENDER POLICY ─────────────────────────────────────────
  renderPolicy:function(){
    var s=G.s;
    var adopted=s.policies||{};
    var container=q('pan-policy');
    if(!container)return;
    var wbBar='<div style="padding:12px 12px 0">'
      +'<div class="sh" style="margin-bottom:8px">🌿 ウェルビーイング制度 <span class="ct">'+Object.keys(adopted).length+'件導入</span></div>'
      +'<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;background:var(--bg2);border-radius:var(--r-lg);padding:10px 12px">'
      +'<div style="font-size:11px;color:var(--t2);white-space:nowrap">WBスコア</div>'
      +'<div style="flex:1"><div class="wb-bar-wrap"><div class="wb-bar-fill" style="width:'+(s.wb||50)+'%;background:'+(s.wb>=70?'var(--ok)':s.wb>=40?'var(--acc)':'var(--red)')+'"></div></div></div>'
      +'<div style="font-size:14px;font-weight:700;color:'+(s.wb>=70?'var(--ok)':s.wb>=40?'var(--acc)':'var(--red)')+'">'+Math.round(s.wb||50)+'</div>'
      +'</div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">'
      +(s.bases||['kyoto']).map(function(b){
        var labels={kyoto:'🍵 京都',niigata:'🌾 新潟',tokyo:'🏙️ 東京',seoul:'🇰🇷 Seoul',ny:'🗽 NY',london:'🇬🇧 LDN'};
        return '<div class="base-chip active">'+(labels[b]||b)+'</div>';
      }).join('')
      +'</div>'
      +'</div>';

    var cats=Object.keys(POLICY_CATS);
    var polHtml=cats.map(function(cat){
      var pols=POLICIES.filter(function(p){return p.cat===cat;});
      return '<div style="padding:0 12px 8px">'
        +'<div class="pol-cat-hd">'+POLICY_CATS[cat]+'</div>'
        +'<div class="pol-grid">'
        +pols.map(function(p){
          var isAdopted=!!adopted[p.id];
          var locked=p.reqPhase&&s.phase<p.reqPhase;
          var canAfford=s.money>=p.cost;
          var tags='<div class="pol-tags">'
            +'<span class="pol-tag pt-wb">🌿 WB+'+p.wb+'</span>'
            +'<span class="pol-tag pt-bk">BK'+p.black+'</span>'
            +(p.cost>0?'<span class="pol-tag" style="background:var(--bg3);color:var(--t3)">'+fY(p.cost)+'</span>':'')
            +(locked?'<span class="pol-tag" style="background:rgba(239,68,68,.1);color:var(--red)">PH'+p.reqPhase+'以降</span>':'')
            +'</div>';
          var action=isAdopted
            ?'<div style="font-size:9px;color:var(--ok);font-weight:700">✓ 導入済み</div>'
            :locked?'<div style="font-size:9px;color:var(--t4)">🔒 フェーズ不足</div>'
            :'<button onclick="G.adoptPolicy(\''+p.id+'\')" style="font-size:9px;padding:3px 10px;border-radius:6px;border:1px solid var(--acc);color:var(--acc);background:var(--acc-lt);cursor:pointer;'+(canAfford?'':';opacity:.5;pointer-events:none')+'">導入する</button>';
          return '<div class="pol-card'+(isAdopted?' adopted':'')+'">'
            +'<div class="pol-head"><div class="pol-nm">'+p.ic+' '+p.nm+'</div>'+action+'</div>'
            +'<div style="font-size:10px;color:var(--t2);line-height:1.6;margin-bottom:4px">'+esc(p.desc)+'</div>'
            +tags
            +'</div>';
        }).join('')
        +'</div></div>';
    }).join('');

    container.innerHTML=wbBar+polHtml;
  },

  // ─── RENDER WORLD ──────────────────────────────────────────
  // ── Canvas世界地図描画 ────────────────────────────────────
  _worldMapRaf:null,
  _drawWorldMap:function(STUDIOS,active){
    var cv=document.getElementById('world-cv');
    if(!cv)return;
    var W=cv.offsetWidth||800,H=cv.offsetHeight||400;
    cv.width=W;cv.height=H;
    var ctx=cv.getContext('2d');

    // 座標変換（lon,lat → canvas px）
    function px(lon,lat){
      return {x:(lon+180)/360*W, y:(90-lat)/180*H};
    }

    // ── 大陸データ [lon, lat] 配列 ──────────────────────────
    var CONTINENTS=[
      // 北アメリカ
      {name:'namerica',color:'#2a3f6f',stroke:'rgba(100,130,220,0.4)',pts:[
        [-168,72],[-140,72],[-130,68],[-120,58],[-110,50],[-95,50],[-85,48],
        [-80,44],[-75,40],[-72,38],[-70,34],[-74,28],[-80,24],[-85,20],
        [-90,16],[-86,10],[-80,8],[-78,12],[-76,18],[-80,22],[-84,26],
        [-88,30],[-90,34],[-92,38],[-95,42],[-100,44],[-105,42],[-112,38],
        [-118,34],[-122,37],[-124,40],[-126,46],[-128,52],[-130,56],
        [-140,62],[-148,62],[-155,58],[-162,54],[-168,60],[-172,64],[-168,72]
      ]},
      // グリーンランド
      {name:'greenland',color:'#233558',stroke:'rgba(80,110,200,0.3)',pts:[
        [-44,83],[-28,82],[-18,78],[-20,74],[-28,70],[-42,66],[-50,66],
        [-58,68],[-62,72],[-58,76],[-48,80],[-44,83]
      ]},
      // 南アメリカ
      {name:'samerica',color:'#2a3f6f',stroke:'rgba(100,130,220,0.4)',pts:[
        [-80,12],[-76,10],[-72,12],[-68,12],[-64,10],[-60,8],[-52,4],
        [-48,0],[-44,-4],[-40,-8],[-38,-12],[-38,-18],[-40,-22],[-44,-24],
        [-48,-28],[-50,-30],[-52,-34],[-56,-38],[-64,-42],[-68,-46],
        [-70,-50],[-68,-54],[-66,-56],[-70,-56],[-74,-52],[-72,-46],
        [-70,-42],[-68,-36],[-66,-30],[-68,-24],[-70,-18],[-76,-14],
        [-80,-8],[-80,-2],[-78,4],[-78,8],[-80,12]
      ]},
      // ヨーロッパ（西部）
      {name:'europe',color:'#2a3f6f',stroke:'rgba(100,130,220,0.4)',pts:[
        [-10,36],[-6,36],[-2,38],[4,44],[8,46],[10,48],[14,50],[18,52],
        [22,54],[24,56],[26,58],[28,60],[30,62],[28,64],[24,66],[20,68],
        [16,70],[14,68],[10,66],[6,64],[2,62],[0,58],[-2,54],[-4,50],
        [-4,44],[-8,40],[-10,36]
      ]},
      // スカンジナビア
      {name:'scandinavia',color:'#233a66',stroke:'rgba(100,130,220,0.3)',pts:[
        [4,58],[6,58],[10,58],[14,56],[18,58],[22,60],[26,62],[28,64],
        [26,68],[22,70],[18,70],[14,68],[10,64],[6,62],[4,58]
      ]},
      // アフリカ
      {name:'africa',color:'#2a3f6f',stroke:'rgba(100,130,220,0.4)',pts:[
        [-18,16],[-16,12],[-14,10],[-12,8],[-10,6],[-8,4],[-6,4],
        [0,6],[4,6],[8,6],[12,4],[14,4],[16,2],[18,-2],[20,-6],[22,-10],
        [26,-14],[28,-18],[32,-22],[34,-24],[34,-28],[30,-32],[28,-34],
        [26,-34],[22,-36],[18,-34],[16,-30],[14,-26],[12,-22],[10,-18],
        [10,-14],[8,-10],[6,-6],[4,-2],[2,4],[-2,4],[-4,8],[-8,12],
        [-14,14],[-18,16]
      ]},
      // マダガスカル
      {name:'madagascar',color:'#233a66',stroke:'rgba(80,110,200,0.3)',pts:[
        [44,-12],[48,-14],[50,-18],[50,-22],[48,-24],[46,-24],[44,-20],[44,-16],[44,-12]
      ]},
      // アジア（メイン）
      {name:'asia',color:'#2a3f6f',stroke:'rgba(100,130,220,0.4)',pts:[
        [26,58],[30,60],[36,62],[40,58],[44,54],[48,50],[52,46],[56,44],
        [60,42],[64,40],[68,38],[72,36],[74,34],[76,30],[80,28],[84,26],
        [88,24],[90,22],[92,22],[94,22],[96,20],[100,18],[102,16],[104,14],
        [102,10],[100,6],[104,4],[108,4],[112,4],[116,8],[118,12],[120,16],
        [122,20],[124,24],[126,28],[128,32],[128,36],[126,38],[124,40],
        [122,40],[120,40],[118,42],[114,44],[110,46],[108,50],[106,52],
        [102,54],[98,56],[92,56],[86,56],[80,56],[74,56],[68,54],[62,52],
        [56,52],[50,52],[44,52],[38,56],[34,58],[30,60],[26,58]
      ]},
      // インド半島
      {name:'india',color:'#253862',stroke:'rgba(80,110,200,0.3)',pts:[
        [68,24],[72,22],[76,20],[80,18],[84,16],[80,10],[76,8],[72,8],
        [70,10],[68,14],[68,18],[68,24]
      ]},
      // 東南アジア（インドシナ）
      {name:'indochina',color:'#233a66',stroke:'rgba(80,110,200,0.3)',pts:[
        [98,22],[102,20],[106,18],[104,14],[102,10],[100,6],[98,8],
        [100,12],[100,16],[98,18],[96,16],[94,20],[96,22],[98,22]
      ]},
      // 朝鮮半島
      {name:'korea',color:'#1e3055',stroke:'rgba(80,110,200,0.3)',pts:[
        [124,38],[126,36],[128,34],[128,36],[126,38],[124,38]
      ]},
      // オーストラリア
      {name:'australia',color:'#2a3f6f',stroke:'rgba(100,130,220,0.4)',pts:[
        [114,-22],[116,-20],[118,-18],[122,-16],[126,-14],[130,-12],[134,-12],
        [138,-12],[142,-10],[146,-12],[150,-14],[152,-18],[152,-22],[150,-28],
        [148,-34],[146,-38],[142,-38],[138,-36],[134,-34],[130,-32],[126,-30],
        [122,-26],[118,-24],[114,-22]
      ]},
      // 日本（本州）
      {name:'japan_honshu',color:'#4f46e5',stroke:'rgba(140,130,255,0.6)',pts:[
        [130,32],[132,34],[134,36],[136,36],[138,36],[140,38],[142,40],
        [141,42],[139,40],[137,38],[135,36],[133,34],[131,34],[130,32]
      ]},
      // 北海道
      {name:'japan_hokkaido',color:'#4338ca',stroke:'rgba(140,130,255,0.5)',pts:[
        [140,42],[142,44],[144,44],[145,44],[144,42],[142,42],[140,42]
      ]},
      // イギリス
      {name:'uk',color:'#233a66',stroke:'rgba(80,110,200,0.3)',pts:[
        [-4,56],[-2,58],[0,58],[0,54],[-2,50],[-4,52],[-4,56]
      ]},
      // イベリア半島
      {name:'iberia',color:'#233a66',stroke:'rgba(80,110,200,0.3)',pts:[
        [-10,36],[-6,36],[-4,38],[0,38],[2,40],[0,44],[-2,44],[-4,44],
        [-6,42],[-8,40],[-10,38],[-10,36]
      ]},
      // イタリア半島
      {name:'italy',color:'#1e3055',stroke:'rgba(80,110,200,0.3)',pts:[
        [8,44],[10,44],[12,44],[14,42],[16,40],[18,38],[16,38],[14,40],[12,42],[8,44]
      ]},
    ];

    // ── 描画開始 ──────────────────────────────────────────────
    // 海洋グラデーション
    var seaGrad=ctx.createLinearGradient(0,0,0,H);
    seaGrad.addColorStop(0,'#060d1f');
    seaGrad.addColorStop(0.5,'#0c1a35');
    seaGrad.addColorStop(1,'#040a16');
    ctx.fillStyle=seaGrad;
    ctx.fillRect(0,0,W,H);

    // 海の微細テクスチャ（薄いノイズ）
    for(var ny2=0;ny2<H;ny2+=4){
      for(var nx2=0;nx2<W;nx2+=4){
        var v=Math.sin(nx2*0.07+ny2*0.05)*Math.cos(nx2*0.03-ny2*0.08)*8;
        ctx.fillStyle='rgba(30,60,120,'+Math.max(0,v*0.004)+')';
        ctx.fillRect(nx2,ny2,4,4);
      }
    }

    // 緯線・経線グリッド
    ctx.strokeStyle='rgba(80,120,220,0.06)';
    ctx.lineWidth=0.5;
    for(var lat=-60;lat<=60;lat+=30){
      var yg=px(0,lat).y;
      ctx.beginPath();ctx.moveTo(0,yg);ctx.lineTo(W,yg);ctx.stroke();
    }
    for(var lon=-150;lon<=150;lon+=60){
      var xg=px(lon,0).x;
      ctx.beginPath();ctx.moveTo(xg,0);ctx.lineTo(xg,H);ctx.stroke();
    }
    // 赤道
    ctx.strokeStyle='rgba(99,102,241,0.12)';
    ctx.lineWidth=0.8;
    ctx.setLineDash([6,6]);
    var yeq=px(0,0).y;
    ctx.beginPath();ctx.moveTo(0,yeq);ctx.lineTo(W,yeq);ctx.stroke();
    ctx.setLineDash([]);

    // ── 大陸描画 ──────────────────────────────────────────────
    CONTINENTS.forEach(function(c){
      if(!c.pts||c.pts.length<3)return;
      ctx.beginPath();
      var p0=px(c.pts[0][0],c.pts[0][1]);
      ctx.moveTo(p0.x,p0.y);
      for(var i=1;i<c.pts.length;i++){
        // Catmull-Rom風の滑らかな補間
        var p1=px(c.pts[i][0],c.pts[i][1]);
        if(i<c.pts.length-1){
          var p2=px(c.pts[Math.min(i+1,c.pts.length-1)][0],c.pts[Math.min(i+1,c.pts.length-1)][1]);
          ctx.bezierCurveTo(
            (p0.x+p1.x)/2,(p0.y+p1.y)/2,
            (p1.x+p2.x)/2,(p1.y+p2.y)/2,
            p1.x,p1.y
          );
          p0=p1;
        }else{
          ctx.lineTo(p1.x,p1.y);
        }
      }
      ctx.closePath();
      ctx.fillStyle=c.color;
      ctx.fill();
      // 輪郭
      ctx.strokeStyle=c.stroke;
      ctx.lineWidth=0.8;
      ctx.stroke();

      // 陸地に微細ハイライト（上端に薄いグロー）
      ctx.strokeStyle='rgba(120,160,255,0.04)';
      ctx.lineWidth=2;
      ctx.stroke();
    });

    // 日本列島ハイライト（ゲームのホーム国）
    ctx.shadowColor='rgba(99,102,241,0.6)';
    ctx.shadowBlur=8;
    var japanPts=CONTINENTS.find(function(c){return c.name==='japan_honshu';});
    if(japanPts){
      ctx.beginPath();
      var p0j=px(japanPts.pts[0][0],japanPts.pts[0][1]);
      ctx.moveTo(p0j.x,p0j.y);
      japanPts.pts.forEach(function(pt){var p=px(pt[0],pt[1]);ctx.lineTo(p.x,p.y);});
      ctx.closePath();
      ctx.fillStyle='rgba(99,102,241,0.5)';
      ctx.fill();
      ctx.strokeStyle='rgba(140,130,255,0.8)';
      ctx.lineWidth=1;
      ctx.stroke();
    }
    ctx.shadowBlur=0;

    // ── 拠点座標 (lon, lat) ──────────────────────────────────
    var STUDIO_GEO={
      kyoto:    {lon:135.8, lat:35.0},
      tokyo:    {lon:139.7, lat:35.7},
      niigata:  {lon:138.9, lat:37.9},
      seoul:    {lon:126.9, lat:37.6},
      singapore:{lon:103.8, lat:1.3},
      berlin:   {lon:13.4,  lat:52.5},
      london:   {lon:-0.1,  lat:51.5},
      ny:       {lon:-74.0, lat:40.7},
    };

    // ── 接続アーク（京都→各拠点）──────────────────────────
    var kyotoGeo=STUDIO_GEO.kyoto;
    var kPx=px(kyotoGeo.lon,kyotoGeo.lat);
    active.forEach(function(st){
      if(st.id==='kyoto')return;
      var geo=STUDIO_GEO[st.id];if(!geo)return;
      var tPx=px(geo.lon,geo.lat);
      // 大弧アーク（制御点を上方向に持ち上げる）
      var mx=(kPx.x+tPx.x)/2;
      var my=(kPx.y+tPx.y)/2;
      var dist=Math.sqrt(Math.pow(tPx.x-kPx.x,2)+Math.pow(tPx.y-kPx.y,2));
      var arcH=Math.min(dist*0.35,H*0.3);
      var cpx=mx;
      var cpy=my-arcH;
      ctx.beginPath();
      ctx.moveTo(kPx.x,kPx.y);
      ctx.quadraticCurveTo(cpx,cpy,tPx.x,tPx.y);
      var grad=ctx.createLinearGradient(kPx.x,kPx.y,tPx.x,tPx.y);
      grad.addColorStop(0,'rgba(99,102,241,0.7)');
      grad.addColorStop(0.5,'rgba(139,92,246,0.4)');
      grad.addColorStop(1,'rgba('+G._hexToRgb(st.color||'#6366f1')+',0.7)');
      ctx.strokeStyle=grad;
      ctx.lineWidth=1.2;
      ctx.setLineDash([3,4]);
      ctx.stroke();
      ctx.setLineDash([]);
    });

    // ── 拠点ドット描画 ───────────────────────────────────────
    var t=Date.now();
    STUDIOS.forEach(function(st){
      var geo=STUDIO_GEO[st.id];if(!geo)return;
      var p=px(geo.lon,geo.lat);
      var col=st.color||'#6366f1';
      var rgb=G._hexToRgb(col);

      if(st.locked){
        // ロック: 薄いドット
        ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);
        ctx.fillStyle='rgba(255,255,255,0.1)';ctx.fill();
        ctx.strokeStyle='rgba(255,255,255,0.08)';ctx.lineWidth=0.6;ctx.stroke();
      }else{
        // パルスリング（アクティブ拠点のみ）
        var pulse=(Math.sin(t*0.002+STUDIOS.indexOf(st)*1.3)+1)/2;
        var ringR=8+pulse*6;
        ctx.beginPath();ctx.arc(p.x,p.y,ringR,0,Math.PI*2);
        ctx.strokeStyle='rgba('+rgb+','+(0.3-pulse*0.25)+')';
        ctx.lineWidth=1;ctx.stroke();

        var ringR2=12+pulse*8;
        ctx.beginPath();ctx.arc(p.x,p.y,ringR2,0,Math.PI*2);
        ctx.strokeStyle='rgba('+rgb+','+(0.12-pulse*0.1)+')';
        ctx.lineWidth=0.8;ctx.stroke();

        // グローエフェクト
        ctx.shadowColor=col;ctx.shadowBlur=14;
        ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);
        ctx.fillStyle=col;ctx.fill();
        ctx.shadowBlur=0;

        // 中心白点
        ctx.beginPath();ctx.arc(p.x,p.y,2,0,Math.PI*2);
        ctx.fillStyle='rgba(255,255,255,0.95)';ctx.fill();

        // ラベル（シティ名）
        ctx.font='bold '+Math.round(W/80)+'px sans-serif';
        ctx.textAlign='center';
        ctx.fillStyle='rgba(255,255,255,0.85)';
        ctx.shadowColor='rgba(0,0,0,0.8)';ctx.shadowBlur=4;
        var lbl=st.nm.replace('スタジオ','').replace('オフィス','').replace(' Hub','').split(' ')[0];
        ctx.fillText(lbl,p.x,p.y-10);
        ctx.shadowBlur=0;

        // クリックエリア登録（canvas外のオーバーレイdiv）
        // → HTMLで<div>を使ってオーバーレイ配置
      }
    });

    // ACTIVE表示
    ctx.font='bold '+Math.round(W/90)+'px sans-serif';
    ctx.textAlign='left';
    ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.fillText('WORLD STUDIOS  '+active.length+'/'+STUDIOS.length+' ACTIVE',8,H-8);

    // ── クリックオーバーレイ（div）──────────────────────────
    var mapEl=document.getElementById('world-map');
    if(mapEl){
      // 既存オーバーレイを削除してから再生成
      mapEl.querySelectorAll('.map-hit').forEach(function(el){el.remove();});
      active.forEach(function(st){
        var geo=STUDIO_GEO[st.id];if(!geo)return;
        var p=px(geo.lon,geo.lat);
        var xPct=(p.x/W*100).toFixed(2);
        var yPct=(p.y/H*100).toFixed(2);
        var hit=document.createElement('div');
        hit.className='map-hit';
        hit.style.cssText='position:absolute;left:'+xPct+'%;top:'+yPct+'%;'
          +'transform:translate(-50%,-50%);width:28px;height:28px;'
          +'border-radius:50%;cursor:pointer;z-index:10;';
        hit.title=st.nm;
        hit.onclick=function(){G.openWorldCity(st.id);};
        mapEl.appendChild(hit);
      });
      // アニメーションループ（パルス更新）
      if(G._worldMapRaf)cancelAnimationFrame(G._worldMapRaf);
      var _lastFrame=0;
      var _animFn=function(ts){
        if(ts-_lastFrame>50){// 20fps
          _lastFrame=ts;
          if(document.getElementById('world-cv'))G._drawWorldMap(STUDIOS,active);
        }
        if(document.getElementById('world-cv'))G._worldMapRaf=requestAnimationFrame(_animFn);
      };
      G._worldMapRaf=requestAnimationFrame(_animFn);
    }
  },

  // 16進色をRGB文字列に変換
  _hexToRgb:function(hex){
    var r=parseInt(hex.slice(1,3),16);
    var g=parseInt(hex.slice(3,5),16);
    var b=parseInt(hex.slice(5,7),16);
    return r+','+g+','+b;
  },

  // 拠点マスターデータ（renderWorldとopenWorldCityで共有）
  _getStudios:function(){
    var s=G.s;
    return [
      {id:'kyoto',   nm:'京都スタジオ',    ic:'🍵',country:'JP', px:73,py:36, locked:false,
       unlock:'常時開放', desc:'創業の地。世界に誇る本拠地。',
       color:'#a67c52', landmarks:['🏯','⛩️','🎋'], vibe:'Wabi-sabi meets innovation'},
      {id:'tokyo',   nm:'東京オフィス',    ic:'🏙️',country:'JP', px:75,py:34, locked:s.offLevel<3,
       unlock:'Phase2 + 東京オフィス取得', desc:'案件の拠点。クライアントとの接点。',
       color:'#ef4444', landmarks:['🗼','🌆','🚄'], vibe:'Speed & precision'},
      {id:'niigata', nm:'新潟サテライト',  ic:'🌾',country:'JP', px:73,py:31, locked:!(s.policies||{})['niigata_base'],
       unlock:'制度: 新潟サテライト正式化', desc:'田園の中のクリエイティブ拠点。',
       color:'#22c55e', landmarks:['🌾','⛰️','🍚'], vibe:'Slow & deep design'},
      {id:'seoul',   nm:'ソウルスタジオ', ic:'🇰🇷',country:'KR', px:70,py:33, locked:!(s.policies||{})['intl_exchange'],
       unlock:'グローバル交流制度導入後', desc:'Kデザインの最前線。',
       color:'#3b82f6', landmarks:['🏛️','💡','📱'], vibe:'K-design culture'},
      {id:'singapore',nm:'Singapore Hub',  ic:'🇸🇬',country:'SG', px:68,py:54, locked:s.phase<4,
       unlock:'Phase4以降', desc:'東南アジアのデザインハブ。',
       color:'#f59e0b', landmarks:['🌴','🦁','🌊'], vibe:'East meets West'},
      {id:'berlin',  nm:'Berlinスタジオ', ic:'🇩🇪',country:'DE', px:48,py:27, locked:s.phase<6,
       unlock:'Phase6到達後', desc:'バウハウスの精神を継ぐ拠点。',
       color:'#8b5cf6', landmarks:['🏛️','🎨','🚪'], vibe:'Bauhaus discipline'},
      {id:'london',  nm:'London Office',  ic:'🇬🇧',country:'UK', px:43,py:26, locked:!s.tech['global'],
       unlock:'global_expandテック習得後', desc:'ヨーロッパ市場への窓口。',
       color:'#64748b', landmarks:['🎡','🏰','☂️'], vibe:'Classic & bold'},
      {id:'ny',      nm:'New York Studio',ic:'🗽',country:'US', px:22,py:31, locked:s.offLevel<4,
       unlock:'offLevel≥4 + 世界スタジオオフィス', desc:'グローバルクリエイティブの中心。',
       color:'#f97316', landmarks:['🗽','🌃','🏙️'], vibe:'Go big or go home'},
    ];
  },

  renderWorld:function(){
    var container=q('pan-world');if(!container)return;
    var s=G.s;
    var STUDIOS=G._getStudios();
    var active=STUDIOS.filter(function(st){return !st.locked;});
    var totalStaff=s.staff.length;
    var intlStaff=(s.intlStaff||0);

    // ── 世界地図 SVG（aspect-ratio:2/1で表示） ──────────────
    // ── Canvas世界地図（高品質描画） ──────────────────────────
    var mapHtml='<div class="world-map-area" id="world-map">'
      +'<canvas id="world-cv" style="display:block;width:100%;height:100%"></canvas>'
      +'</div>';
    // ── ここまで地図 ──

    // サマリーバー
    var summaryHtml='<div class="world-hdr">'
      +'<div style="font-size:12.5px;font-weight:700;color:var(--t1)">🌍 ワールドスタジオ</div>'
      +'<div style="display:flex;gap:12px">'
      +'<div style="text-align:center"><div style="font-size:16px;font-weight:700;color:var(--acc)">'+active.length+'</div><div style="font-size:9px;color:var(--t4)">拠点</div></div>'
      +'<div style="text-align:center"><div style="font-size:16px;font-weight:700;color:var(--t1)">'+totalStaff+'</div><div style="font-size:9px;color:var(--t4)">総スタッフ</div></div>'
      +'<div style="text-align:center"><div style="font-size:16px;font-weight:700;color:var(--teal)">'+intlStaff+'</div><div style="font-size:9px;color:var(--t4)">国際人材</div></div>'
      +'</div>'
      +'</div>';

    // スタジオカードグリッド
    var cardsHtml='<div class="world-grid">';
    STUDIOS.forEach(function(st){
      var stStaff=st.locked?0:Math.max(1,Math.floor(totalStaff*(st.id==='kyoto'?0.4:st.id==='tokyo'?0.25:0.08)));
      var stRev=st.locked?0:Math.round((s.totalRev||0)*(st.id==='kyoto'?0.5:st.id==='tokyo'?0.3:0.05));
      cardsHtml+='<div class="studio-card'+(st.locked?' locked':'')+'">'
        +'<div class="studio-nm"><span class="studio-ic">'+st.ic+'</span>'+st.nm+'</div>';
      if(st.locked){
        cardsHtml+='<div class="studio-unlock">🔒 '+st.unlock+'</div>';
      }else{
        cardsHtml+='<div style="font-size:9.5px;color:var(--t3);margin-bottom:2px">'+st.desc+'</div>'
          +'<div class="studio-stat">'
          +'<div class="studio-stat-item"><div class="studio-stat-val">'+stStaff+'名</div><div>スタッフ</div></div>'
          +'<div class="studio-stat-item"><div class="studio-stat-val">'+fY(stRev)+'</div><div>累計売上</div></div>'
          +'<div class="studio-stat-item"><div class="studio-stat-val '+((s.wb||50)>=70?'':'') +'">'+Math.round((s.wb||50))+'</div><div>WBスコア</div></div>'
          +'</div>';
      }
      cardsHtml+='</div>';
    });
    cardsHtml+='</div>';

    // 解放ガイド（未解放拠点がある場合）
    var lockedStudios=STUDIOS.filter(function(st){return st.locked;});
    var guideHtml='';
    if(lockedStudios.length){
      guideHtml='<div style="padding:12px 14px;background:var(--bg2);border-top:1px solid var(--bord)">'
        +'<div style="font-size:10px;font-weight:700;color:var(--t3);letter-spacing:.5px;margin-bottom:6px">🔒 次の拠点を解放するには</div>'
        +lockedStudios.slice(0,3).map(function(st){
          return '<div style="font-size:10px;color:var(--t2);padding:3px 0;border-bottom:1px solid var(--bord)">'+st.ic+' <b>'+st.nm+'</b> — '+st.unlock+'</div>';
        }).join('')
        +'</div>';
    }

    container.innerHTML=mapHtml+summaryHtml+cardsHtml+guideHtml;
    // Canvas描画（innerHTML設定後に実行）
    // 既存RAFを停止してから新しいループを開始
    if(G._worldMapRaf){cancelAnimationFrame(G._worldMapRaf);G._worldMapRaf=null;}
    G._drawWorldMap(STUDIOS,active);
    // パルスアニメーションループ（描画のみ、DOM操作なし）
    var _wmLastFrame=0;
    var _wmLoop=function(ts){
      if(!document.getElementById('world-cv')){G._worldMapRaf=null;return;}
      if(ts-_wmLastFrame>80){// 12fps - パルス更新に十分
        _wmLastFrame=ts;
        try{G._drawWorldMap(STUDIOS,active);}catch(e2){}
      }
      G._worldMapRaf=requestAnimationFrame(_wmLoop);
    };
    G._worldMapRaf=requestAnimationFrame(_wmLoop);
  },

  // ─── ADOPT POLICY ──────────────────────────────────────────
  adoptPolicy:function(pid){
    var s=G.s;
    var pol=POLICIES.find(function(p){return p.id===pid;});
    if(!pol)return;
    if(s.policies[pid])return;
    if(s.money<pol.cost){notify('資金が不足しています','warn');return;}
    s.money-=pol.cost;
    s.policies[pid]=true;
    s.wb=clamp((s.wb||50)+pol.wb,0,100);
    s.black=clamp(s.black+pol.black,0,100);
    if(pol.eff)pol.eff(s);
    SFX.good();
    PTCL.burst(window.innerWidth/2,window.innerHeight*0.5,'hire');
    notify('「'+pol.nm+'」を導入しました！ WB +'+pol.wb+' / BK '+pol.black,'ok');
    addLog('[制度] '+pol.nm+' 導入','good');
    G.updateHUD();G.renderPolicy();
  },
};

// ─── PARTICLE SYSTEM ─────────────────────────────────────────
var PTCL=(function(){
  // パーティクル一時無効
  return{burst:function(){},stop:function(){}};
  var canvas=null,ctx=null,particles=[],raf=null,running=false;
  var COLORS={
    coin:['#f59e0b','#fbbf24','#fde68a','#f97316'],
    star:['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#ddd6fe'],
    hire:['#22c55e','#34d399','#6ee7b7','#86efac'],
    lvup:['#00b4d8','#0096c7','#7ee8fa','#ffffff'],
  };
  function init(){
    canvas=q('ptcl-canvas');if(!canvas)return false;
    ctx=canvas.getContext('2d');
    function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
    resize();window.addEventListener('resize',resize);
    return true;
  }
  function loop(){
    if(!ctx)return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles=particles.filter(function(p){
      p.x+=p.vx;p.y+=p.vy;p.vy+=0.25;p.life-=1;p.r*=0.97;
      if(p.life<=0||p.r<0.5)return false;
      ctx.save();ctx.globalAlpha=Math.min(1,p.life/15);
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=p.col;ctx.fill();ctx.restore();
      return true;
    });
    if(particles.length>0)raf=requestAnimationFrame(loop);
    else{running=false;if(ctx)ctx.clearRect(0,0,canvas.width,canvas.height);}
  }
  return{
    burst:function(x,y,type,count){
      if(!canvas&&!init())return;
      var cols=COLORS[type]||COLORS.coin;
      var n=count||30;
      for(var i=0;i<n;i++){
        var angle=Math.random()*Math.PI*2;
        var speed=2+Math.random()*6;
        particles.push({
          x:x+(Math.random()-0.5)*60,y:y+(Math.random()-0.5)*30,
          vx:Math.cos(angle)*speed*(Math.random()*0.6+0.4),
          vy:Math.sin(angle)*speed-4,
          r:3+Math.random()*6,life:30+Math.random()*30,
          col:cols[Math.floor(Math.random()*cols.length)]
        });
      }
      if(!running){running=true;loop();}
    }
  };
})();

// ─── INIT ────────────────────────────────────────────────────
window.addEventListener('load',function(){
  initAC();
  setTimeout(function(){
    q('SCR_LOAD').style.display='none';
    q('SCR_TITLE').style.display='flex';
    G.startTC();
    if(!localStorage.getItem('dcfk_v3')){var bl=document.querySelector('.t-btn.sec');if(bl)bl.style.opacity='.4';}
    var lf=document.createElement('link');lf.rel='stylesheet';lf.href='https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap';document.head.appendChild(lf);
  },1700);
});

document.addEventListener('keydown',function(e){
  if(!q('GAME')||q('GAME').style.display==='none')return;
  if(q('modal-ev').classList.contains('open')||q('modal-mod').classList.contains('open')||q('modal-rev').classList.contains('open'))return;
  if(e.key===' '){e.preventDefault();G.nextTurn();}
  else if(e.key==='1')G.tab('dash');
  else if(e.key==='2')G.tab('proj');
  else if(e.key==='3')G.tab('active');
  else if(e.key==='4')G.tab('staff');
  else if(e.key==='5')G.tab('hire');
  else if(e.key==='6')G.tab('tech');
  else if(e.key==='7')G.tab('prog');
  else if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();G.save();}
});

document.addEventListener('click',function(){if(AC&&AC.state==='suspended')AC.resume();},{ once:true });



</script>


<style>
#adm-btn{position:fixed;bottom:14px;left:14px;z-index:9900;width:30px;height:30px;border-radius:50%;background:rgba(99,102,241,.18);border:1px solid rgba(99,102,241,.35);color:#818cf8;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.55;transition:all .2s;padding:0;}
#adm-btn:hover{opacity:1;background:rgba(99,102,241,.35);}
#adm-ov{position:fixed;inset:0;z-index:9901;background:rgba(0,0,0,.72);backdrop-filter:blur(5px);display:none;align-items:center;justify-content:center;}
#adm-ov.open{display:flex;}
#adm-pan{width:min(680px,95vw);max-height:90vh;background:#0d0d1c;border:1px solid #252540;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,.85);}
#adm-head{padding:16px 20px;background:#0a0a18;border-bottom:1px solid #1c1c30;display:flex;align-items:center;justify-content:space-between;font-size:11px;font-weight:700;letter-spacing:3px;color:#6366f1;text-transform:uppercase;}
#adm-head button{background:none;border:1px solid #333;color:#666;width:26px;height:26px;border-radius:6px;cursor:pointer;font-size:13px;}
#adm-head button:hover{color:#fff;border-color:#666;}
#adm-body{overflow-y:auto;padding:0 0 12px;}
.adm-pre{padding:12px 18px;background:#08081a;border-bottom:1px solid #181828;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.adm-pre label{font-size:9px;color:#555;text-transform:uppercase;letter-spacing:1px;margin-right:4px;}
.pb{padding:5px 14px;border-radius:20px;font-size:10px;font-weight:800;letter-spacing:.5px;cursor:pointer;border:1px solid;transition:all .15s;text-transform:uppercase;}
.pb.ea{color:#22c55e;border-color:#22c55e40;background:#22c55e0a;}.pb.ea:hover,.pb.ea.on{background:#22c55e;color:#000;}
.pb.no{color:#6366f1;border-color:#6366f140;background:#6366f10a;}.pb.no:hover,.pb.no.on{background:#6366f1;color:#fff;}
.pb.ha{color:#f59e0b;border-color:#f59e0b40;background:#f59e0b0a;}.pb.ha:hover,.pb.ha.on{background:#f59e0b;color:#000;}
.pb.br{color:#ef4444;border-color:#ef444440;background:#ef44440a;}.pb.br:hover,.pb.br.on{background:#ef4444;color:#fff;}
.pb.rs{color:#666;border-color:#33335540;background:transparent;margin-left:auto;}.pb.rs:hover{color:#aaa;border-color:#555;}
.adm-sec{padding:12px 18px 4px;}
.adm-sl{font-size:9px;font-weight:700;letter-spacing:2px;color:#3a3a58;text-transform:uppercase;padding-bottom:8px;margin-bottom:2px;}
.adm-row{display:grid;grid-template-columns:170px 1fr 64px;align-items:center;gap:10px;padding:6px 0;}
.adm-row label{font-size:10px;color:#7070a0;}
input[type=range].sr{-webkit-appearance:none;appearance:none;height:3px;border-radius:2px;background:#1c1c30;outline:none;cursor:pointer;width:100%;}
input[type=range].sr::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:#6366f1;border:2px solid #0d0d1c;cursor:pointer;}
input[type=range].sr::-webkit-slider-thumb:hover{background:#818cf8;}
.adm-v{font-size:10px;font-weight:800;color:#b0b0d0;text-align:right;font-variant-numeric:tabular-nums;}
.adm-live{padding:12px 18px;border-top:1px solid #181828;margin-top:6px;background:#08081a;}
.adm-live-t{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#3a3a58;margin-bottom:8px;}
.adm-lg{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;}
.adm-li{background:#10102a;border:1px solid #1c1c30;border-radius:8px;padding:8px 10px;text-align:center;}
.adm-li .lv{font-size:13px;font-weight:800;color:#6366f1;font-variant-numeric:tabular-nums;}
.adm-li .lk{font-size:8px;color:#44445a;letter-spacing:.5px;margin-top:2px;}
.adm-apply{margin:10px 18px 4px;padding:9px;width:calc(100% - 36px);background:#4f46e5;color:#fff;border:none;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:1px;cursor:pointer;text-transform:uppercase;}
.adm-apply:hover{background:#6366f1;}
</style>

<button id="adm-btn" title="バランス管理 Ctrl+Shift+D">⚙</button>
<div id="adm-ov">
<div id="adm-pan">
  <div id="adm-head"><span>⚙ BALANCE MANAGER</span><span id="adm-conn" style="font-size:9px;letter-spacing:1px;color:#22c55e;font-weight:700;">● LIVE</span><button id="adm-cls">✕</button></div>
  <div id="adm-body">
    <div class="adm-pre">
      <label>PRESET</label>
      <button class="pb ea" data-p="easy">🟢 EASY</button>
      <button class="pb no" data-p="normal">🔵 NORMAL</button>
      <button class="pb ha" data-p="hard">🟡 HARD</button>
      <button class="pb br" data-p="brutal">🔴 BRUTAL</button>
      <button class="pb rs" data-p="reset">↺ リセット</button>
    </div>

    <div class="adm-sec">
      <div class="adm-sl">💰 財務</div>
      <div class="adm-row"><label>初期資金 <small style="color:#555">(次回起動から)</small></label><input type="range" class="sr" id="s-startMoney" min="100000" max="2000000" step="50000"><div class="adm-v" id="v-startMoney"></div></div>
      <div class="adm-row"><label>破産閾値</label><input type="range" class="sr" id="s-brokeLine" min="-500000" max="0" step="10000"><div class="adm-v" id="v-brokeLine"></div></div>
    </div>
    <div class="adm-sec">
      <div class="adm-sl">😰 メンタル</div>
      <div class="adm-row"><label>週次ダメージ（通常）</label><input type="range" class="sr" id="s-mentalDmg" min="0" max="12" step="1"><div class="adm-v" id="v-mentalDmg"></div></div>
      <div class="adm-row"><label>月次回復量</label><input type="range" class="sr" id="s-mentalRec" min="0" max="20" step="1"><div class="adm-v" id="v-mentalRec"></div></div>
    </div>
    <div class="adm-sec">
      <div class="adm-sl">🔥 炎上</div>
      <div class="adm-row"><label>GO閾値</label><input type="range" class="sr" id="s-fireGO" min="50" max="100" step="5"><div class="adm-v" id="v-fireGO"></div></div>
      <div class="adm-row"><label>拡大開始</label><input type="range" class="sr" id="s-fireSp" min="20" max="80" step="5"><div class="adm-v" id="v-fireSp"></div></div>
      <div class="adm-row"><label>イベント確率</label><input type="range" class="sr" id="s-fireEv" min="0" max="0.6" step="0.05"><div class="adm-v" id="v-fireEv"></div></div>
    </div>
    <div class="adm-sec">
      <div class="adm-sl">🎯 イベント</div>
      <div class="adm-row"><label>通常確率</label><input type="range" class="sr" id="s-evProb" min="0" max="0.7" step="0.05"><div class="adm-v" id="v-evProb"></div></div>
      <div class="adm-row"><label>ハード解禁ターン</label><input type="range" class="sr" id="s-hdTurn" min="0" max="150" step="10"><div class="adm-v" id="v-hdTurn"></div></div>
      <div class="adm-row"><label>ハード確率</label><input type="range" class="sr" id="s-hdProb" min="0" max="0.5" step="0.05"><div class="adm-v" id="v-hdProb"></div></div>
    </div>
    <div class="adm-sec">
      <div class="adm-sl">🤖 AIモード</div>
      <div class="adm-row"><label>判断ミス率</label><input type="range" class="sr" id="s-aiErr" min="0" max="0.8" step="0.05"><div class="adm-v" id="v-aiErr"></div></div>
      <div class="adm-row"><label>制度採択周期</label><input type="range" class="sr" id="s-aiPol" min="2" max="30" step="2"><div class="adm-v" id="v-aiPol"></div></div>
    </div>
    <div class="adm-sec">
      <div class="adm-sl">🏆 エンディング good（最低難度・即時反映）</div>
      <div class="adm-row"><label>解禁ターン</label><input type="range" class="sr" id="s-eTurn" min="30" max="300" step="10"><div class="adm-v" id="v-eTurn"></div></div>
      <div class="adm-row"><label>必要評判</label><input type="range" class="sr" id="s-eRep" min="10" max="90" step="5"><div class="adm-v" id="v-eRep"></div></div>
      <div class="adm-row"><label>必要累計収益</label><input type="range" class="sr" id="s-eRev" min="1000000" max="100000000" step="1000000"><div class="adm-v" id="v-eRev"></div></div>
      <div class="adm-row"><label>必要案件数</label><input type="range" class="sr" id="s-eProj" min="5" max="80" step="5"><div class="adm-v" id="v-eProj"></div></div>
    </div>

    <div class="adm-live">
      <div class="adm-live-t">📊 CURRENT STATE</div>
      <div class="adm-lg">
        <div class="adm-li"><div class="lv" id="L-money">—</div><div class="lk">資金</div></div>
        <div class="adm-li"><div class="lv" id="L-rep">—</div><div class="lk">評判</div></div>
        <div class="adm-li"><div class="lv" id="L-fire">—</div><div class="lk">炎上%</div></div>
        <div class="adm-li"><div class="lv" id="L-mental">—</div><div class="lk">平均メンタル</div></div>
        <div class="adm-li"><div class="lv" id="L-turn">—</div><div class="lk">ターン</div></div>
        <div class="adm-li"><div class="lv" id="L-rev">—</div><div class="lk">累計収益</div></div>
        <div class="adm-li"><div class="lv" id="L-proj">—</div><div class="lk">完了案件</div></div>
        <div class="adm-li"><div class="lv" id="L-wb">—</div><div class="lk">WB</div></div>
      </div>
    </div>
    <button class="adm-apply" id="adm-ok">✓ 閉じる（即時反映）</button>
  </div>
</div>
</div>

<script>
(function(){
  // ── ゲームのパラメーターを直接書き換えるパッチ ──
  // G、ENDINGS等はこのscriptより前に定義済み

  window.CFG = window.CFG || {};
  var CFG = window.CFG;
  // デフォルト値をセット（まだ設定されていない場合のみ）
  var CFG_DEFAULTS = {
    startMoney: 500000,
    brokeLine:  0,
    mentalDmg:  4,
    mentalRec:  5,
    fireGO:     85,
    fireSp:     50,
    fireEv:     0.25,
    evProb:     0.35,
    hdTurn:     40,
    hdProb:     0.15,
    aiErr:      0.25,
    aiPol:      8,
    eTurn:      120,
    eRep:       55,
    eRev:       20000000,
    eProj:      25,
  };
  // デフォルト値をCFGに適用（上書きなし）
  Object.keys(CFG_DEFAULTS).forEach(function(k){
    if(!(k in CFG)) CFG[k] = CFG_DEFAULTS[k];
  });

  var PRESETS = {
    easy:   {startMoney:1000000,brokeLine:-50000,mentalDmg:2,mentalRec:8,fireGO:92,fireSp:65,fireEv:0.10,evProb:0.20,hdTurn:80,hdProb:0.05,aiErr:0.10,aiPol:6,eTurn:60,eRep:40,eRev:4000000,eProj:15},
    normal: null,
    hard:   {startMoney:300000,brokeLine:0,mentalDmg:6,mentalRec:3,fireGO:80,fireSp:40,fireEv:0.35,evProb:0.45,hdTurn:20,hdProb:0.25,aiErr:0.35,aiPol:12,eTurn:120,eRep:65,eRev:15000000,eProj:35},
    brutal: {startMoney:200000,brokeLine:-30000,mentalDmg:8,mentalRec:2,fireGO:75,fireSp:30,fireEv:0.45,evProb:0.55,hdTurn:10,hdProb:0.35,aiErr:0.50,aiPol:16,eTurn:200,eRep:75,eRev:50000000,eProj:50},
  };
  PRESETS.normal = JSON.parse(JSON.stringify(CFG));

  // ゲームに設定を適用
  function applyToGame() { /* CFG=window.CFG、gcfg()経由で自動反映 */ }

  // フォーマット
  function fmt(k,v){
    if(k==='startMoney')return '¥'+Math.round(v/10000)+'万';
    if(k==='brokeLine')return v>=0?'±0':'¥'+(v/10000)+'万';
    if(k==='eRev')return '¥'+Math.round(v/1000000)+'M';
    if(k.endsWith('Ev')||k.endsWith('Prob')||k.endsWith('Err')||k==='evProb'||k==='hdProb'||k==='fireEv')return Math.round(v*100)+'%';
    return String(v);
  }

  // スライダー同期
  function syncSliders(){
    Object.keys(CFG).forEach(function(k){
      var sl=document.getElementById('s-'+k);
      var vl=document.getElementById('v-'+k);
      if(sl){sl.value=CFG[k];}
      if(vl){vl.textContent=fmt(k,CFG[k]);}
    });
  }

  // ライブ状態
  function syncLive(){
    if(typeof G==='undefined'||!G.s||!G.s.staff) return;
    var s=G.s;
    var avgM=s.staff.length>0?Math.round(s.staff.reduce(function(a,x){return a+x.mental;},0)/s.staff.length):'--';
    function sv(id,v){var e=document.getElementById(id);if(e)e.textContent=v;}
    sv('L-money','¥'+Math.round((s.money||0)/10000)+'万');
    sv('L-rep',(s.rep||0)+'%');
    sv('L-fire',(s.fire||0)+'%');
    sv('L-mental',avgM);
    sv('L-turn','W'+(s.turn||1));
    sv('L-rev','¥'+Math.round((s.totalRev||0)/10000)+'万');
    sv('L-proj',(s.projDone||0)+'件');
    sv('L-wb',s.wb||50);
    // good条件達成チェック
    var ok=s.turn>=CFG.eTurn&&s.rep>=CFG.eRep&&(s.totalRev||0)>=CFG.eRev&&(s.projDone||0)>=CFG.eProj;
    ['L-turn','L-rep','L-rev','L-proj'].forEach(function(id){
      var e=document.getElementById(id);if(e)e.style.color=ok?'#22c55e':'#6366f1';
    });
  }

  function open_(){
    syncSliders();
    syncLive();
    document.getElementById('adm-ov').classList.add('open');
  }
  function close_(){document.getElementById('adm-ov').classList.remove('open');}

  // スライダー変更 → CFG更新 → ゲームに即反映
  document.querySelectorAll('input.sr').forEach(function(sl){
    sl.addEventListener('input',function(){
      var k=this.id.replace('s-','');
      var v=parseFloat(this.value);
      CFG[k]=v;
      var vl=document.getElementById('v-'+k);
      if(vl)vl.textContent=fmt(k,v);
      // リアルタイム反映のフィードバック
      var conn=document.getElementById('adm-conn');
      if(conn){conn.textContent='✓ 反映済';conn.style.color='#22c55e';}
    });
  });

  // プリセット
  document.querySelectorAll('[data-p]').forEach(function(btn){
    btn.addEventListener('click',function(){
      var name=this.dataset.p;
      var p=name==='reset'?PRESETS.normal:PRESETS[name];
      if(!p)return;
      Object.keys(p).forEach(function(k){CFG[k]=p[k];});
      syncSliders();
      applyToGame();
      document.querySelectorAll('[data-p]').forEach(function(b){b.classList.remove('on');});
      if(name!=='reset')this.classList.add('on');
    });
  });

  document.getElementById('adm-btn').addEventListener('click',open_);
  document.getElementById('adm-cls').addEventListener('click',close_);
  document.getElementById('adm-ok').addEventListener('click',close_);
  document.getElementById('adm-ov').addEventListener('click',function(e){if(e.target===this)close_();});
  document.addEventListener('keydown',function(e){
    if(e.ctrlKey&&e.shiftKey&&e.key==='D'){e.preventDefault();open_();}
  });

  // ライブ更新
  setInterval(function(){
    if(document.getElementById('adm-ov').classList.contains('open'))syncLive();
  },600);


})();
</script>

</body>
</html>

